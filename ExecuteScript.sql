
/****** Object:  StoredProcedure [patient].[Usp_Manage_taluka]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_taluka]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_states]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_states]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_regiondetails]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_regiondetails]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_PinCodes]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_PinCodes]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_patientNames]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_patientNames]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_LastNames]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_LastNames]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_Landmarks]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_Landmarks]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_HusbandNames]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_HusbandNames]
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_District]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [patient].[Usp_Manage_District]
GO
/****** Object:  StoredProcedure [dbo].[Usp_UserTemplateSettings]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_UserTemplateSettings]
GO
/****** Object:  StoredProcedure [dbo].[Usp_SubscriptionExecution]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_SubscriptionExecution]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_VillageCity_16_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_VillageCity_16_06_2025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_VillageCity]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_VillageCity]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgReports_19042025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgReports_19042025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgReports]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgReports]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_23022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgDetails_23022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_19022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgDetails_19022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_14032025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgDetails_14032025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_04032025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgDetails_04032025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UsgDetails]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UserSettings]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_UserSettings]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Users]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Users]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_tblIndoorRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_tblIndoorRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas_16_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Talukas_16_06_2025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas_15_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Talukas_15_06_2025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Talukas]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Subscriptions]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Subscriptions]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_States]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_States]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Society]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Society]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ReportHeader_BKP]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_ReportHeader_BKP]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ReportHeader]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_ReportHeader]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Plans]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Plans]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PincodeLocations]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_PincodeLocations]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits_24022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_PatientVisits_24022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits_07032025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_PatientVisits_07032025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_PatientVisits]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_bkp_19_10_2024]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_bkp_19_10_2024]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_30122024]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_30122024]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_23012024]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_23012024]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_21102025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_21102025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_15022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_15022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_03052025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_03052025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_02072025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients_02072025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Patients]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientDischarge]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_PatientDischarge]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OvulationProfiles_19042025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_OvulationProfiles_19042025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OvulationProfiles]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_OvulationProfiles]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OTCharges]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_OTCharges]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OpdRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_OpdRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs_19042025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_MTPs_19042025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs_13022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_MTPs_13022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_MTPs]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ModuleRights]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_ModuleRights]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Medicines]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Medicines]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Items]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Items]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRoundRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_IndoorRoundRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRecords_19042025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_IndoorRecords_19042025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_IndoorRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Hospitals]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Hospitals]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Histolap]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Histolap]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Groups]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Groups]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_EntityRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_EntityRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Districts]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Districts]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Diagnosis]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Diagnosis]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_19042025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_DeliveryRecords_19042025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_13032025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_DeliveryRecords_13032025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_13022025]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_DeliveryRecords_13022025]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_DeliveryRecords]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DataSync]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_DataSync]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_City]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_City]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_BillVouchers]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_BillVouchers]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Bills]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Bills]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_AutoSync_Medicines]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_AutoSync_Medicines]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Area]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Area]
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Advice]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_Manage_Advice]
GO
/****** Object:  StoredProcedure [dbo].[usp_Login]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[usp_Login]
GO
/****** Object:  StoredProcedure [dbo].[USP_GETDATE]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[USP_GETDATE]
GO
/****** Object:  StoredProcedure [dbo].[USP_GenBakup]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[USP_GenBakup]
GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_SPForTable]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_AutoGenerate_SPForTable]
GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_EntityLayerForTable]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_AutoGenerate_EntityLayerForTable]
GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_DataLayerForTable]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [dbo].[Usp_AutoGenerate_DataLayerForTable]
GO
/****** Object:  StoredProcedure [appadvertise].[Usp_Manage_Advertisements]    Script Date: 13-02-2026 09:34:09 ******/
DROP PROCEDURE [appadvertise].[Usp_Manage_Advertisements]
GO
/****** Object:  StoredProcedure [appadvertise].[Usp_Manage_Advertisements]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ============
 CREATE PROC [appadvertise].[Usp_Manage_Advertisements]  
   @Command varchar(200) 
  , @AdId int=NULL 
  , @Message nvarchar(255)=NULL 
  , @CreatedDate datetime=NULL 
  , @ExpiryDate datetime=NULL 
  , @IsActive bit=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
  
  , @PlaceMent nvarchar(500) = ''

  ,@tbl_AdvertisementDetail  [dbo].[tbl_AdvertisementDetail] null READONLY 
  ,@tbl_AdvertisementMaster  [dbo].[tbl_AdvertisementMaster] null READONLY 

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      
	  --INSERT INTO appadvertise.tbl_Advertisements  
   --      (Message, CreatedDate, ExpiryDate, IsActive) 
   --    VALUES (@Message, @CreatedDate, @ExpiryDate, @IsActive)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	-- Jeet Chauhan New Logic

	IF @SubCommand = 'New Advertisement'
	BEGIN
		
		-- // new advertise updated the whole content.
		truncate table appadvertise.tbl_AdvertisementMaster

		INSERT INTO appadvertise.tbl_AdvertisementMaster 
		( AdType, Headline, Description, TargetUrl, StartDate, ExpireDate, IsActive, CreatedOn, UpdatedOn, LastSyncDate)
		select  AdType, Headline, Description, TargetUrl, StartDate, ExpireDate, IsActive, CreatedOn, UpdatedOn, GETDATE() from @tbl_AdvertisementMaster



		truncate table appadvertise.tbl_AdvertisementDetail

		INSERT INTO appadvertise.tbl_AdvertisementDetail ( AdId, MediaType, MediaUrl, MediaContent, SortOrder, PlaceMent)
		select AdId, MediaType, MediaUrl, MediaContent, SortOrder, PlaceMent from @tbl_AdvertisementDetail
		
		

		-- // new advertise updated the whole content.

	END

	-- Jeet Chauhan New Logic


      --UPDATE appadvertise.tbl_AdvertisementDetail SET Message=@Message 
      --  , CreatedDate=@CreatedDate 
      --  , ExpiryDate=@ExpiryDate 
      --  , IsActive=@IsActive 
      --   WHERE Id=@AdId 
		 

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @AdId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @AdId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      --SELECT Id, Message, CreatedDate, ExpiryDate, IsActive FROM  appadvertise.tbl_Advertisements WHERE Id=@Id 

	  IF @SubCommand = 'ALL'
	  BEGIN
			
				select ad.AdId,AdType,Headline,Description,TargetUrl,StartDate,ExpireDate,IsActive,CreatedOn,UpdatedOn,DetailId,MediaType,MediaUrl,MediaContent,SortOrder from appadvertise.tbl_AdvertisementMaster ad
			inner join appadvertise.tbl_AdvertisementDetail ade
			on ade.AdId = ad.adid
			


	  END

	  ELSE IF @SubCommand = 'SELECT SINGLE'
	  BEGIN

			select ad.AdId,AdType,Headline,Description,TargetUrl,StartDate,ExpireDate,IsActive,CreatedOn,UpdatedOn,DetailId,MediaType,MediaUrl,MediaContent,SortOrder from appadvertise.tbl_AdvertisementMaster ad
			inner join appadvertise.tbl_AdvertisementDetail ade
			on ade.AdId = ad.adid
			--where ade.adid = @AdId
			where trim(ade.Placement) = trim(@PlaceMent)
	  END

	  ELSE IF @SubCommand = 'IsSyncNeeded'
	  BEGIN
		
		declare @LastSyncDate datetime , @IsSyncNeeded bit = 0;
		select top 1 @LastSyncDate = LastSyncDate from appadvertise.tbl_AdvertisementMaster 
								     where LastSyncDate is not null

		--select CAST( @LastSyncDate as date) 
		declare @DayDiffOfLastSyncToTodate int = ( DATEDIFF(DAY , CAST( @LastSyncDate as date)  , cast( GETDATE() as date)))

		IF @DayDiffOfLastSyncToTodate > 7
		BEGIN
			select CAST( @LastSyncDate as date) as LastSyncDate , 1 as IsSyncNeeded
		END
		ELSE
		BEGIN
			select CAST( @LastSyncDate as date) as LastSyncDate , 0 as IsSyncNeeded
		END

	  END
		

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  --DELETE FROM appadvertise.tbl_Advertisements WHERE Id=@AdId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @AdId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_DataLayerForTable]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 /*
   
## Description: This SP will generate an Data Layer class code from the table specified.

## Execution statement:

EXEC Usp_AutoGenerate_DataLayerForTable
 @Table = 'tblSociety'
 ,@EntityClassName ='SocietySL'
 ,@Language = 'Csharp'

## Argument Description:
@Table – specifies the name of the table for which you want to generate the Data Layer Code
@EntityClassName – specifies the name with which the Data Layer class will be generated

*/

 
CREATE PROC [dbo].[Usp_AutoGenerate_DataLayerForTable] 
@Table varchar(1000), 
@EntityClassName varchar(1000), 
@Language varchar(1000)=null
AS 

BEGIN 
 
SET NOCOUNT ON; 

 Declare @v_PKColumns_Vc varchar(max)='' 
 -- -- // QUERY TO GET THE PRIMARY COLUMN OF  THE TABLE 
 SELECT @v_PKColumns_Vc=Col.Column_Name from  
    INFORMATION_SCHEMA.TABLE_CONSTRAINTS Tab,  
    INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE Col  
 WHERE  
    Col.Constraint_Name = Tab.Constraint_Name 
    AND Col.Table_Name = Tab.Table_Name 
    AND Constraint_Type = 'PRIMARY KEY ' 
    AND Col.Table_Name = @Table 

-- -- // QUERY TO GENERATE ENTITY CLASS FOR TABLE COLUMNS
 BEGIN 
 
	If @Language='VB'
	begin
		 select ' objCmd.Parameters.Add("@' + column_name + '", System.Data.SqlDbType.' + DATA_TYPE + ').Value = ' + 'obj'+@EntityClassName+'.'+column_name AS SaveParam 
  , column_name as ColumnName, DATA_TYPE as DataType
  from information_schema.columns where table_name = @Table;   
 
 
    select ' objCmd.Parameters.Add("@' + column_name + '", System.Data.SqlDbType.' + DATA_TYPE + ').Value = ' + 'obj'+@EntityClassName+'.'+column_name AS GetParam 
  , column_name as ColumnName, DATA_TYPE as DataType
  from information_schema.columns where table_name = @Table and column_name=@v_PKColumns_Vc; 
 
  Select 'obj'+@EntityClassName+'.'+A.ColumnName + ' = Convert.To' +  A.DataType + '(objReader("'+A.ColumnName +'"))' as GetData
 
  , A.ColumnName, A.DataType From (
  select column_name as ColumnName,  
  CASE DATA_TYPE  
 When 'int' then 'Int32' 
 When 'smallint' then 'Int32'  
 When 'tinyint' then 'Int16'  
 When 'bigint' then 'Int64'  
 When 'float' then 'Decimal'
 When 'decimal' then 'Decimal'  
 When 'varchar' then 'String'
 When 'nvarchar' then 'String'
 When 'char' then 'String'
 When 'nchar' then 'String'  
 When 'text' then 'String'  
 When 'bit' then 'Boolean' 
 When 'datetime' then 'DateTime'  
 When 'date' then 'DateTime'
 When 'time' then 'TimeSpan'
 When 'money' then 'Decimal'
 When 'varbinary' then 'Byte'  
  END    
 AS DataType
   
  from information_schema.columns where table_name = @Table
  ) as A
	end
	Else If @Language='CSharp'
	begin		  
		 select ' dCmd.Parameters.AddWithValue("@' + column_name + '", obj'+@EntityClassName+'.'+column_name+');' AS SaveParam 
  , column_name as ColumnName, DATA_TYPE as DataType
  from information_schema.columns where table_name = @Table;   
 
 
    select ' dCmd.Parameters.AddWithValue("@' + column_name + '", obj'+@EntityClassName+'.'+column_name+');' AS GetParam 
  , column_name as ColumnName, DATA_TYPE as DataType
  from information_schema.columns where table_name = @Table and column_name=@v_PKColumns_Vc; 
 
  Select 'obj'+@EntityClassName+'.'+A.ColumnName + ' = Convert.To' +  A.DataType + '(objReader["'+A.ColumnName +'"]);' as GetData
 
  , A.ColumnName, A.DataType From (
  select column_name as ColumnName,  
  CASE DATA_TYPE  
 When 'int' then 'Int32' 
 When 'smallint' then 'Int32'  
 When 'tinyint' then 'Int16'  
 When 'bigint' then 'Int64'  
 When 'float' then 'Decimal'
 When 'decimal' then 'Decimal'  
 When 'varchar' then 'String'
 When 'nvarchar' then 'String'
 When 'char' then 'String'
 When 'nchar' then 'String'  
 When 'text' then 'String'  
 When 'bit' then 'Boolean' 
 When 'datetime' then 'DateTime'  
 When 'date' then 'DateTime'
 When 'time' then 'TimeSpan'
 When 'money' then 'Decimal'
 When 'varbinary' then 'Byte'  
  END    
 AS DataType
   
  from information_schema.columns where table_name = @Table
  ) as A
	end
 
 
 
 END 

END
GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_EntityLayerForTable]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 /*
   
## Description: This SP will generate an Entity Layer class code from the table specified.

## Execution statement:

EXEC Usp_AutoGenerate_EntityLayerForTable
 @Table = 'tbl_Orders'
 ,@EntityClassName ='Orders'

## Argument Description:
@Table – specifies the name of the table for which you want to generate the Entity Layer Code
@EntityClassName – specifies the name with which the Entity Layer class will be generated

*/
   
CREATE PROC [dbo].[Usp_AutoGenerate_EntityLayerForTable]   
@Table varchar(1000),   
@EntityClassName varchar(1000)   
AS   
 
BEGIN   
   
SET NOCOUNT ON;   
 
-- -- // QUERY TO GENERATE ENTITY CLASS FOR TABLE COLUMNS 
 BEGIN   
    

  select column_name as ColumnName,  
  CASE DATA_TYPE  
 When 'int' then 'Int32' 
 When 'smallint' then 'Int32'  
 When 'tinyint' then 'Int16'  
 When 'bigint' then 'Int64'  
 When 'float' then 'Decimal'
 When 'decimal' then 'Decimal'  
 When 'varchar' then 'String'
 When 'nvarchar' then 'String'
 When 'char' then 'String'
 When 'nchar' then 'String'  
 When 'text' then 'String'  
 When 'bit' then 'Boolean' 
 When 'datetime' then 'DateTime'  
 When 'date' then 'DateTime'
 When 'time' then 'TimeSpan'
 When 'money' then 'Decimal'
 When 'varbinary' then 'Byte'  
  END    
 AS DataType
   
  from information_schema.columns where table_name = @Table;       
 
       
 END   
 
END
GO
/****** Object:  StoredProcedure [dbo].[Usp_AutoGenerate_SPForTable]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/* 

## Description: This SP will generate an stored procedure script containing the logic to INSERT/UPDATE/SELECT/DELETE a record from the table specified.

## Execution statement:

EXEC Usp_AutoGenerate_SPForTable 
@Schema = 'location'
 ,@Table = 'tblDistrict' 
 ,@UspName ='Usp_Manage_Disctricts'

## Argument Description:
@Table – specifies the name of the table for which you want to generate the stored procedure script
@UspName – specifies the name with ehich the stored procedure script will be generated

*/ 
 
  
CREATE PROC [dbo].[Usp_AutoGenerate_SPForTable] 
@Schema varchar(50),
@Table varchar(1000), 
@UspName varchar(1000) 
AS 
 
BEGIN 


 
SET NOCOUNT ON; 
 Declare @Command varchar(200)='@Command' 
 Declare @CommandType varchar(200)='varchar(200)' 
 Declare @v_PKColumns_Vc varchar(max)='' 



 -- -- // QUERY TO GET THE PRIMARY COLUMN OF  THE TABLE 
 SELECT @v_PKColumns_Vc=Col.Column_Name from  
    INFORMATION_SCHEMA.TABLE_CONSTRAINTS Tab,  
    INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE Col  
 WHERE  
    Col.Constraint_Name = Tab.Constraint_Name 
    AND Col.Table_Name = Tab.Table_Name 
    --AND Constraint_Type = 'PRIMARY KEY ' 
    AND Col.Table_Name = @Table 
 
 -- -- // QUERY TO GENERATE DECLARATION OF TABLE COLUMN NAME VARIABLES  
 BEGIN 
  
  Declare @v_DeclareColumns_Vc varchar(max)='' 
  Declare @DeclareQuery_Vc varchar(max)='' 
  select @v_DeclareColumns_Vc = Coalesce(@v_DeclareColumns_Vc, '') + '@' + column_name + ' ' + DATA_TYPE  
  + CASE WHEN (CHARACTER_MAXIMUM_LENGTH IS NULL OR DATA_TYPE='text') Then ''  
    WHEN (CHARACTER_MAXIMUM_LENGTH = -1 ) Then '(MAX)' 
    ELSE '(' + CONVERT(varchar(50),CHARACTER_MAXIMUM_LENGTH) + ')' 
    END 
  + '=NULL'      
  + ' 
  , '  
 
  from information_schema.columns where table_name = @Table; 
 
  Set @v_DeclareColumns_Vc=SUBSTRING(@v_DeclareColumns_Vc,0,LEN(@v_DeclareColumns_Vc)) 
  select  @DeclareQuery_Vc = @Command + ' '+@CommandType+' 
  , ' + @v_DeclareColumns_Vc 
  --print @DeclareQuery_Vc 
+ ', @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)=''CategoryName''
  , @SortOrder varchar(5)=''Asc''
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
  '
 
 END 
  
 BEGIN 
  -- -- QUERY TO GENERATE INSERT STATEMENT FOR A TABLE 
  Declare @InsertQuery varchar(MAX) 
  Declare @v_InsertColumns_Vc varchar(max)='' 
 
 --SET @Table = @Schema + '.' + @Table;

  select @v_InsertColumns_Vc = Coalesce(@v_InsertColumns_Vc, '') + '@' + column_name +', '  
        from information_schema.columns where table_name = @Table and column_name!=@v_PKColumns_Vc ; 
 
  Set @v_InsertColumns_Vc=SUBSTRING(@v_InsertColumns_Vc,0,LEN(@v_InsertColumns_Vc)) 
 
 
  SELECT @InsertQuery = ' INSERT INTO ' + @Schema + '.' + @Table + '  
         (' + Replace(@v_InsertColumns_Vc,'@','') + ') 
       VALUES (' + @v_InsertColumns_Vc + ')   
   ' 
 
  --PRINT @InsertQuery 
 END 
  
 BEGIN 
  -- -- QUERY TO GENERATE UPDATE STATEMENT FOR A TABLE 
  Declare @UpdateQuery varchar(MAX) 
  Declare @v_UpdateColumns_Vc varchar(max)='' 
   
  select @v_UpdateColumns_Vc = Coalesce(@v_UpdateColumns_Vc, '') + column_name + '=@' + column_name +' 
        , '  
        from information_schema.columns where table_name = @Table and column_name!=@v_PKColumns_Vc; 
 
  Set @v_UpdateColumns_Vc=SUBSTRING(@v_UpdateColumns_Vc,0,LEN(@v_UpdateColumns_Vc)) 
   
  Select @UpdateQuery = ' UPDATE ' + @Schema + '.' + @Table 
        + ' SET ' 
        + @v_UpdateColumns_Vc 
        +' WHERE ' + @v_PKColumns_Vc + '=@' + @v_PKColumns_Vc  
         
   
  --PRINT @UpdateQuery 
 END 
  
 BEGIN 
  -- -- QUERY TO GENERATE SELECT STATEMENT FOR A TABLE ROW 
  Declare @SelectQuery varchar(MAX) 
  Declare @v_SelectColumns_Vc varchar(max)='' 
  select @v_SelectColumns_Vc = Coalesce(@v_SelectColumns_Vc, '') + column_name +', '  
        from information_schema.columns where table_name = @Table; 
         
  Set @v_SelectColumns_Vc=SUBSTRING(@v_SelectColumns_Vc,0,LEN(@v_SelectColumns_Vc))       
         
  Select @SelectQuery = ' SELECT ' + @v_SelectColumns_Vc 
  + ' FROM  ' + @Schema + '.' + @Table 
  + ' WHERE ' + @v_PKColumns_Vc + '=@' + @v_PKColumns_Vc  
   
  --PRINT @SelectQuery 
 END 
  
 BEGIN 
  -- -- QUERY TO GENERATE DELETE STATEMENT FOR A TABLE ROW 
  Declare @DeleteQuery varchar(MAX) 
  Select @DeleteQuery = ' DELETE FROM ' + @Schema + '.' + @Table 
  + ' WHERE ' + @v_PKColumns_Vc + '=@' + @v_PKColumns_Vc  
   
  --PRINT @DeleteQuery   
 END 
  
 -- -- // STEPS TO CREATE SCRIPT OF NEW USP 
 Declare @UspQuery varchar(MAX) 
  
 Select @UspQuery = ' CREATE PROC ' + @UspName 
  
   + '  
   ' + @DeclareQuery_Vc +     
  
 ' 
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='''', @v_CustomMessage varchar(MAX)=''''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF '+@Command+'=''INSERT'' 
    BEGIN 
     ' 
     + 
      @InsertQuery 
     + 
     '     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message=''success'',  @v_CustomMessage = ''Saved successfully!''
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = ''Save failed!''
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF '+@Command+'=''UPDATE'' 
    BEGIN 
     ' 
     + 
      @UpdateQuery 
     + 
     '     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @' + @v_PKColumns_Vc + ', @v_Message=''success'',  @v_CustomMessage = ''Saved successfully!''
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @' + @v_PKColumns_Vc + ', @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = ''Save failed!''
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF '+@Command+'=''SELECT'' 
    BEGIN 
     ' 
     + 
      @SelectQuery 
     + 
     ' 
    END 
     
    ELSE IF '+@Command+'=''DELETE'' 
    BEGIN 
     ' 
     + 
      @DeleteQuery 
     + 
     ' 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @' + @v_PKColumns_Vc + ', @v_Message=''success''
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 '  
 
 print '-- ============' 
 print @UspQuery

 --EXEC (@UspQuery )    
END
GO
/****** Object:  StoredProcedure [dbo].[USP_GenBakup]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[USP_GenBakup]    Script Date: 23-07-2025 00:23:38 ******/
CREATE PROC [dbo].[USP_GenBakup]
@Command nvarchar(50) = 'INSERT',
@SubCommand nvarchar(50) = '',

@BackupName nvarchar(100) = null,
@RoutPath nvarchar(500) = null,
@EMPId nvarchar(100) = '1'
, @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT

as
BEGIN

IF @BackupName is null
	set @BackupName = (select (CAST(CAST(getdate() as date) as nvarchar(max))));

IF @RoutPath is null
	--set @Path = 'D:\MyAppBackup'
	set @RoutPath = 'C:\JeetTestingBkps'


DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0


	IF @Command = 'INSERT'
	BEGIN

		declare @Identity_Id bigint = 0;
		
		insert into tbl_BackupSceduleLog(BackupName , BackupPath , CreateBy , IsSuccess)
		values (@BackupName , @RoutPath , @EMPId , 0)

		set @Identity_Id = SCOPE_IDENTITY();


		declare @backupDirectory nvarchar(max) = 
		@RoutPath + '\db_' + @BackupName + '.bak';;

		BACKUP DATABASE [dbMyOPD]
		TO DISK = @backupDirectory
		WITH DIFFERENTIAL;
		--WITH  COMPRESSION, STATS = 10;

		print @backupDirectory

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = 1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			update tbl_BackupSceduleLog set IsSuccess = 1 , UpdateTime = getdate() where logid = @Identity_Id
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			update tbl_BackupSceduleLog set IsSuccess = 3 , UpdateTime = getdate() where logid = @Identity_Id
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

		

	END
END
GO
/****** Object:  StoredProcedure [dbo].[USP_GETDATE]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[USP_GETDATE]
    @cmd INT = 0
AS
BEGIN
    SET NOCOUNT ON;
    SELECT GETDATE() AS CurrentDateTime;
END;
GO
/****** Object:  StoredProcedure [dbo].[usp_Login]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Karan>
-- Create date: <02-08-2023>
-- Description:	<Used for Login Purpose>
-- =============================================

/*
Exec [dbo].[usp_Login]
@action_Vc = 'UserSignIn',
@loginId_Vc = 'SA1',
@password_Vc = 'Admin@1234' ,
@ipAddress_Vc = '127.0.0.1'

*/

CREATE PROCEDURE [dbo].[usp_Login]
-- Add the parameters for the stored procedure here
@action_Vc varchar(50),
@loginId_Vc varchar(200)=null,
@password_Vc varchar(30) = null,
@ipAddress_Vc varchar(20)=null,
@outMessage_Vc varchar(2000) = null output,
@outIsSuccess bit = NULL OUTPUT,
@outCustomMessage_Vc varchar(2000) = null output,

@contactId_Int bigint = null,
@userId_Int int = null,
@activityId_Int int = null,
@newPassword_Vc varchar(30) = null,
@email_Vc varchar(200)=null,
@profId_Int int = 0,
@SiteID int=null,
@userStatus bit = 0
,@UserIP varchar(20)=NULL
,@userRights varchar(1000)=NULL
, @CompanyId int=0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
DECLARE @v_userId_Int int, @v_companyId_Int int, @v_ContactId_Int bigint
    -- procedure logic goes here
	
	IF @action_Vc='UserSignIn'
	BEGIN	
		
		--select @v_userId_Int = hu.UserId
		--from hospital.tblHospitalUsers hu with (nolock)
		--inner join hospital.tblHospital h on hu.HospitalId=h.HospitalId
		--inner join hospital.tblUserLogin ul on hu.HospitalId=ul.HospitalId and hu.UserId=ul.UserId
		--and hu.UserCode=@loginId_Vc and ul.Password=@password_Vc

		select @v_userId_Int = hu.UserId
		from hospital.tblHospitalUsers hu with (nolock)
		inner join hospital.tblHospital h on hu.HospitalId=h.HospitalId
		--inner join hospital.tblUserLogin ul on hu.HospitalId=ul.HospitalId and hu.UserId=ul.UserId
		and hu.UserCode=@loginId_Vc and hu.Password=@password_Vc

		If @v_userId_Int is not null
		Begin
			--Insert into dbo.tbl_activity 
			--	(userId, activity, activityNote, ipAddress) 
			--Values (@v_userId_Int, 'Sign In', @loginId_Vc + ' signed in.', @ipAddress_Vc)

			--Update tbl_activity Set loginActivityId = SCOPE_IDENTITY() Where ActivityId=SCOPE_IDENTITY()

			--select h.HospitalId, hu.UserId, hu.UserCode, hu.FirstName, hu.MiddleName, hu.LastName
			--, h.IsActive as IsHospitalActive, hu.IsUserActive, hu.EmployeeTypeId ,ul.LoginAccessStatus
			--,hc.Phone,hc.LandLine,hc.FaxNo,hc.EmailAddress
			--from hospital.tblHospitalUsers hu with (nolock)
			--inner join hospital.tblHospital h on hu.HospitalId=h.HospitalId
			--inner join hospital.tblUserLogin ul on hu.HospitalId=ul.HospitalId and hu.UserId=ul.UserId
			--and hu.UserCode=@loginId_Vc and ul.Password=@password_Vc
			--inner join hospital.tblHospitalContacts hc on hu.UserId=hc.ContactEntityRefId and hc.ContactEntityType=13

			select h.HospitalId, hu.UserId, hu.UserCode, hu.FirstName, hu.MiddleName, hu.LastName
			, h.IsActive as IsHospitalActive, hu.IsUserActive, hu.EmployeeTypeId, hu.LoginAccessTypeId, accesstyp.RecordName as LoginAccessType, UserRights  
			, hc.Phone,hc.LandLine,hc.FaxNo,hc.EmailAddress
			, isnull(s.SubscriptionId,0) as SubscriptionId, isnull(s.IsSubscriptionActive,0) as IsSubscriptionActive, s.EndDate
			, h.HospitalName
			, IsNull(h.LocationType,'City') as HospitalLocationType
			--, 'City' as HospitalLocationType

			,hu.UserTypeId, usertype.RecordName as UserType
			, s.AttendanceAccess as AttendanceAccess

			--, h.HospitalMasterId as MasterHospitalId
			, 24 as MasterHospitalId

			from hospital.tblHospitalUsers hu with (nolock)
			inner join hospital.tblHospital h on hu.HospitalId=h.HospitalId
			--inner join hospital.tblUserLogin ul on hu.HospitalId=ul.HospitalId and hu.UserId=ul.UserId
			and hu.UserCode=@loginId_Vc and hu.Password=@password_Vc
			INNER JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
			LEFT join hospital.tblHospitalContacts hc on hu.UserId=hc.ContactEntityRefId and hc.ContactEntityType=13
			inner join common.tblEntityRecords usertype on hu.UserTypeId=usertype.EntityRecordId
			left join subscription.tblSubscriptions s on h.HospitalId=s.HospitalId

			
					
		End
	END
	
	
END

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Advice]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Advice]  
   @Command varchar(200) 
  , @AdviceId int=NULL 
  , @Advice nvarchar(1000)=NULL 
  , @Detail nvarchar(4000)=NULL 
  , @IsAdviceActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Advice'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)='', @v_advs varchar(100)
  
    IF @Command='INSERT' 
    BEGIN 
        
        
		
		If Not Exists (select top 1 AdviceId from hospital.tblAdvice with (nolock) where Advice=@Advice)
		Begin
				INSERT INTO hospital.tblAdvice  
				 (Advice, Detail, IsAdviceActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@Advice, @Detail, @IsAdviceActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy) 
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Advice with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN    
		 
		If not Exists (select top 1 AdviceId from hospital.tblAdvice with (nolock) where Advice=@Advice and AdviceId!=@AdviceId)
			Begin				
				   UPDATE hospital.tblAdvice SET Advice=@Advice 
				, Detail=@Detail 
				, IsAdviceActive=@IsAdviceActive 
				, IsEdited=@IsEdited 
				--, EntryDate=@EntryDate 
				, UpdatedDate=@UpdatedDate 
				--, CreatedBy=@CreatedBy 
				, UpdatedBy=@UpdatedBy 
				 WHERE AdviceId=@AdviceId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @AdviceId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @AdviceId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @AdviceId, @v_Message='error', @v_CustomMessage='Duplication error. Another Advice with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN       

	  	If @SubCommand = 'SelectSingle'
		Begin
			SELECT AdviceId, Advice, Detail, IsAdviceActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM hospital.tblAdvice with (nolock) WHERE AdviceId=@AdviceId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			if(@IsAdviceActive is not null and @IsAdviceActive=1)
			begin
				SET @WhereQry = ' a.IsAdviceActive = 1 ' -- -- // Select only Active records			
			end
			else
			begin
				SET @WhereQry = ' a.IsAdviceActive in (1,0) '			
			end

				
			
			If ISNULL(@SearchKey,'')!=''
			Begin

				If ISNULL(@SearchType,'')='GroupWise'
				Begin					
					SELECT @v_advs =  '''' + Replace(GroupItems,',', ''',''') + '''' FROM common.tblGroups with(nolock) WHERE GroupId=@SearchKey
					--print @v_meds

					SET @WhereQry = @WhereQry + ' AND a.Advice in (' + @v_advs + ') and a.IsAdviceActive=1 '
					
					--print '@v_meds : ' + @v_meds
					--print '@WhereQry : ' + @WhereQry
				End			
				Else If ISNULL(@SearchType ,'')='AdviceWise'
				Begin
					SET @WhereQry = @WhereQry + ' AND a.AdviceId in (' + @SearchKey + ') and a.IsAdviceActive=1 '
				End
				Else If ISNULL(@SearchType ,'')='Status' Or  ISNULL(@SearchType ,'')='Active'
				Begin
					SET @WhereQry = @WhereQry + ' AND a.IsAdviceActive=1 '
				End
				Else
				Begin
					SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Name'
						Then 'a.Advice = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(a.Advice like ''%' + @SearchKey + '%'' 
						Or a.Detail like ''%' + @SearchKey + '%'')' 
					 End
				End

				
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select AdviceId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct a.AdviceId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblAdvice a with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, a.AdviceId, a.Advice, a.Detail, a.IsAdviceActive, a.IsEdited, a.EntryDate, a.UpdatedDate, a.CreatedBy, a.UpdatedBy 						  
				  From CTE 
				  INNER JOIN hospital.tblAdvice a with(nolock) ON CTE.AdviceId=a.AdviceId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tblAdvice WHERE AdviceId=@AdviceId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @AdviceId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Area]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_Area]  
   @Command varchar(200) 
  , @AreaId bigint=NULL 
  , @Area nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @CityId bigint =null
  , @DistrictId bigint=0 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
	
	IF not exists(select top 1 1 from location.tblArea where Area = @Area and Language = @Language)
	BEGIN
		
		INSERT INTO location.tblArea  
         (Area, Language, CityId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@Area, @Language, @CityId, @IsActive, @IsEdited, isnull(@EntryDate, getdate()), @UpdatedDate, @CreatedBy, @UpdatedBy)  

	   declare @V_AreaId bigint = SCOPE_IDENTITY()

	   If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Area=@Area and CityId=@CityId and Language=@Language)
	   BEGIN
			INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , Area ,CityId , IsTaluka , AreaId) 
			   VALUES ('', @Language, @DistrictId, @IsActive, @IsEdited, isnull(@EntryDate, getdate()), @UpdatedDate, @CreatedBy, @UpdatedBy , @Area , @CityId,0 , @V_AreaId)
	   END


	END
		
       
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	 If Not Exists (select top 1 1 from location.tblArea where Area = @Area and Language = @Language)
		  BEGIN

      UPDATE location.tblArea SET Area=@Area 
        , Language=@Language 
        , CityId=@CityId
        , IsActive=@IsActive 
        , IsEdited=1 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        --, CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE AreaId=@AreaId   
		 
		  If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Area=@Area and AreaId = @AreaId and CityId=@CityId and Language=@Language)
		  BEGIN
			
			UPDATE location.tblTaluka 
				SET 
				  Language=@Language 
				, Area = @Area
				, CityId = @CityId
				, IsActive=@IsActive 
				, IsEdited=1 				
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				 WHERE AreaId=@AreaId  
		  END
		END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @AreaId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @AreaId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		if @SubCommand = 'SelectSingle'
		BEGIN
			 SELECT AreaId, Area, a.Language, a.CityId, c.CityName as City , State , s.StateId, a.IsActive, a.IsEdited, a.EntryDate, a.UpdatedDate, a.CreatedBy, a.UpdatedBy
			FROM  
			location.tblArea a
			inner join location.TblCity c on c.CityId = a.CityId
			inner join location.tblState s on s.StateId = c.StateId
			where AreaId=@AreaId 
		END
		ELSe
		BEGIN
			 
				SELECT AreaId, Area, a.Language, a.CityId, CityName as City, State , s.StateId , a.IsActive, a.IsEdited, a.EntryDate, a.UpdatedDate, a.CreatedBy, a.UpdatedBy 
				FROM  
				location.tblArea a
				inner join location.TblCity c on c.CityId = a.CityId
				inner join location.tblState s on s.StateId = c.StateId
		END
     
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblArea WHERE AreaId=@AreaId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @AreaId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_AutoSync_Medicines]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_AutoSync_Medicines]  
   @Command varchar(200) 
  , @MedicineId int=NULL 
  , @MedicineName nvarchar(500)=NULL 
  , @MedicineTypeId bigint=NULL 
  , @MainContent nvarchar(1000)=NULL 
  , @Company nvarchar(500)=NULL 
  , @MorningMedTimeRefId bigint=NULL 
  , @NoonMedTimeRefId bigint=NULL 
  , @EveningMedTimeRefId bigint=NULL 
  , @NightMedTimeRefId bigint=NULL
  , @PrescriptionDays int=NULL 
  , @IsMedicineActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @MorningDose nvarchar(max) = null
  , @NoonDose nvarchar(max) = null
  , @EveningDose nvarchar(max) = null
  , @NightDose nvarchar(max) = null
  , @MedicineType nvarchar(max) = null

  , @Remark nvarchar(max) = null
  , @MedicinesType [dbo].[MedicineUDT] READONLY


 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)='', @v_meds varchar(100)
  
    IF @Command='INSERT' 
    BEGIN 
		
		INSERT INTO hospital.tblMedicine (  
                MedicineName, 
                MainContent, 
                Company, 
                PrescriptionDays, 
                IsMedicineActive, 
                MorningMedTimeRef,
                NoonMedTimeRef,
                EveningMedTimeRef,
                NightMedTimeRef, 
                MedicineType, 
                Remark,
                MedicineTypeId,
                MorningMedTimeRefId, 
                NoonMedTimeRefId, 
                EveningMedTimeRefId, 
                NightMedTimeRefId,
                CreatedBy,
                UpdatedBy,
                IsSyncFromServer,
                LastSync
            )
            SELECT 
                m.MedicineName, 
                m.MainContent, 
                m.Company, 
                m.PrescriptionDays, 
                m.IsMedicineActive, 
                m.MorningMedTimeRef,
                m.NoonMedTimeRef,
                m.EveningMedTimeRef,
                m.NightMedTimeRef, 
                m.MedicineType, 
                m.Remark,
                0, -- MedicineTypeId
                0, -- MorningMedTimeRefId
                0, -- NoonMedTimeRefId
                0, -- EveningMedTimeRefId
                0, -- NightMedTimeRefId
                1, -- CreatedBy
                1, -- UpdatedBy
                1, -- IsSyncFromServer
                GETDATE() -- LastSync
            FROM @MedicinesType m 
            WHERE
            IsMedicineActive = 1 AND
            NOT EXISTS (
                SELECT 1
                FROM hospital.tblMedicine t
                WHERE 
                    t.MedicineName = m.MedicineName
                    AND t.MainContent = m.MainContent
                    AND t.Company = m.Company
                    and t.EveningMedTimeRef = m.EveningMedTimeRef
                    and t.MorningMedTimeRef = m.MorningMedTimeRef
                    and t.NoonMedTimeRef = m.NoonMedTimeRef
                    and t.NightMedTimeRef = m.NightMedTimeRef
            );


		--select * into tbl_temp_DataAsync from @MedicinesType

		--select * from tbl_temp_DataAsync
		--select 0
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		select 0
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand='ALL'
		Begin			
			  SELECT MedicineId, MedicineName, MedicineTypeId, MainContent, Company, MorningMedTimeRefId, NoonMedTimeRefId, EveningMedTimeRefId, NightMedTimeRefId, PrescriptionDays
			  , IsMedicineActive, m.IsEdited, m.EntryDate, m.UpdatedDate, m.CreatedBy, m.UpdatedBy 

			  , MorningMedTimeRef,NoonMedTimeRef,EveningMedTimeRef,NightMedTimeRef , MedicineType

			  , Remark

			  FROM  hospital.tblMedicine m  with(nolock)
			  where m.IsMedicineActive = 1 
		End

		ELSE IF @SubCommand = 'LASTSYNCMEDICINE'
		BEGIN
			
			declare @LastSyncDate datetime = getdate() - 8, @IsSyncNedded int = 1;

			select @LastSyncDate = max(LastSync)  from hospital.tblMedicine where IsSyncFromServer = 1
				and lastsync is not null

			--IF not exists (select max(LastSync) from hospital.tblMedicine where IsSyncFromServer = 1
			--and lastsync is not null)

			IF (@LastSyncDate is null)
			BEGIN
				set @LastSyncDate = GETDATE() - 8
			END
			ELSE
			BEGIN
				select @LastSyncDate = max(LastSync)  from hospital.tblMedicine where IsSyncFromServer = 1
				and lastsync is not null
			END
			print DATEDIFF(DAY, @LastSyncDate,GETDATE())
			IF DATEDIFF(DAY, @LastSyncDate,GETDATE()) > 7
			BEGIN
				set @IsSyncNedded = 1
			END
			ELSE 
			BEGIN
				set @IsSyncNedded = 0
			END

			select CAST(@LastSyncDate as date) as LastSyncDate , @IsSyncNedded as IsSyncNeeded

		END

	END
		
     
    ELSE IF @Command='DELETE' 
    BEGIN 
     select 0
    END 

   SET NOCOUNT OFF; 

  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Bills]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Bills]  
   @Command varchar(200) 
  , @BillId bigint=NULL 
  , @BillNo nvarchar(100)=NULL 
  , @HospitalId int=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @AdmissionDate date=NULL 
  , @DischargeDate date=NULL 
  , @OTDate date=NULL 
  , @ChargeForRefId bigint=NULL 
  , @DiagnosisRefId bigint=NULL 
  , @ProcedureNameRefId bigint=NULL 
  , @DocVisits int=NULL 
  , @DocFeeRate money=NULL 
  , @DocCharges money=NULL 
  , @UsgNo int=NULL 
  , @UsgFeeRate money=NULL 
  , @UsgCharges money=NULL 
  , @RoomTypeRefId bigint=NULL 
  , @RoomRentDays int=NULL 
  , @RoomFeeRate money=NULL 
  , @RoomCharges money=NULL 
  , @NursingDays int=NULL 
  , @NursingFeeRate money=NULL 
  , @NursingCharges money=NULL 
  , @OTCharges money=NULL 
  , @MedicineCharges money=NULL 
  , @OtherChargeNameRefId bigint=NULL 
  , @OtherCharges money=NULL 
  , @TotalAmount money=NULL 
  , @PaymentTypeRefId bigint=NULL 
  , @IsBillActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='BillId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  
  -- Jeet Chauhan
  , @VisitId bigint = null
  , @AllOTCharges nvarchar(max) = null
  -- Jeet Chauhan
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblBill  
         (BillNo, HospitalId, PatientId, CaseId, AdmissionDate, DischargeDate, OTDate, ChargeForRefId, DiagnosisRefId, ProcedureNameRefId
		 , DocVisits, DocFeeRate, DocCharges, UsgNo, UsgFeeRate, UsgCharges, RoomTypeRefId, RoomRentDays, RoomFeeRate, RoomCharges, NursingDays, NursingFeeRate, NursingCharges
		 , OTCharges, MedicineCharges, OtherChargeNameRefId, OtherCharges, TotalAmount, PaymentTypeRefId
		 , IsBillActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  VisitId,  AllOTCharges) 
       VALUES (@BillNo, @HospitalId, @PatientId, @CaseId, @AdmissionDate, @DischargeDate, @OTDate, @ChargeForRefId, @DiagnosisRefId, @ProcedureNameRefId
	   , @DocVisits, @DocFeeRate, @DocCharges, @UsgNo, @UsgFeeRate, @UsgCharges, @RoomTypeRefId, @RoomRentDays, @RoomFeeRate, @RoomCharges, @NursingDays, @NursingFeeRate, @NursingCharges
	   , @OTCharges, @MedicineCharges, @OtherChargeNameRefId, @OtherCharges, @TotalAmount, @PaymentTypeRefId
	   , @IsBillActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @VisitId,  @AllOTCharges)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblBill SET BillNo=@BillNo 
        , HospitalId=@HospitalId 
        , PatientId=@PatientId 
        , CaseId=@CaseId 
        , AdmissionDate=@AdmissionDate 
        , DischargeDate=@DischargeDate 
        , OTDate=@OTDate 
        , ChargeForRefId=@ChargeForRefId 
        , DiagnosisRefId=@DiagnosisRefId 
        , ProcedureNameRefId=@ProcedureNameRefId 
        , DocVisits=@DocVisits 
        , DocFeeRate=@DocFeeRate 
        , DocCharges=@DocCharges 
        , UsgNo=@UsgNo 
        , UsgFeeRate=@UsgFeeRate 
        , UsgCharges=@UsgCharges 
        , RoomTypeRefId=@RoomTypeRefId 
        , RoomRentDays=@RoomRentDays 
        , RoomFeeRate=@RoomFeeRate 
        , RoomCharges=@RoomCharges 
        , NursingDays=@NursingDays 
        , NursingFeeRate=@NursingFeeRate 
        , NursingCharges=@NursingCharges 
        , OTCharges=@OTCharges 
        , MedicineCharges=@MedicineCharges 
        , OtherChargeNameRefId=@OtherChargeNameRefId 
        , OtherCharges=@OtherCharges 
        , TotalAmount=@TotalAmount 
        , PaymentTypeRefId=@PaymentTypeRefId 
        , IsBillActive=@IsBillActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, VisitId = @VisitId
		,AllOTCharges = @AllOTCharges

         WHERE BillId=@BillId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @BillId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @BillId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
				--SELECT BillId, BillNo, HospitalId, PatientId, CaseId, AdmissionDate, DischargeDate, OTDate, ChargeForRefId, DiagnosisRefId, ProcedureNameRefId
			 -- , DocVisits, DocFeeRate, DocCharges, UsgNo, UsgFeeRate, UsgCharges, RoomTypeRefId, RoomRentDays, RoomFeeRate, RoomCharges, NursingDays, NursingFeeRate, NursingCharges
			 -- , OTCharges, MedicineCharges, OtherChargeNameRefId, OtherCharges, TotalAmount, PaymentTypeRefId
			 -- , IsBillActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			 -- FROM  patient.tblBill WHERE BillId=@BillId 

			SELECT b.BillId, BillNo, p.HospitalId, p.PatientId, pc.CaseId, AdmissionDate, DischargeDate, OTDate
				, ChargeForRefId, cf.RecordName as ChargeFor
				, DiagnosisRefId, dia.DiagnosisName as Diagnosis
				, ProcedureNameRefId, pro.RecordName as ProcedureName
				, DocVisits, DocFeeRate, DocCharges
				, UsgNo, UsgFeeRate, UsgCharges
				, RoomTypeRefId, rt.RecordName as RoomType
				, RoomRentDays, RoomFeeRate, RoomCharges
				, NursingDays, NursingFeeRate, NursingCharges
				, OTCharges, MedicineCharges
				, OtherChargeNameRefId, oc.RecordName as OtherChargeName
				, OtherCharges
				, TotalAmount
				, PaymentTypeRefId, paytyp.RecordName as PaymentType
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo				
				, b.IsBillActive, b.IsEdited, b.EntryDate, b.UpdatedDate, b.CreatedBy, b.UpdatedBy	, b.AllOTCharges	
			  FROM  patient.tblBill b
			  INNER JOIN patient.tblPatients p with(nolock) on b.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and b.CaseId=pc.CaseId
				  LEFT JOIN common.tblEntityRecords cf with(nolock) on b.ChargeForRefId = cf.EntityRecordId
				  LEFT JOIN hospital.tblDiagnosis dia with(nolock) on b.DiagnosisRefId = dia.DiagnosisId
				  LEFT JOIN common.tblEntityRecords pro with(nolock) on b.ProcedureNameRefId = pro.EntityRecordId
				  LEFT JOIN common.tblEntityRecords rt with(nolock) on b.RoomTypeRefId = rt.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oc with(nolock) on b.OtherChargeNameRefId = oc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords paytyp with(nolock) on b.PaymentTypeRefId = paytyp.EntityRecordId
			  WHERE BillId=@BillId 
		End

		Else if @SubCommand='GetAllList' 
		Begin

				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' b.BillId > 0 '				
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			

			--If @HospitalId > 0  And @HospitalId > 1
			--	SET @WhereQry += ' And b.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			--If @PatientId > 0
			--	SET @WhereQry += ' And b.PatientId = ' + Convert(varchar(20), @PatientId)	
			--If @CaseId > 0
			--	SET @WhereQry += ' And b.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			set @WhereQry = ' 1=1'

			if @FromDate = 'undefined'
				set @FromDate = ''

			if @ToDate = 'undefined'
				set @ToDate = ''


			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(b.EntryDate as date) >= ''' + @FromDate + ''' AND cast(b.EntryDate as date) <= ''' + @ToDate + ''')' 	
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.BillId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct b.BillId, ' + @SortBy + ' as SortBy
						 FROM patient.tblBill  b with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, b.BillId, BillNo, p.HospitalId, p.PatientId, pc.CaseId, AdmissionDate, DischargeDate, OTDate
				, ChargeForRefId, cf.RecordName as ChargeFor
				, DiagnosisRefId, dia.DiagnosisName as Diagnosis
				, ProcedureNameRefId, pro.RecordName as ProcedureName
				, DocVisits, DocFeeRate, DocCharges
				, UsgNo, UsgFeeRate, UsgCharges
				, RoomTypeRefId, rt.RecordName as RoomType
				, RoomRentDays, RoomFeeRate, RoomCharges
				, NursingDays, NursingFeeRate, NursingCharges
				, OTCharges, MedicineCharges
				, OtherChargeNameRefId, oc.RecordName as OtherChargeName
				, OtherCharges
				, TotalAmount
				, PaymentTypeRefId, paytyp.RecordName as PaymentType
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo				
				, b.IsBillActive, b.IsEdited, b.EntryDate, b.UpdatedDate, b.CreatedBy, b.UpdatedBy							  
				  From CTE 
				  INNER JOIN patient.tblBill b with(nolock) ON CTE.BillId=b.BillId
				  INNER JOIN patient.tblPatients p with(nolock) on b.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and b.CaseId=pc.CaseId
				  LEFT JOIN common.tblEntityRecords cf with(nolock) on b.ChargeForRefId = cf.EntityRecordId
				  LEFT JOIN hospital.tblDiagnosis dia with(nolock) on b.DiagnosisRefId = dia.DiagnosisId
				  LEFT JOIN common.tblEntityRecords pro with(nolock) on b.ProcedureNameRefId = pro.EntityRecordId
				  LEFT JOIN common.tblEntityRecords rt with(nolock) on b.RoomTypeRefId = rt.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oc with(nolock) on b.OtherChargeNameRefId = oc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords paytyp with(nolock) on b.PaymentTypeRefId = paytyp.EntityRecordId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		Else if @SubCommand='GetMonthlyReportList' 
		Begin

				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' b.BillId > 0 '				
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			

			If @HospitalId > 0 And @HospitalId > 1
				SET @WhereQry += ' And b.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And b.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And b.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(b.EntryDate as date) >= ''' + @FromDate + ''' AND cast(b.EntryDate as date) <= ''' + @ToDate + ''')' 	
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.BillId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct b.BillId, ' + @SortBy + ' as SortBy
						 FROM patient.tblBill  b with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) 
				Select  
				EntryDate
				, SUM(DocCharges) as DocCharges
				, SUM(UsgCharges) as UsgCharges
				, SUM(NursingCharges) as NursingCharges
				, SUM(OTCharges) as OTCharges
				, SUM(MedicineCharges) as MedicineCharges
				, SUM(RoomCharges) as RoomCharges
				, SUM(OtherCharges) as OtherCharges
				, SUM(TotalAmount) as TotalAmount from (
						Select 
						cast(b.EntryDate as date) as EntryDate
						, DocCharges
						, UsgCharges
						, NursingCharges
						, OTCharges
						, MedicineCharges
						, RoomCharges
						, OtherCharges
						, TotalAmount												  
						  From CTE 
						  INNER JOIN patient.tblBill b with(nolock) ON CTE.BillId=b.BillId
				  ) X
				Group By (X.EntryDate) Order by X.EntryDate'
				  
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

   
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblBill WHERE BillId=@BillId 
	  
	  
	  --DELETE FROM patient.tblBill WHERE VisitId = @VisitId

	  IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblBill WHERE BillId = @BillId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblBill WHERE VisitId = @VisitId
	  END

    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @BillId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_BillVouchers]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_BillVouchers]  
   @Command varchar(200) 
  , @VoucherId bigint=NULL 
  , @HospitalId int=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VoucherNo nvarchar(50)=NULL 
  , @BillDate date=NULL 
  , @VoucherTypeRefId bigint=NULL 
  , @Amount money=NULL
  , @VoucherItemDetails nvarchar(max)=NULL
  , @IsVoucherActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='VoucherId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
   --Jeet Chauhan new parameter
   , @VisitId bigint = null 
   -- Jeet Chauhan New parameter
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblBillVoucher  
         (HospitalId, PatientId, CaseId, VoucherNo, BillDate, VoucherTypeRefId, Amount, VoucherItemDetails, IsVoucherActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, VisitId) 
       VALUES (@HospitalId, @PatientId, @CaseId, @VoucherNo, @BillDate, @VoucherTypeRefId, @Amount, @VoucherItemDetails, @IsVoucherActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @VisitId)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblBillVoucher 
	  SET HospitalId=@HospitalId 
        , PatientId=@PatientId 
        , CaseId=@CaseId 
        --, VoucherNo=@VoucherNo 
        , BillDate=@BillDate 
        , VoucherTypeRefId=@VoucherTypeRefId 
        , Amount=@Amount
		, VoucherItemDetails=@VoucherItemDetails
        , IsVoucherActive=@IsVoucherActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		VisitId = @VisitId

         WHERE VoucherId=@VoucherId    
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VoucherId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @VoucherId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT VoucherId, HospitalId, PatientId, CaseId, VoucherNo, BillDate, VoucherTypeRefId, Amount, VoucherItemDetails,
			--IsVoucherActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			--FROM  patient.tblBillVoucher 
			--WHERE VoucherId=@VoucherId
			

			SELECT VoucherId, HospitalId, PatientId, CaseId, VoucherNo, BillDate, VoucherTypeRefId , voucherType.GroupName as VoucherType
			, Amount, VoucherItemDetails,
			IsVoucherActive, v.IsEdited, v.EntryDate, v.UpdatedDate, v.CreatedBy, v.UpdatedBy 
			FROM  patient.tblBillVoucher v
			left join common.tblGroups  voucherType on voucherType.GroupId = v.VoucherTypeRefId
			WHERE VoucherId=@VoucherId


		End

		Else if @SubCommand='GetAllList' 
		Begin

			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' bv.CaseId = '	+ CONVERT(varchar(20),@CaseId)			
			
			SET @WhereQry = ' bv.VisitId = '	+ CONVERT(varchar(20),@VisitId)			

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.VoucherId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct bv.VoucherId, ' + @SortBy + ' as SortBy
						 FROM patient.tblBillVoucher  bv with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, bv.VoucherId, HospitalId, PatientId, CaseId, VoucherNo, BillDate, Amount, VoucherItemDetails
				, VoucherTypeRefId, vt.GroupName as VoucherType							
				, bv.IsVoucherActive, bv.IsEdited, bv.EntryDate, bv.UpdatedDate, bv.CreatedBy, bv.UpdatedBy	, VisitId							  
				  From CTE 
				  INNER JOIN patient.tblBillVoucher bv with(nolock) ON CTE.VoucherId=bv.VoucherId
				  INNER JOIN common.tblGroups vt with(nolock) on bv.VoucherTypeRefId = vt.GroupId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  --DELETE FROM patient.tblBillVoucher WHERE VoucherId=@VoucherId 
	  DELETE FROM patient.tblBillVoucher WHERE VisitId= @VisitId
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VoucherId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_City]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_City]  
   @Command varchar(200) 
  , @CityId bigint=NULL 
  , @CityName nvarchar(500)=NULL 
  , @Language nvarchar(100)=NULL 
  , @StateId bigint=NULL 
  , @IsActive bit=NULL 
  , @IsEdit bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdateDate datetime=NULL 
  , @CreateBy bigint=NULL 
  , @UpdateBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      
	  IF not exists (select top 1 1 from location.TblCity where CityName = @CityName and StateId = @StateId and Language=@Language)
	  BEGIN
		
			 INSERT INTO location.TblCity  
			(CityName, Language, StateId, IsActive, IsEdit, EntryDate, UpdateDate, CreateBy, UpdateBy) 
			VALUES (@CityName, @Language, @StateId, @IsActive, @IsEdit, @EntryDate, @UpdateDate, @CreateBy, @UpdateBy)   

			set @CityId = SCOPE_IDENTITY();

			If Not Exists (select top 1 1  from location.tblDistrict with (nolock) where City=@CityName and StateId=@StateId and Language=@Language)
			Begin
					
					 INSERT INTO location.tblDistrict  
					 (City, CityId,Language, District,StateId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, IsDistrict) 
				   VALUES (@CityName, @CityId,@Language, '' ,@StateId, @IsActive, @IsEdit, @EntryDate, @UpdateDate, @CreateBy, @UpdateBy , 0)  

			END
	  END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 


	IF Not Exists (select top 1 1 from location.TblCity where CityName = @CityName and Language = @Language and StateId = @StateId)
	BEGIN
		UPDATE location.TblCity 
		 SET  CityName=@CityName 
        , Language=@Language 
        , StateId=@StateId 
        , IsActive=@IsActive 
        , IsEdit=@IsEdit 
        , EntryDate=@EntryDate 
        , UpdateDate=@UpdateDate 
        , CreateBy=@CreateBy 
        , UpdateBy=@UpdateBy 
         WHERE CityId=@CityId     

		 IF Not Exists (select top 1 1 from location.tblDistrict where City = @CityName  and Language = @Language)
		 BEGIN
			
			update location.tblDistrict set City = @CityName where CityId = @CityId and Language = @Language and StateId = @StateId

		 END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @CityId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @CityId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
	END

      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		
		
		If @SubCommand = 'GetAllList'
		BEGIN
			SELECT CityId, CityName, Language, StateId, IsActive, IsEdit, EntryDate, UpdateDate, CreateBy, UpdateBy 
			FROM location.TblCity 
			
		END
		ELSe
		BEGIN
			SELECT CityId, CityName, c.Language,s.State, s.StateId, c.IsActive, IsEdit, c.EntryDate, c.UpdateDate, CreateBy, UpdateBy
			FROM location.TblCity c
			inner join location.tblState s on s.StateId = c.StateId
			WHERE CityId = @CityId
		END

      
			

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		DELETE FROM location.TblCity WHERE CityId=@CityId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @CityId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DataSync]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_DataSync]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL
 -- , @MedicineName nvarchar(100)=NULL
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @State nvarchar(200)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Language nvarchar(50) = NULL
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
	   --/// =================================

	   declare @V_languageCode nvarchar(10) = 'en'
	   declare @V_language nvarchar(100) = 'English'

	   if(@Language = 'English')
		
		BEGIN
			set @V_languageCode = 'en'
			set @V_language = 'English'
		END
		ELSE IF @Language = 'Hindi'
		BEGIN
			set @V_language = 'Hindi'
			set @V_languageCode = 'hi'
		END
		ELSE IF @Language = 'Gujarati'
		BEGIN
			set @V_language = 'Gujarati'
			set @V_languageCode = 'gu'
		END


	   --/// =================================


  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0
  
    IF @Command='INSERT' 
    BEGIN
		If @SubCommand='Sync FirstName'
		Begin
			
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 0, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End

		Else If @SubCommand='Add FirstName'
		Begin
			
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End

		Else If @SubCommand='Sync LastName'
		Begin

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 0, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

		End

		Else If @SubCommand='Add LastName'
		Begin

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

		End


		If @SubCommand='Sync MedicineName'
		Begin
			
			If Not Exists(Select top 1 MedicineName from sync.tblMedicineNames where LOWER(MedicineName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblMedicineNames (MedicineName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 0, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End

		Else If @SubCommand='Add MedicineName'
		Begin
			
			If Not Exists(Select top 1 MedicineName from sync.tblMedicineNames where LOWER(MedicineName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblMedicineNames (MedicineName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
			End   
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error',  @v_CustomMessage = 'Value already exists'	
			End      
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
    END 

	ELSE IF @Command='UPDATE' 
    BEGIN
		If @SubCommand='FirstName'
		Begin
			UPDATE sync.tblFirstNames SET IsSyncPending=0 WHERE LOWER(FirstName)=LOWER(@FirstName) AND IsSyncPending=1

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

		End
		Else If @SubCommand='LastName'
		Begin
			UPDATE sync.tblLastNames SET IsSyncPending=0 WHERE LOWER(LastName)=LOWER(@LastName) AND IsSyncPending=1

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
		Else If @SubCommand='MedicineName'
		Begin
			UPDATE sync.tblMedicineNames SET IsSyncPending=0 WHERE LOWER(MedicineName)=LOWER(@FirstName) AND IsSyncPending=1

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
		Else If @SubCommand='State'
		Begin
			UPDATE location.tblState SET IsEdited=0 WHERE State=@State AND Language=@Language AND IsEdited=1

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
		Else If @SubCommand='District'
		Begin
			UPDATE d SET IsEdited=0 
			FROM location.tblDistrict d
			inner join location.tblState s ON d.StateId=s.StateId And s.State=@State			
			And d.Language=@Language AND d.IsEdited=1

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
		Else If @SubCommand='Taluka'
		Begin
			UPDATE t SET t.IsEdited=0 
			FROM location.tblTaluka t
			inner join location.tblDistrict d on t.DistrictId=d.DistrictId and d.District=@District
			And t.Language=@Language AND t.IsEdited=1
			inner join location.tblState s on d.StateId=s.StateId And s.State=@State
			
			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
		Else If @SubCommand='VillageCity'
		Begin
			UPDATE vc SET vc.IsEdited=0 
			FROM location.tblVillageCity vc
			inner join location.tblTaluka t on vc.TalukaId=t.TalukaId And t.Taluka=@Taluka
			And vc.Language=@Language AND vc.IsEdited=1
			inner join location.tblDistrict d on t.DistrictId=d.DistrictId and d.District=@District	
			inner join location.tblState s on d.StateId=s.StateId And s.State=@State
			
			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End

			SELECT @outIsSuccess=@v_IsSuccess, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
		End
	END

	ELSE IF @Command='SELECT' 
    BEGIN
		-- -- // To Select for Sync
		If @SubCommand='FirstName'
		Begin
			SELECT fn.FirstName FROM sync.tblFirstNames fn WHERE IsSyncPending=1
			--SELECT PatientName as FirstName FROM patient.tbl_PatientName fn --WHERE IsSyncPending=1
		End
		Else If @SubCommand='LastName'
		Begin
			SELECT ln.LastName FROM sync.tblLastNames ln WHERE IsSyncPending=1
		End
		Else If @SubCommand='MedicineName'
		Begin
			SELECT mn.MedicineName FROM sync.tblMedicineNames mn WHERE IsSyncPending=1
		End
		Else If @SubCommand='Location'
		Begin
			--SELECT s.State, s.Language FROM sync.tblStates s WHERE IsSyncPending=1 Order By s.State
			--SELECT s.State, s.Language FROM location.tblState s WHERE s.IsEdited=1 and s.IsActive=1 Order By s.State

			Select * from (
			SELECT 1 as RankNo, VillageCityId, VillageCity, vc.Language
			, t.TalukaId, t.Taluka
			, d.DistrictId, d.District
			, s.StateId, s.State			
			FROM location.tblVillageCity vc with(nolock)
			INNER JOIN location.tblTaluka t with(nolock) on vc.TalukaId=t.TalukaId
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE vc.IsActive=1 and vc.IsEdited=1

			UNION

			 SELECT 2 as RankNo, 0 as VillageCityId, '' as VillageCity, t.Language
			, t.TalukaId, t.Taluka
			, d.DistrictId, d.District
			, s.StateId, s.State			
			FROM location.tblTaluka t with(nolock) 
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE t.IsActive=1 and t.IsEdited=1

			UNION

			 SELECT 3 as RankNo, 0 as VillageCityId, '' as VillageCity, d.Language
			, 0 as TalukaId, '' as Taluka
			, d.DistrictId, d.District
			, s.StateId, s.State			
			FROM location.tblDistrict d with(nolock)
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE d.IsActive=1 and d.IsEdited=1

			UNION

		    SELECT 4 as RankNo, 0 as VillageCityId, '' as VillageCity, s.Language
			, 0 as TalukaId, '' as Taluka
			, 0 as districtId, '' as District
			, s.StateId, s.State			
			FROM location.tblState s with(nolock) 
			WHERE s.IsActive=1 and s.IsEdited=1
			) Location
			Order By RankNo desc

		End

		-- -- // To Select all records for Auto suggest

		Else If @SubCommand='FirstNameList'
		Begin
			--SELECT fn.FirstName FROM sync.tblFirstNames fn Order By fn.FirstName
			declare @countOfFisrtName bigint = 0
			select @countOfFisrtName=COUNT(distinct FirstName) from patient.tblPatients with (nolock)

			--If (@countOfFisrtName > 10)
			--BEGIN
			--	SELECT PatientName as FirstName FROM patient.tbl_PatientName fn Order By fn.PatientName
			--END
			--ELSE
			--BEGIN
			--	select distinct FirstName from patient.tblPatients WITH(NOLOCK)
			--END

			SELECT PatientName as FirstName FROM patient.tbl_PatientName fn where langauge in (@V_languageCode, @V_language) and isnull(fn.PatientName,'') <> '' Order By fn.PatientName 

		End

		Else If @SubCommand='LandmarkList'
		Begin
			--SELECT fn.FirstName FROM sync.tblFirstNames fn Order By fn.FirstName
			declare @countOfLandMark bigint = 0
			select @countOfLandMark=COUNT(distinct Landmark) from patient.tblPatients

			--If (@countOfLandMark > 10)
			--BEGIN
			--	SELECT Landmark as LandMark FROM patient.tbl_Landmark fn Order By fn.Landmark
			--END
			--ELSE
			--BEGIN
			--		select distinct Landmark from patient.tblPatients WITH(NOLOCK)
			--END

			SELECT Landmark as LandMark FROM patient.tbl_Landmark fn where langauge in (@V_languageCode, @V_language) Order By fn.Landmark


		End

		Else If @SubCommand='HusbandNameList'
		Begin
			--SELECT fn.FirstName FROM sync.tblFirstNames fn Order By fn.FirstName
			declare @countOfHusbandName bigint = 0
			select @countOfHusbandName=COUNT(distinct PrimaryRelativeName) from patient.tblPatients

			--If (@countOfHusbandName > 10)
			--BEGIN
			--	SELECT HusbandName as HusbandName FROM patient.tbl_husbandName fn Order By fn.HusbandName
			--END
			--ELSE
			--BEGIN
			--		select distinct PrimaryRelativeName as HusbandName from patient.tblPatients WITH(NOLOCK)
			--END

			SELECT HusbandName as HusbandName FROM patient.tbl_husbandName fn where langauge in (@V_languageCode, @V_language) Order By fn.HusbandName

		End

		Else If @SubCommand='LastNameList'
		Begin
			
			--SELECT ln.LastName FROM sync.tblLastNames ln Order By ln.LastName

			declare @countOfLastName bigint = 0
			select @countOfLastName=COUNT(distinct LastName) from patient.tblPatients with(nolock)

			--If (@countOfLastName > 10)
			--BEGIN
			--	SELECT LastName  as LastName FROM patient.tbl_LastName fn with(nolock) Order By fn.LastName
			--END
			--ELSE
			--BEGIN
			--		select distinct LastName from patient.tblPatients WITH(NOLOCK)
			--END

			SELECT LastName  as LastName FROM patient.tbl_LastName fn with(nolock) where langauge in (@V_languageCode, @V_language) Order By fn.LastName


		End
		Else If @SubCommand='MedicineNameList'
		Begin
			SELECT mn.MedicineName FROM sync.tblMedicineNames mn Order By mn.MedicineName
		End

	END

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- ============
------------------------------------================================== Updated............................
 CREATE PROCEDURE [dbo].[Usp_Manage_DeliveryRecords]
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @DeliveryId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @AltLangEntry bit=NULL 
  , @LanguageCode nvarchar(50)=NULL 
  , @SrNo int=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @DeliveryNo nvarchar(20)=NULL 
  , @DeliveryNoRefId bigint=NULL
  , @BabyNo nvarchar(20)=NULL 
  , @BabyNoRefId bigint=NULL 
  , @BirthDate date=NULL 
 -- , @BirthTime time=NULL

  , @BirthTime nvarchar(50) = NULL

  , @ChildName nvarchar(50)=NULL
  , @ChildGender nvarchar(20)=NULL 
  , @ChildGenderRefId bigint=NULL 
  , @ChildWeight decimal(5,2)=NULL 
  , @BabyStatus nvarchar(20)=NULL 
  , @BabyStatusRefId bigint=NULL 
  , @MotherFirstName nvarchar(50)=NULL 
  , @MotherFNameSuffix nvarchar(20)=NULL 
  , @MotherLastName nvarchar(50)=NULL 
  , @PrimaryContactName nvarchar(50)=NULL 
  , @PrimaryContactNameSuffix nvarchar(20)=NULL 
  , @SecondaryContactName nvarchar(50)=NULL 
  , @SecondaryContactNameSuffix nvarchar(20)=NULL
  , @PatientMobile nvarchar(50)=NULL
  , @DeliveryType nvarchar(20)=NULL 
  , @DeliveryTypeId bigint=NULL 
  , @Religion nvarchar(20)=NULL 
  , @ReligionId bigint=NULL
  , @Nationality nvarchar(50)=NULL
  , @EpisioBy nvarchar(50)=NULL 
  , @EpisioById bigint=NULL 
  , @Dayan nvarchar(50)=NULL 
  , @DayanRefId bigint=NULL 
  , @LocationRefId int=NULL 
  , @Landmark nvarchar(200)=NULL 
  , @Area nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @MarriageAge int=NULL 
  , @MothersCurrentAge int=NULL 
  , @PregWeeks int=NULL 
  , @LiveMaleFemale nvarchar(20)=NULL 
  , @FathersEducation nvarchar(50)=NULL 
  , @MothersEducation nvarchar(50)=NULL 
  , @FathersOccupation nvarchar(50)=NULL 
  , @MothersOccupation nvarchar(50)=NULL 
  , @IsDelActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Language nvarchar(200) = NULL
   
  ,@IsMisMatchSrNos bit = null

  , @HouseNo nvarchar(1000) = null
  , @Society nvarchar(1000) = null

  --- Jeet Chauhan New Fields
  ,@OE nvarchar(800) = null
  ,@SE nvarchar(800) = null
  ,@RS nvarchar(800) = null
  ,@Complain  nvarchar(800) = null
  ,@Diagnosis nvarchar(800) = null
  ,@AdmissionDate  date = null
  ,@AdmissionTime  time = null
  ,@DischargeDate date = null
  ,@DischargeTime time = null
  ,@Pulse nvarchar(800) = null
  ,@ObstetricHistory nvarchar(800) = null
  ,@PastHistory nvarchar(800) = null
  ,@HB nvarchar(800) = null
  ,@BG nvarchar(800) = null
  ,@PerAbdomen nvarchar(800) = null
  ,@PerVaginum nvarchar(800) = null
  ,@AdharNumber nvarchar(800) = null
  ,@EmailId nvarchar(800) = null
  , @GroupId bigint = 0
  , @PrescriptionGrid nvarchar(800) = null
  , @SaveGroup int = 0
  , @GroupName nvarchar(800) = null
  , @City nvarchar(500) = null
  --- Jeet Chauhan New Fields

 AS 
  BEGIN 
       
	SET NOCOUNT ON;    

  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNo int, @v_SrNoAccMonth int, @v_SrNoAccYear int, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 


	--- If Saving in Group is checked

	IF @SaveGroup = 1
	BEGIN
		
		IF not exists (select top 1 1 from patient.tbl_DischargeCardGroup where trim(GroupName) = @GroupName)
		BEGIN
			
			insert into patient.tbl_DischargeCardGroup (GroupName,Cstatus,CreatedBy	,PrescriptionGrid)
			values (@GroupName , 1 , @UpdatedBy , @PrescriptionGrid)

		END
		ELSE
		BEGIN
			
			update patient.tbl_DischargeCardGroup
			set PrescriptionGrid = @PrescriptionGrid
			where GroupName = @GroupName

		END

	END

	--- If Saving in Group is checked


			If(isnull(@AltLangEntry, 0) = 0)
			Begin
				select @v_SrNoAccMonth = max(SrNo) from patient.tblDeliveryRecords where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
				select @v_SrNoAccYear = max(SrNo) from patient.tblDeliveryRecords where year(entrydate)=year(GETDATE())
				select @v_SrNo = max(SrNo) from patient.tblDeliveryRecords

				Select @SrNo = ISNULL(@v_SrNo,0)+1, @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1
			End
			

      INSERT INTO patient.tblDeliveryRecords  
         (PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
		 , ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
		 , MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
		 , DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
		 , LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
		 , MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
		 , IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, IsMisMatchSrNos, HouseNo, Society
		 
		  , OE, 
			SE, 
			RS, 
			Complain, 
			Diagnosis, 
			AdmissionDate, 
			AdmissionTime, 
			DischargeDate, 
			DischargeTime, 
			Pulse, 
			ObstetricHistory, 
			PastHistory, 
			HB, 
			BG, 
			PerAbdomen, 
			PerVaginum,
			AdharNumber,
			EmailId,
			PrescriptionGrid,
			City

		 ) 



       VALUES (@PatientId, @CaseId, @VisitId, @LanguageCode, @SrNo, @SrNoAccMonth, @SrNoAccYear, @DeliveryNo, @DeliveryNoRefId, @BabyNo, @BabyNoRefId, @BirthDate, cast(@BirthTime as time), @ChildName
	   , @ChildGender, @ChildGenderRefId, @ChildWeight, @BabyStatus
	   , @BabyStatusRefId, @MotherFirstName, @MotherFNameSuffix, @MotherLastName, @PrimaryContactName, @PrimaryContactNameSuffix, @SecondaryContactName, @SecondaryContactNameSuffix, @PatientMobile
	   , @DeliveryType, @DeliveryTypeId, @Religion, @ReligionId, @Nationality, @EpisioBy, @EpisioById, @Dayan, @DayanRefId
	   , @LocationRefId, @Landmark, @Area, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @MarriageAge, @MothersCurrentAge, @PregWeeks, @LiveMaleFemale, @FathersEducation, @MothersEducation, @FathersOccupation, @MothersOccupation
	   , @IsDelActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @IsMisMatchSrNos, @HouseNo , 
	   @Society
	   
	   ,@OE, 
		@SE, 
		@RS, 
		@Complain, 
		@Diagnosis, 
		@AdmissionDate, 
		@AdmissionTime, 
		@DischargeDate, 
		@DischargeTime, 
		@Pulse, 
		@ObstetricHistory, 
		@PastHistory, 
		@HB, 
		@BG, 
		@PerAbdomen, 
		@PerVaginum,
		@AdharNumber,
		@EmailId,
		@PrescriptionGrid,
	    @City
	   )   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					-- Jeet Chauhan New Taluka add logic

				declare @VV_StateId bigint = 0 , @VV_talukaId bigint = 0 , @VV_DistrictId bigint = 0;

				select top 1 @VV_StateId = StateId from location.tblState where State = @State and Language = @Language and isnull(State , '') <> ''
				select top 1 @VV_DistrictId = StateId from location.tblDistrict where District = @District and Language = @Language  and isnull(District , '') <> ''
				select top 1 @VV_talukaId = TalukaId from location.tblTaluka where Taluka = @Taluka and Language = @Language and isnull(Taluka , '') <> ''

				If Not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language)
				Begin
					INSERT INTO location.tblState  
					 (State, Language, IsActive, IsEdited, EntryDate, CreatedBy) 
						VALUES (@State, @Language, 1, 1, GETDATE(), 1) 

						Set @VV_StateId = SCOPE_IDENTITY()
				END

				If Not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@VV_StateId and Language=@Language)
			    Begin
					 INSERT INTO location.tblDistrict  
					(District, Language, StateId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@District, @Language, @VV_StateId, 1, 1, GETDATE(), 1)

						Set @VV_DistrictId = SCOPE_IDENTITY()
				END



				If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@VV_DistrictId and Language=@Language)
				Begin
					INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@Taluka, @Language, @VV_DistrictId, 1, 1, GETDATE(), 1)  
				END


				-- Jeet Chauhan New Taluka add logic
				

				declare @C_CityId bigint = 0, @C_AreaId bigint = 0 , @C_SocietyId bigint = 0;

				if not Exists (select top 1 CityId from location.TblCity with(nolock) where trim(lower(CityName)) = TRIM(LOWER(@City)))
				begin
					insert into location.TblCity(CityName , Language, IsActive ,IsEdit , StateId , EntryDate)
					values (@City , @Language , 1 , 0 , @VV_StateId , GETDATE())
				
					set @C_CityId = SCOPE_IDENTITY();
				end
				else
				BEGIN
					set @C_CityId = (select top 1 CityId from location.TblCity with(nolock) where trim(lower(CityName)) = TRIM(LOWER(@City)))
				END


				if not Exists (select top 1 Area from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
				begin
					insert into location.tblArea(Area, Language, IsActive ,IsEdited , EntryDate , CityId)
					values (@Area,@Language , 1 , 0 , GETDATE() , @C_CityId)
				
					set @C_AreaId = SCOPE_IDENTITY();

				end
				BEGIN
					set @C_AreaId = (select top 1 AreaId from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
				END


				if not Exists (select top 1 Society from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
				begin
					insert into location.tblSociety(Society, Language , IsActive , IsEdited , EntryDate , AreaId)
					values (@Society,@Language , 1 , 0 , GETDATE() , @C_AreaId)
				
					set @C_SocietyId = SCOPE_IDENTITY();

				end
				BEGIN
					set @C_SocietyId = (select top 1 SocietyId from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
				END


					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					IF @VV_talukaId <> 0 
					BEGIN
						
						INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
							, Area , Society , AreaId , SocietyId , IsVillageCity) 
					   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
								@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , 
								@C_AreaId ,@C_SocietyId , 1)   

					END
					ELSE
					BEGIN
						
						INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
						, Area , Society , AreaId , SocietyId , City, IsVillageCity) 
					   VALUES ('', isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
								@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , @C_AreaId ,
								@C_SocietyId ,@City , 0)   

					END

					--INSERT INTO location.tblVillageCity  
					-- (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				 --  VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End


			--/// add into seprate table for dropdown

			IF NOT EXISTS(select top 1 pid from patient.tbl_PatientName where trim(PatientName) = trim( @MotherFirstName))
			BEGIN
				insert into patient.tbl_PatientName (PatientName, langauge , Language)
				values (trim(@MotherFirstName ), trim(@LanguageCode) , TRIM(@Language))
			END

			IF NOT EXISTS(select top 1 hid from patient.tbl_husbandName where trim(HusbandName) = trim(@PrimaryContactName))
			BEGIN
				insert into patient.tbl_husbandName (HusbandName, langauge , Language)
				values (trim(@PrimaryContactName ), trim(@LanguageCode) , TRIM(@Language))
			END

			IF NOT EXISTS(select top 1 id from patient.tbl_LastName where trim(LastName) = trim( @MotherLastName))
			BEGIN
				insert into patient.tbl_LastName (LastName, langauge , Language)
				values (trim(@MotherLastName) , trim(@LanguageCode) , TRIM(@Language))
			END

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge )
				values (trim(@Landmark),trim(@Language) )
			end

			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark)
				values (trim(@VillageCity),trim(@State),trim(@Taluka), trim(@District), trim(@Language),trim(@PinCode),trim(@Landmark))
			end

			--/// add into seprate table for dropdown


		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
	--- Insert in GridMEd Table ----

	ELSE IF @Command = 'Insert GridMedicies'
	BEGIN
		
		DECLARE @json nvarchar(max) = '' ;
		set @json = @PrescriptionGrid;

			SELECT
				[order],
				med,
				dose,
				remark,
				[check]
				into #tbl_prescribGrid
			FROM OPENJSON(@json)
			WITH (
				[order]  nvarchar(10) '$.order',
				med      nvarchar(100) '$.med',
				dose     nvarchar(50)  '$.dose',
				remark   nvarchar(200) '$.remark',
				[check]  int           '$.check'
			);

			DECLARE @med nvarchar(100);

			DECLARE med_cursor CURSOR FOR
			SELECT med FROM #tbl_prescribGrid where [check] = 1;

			OPEN med_cursor;
			FETCH NEXT FROM med_cursor INTO @med;

			WHILE @@FETCH_STATUS = 0
			BEGIN
				IF NOT EXISTS (
					SELECT 1
					FROM patient.tbl_DischargeCardMedicines
					WHERE LTRIM(RTRIM(MedicineName)) = LTRIM(RTRIM(@med))
				)
				BEGIN
					INSERT INTO patient.tbl_DischargeCardMedicines (MedicineName, Cstatus)
					VALUES (@med , 1);
				END
				ELSE
				BEGIN
					-- Example update; adjust columns as needed
					UPDATE patient.tbl_DischargeCardMedicines
					SET MedicineName = @med
					WHERE LTRIM(RTRIM(MedicineName)) = LTRIM(RTRIM(@med));
				END

				FETCH NEXT FROM med_cursor INTO @med;
			END

			CLOSE med_cursor;
			DEALLOCATE med_cursor;


	END

	--- Insert in GridMEd Table ----

    ELSE IF @Command='UPDATE' 
    BEGIN 


	--- If Saving in Group is checked

	IF @SaveGroup = 1
	BEGIN
		IF not exists (select top 1 1 from patient.tbl_DischargeCardGroup where trim(GroupName) = @GroupName)
		BEGIN
			insert into patient.tbl_DischargeCardGroup (GroupName,Cstatus,CreatedBy	,PrescriptionGrid)
			values (@GroupName , 1 , @UpdatedBy , @PrescriptionGrid)
		END
		ELSE
		BEGIN
			update patient.tbl_DischargeCardGroup
			set PrescriptionGrid = @PrescriptionGrid
			where GroupName = @GroupName
		END
	END

	--- If Saving in Group is checked


      UPDATE patient.tblDeliveryRecords 
	 -- SET PatientId=@PatientId 
       -- , CaseId=@CaseId 
       -- , VisitId=@VisitId 
        SET SrNo=@SrNo 
        , SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
        ,  DeliveryNo=@DeliveryNo
		, DeliveryNoRefId=@DeliveryNoRefId
        , BabyNo=@BabyNo 
        , BabyNoRefId=@BabyNoRefId 
        , BirthDate=@BirthDate 
        , BirthTime=cast(@BirthTime as time)
		, ChildName=@ChildName
        , ChildGender=@ChildGender 
        , ChildGenderRefId=@ChildGenderRefId 
        , ChildWeight=@ChildWeight 
        , BabyStatus=@BabyStatus 
        , BabyStatusRefId=@BabyStatusRefId 
        , MotherFirstName=@MotherFirstName 
        , MotherFNameSuffix=@MotherFNameSuffix 
        , MotherLastName=@MotherLastName 
        , PrimaryContactName=@PrimaryContactName 
        , PrimaryContactNameSuffix=@PrimaryContactNameSuffix 
        , SecondaryContactName=@SecondaryContactName 
        , SecondaryContactNameSuffix=@SecondaryContactNameSuffix
		, PatientMobile=@PatientMobile
        , DeliveryType=@DeliveryType 
        , DeliveryTypeId=@DeliveryTypeId 
        , Religion=@Religion 
        , ReligionId=@ReligionId
		, Nationality=@Nationality
        , EpisioBy=@EpisioBy 
        , EpisioById=@EpisioById 
        , Dayan=@Dayan 
        , DayanRefId=@DayanRefId 
        , LocationRefId=@LocationRefId 
        , Landmark=@Landmark 
        , Area=@Area 
        , VillageCity=@VillageCity 
		, City = @City
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , MarriageAge=@MarriageAge 
        , MothersCurrentAge=@MothersCurrentAge 
        , PregWeeks=@PregWeeks 
        , LiveMaleFemale=@LiveMaleFemale 
        , FathersEducation=@FathersEducation 
        , MothersEducation=@MothersEducation 
        , FathersOccupation=@FathersOccupation 
        , MothersOccupation=@MothersOccupation 
        , IsDelActive=@IsDelActive 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,IsMisMatchSrNos = @IsMisMatchSrNos
		,HouseNo  = @HouseNo
		, Society = @Society

		,    OE = @OE,
    SE = @SE,
    RS = @RS,
    Complain = @Complain,
    Diagnosis = @Diagnosis,
    AdmissionDate = @AdmissionDate,
    AdmissionTime = @AdmissionTime,
    DischargeDate = @DischargeDate,
    DischargeTime = @DischargeTime,
    Pulse = @Pulse,
    ObstetricHistory = @ObstetricHistory,
    PastHistory = @PastHistory,
    HB = @HB,
    BG = @BG,
    PerAbdomen = @PerAbdomen,
    PerVaginum = @PerVaginum,
    AdharNumber = @AdharNumber,
    EmailId = @EmailId,
	PrescriptionGrid = @PrescriptionGrid

         WHERE DeliveryId=@DeliveryId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'


			--SET @v_TalukaId= (select top 1 TalukaId from  
			--		location.tblTaluka t with (nolock) 
			--		inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
			--		inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
			--		where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
			--		)

			--		IF @VV_talukaId <> 0 
			--		BEGIN
						
			--			INSERT INTO location.tblVillageCity  
			--		 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
			--				, Area , Society , AreaId , SocietyId , IsVillageCity) 
			--		   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
			--					@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , 
			--					@C_AreaId ,@C_SocietyId , 1)   

			--		END
			--		ELSE
			--		BEGIN
						
			--			INSERT INTO location.tblVillageCity  
			--		 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
			--			, Area , Society , AreaId , SocietyId , City, IsVillageCity) 
			--		   VALUES ('', isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
			--					@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , @C_AreaId ,
			--					@C_SocietyId ,@City , 0)   

			--		END


			-- -- // Check to add new location record

				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
				Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
				End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @DeliveryId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			--- new Logic ----------

			
			

				SELECT dr.DeliveryId, p.PatientId, dr.CaseId, dr.VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society
				, dr.City
				
				-- // ========================== new Columns for Print Discharge Card==============
				, Complain as Complain
				,dr.Pulse as Pulse,
				OE as OE,
				SE as SE,
				RS as RS,
				ObstetricHistory as ObstetricHistory, -- patient Visit , Should added
				
				dr.PastHistory as PastHistory, -- patient Visit
				--pv.PastHistory as PASTHISTORY, -- patient Visit
				dr.PerAbdomen as PerAbdomen, -- patient Visit

				dr.PerVaginum as PerVaginum, -- patient Visit

				--PerAbdomen as PA, -- patient Visit
				dr.Diagnosis as DIAGNOSIS,  -- patient Visit
				--Diagnosis as DIAGNOSIS,  -- patient Visit

				AdmissionDate as AdmissionDate,
				AdmissionTime as AdmissionTime,
				DischargeDate as DischargeDate,
				DischargeTime as DischargeTime,

				AdharNumber as AdharNumber,
				EmailId as EmailId,

				--dr.DeliveryType as MODE_OF_DELI,
				
				weight as weight,
				Hb as HB, -- Investigation
				BG as BG, -- Investigation
				inv.HIV as HIV, -- Investigation
				inv.HepatitisBsurfaceAntigen as HBsAG, -- Investigation
				PrescriptionGrid as PrescriptionGrid
				-- // ========================== new Columns for Print Discharge Card==============

			 FROM patient.tblDeliveryRecords dr 
				  --INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  --INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  --INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  --INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  --INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  --INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  --INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  --INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  --INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId


				  LEFT JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  LEFT JOIN patient.tblPatientVisits pv with(nolock) 
													 On pv.PatientId = p.PatientId and pv.VisitId = dr.VisitId
				  LEFT JOIN patient.tblInvestigation inv with(nolock) on inv.PatientId = pv.PatientId and inv.VisitId = pv.VisitId
				  LEFT JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  LEFT JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  LEFT JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  LEFT JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId

				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE DeliveryId=@DeliveryId 
				
			

			--- new Logic ----------

			
		End

		IF @SubCommand = 'PreviousBaByNo'
			BEGIN

				declare @MaxBabyNo bigint = 0;
				select top 1 @MaxBabyNo =  cast(replace(replace(replace(replace(BabyNo , 'st baby' , ''),'rd baby' , ''),'nd baby' , '') , 'th baby' , '') as bigint) from patient.tblDeliveryRecords where PatientId = @PatientId order by EntryDate desc


				declare @totalAvailableNo bigint = (select COUNT(1) from common.tblEntityRecords where EntityId = 51 and IsActive = 1)

				select case when (@MaxBabyNo + 1) > @totalAvailableNo then @MaxBabyNo else @MaxBabyNo + 1 end as BaByNo

				
				
			END


		If @SubCommand = 'SelectSingle1111'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT top 1 dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, dr.City
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society
				,PrescriptionGrid

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE dr.PatientId=@PatientId
			 order by EntryDate desc
		End



			-- //   // Jeet Chauhan for taking month and year number
		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0
			declare @SrNoOut1 bigint = 0, @SrNoOut2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblDeliveryRecords where month(BirthDate ) = month(GETDATE()) and LanguageCode = @LanguageCode
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblDeliveryRecords where year(BirthDate ) = year(GETDATE()) and LanguageCode = @LanguageCode

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblDeliveryRecords where YEAR(BirthDate) = month(GETDATE()) and month(BirthDate ) = month(GETDATE()) --and LanguageCode = @LanguageCode
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblDeliveryRecords where  year(BirthDate ) = year(GETDATE()) and LanguageCode = @LanguageCode

			--select * from patient.tblDeliveryRecords
			
			select @SrNoOut1 = COUNT(SrNo) from patient.tblDeliveryRecords  where LanguageCode = @LanguageCode
			select @SrNoOut2 = MAX(SrNo) from patient.tblDeliveryRecords  where LanguageCode = @LanguageCode

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
			(isnull(@SrNoOut1, 0) + 1) as SrNo,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as srnoAccYear2,
					  (isnull(@SrNoOut2,0) + 1) as SrNo2
		End
		-- //   // Jeet Chauhan for taking month and year number

		 if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			IF @FromDate = 'undefined'
			BEGIN
				Set @FromDate = null
			END


			IF @ToDate = 'undefined'
			BEGIN
				Set @ToDate = null
			END

			SET @WhereQry = ' p.PatientId > 0'
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And dr.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And dr.CaseId = ' + Convert(varchar(20), @CaseId)
			If ISNULL(@LanguageCode,'')!=''
				SET @WhereQry += ' And dr.LanguageCode = ''' + @LanguageCode + ''''
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (dr.BirthDate >= ''' + @FromDate + ''' AND dr.BirthDate
				<= ''' + @ToDate + ''')' 	

			If ISNULL(@BirthDate,'') != ''
				SET @WhereQry += ' And Cast(dr.BirthDate as Date) = Cast(''' +  Convert(varchar(20), @BirthDate) + ''' as Date)' 	

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(dr.MotherFirstName like ''%' + @SearchKey + '%'' 
						Or dr.MotherLastName like ''%' + @SearchKey + '%'' 
						Or dr.ChildName like ''%' + @SearchKey + '%'' 
						Or dr.PatientMobile like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or dr.VillageCity like ''%' + @SearchKey + '%'' 
						Or dr.Taluka like ''%' + @SearchKey + '%'' 
						Or dr.District like ''%' + @SearchKey + '%'' 
						Or dr.State like ''%' + @SearchKey + '%'' 
						Or dr.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.DeliveryId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct dr.DeliveryId, ' + @SortBy + ' as SortBy
						 FROM patient.tblDeliveryRecords dr with(nolock) 		
						 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, dr.DeliveryId, p.PatientId, dr.CaseId, dr.VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId
				, BirthDate, BirthTime, isnull(ChildName,'''') as ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName, isnull(PrimaryContactName,'''') as PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, isnull(EpisioBy ,'''') as EpisioBy
				, DayanRefId, isnull(Dayan,'''') as Dayan
				, dr.LocationRefId, isnull(dr.Landmark ,'''') as Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, dr.City
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy

				, IsMisMatchSrNos
				, dr.HouseNo, dr.Society
				, PrescriptionGrid

				  From CTE 
				 
				  INNER JOIN patient.tblDeliveryRecords dr with(nolock) ON CTE.DeliveryId=dr.DeliveryId
				  INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  LEFT JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  LEFT JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  LEFT JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  LEFT JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId


				  ' + @v_PagingQry + 
				  ' Order by DeliveryId	 desc'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		END


		---- JEet Chauhan New Logic for grid binding

		 IF @SubCommand = 'Select DischargeMed'
		BEGIN
			select MedicineName from patient.tbl_DischargeCardMedicines where Cstatus = 1
		END

		 IF @SubCommand = 'Select DichargeGroups'
		BEGIN
			select Groupid,GroupName from patient.tbl_DischargeCardGroup where cstatus =1
		END

		IF @SubCommand = 'Select GroupMed'
		BEGIN
			
			declare @V_groupIds nvarchar(50);
			select @V_groupIds = DischargeMedicineIds from patient.tbl_DischargeCardGroup where GroupId = @GroupId
			--select @V_groupIds

			select cast(trim(value) as bigint) as value into #tbl_tempIds from string_split(@V_groupIds , ',')

			--select 
			--trim(MedicineName) as MedicineName,
			--trim(PrescriptionGrid) as PrescriptionGrid, 
			--trim(Doses) as Doses,
			--trim(Remark) as Remark 
			--from patient.tbl_DischargeCardMedicines med
			--inner join #tbl_tempIds t2 on t2.value = med.id

			--- NEw logic ----------------

			select top 1 trim(PrescriptionGrid) as PrescriptionGrid from patient.tbl_DischargeCardGroup where GroupId= @GroupId


		END

		---- JEet Chauhan New Logic for grid binding


	ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
    
		

		IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE VisitId=@VisitId
	  END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 
  
END;









GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_13022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_DeliveryRecords_13022025]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @DeliveryId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @AltLangEntry bit=NULL 
  , @LanguageCode nvarchar(50)=NULL 
  , @SrNo int=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @DeliveryNo nvarchar(20)=NULL 
  , @DeliveryNoRefId bigint=NULL
  , @BabyNo nvarchar(20)=NULL 
  , @BabyNoRefId bigint=NULL 
  , @BirthDate date=NULL 
  , @BirthTime time=NULL
  , @ChildName nvarchar(50)=NULL
  , @ChildGender nvarchar(20)=NULL 
  , @ChildGenderRefId bigint=NULL 
  , @ChildWeight decimal(5,2)=NULL 
  , @BabyStatus nvarchar(20)=NULL 
  , @BabyStatusRefId bigint=NULL 
  , @MotherFirstName nvarchar(50)=NULL 
  , @MotherFNameSuffix nvarchar(20)=NULL 
  , @MotherLastName nvarchar(50)=NULL 
  , @PrimaryContactName nvarchar(50)=NULL 
  , @PrimaryContactNameSuffix nvarchar(20)=NULL 
  , @SecondaryContactName nvarchar(50)=NULL 
  , @SecondaryContactNameSuffix nvarchar(20)=NULL
  , @PatientMobile nvarchar(50)=NULL
  , @DeliveryType nvarchar(20)=NULL 
  , @DeliveryTypeId bigint=NULL 
  , @Religion nvarchar(20)=NULL 
  , @ReligionId bigint=NULL
  , @Nationality nvarchar(50)=NULL
  , @EpisioBy nvarchar(50)=NULL 
  , @EpisioById bigint=NULL 
  , @Dayan nvarchar(50)=NULL 
  , @DayanRefId bigint=NULL 
  , @LocationRefId int=NULL 
  , @Landmark nvarchar(200)=NULL 
  , @Area nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @MarriageAge int=NULL 
  , @MothersCurrentAge int=NULL 
  , @PregWeeks int=NULL 
  , @LiveMaleFemale nvarchar(20)=NULL 
  , @FathersEducation nvarchar(50)=NULL 
  , @MothersEducation nvarchar(50)=NULL 
  , @FathersOccupation nvarchar(50)=NULL 
  , @MothersOccupation nvarchar(50)=NULL 
  , @IsDelActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Language nvarchar(200) = NULL
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNo int, @v_SrNoAccMonth int, @v_SrNoAccYear int, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
			If(isnull(@AltLangEntry, 0) = 0)
			Begin
				select @v_SrNoAccMonth = max(SrNo) from patient.tblDeliveryRecords where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
				select @v_SrNoAccYear = max(SrNo) from patient.tblDeliveryRecords where year(entrydate)=year(GETDATE())
				select @v_SrNo = max(SrNo) from patient.tblDeliveryRecords

				Select @SrNo = ISNULL(@v_SrNo,0)+1, @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1
			End
			

      INSERT INTO patient.tblDeliveryRecords  
         (PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
		 , ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
		 , MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
		 , DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
		 , LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
		 , MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
		 , IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @LanguageCode, @SrNo, @SrNoAccMonth, @SrNoAccYear, @DeliveryNo, @DeliveryNoRefId, @BabyNo, @BabyNoRefId, @BirthDate, @BirthTime, @ChildName
	   , @ChildGender, @ChildGenderRefId, @ChildWeight, @BabyStatus
	   , @BabyStatusRefId, @MotherFirstName, @MotherFNameSuffix, @MotherLastName, @PrimaryContactName, @PrimaryContactNameSuffix, @SecondaryContactName, @SecondaryContactNameSuffix, @PatientMobile
	   , @DeliveryType, @DeliveryTypeId, @Religion, @ReligionId, @Nationality, @EpisioBy, @EpisioById, @Dayan, @DayanRefId
	   , @LocationRefId, @Landmark, @Area, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @MarriageAge, @MothersCurrentAge, @PregWeeks, @LiveMaleFemale, @FathersEducation, @MothersEducation, @FathersOccupation, @MothersOccupation
	   , @IsDelActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblDeliveryRecords 
	 -- SET PatientId=@PatientId 
       -- , CaseId=@CaseId 
       -- , VisitId=@VisitId 
        SET SrNo=@SrNo 
        , SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
        ,  DeliveryNo=@DeliveryNo
		, DeliveryNoRefId=@DeliveryNoRefId
        , BabyNo=@BabyNo 
        , BabyNoRefId=@BabyNoRefId 
        , BirthDate=@BirthDate 
        , BirthTime=@BirthTime
		, ChildName=@ChildName
        , ChildGender=@ChildGender 
        , ChildGenderRefId=@ChildGenderRefId 
        , ChildWeight=@ChildWeight 
        , BabyStatus=@BabyStatus 
        , BabyStatusRefId=@BabyStatusRefId 
        , MotherFirstName=@MotherFirstName 
        , MotherFNameSuffix=@MotherFNameSuffix 
        , MotherLastName=@MotherLastName 
        , PrimaryContactName=@PrimaryContactName 
        , PrimaryContactNameSuffix=@PrimaryContactNameSuffix 
        , SecondaryContactName=@SecondaryContactName 
        , SecondaryContactNameSuffix=@SecondaryContactNameSuffix
		, PatientMobile=@PatientMobile
        , DeliveryType=@DeliveryType 
        , DeliveryTypeId=@DeliveryTypeId 
        , Religion=@Religion 
        , ReligionId=@ReligionId
		, Nationality=@Nationality
        , EpisioBy=@EpisioBy 
        , EpisioById=@EpisioById 
        , Dayan=@Dayan 
        , DayanRefId=@DayanRefId 
        , LocationRefId=@LocationRefId 
        , Landmark=@Landmark 
        , Area=@Area 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , MarriageAge=@MarriageAge 
        , MothersCurrentAge=@MothersCurrentAge 
        , PregWeeks=@PregWeeks 
        , LiveMaleFemale=@LiveMaleFemale 
        , FathersEducation=@FathersEducation 
        , MothersEducation=@MothersEducation 
        , FathersOccupation=@FathersOccupation 
        , MothersOccupation=@MothersOccupation 
        , IsDelActive=@IsDelActive 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE DeliveryId=@DeliveryId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
				Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
				End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @DeliveryId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE DeliveryId=@DeliveryId 
		End



		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' p.PatientId > 0'
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And dr.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And dr.CaseId = ' + Convert(varchar(20), @CaseId)
			If ISNULL(@LanguageCode,'')!=''
				SET @WhereQry += ' And dr.LanguageCode = ''' + @LanguageCode + ''''
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (dr.BirthDate >= ''' + @FromDate + ''' AND dr.BirthDate
				<= ''' + @ToDate + ''')' 	

			If ISNULL(@BirthDate,'') != ''
				SET @WhereQry += ' And Cast(dr.BirthDate as Date) = Cast(''' +  Convert(varchar(20), @BirthDate) + ''' as Date)' 	

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(dr.MotherFirstName like ''%' + @SearchKey + '%'' 
						Or dr.MotherLastName like ''%' + @SearchKey + '%'' 
						Or dr.ChildName like ''%' + @SearchKey + '%'' 
						Or dr.PatientMobile like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or dr.VillageCity like ''%' + @SearchKey + '%'' 
						Or dr.Taluka like ''%' + @SearchKey + '%'' 
						Or dr.District like ''%' + @SearchKey + '%'' 
						Or dr.State like ''%' + @SearchKey + '%'' 
						Or dr.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.DeliveryId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct dr.DeliveryId, ' + @SortBy + ' as SortBy
						 FROM patient.tblDeliveryRecords dr with(nolock) 		
						 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, dr.DeliveryId, p.PatientId, dr.CaseId, dr.VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId
				, BirthDate, BirthTime, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				  From CTE 
				 
				  INNER JOIN patient.tblDeliveryRecords dr with(nolock) ON CTE.DeliveryId=dr.DeliveryId
				  INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId


				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		END

	ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
    
		DELETE FROM patient.tblDeliveryRecords WHERE VisitId=@VisitId

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

      
    END 
      


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_13032025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_DeliveryRecords_13032025]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @DeliveryId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @AltLangEntry bit=NULL 
  , @LanguageCode nvarchar(50)=NULL 
  , @SrNo int=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @DeliveryNo nvarchar(20)=NULL 
  , @DeliveryNoRefId bigint=NULL
  , @BabyNo nvarchar(20)=NULL 
  , @BabyNoRefId bigint=NULL 
  , @BirthDate date=NULL 
  , @BirthTime time=NULL
  , @ChildName nvarchar(50)=NULL
  , @ChildGender nvarchar(20)=NULL 
  , @ChildGenderRefId bigint=NULL 
  , @ChildWeight decimal(5,2)=NULL 
  , @BabyStatus nvarchar(20)=NULL 
  , @BabyStatusRefId bigint=NULL 
  , @MotherFirstName nvarchar(50)=NULL 
  , @MotherFNameSuffix nvarchar(20)=NULL 
  , @MotherLastName nvarchar(50)=NULL 
  , @PrimaryContactName nvarchar(50)=NULL 
  , @PrimaryContactNameSuffix nvarchar(20)=NULL 
  , @SecondaryContactName nvarchar(50)=NULL 
  , @SecondaryContactNameSuffix nvarchar(20)=NULL
  , @PatientMobile nvarchar(50)=NULL
  , @DeliveryType nvarchar(20)=NULL 
  , @DeliveryTypeId bigint=NULL 
  , @Religion nvarchar(20)=NULL 
  , @ReligionId bigint=NULL
  , @Nationality nvarchar(50)=NULL
  , @EpisioBy nvarchar(50)=NULL 
  , @EpisioById bigint=NULL 
  , @Dayan nvarchar(50)=NULL 
  , @DayanRefId bigint=NULL 
  , @LocationRefId int=NULL 
  , @Landmark nvarchar(200)=NULL 
  , @Area nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @MarriageAge int=NULL 
  , @MothersCurrentAge int=NULL 
  , @PregWeeks int=NULL 
  , @LiveMaleFemale nvarchar(20)=NULL 
  , @FathersEducation nvarchar(50)=NULL 
  , @MothersEducation nvarchar(50)=NULL 
  , @FathersOccupation nvarchar(50)=NULL 
  , @MothersOccupation nvarchar(50)=NULL 
  , @IsDelActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Language nvarchar(200) = NULL
   
  ,@IsMisMatchSrNos bit = null

  , @HouseNo nvarchar(1000) = null
  , @Society nvarchar(1000) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNo int, @v_SrNoAccMonth int, @v_SrNoAccYear int, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
			If(isnull(@AltLangEntry, 0) = 0)
			Begin
				select @v_SrNoAccMonth = max(SrNo) from patient.tblDeliveryRecords where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
				select @v_SrNoAccYear = max(SrNo) from patient.tblDeliveryRecords where year(entrydate)=year(GETDATE())
				select @v_SrNo = max(SrNo) from patient.tblDeliveryRecords

				Select @SrNo = ISNULL(@v_SrNo,0)+1, @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1
			End
			

      INSERT INTO patient.tblDeliveryRecords  
         (PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
		 , ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
		 , MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
		 , DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
		 , LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
		 , MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
		 , IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, IsMisMatchSrNos, HouseNo, Society) 
       VALUES (@PatientId, @CaseId, @VisitId, @LanguageCode, @SrNo, @SrNoAccMonth, @SrNoAccYear, @DeliveryNo, @DeliveryNoRefId, @BabyNo, @BabyNoRefId, @BirthDate, @BirthTime, @ChildName
	   , @ChildGender, @ChildGenderRefId, @ChildWeight, @BabyStatus
	   , @BabyStatusRefId, @MotherFirstName, @MotherFNameSuffix, @MotherLastName, @PrimaryContactName, @PrimaryContactNameSuffix, @SecondaryContactName, @SecondaryContactNameSuffix, @PatientMobile
	   , @DeliveryType, @DeliveryTypeId, @Religion, @ReligionId, @Nationality, @EpisioBy, @EpisioById, @Dayan, @DayanRefId
	   , @LocationRefId, @Landmark, @Area, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @MarriageAge, @MothersCurrentAge, @PregWeeks, @LiveMaleFemale, @FathersEducation, @MothersEducation, @FathersOccupation, @MothersOccupation
	   , @IsDelActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @IsMisMatchSrNos, @HouseNo , @Society)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblDeliveryRecords 
	 -- SET PatientId=@PatientId 
       -- , CaseId=@CaseId 
       -- , VisitId=@VisitId 
        SET SrNo=@SrNo 
        , SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
        ,  DeliveryNo=@DeliveryNo
		, DeliveryNoRefId=@DeliveryNoRefId
        , BabyNo=@BabyNo 
        , BabyNoRefId=@BabyNoRefId 
        , BirthDate=@BirthDate 
        , BirthTime=@BirthTime
		, ChildName=@ChildName
        , ChildGender=@ChildGender 
        , ChildGenderRefId=@ChildGenderRefId 
        , ChildWeight=@ChildWeight 
        , BabyStatus=@BabyStatus 
        , BabyStatusRefId=@BabyStatusRefId 
        , MotherFirstName=@MotherFirstName 
        , MotherFNameSuffix=@MotherFNameSuffix 
        , MotherLastName=@MotherLastName 
        , PrimaryContactName=@PrimaryContactName 
        , PrimaryContactNameSuffix=@PrimaryContactNameSuffix 
        , SecondaryContactName=@SecondaryContactName 
        , SecondaryContactNameSuffix=@SecondaryContactNameSuffix
		, PatientMobile=@PatientMobile
        , DeliveryType=@DeliveryType 
        , DeliveryTypeId=@DeliveryTypeId 
        , Religion=@Religion 
        , ReligionId=@ReligionId
		, Nationality=@Nationality
        , EpisioBy=@EpisioBy 
        , EpisioById=@EpisioById 
        , Dayan=@Dayan 
        , DayanRefId=@DayanRefId 
        , LocationRefId=@LocationRefId 
        , Landmark=@Landmark 
        , Area=@Area 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , MarriageAge=@MarriageAge 
        , MothersCurrentAge=@MothersCurrentAge 
        , PregWeeks=@PregWeeks 
        , LiveMaleFemale=@LiveMaleFemale 
        , FathersEducation=@FathersEducation 
        , MothersEducation=@MothersEducation 
        , FathersOccupation=@FathersOccupation 
        , MothersOccupation=@MothersOccupation 
        , IsDelActive=@IsDelActive 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,IsMisMatchSrNos = @IsMisMatchSrNos
		,HouseNo  = @HouseNo
		, Society = @Society
         WHERE DeliveryId=@DeliveryId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
				Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
				End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @DeliveryId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE DeliveryId=@DeliveryId 
		End


		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT top 1 dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE dr.PatientId=@PatientId
			 order by EntryDate desc
		End



			-- //   // Jeet Chauhan for taking month and year number
		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0
			declare @SrNoOut1 bigint = 0, @SrNoOut2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblDeliveryRecords where month(BirthDate ) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblDeliveryRecords where year(BirthDate ) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblDeliveryRecords where  month(BirthDate ) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblDeliveryRecords where  year(BirthDate ) = year(GETDATE())

			--select * from patient.tblDeliveryRecords
			
			select @SrNoOut1 = COUNT(SrNo) from patient.tblDeliveryRecords 
			select @SrNoOut2 = MAX(SrNo) from patient.tblDeliveryRecords 

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as srnoAccYear2,
					(isnull(@SrNoOut1, 0) + 1) as SrNo , (isnull(@SrNoOut2,0) + 1) as SrNo2
		End
		-- //   // Jeet Chauhan for taking month and year number

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end



			SET @WhereQry = ' p.PatientId > 0'
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And dr.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And dr.CaseId = ' + Convert(varchar(20), @CaseId)
			If ISNULL(@LanguageCode,'')!=''
				SET @WhereQry += ' And dr.LanguageCode = ''' + @LanguageCode + ''''
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (dr.BirthDate >= ''' + @FromDate + ''' AND dr.BirthDate
				<= ''' + @ToDate + ''')' 	

			If ISNULL(@BirthDate,'') != ''
				SET @WhereQry += ' And Cast(dr.BirthDate as Date) = Cast(''' +  Convert(varchar(20), @BirthDate) + ''' as Date)' 	

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(dr.MotherFirstName like ''%' + @SearchKey + '%'' 
						Or dr.MotherLastName like ''%' + @SearchKey + '%'' 
						Or dr.ChildName like ''%' + @SearchKey + '%'' 
						Or dr.PatientMobile like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or dr.VillageCity like ''%' + @SearchKey + '%'' 
						Or dr.Taluka like ''%' + @SearchKey + '%'' 
						Or dr.District like ''%' + @SearchKey + '%'' 
						Or dr.State like ''%' + @SearchKey + '%'' 
						Or dr.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.DeliveryId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct dr.DeliveryId, ' + @SortBy + ' as SortBy
						 FROM patient.tblDeliveryRecords dr with(nolock) 		
						 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, dr.DeliveryId, p.PatientId, dr.CaseId, dr.VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId
				, BirthDate, BirthTime, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy

				, IsMisMatchSrNos
				, dr.HouseNo, dr.Society
				  From CTE 
				 
				  INNER JOIN patient.tblDeliveryRecords dr with(nolock) ON CTE.DeliveryId=dr.DeliveryId
				  INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId


				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		END

	ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
    
		

		IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE VisitId=@VisitId
	  END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

      
    END 
      


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_DeliveryRecords_19042025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_DeliveryRecords_19042025]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @DeliveryId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @AltLangEntry bit=NULL 
  , @LanguageCode nvarchar(50)=NULL 
  , @SrNo int=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @DeliveryNo nvarchar(20)=NULL 
  , @DeliveryNoRefId bigint=NULL
  , @BabyNo nvarchar(20)=NULL 
  , @BabyNoRefId bigint=NULL 
  , @BirthDate date=NULL 
  , @BirthTime time=NULL
  , @ChildName nvarchar(50)=NULL
  , @ChildGender nvarchar(20)=NULL 
  , @ChildGenderRefId bigint=NULL 
  , @ChildWeight decimal(5,2)=NULL 
  , @BabyStatus nvarchar(20)=NULL 
  , @BabyStatusRefId bigint=NULL 
  , @MotherFirstName nvarchar(50)=NULL 
  , @MotherFNameSuffix nvarchar(20)=NULL 
  , @MotherLastName nvarchar(50)=NULL 
  , @PrimaryContactName nvarchar(50)=NULL 
  , @PrimaryContactNameSuffix nvarchar(20)=NULL 
  , @SecondaryContactName nvarchar(50)=NULL 
  , @SecondaryContactNameSuffix nvarchar(20)=NULL
  , @PatientMobile nvarchar(50)=NULL
  , @DeliveryType nvarchar(20)=NULL 
  , @DeliveryTypeId bigint=NULL 
  , @Religion nvarchar(20)=NULL 
  , @ReligionId bigint=NULL
  , @Nationality nvarchar(50)=NULL
  , @EpisioBy nvarchar(50)=NULL 
  , @EpisioById bigint=NULL 
  , @Dayan nvarchar(50)=NULL 
  , @DayanRefId bigint=NULL 
  , @LocationRefId int=NULL 
  , @Landmark nvarchar(200)=NULL 
  , @Area nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @MarriageAge int=NULL 
  , @MothersCurrentAge int=NULL 
  , @PregWeeks int=NULL 
  , @LiveMaleFemale nvarchar(20)=NULL 
  , @FathersEducation nvarchar(50)=NULL 
  , @MothersEducation nvarchar(50)=NULL 
  , @FathersOccupation nvarchar(50)=NULL 
  , @MothersOccupation nvarchar(50)=NULL 
  , @IsDelActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Language nvarchar(200) = NULL
   
  ,@IsMisMatchSrNos bit = null

  , @HouseNo nvarchar(1000) = null
  , @Society nvarchar(1000) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNo int, @v_SrNoAccMonth int, @v_SrNoAccYear int, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
			If(isnull(@AltLangEntry, 0) = 0)
			Begin
				select @v_SrNoAccMonth = max(SrNo) from patient.tblDeliveryRecords where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
				select @v_SrNoAccYear = max(SrNo) from patient.tblDeliveryRecords where year(entrydate)=year(GETDATE())
				select @v_SrNo = max(SrNo) from patient.tblDeliveryRecords

				Select @SrNo = ISNULL(@v_SrNo,0)+1, @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1
			End
			

      INSERT INTO patient.tblDeliveryRecords  
         (PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
		 , ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
		 , MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
		 , DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
		 , LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
		 , MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
		 , IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, IsMisMatchSrNos, HouseNo, Society) 
       VALUES (@PatientId, @CaseId, @VisitId, @LanguageCode, @SrNo, @SrNoAccMonth, @SrNoAccYear, @DeliveryNo, @DeliveryNoRefId, @BabyNo, @BabyNoRefId, @BirthDate, @BirthTime, @ChildName
	   , @ChildGender, @ChildGenderRefId, @ChildWeight, @BabyStatus
	   , @BabyStatusRefId, @MotherFirstName, @MotherFNameSuffix, @MotherLastName, @PrimaryContactName, @PrimaryContactNameSuffix, @SecondaryContactName, @SecondaryContactNameSuffix, @PatientMobile
	   , @DeliveryType, @DeliveryTypeId, @Religion, @ReligionId, @Nationality, @EpisioBy, @EpisioById, @Dayan, @DayanRefId
	   , @LocationRefId, @Landmark, @Area, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @MarriageAge, @MothersCurrentAge, @PregWeeks, @LiveMaleFemale, @FathersEducation, @MothersEducation, @FathersOccupation, @MothersOccupation
	   , @IsDelActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @IsMisMatchSrNos, @HouseNo , @Society)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblDeliveryRecords 
	 -- SET PatientId=@PatientId 
       -- , CaseId=@CaseId 
       -- , VisitId=@VisitId 
        SET SrNo=@SrNo 
        , SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
        ,  DeliveryNo=@DeliveryNo
		, DeliveryNoRefId=@DeliveryNoRefId
        , BabyNo=@BabyNo 
        , BabyNoRefId=@BabyNoRefId 
        , BirthDate=@BirthDate 
        , BirthTime=@BirthTime
		, ChildName=@ChildName
        , ChildGender=@ChildGender 
        , ChildGenderRefId=@ChildGenderRefId 
        , ChildWeight=@ChildWeight 
        , BabyStatus=@BabyStatus 
        , BabyStatusRefId=@BabyStatusRefId 
        , MotherFirstName=@MotherFirstName 
        , MotherFNameSuffix=@MotherFNameSuffix 
        , MotherLastName=@MotherLastName 
        , PrimaryContactName=@PrimaryContactName 
        , PrimaryContactNameSuffix=@PrimaryContactNameSuffix 
        , SecondaryContactName=@SecondaryContactName 
        , SecondaryContactNameSuffix=@SecondaryContactNameSuffix
		, PatientMobile=@PatientMobile
        , DeliveryType=@DeliveryType 
        , DeliveryTypeId=@DeliveryTypeId 
        , Religion=@Religion 
        , ReligionId=@ReligionId
		, Nationality=@Nationality
        , EpisioBy=@EpisioBy 
        , EpisioById=@EpisioById 
        , Dayan=@Dayan 
        , DayanRefId=@DayanRefId 
        , LocationRefId=@LocationRefId 
        , Landmark=@Landmark 
        , Area=@Area 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , MarriageAge=@MarriageAge 
        , MothersCurrentAge=@MothersCurrentAge 
        , PregWeeks=@PregWeeks 
        , LiveMaleFemale=@LiveMaleFemale 
        , FathersEducation=@FathersEducation 
        , MothersEducation=@MothersEducation 
        , FathersOccupation=@FathersOccupation 
        , MothersOccupation=@MothersOccupation 
        , IsDelActive=@IsDelActive 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,IsMisMatchSrNos = @IsMisMatchSrNos
		,HouseNo  = @HouseNo
		, Society = @Society
         WHERE DeliveryId=@DeliveryId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
				If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
				Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
				End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @DeliveryId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE DeliveryId=@DeliveryId 
		End


		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT DeliveryId, PatientId, CaseId, VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId, BirthDate, BirthTime, ChildName
			--, ChildGender, ChildGenderRefId, ChildWeight, BabyStatus, BabyStatusRefId
			--, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
			--, DeliveryType, DeliveryTypeId, Religion, ReligionId, Nationality, EpisioBy, EpisioById, Dayan, DayanRefId
			--, LocationRefId, Landmark, Area, VillageCity, Taluka, District, State, PinCode
			--, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale, FathersEducation, MothersEducation, FathersOccupation, MothersOccupation
			--, IsDelActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy

			SELECT top 1 dr.DeliveryId, p.PatientId, CaseId, VisitId, LanguageCode
			, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId
				, BabyNo, BabyNoRefId
				, BirthDate, BirthTime
				, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName
				, PrimaryContactName, PrimaryContactNameSuffix, pcns.RecordName as PrimaryContactNameSuffixText
				, SecondaryContactName, SecondaryContactNameSuffix, sns.RecordName as SecondaryContactNameSuffixText
				, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy
				,IsMisMatchSrNos
				,dr.HouseNo,dr.Society

			 FROM patient.tblDeliveryRecords dr 
			 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pcns with(nolock) on dr.PrimaryContactNameSuffix = pcns.EntityRecordId
				  LEFT JOIN common.tblEntityRecords sns with(nolock) on dr.SecondaryContactNameSuffix = sns.EntityRecordId
			 WHERE dr.PatientId=@PatientId
			 order by EntryDate desc
		End



			-- //   // Jeet Chauhan for taking month and year number
		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0
			declare @SrNoOut1 bigint = 0, @SrNoOut2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblDeliveryRecords where month(BirthDate ) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblDeliveryRecords where year(BirthDate ) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblDeliveryRecords where  month(BirthDate ) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblDeliveryRecords where  year(BirthDate ) = year(GETDATE())

			--select * from patient.tblDeliveryRecords
			
			select @SrNoOut1 = COUNT(SrNo) from patient.tblDeliveryRecords 
			select @SrNoOut2 = MAX(SrNo) from patient.tblDeliveryRecords 

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as srnoAccYear2,
					(isnull(@SrNoOut1, 0) + 1) as SrNo , (isnull(@SrNoOut2,0) + 1) as SrNo2
		End
		-- //   // Jeet Chauhan for taking month and year number

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			IF @FromDate = 'undefined'
			BEGIN
				Set @FromDate = null
			END


			IF @ToDate = 'undefined'
			BEGIN
				Set @ToDate = null
			END

			SET @WhereQry = ' p.PatientId > 0'
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And dr.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And dr.CaseId = ' + Convert(varchar(20), @CaseId)
			If ISNULL(@LanguageCode,'')!=''
				SET @WhereQry += ' And dr.LanguageCode = ''' + @LanguageCode + ''''
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (dr.BirthDate >= ''' + @FromDate + ''' AND dr.BirthDate
				<= ''' + @ToDate + ''')' 	

			If ISNULL(@BirthDate,'') != ''
				SET @WhereQry += ' And Cast(dr.BirthDate as Date) = Cast(''' +  Convert(varchar(20), @BirthDate) + ''' as Date)' 	

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(dr.MotherFirstName like ''%' + @SearchKey + '%'' 
						Or dr.MotherLastName like ''%' + @SearchKey + '%'' 
						Or dr.ChildName like ''%' + @SearchKey + '%'' 
						Or dr.PatientMobile like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or dr.VillageCity like ''%' + @SearchKey + '%'' 
						Or dr.Taluka like ''%' + @SearchKey + '%'' 
						Or dr.District like ''%' + @SearchKey + '%'' 
						Or dr.State like ''%' + @SearchKey + '%'' 
						Or dr.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.DeliveryId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct dr.DeliveryId, ' + @SortBy + ' as SortBy
						 FROM patient.tblDeliveryRecords dr with(nolock) 		
						 INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, dr.DeliveryId, p.PatientId, dr.CaseId, dr.VisitId, LanguageCode, SrNo, SrNoAccMonth, SrNoAccYear
				, DeliveryNo, DeliveryNoRefId, BabyNo, BabyNoRefId
				, BirthDate, BirthTime, ChildName
				, ChildGenderRefId, cg.RecordName as ChildGender
				, ChildWeight
				, BabyStatusRefId, bs.RecordName as BabyStatus
				, MotherFirstName, MotherFNameSuffix, MotherLastName, PrimaryContactName, PrimaryContactNameSuffix, SecondaryContactName, SecondaryContactNameSuffix, PatientMobile
				, DeliveryTypeId, dt.RecordName as DeliveryType
				, ReligionId, rel.RecordName as Religion
				, Nationality
				--, EpisioById, ep.RecordName as EpisioBy
				--, DayanRefId, dayan.RecordName as Dayan
				, EpisioById, EpisioBy
				, DayanRefId, Dayan
				, dr.LocationRefId, dr.Landmark, dr.Area, dr.VillageCity, dr.Taluka, dr.District, dr.State, dr.PinCode
				, MarriageAge, MothersCurrentAge, PregWeeks, LiveMaleFemale
				
				, FathersEducation, fedu.RecordName as FathersEducationText
				, MothersEducation, medu.RecordName as MothersEducationText
				, FathersOccupation, foccu.RecordName as FathersOccupationText
				, MothersOccupation, moccu.RecordName as MothersOccupationText

				, dr.IsDelActive, dr.IsEdited, dr.EntryDate, dr.UpdatedDate, dr.CreatedBy, dr.UpdatedBy

				, IsMisMatchSrNos
				, dr.HouseNo, dr.Society
				  From CTE 
				 
				  INNER JOIN patient.tblDeliveryRecords dr with(nolock) ON CTE.DeliveryId=dr.DeliveryId
				  INNER JOIN patient.tblPatients p with(nolock) ON dr.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  INNER JOIN common.tblEntityRecords cg with(nolock) on dr.ChildGenderRefId = cg.EntityRecordId
				  INNER JOIN common.tblEntityRecords bs with(nolock) on dr.BabyStatusRefId = bs.EntityRecordId
				  INNER JOIN common.tblEntityRecords dt with(nolock) on dr.DeliveryTypeId = dt.EntityRecordId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on dr.ReligionId = rel.EntityRecordId
				  
				  INNER JOIN common.tblEntityRecords fedu with(nolock) on dr.FathersEducation = fedu.EntityRecordId
				  INNER JOIN common.tblEntityRecords medu with(nolock) on dr.MothersEducation = medu.EntityRecordId
				  INNER JOIN common.tblEntityRecords foccu with(nolock) on dr.FathersOccupation = foccu.EntityRecordId
				  INNER JOIN common.tblEntityRecords moccu with(nolock) on dr.MothersOccupation = moccu.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords ep with(nolock) on dr.EpisioById = ep.EntityRecordId
				  --LEFT JOIN common.tblEntityRecords dayan with(nolock) on dr.DayanRefId = dayan.EntityRecordId


				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		END

	ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
    
		

		IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE DeliveryId=@DeliveryId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblDeliveryRecords WHERE VisitId=@VisitId
	  END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DeliveryId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

      
    END 
      


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Diagnosis]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Diagnosis]  
   @Command varchar(200) 
  , @DiagnosisId int=NULL 
  , @DiagnosisName nvarchar(500)=NULL 
  , @MedicineIds varchar(2000)=NULL 
  , @Advice nvarchar(2000)=NULL 
  , @IsUterusWeek bit=NULL 
  , @FollowUpDays int=NULL 
  , @IsDiagnosisActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='DiagnosisId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  --, @MedicineId int = 0
  , @MedicineId nvarchar(max) = null
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 DiagnosisId from hospital.tblDiagnosis with (nolock) where DiagnosisName=@DiagnosisName)
		Begin

				--Jeet Chauhan New Change
				--declare @MedicineIds nvarchar(max) = 'Demo14,demo2'
				declare @medicineIdss nvarchar(500) = ''
				select @medicineId =string_agg( MedicineId , ',')from hospital.tblMedicine where MedicineName in 
					(
						select value from string_split(@MedicineIds, ',')
					)

				-- Jeet Chauhan New Change

				INSERT INTO hospital.tblDiagnosis  
				(DiagnosisName, MedicineIds, Advice, IsUterusWeek, FollowUpDays, IsDiagnosisActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, 
				-- new Field Added Changes
				MedicineId) 
				-- new Field Added Changes
				VALUES (@DiagnosisName, @MedicineIds, @Advice, @IsUterusWeek, @FollowUpDays, @IsDiagnosisActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,
				-- new Field Added Changes
				@MedicineId ) 
				-- new Field Added Changes
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Another Record with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

		IF @SubCommand = 'InsertOrUpdateNewGroup'
		BEGIN
			
			--Jeet Chauhan New Change
				--declare @MedicineIds nvarchar(max) = 'Demo14,demo2'
				--declare @medicine nvarchar(500) = ''
				--select @medicine =string_agg( MedicineId , ',')from hospital.tblMedicine where MedicineName in 
				--	(
				--		select value from string_split(@MedicineIds, ',')
				--	)

				-- Jeet Chauhan New Change

			 If Not Exists (select top 1 DiagnosisId from hospital.tblDiagnosis with (nolock) where DiagnosisName=@DiagnosisName)
			 BEGIN
				
				

				INSERT INTO hospital.tblDiagnosis  
				(DiagnosisName, MedicineIds, Advice, IsUterusWeek, FollowUpDays, IsDiagnosisActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, 
				-- new Field Added Changes
				MedicineId) 
				-- new Field Added Changes
				VALUES (@DiagnosisName, @MedicineIds, @Advice, @IsUterusWeek, @FollowUpDays, @IsDiagnosisActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,
				-- new Field Added Changes
				@MedicineId ) 
				-- new Field Added Changes
        


			


				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 

			 END
			 Else
			Begin
				
				UPDATE hospital.tblDiagnosis 
				    SET DiagnosisName=@DiagnosisName 
					, MedicineIds=@MedicineIds 
					, Advice=@Advice 
					, IsUterusWeek=@IsUterusWeek 
					, FollowUpDays=@FollowUpDays 
					, IsDiagnosisActive=@IsDiagnosisActive 
					, IsEdited=@IsEdited 
					--, EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
					--, CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy ,

					-- Jeet Chauhan New Column
						MedicineId =@MedicineId
					-- Jeet Chauhan New Column

					 WHERE DiagnosisId=@DiagnosisId  


				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 

		    End 


		END
		ELSE
		BEGIN
			 If Not Exists (select top 1 DiagnosisId from hospital.tblDiagnosis with (nolock) where DiagnosisName=@DiagnosisName and DiagnosisId!=@DiagnosisId)
			Begin

			--Jeet Chauhan New Change
					--declare @MedicineIds nvarchar(max) = 'Demo14,demo2'
					declare @medicineIdUpdate nvarchar(500) = ''
					select @medicineIdUpdate =string_agg( MedicineId , ',')from hospital.tblMedicine where MedicineName in 
						(
							select value from string_split(@MedicineIds, ',')
						)

					-- Jeet Chauhan New Change

					UPDATE hospital.tblDiagnosis SET DiagnosisName=@DiagnosisName 
					, MedicineIds=@MedicineIds 
					, Advice=@Advice 
					, IsUterusWeek=@IsUterusWeek 
					, FollowUpDays=@FollowUpDays 
					, IsDiagnosisActive=@IsDiagnosisActive 
					, IsEdited=@IsEdited 
					--, EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
					--, CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy ,

					-- Jeet Chauhan New Column
						MedicineId =@medicineIdUpdate
					-- Jeet Chauhan New Column

					 WHERE DiagnosisId=@DiagnosisId    
				 
						IF @@ERROR=0
						Begin               
							SELECT @v_IsSuccess=1, @v_Identity = @DiagnosisId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
						End
						Else
						Begin
							SELECT @v_IsSuccess=0, @v_Identity = @DiagnosisId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
						End 

				 End
			Else
			Begin
				SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Another Record with this name already exists!'
			End  
		END


                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage		


    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand='SelectSingle'
		Begin			
			  SELECT DiagnosisId, DiagnosisName, 
			  
			  --MedicineIds
			  
			   (
					select STRING_AGG( cast(MedicineName as nvarchar(500)), ',') from hospital.tblMedicine where 
						MedicineId in (select cast(value as int) from  string_split(d.MedicineId,','))
				) as MedicineIds
				

			  , Advice, IsUterusWeek, FollowUpDays
			  , IsDiagnosisActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			  FROM hospital.tblDiagnosis d with(nolock) 
			  WHERE DiagnosisId=@DiagnosisId 
			   --INNER JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
			   --INNER JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId
			  
		End

		Else If @SubCommand='SelectSingleByName'
		Begin			
			  SELECT DiagnosisId, DiagnosisName, MedicineIds, Advice, IsUterusWeek, FollowUpDays
			  , IsDiagnosisActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			  FROM hospital.tblDiagnosis with(nolock) 
			  WHERE DiagnosisName=@DiagnosisName and IsDiagnosisActive = 1
			   --INNER JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
			   --INNER JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
			   --INNER JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId
			  
		End

		Else If @SubCommand='GetAllList' 
		 Begin
			
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' d.IsDiagnosisActive in (1,0) '
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'DiagnosisName'
						Then 'd.DiagnosisName = ' + Convert(varchar, @SearchKey)							 						
						--When 'FreeSearch'
						--Then '(medtype.RecordName like ''%' + @SearchKey + '%'' 
						--	Or m.MedicineName like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select DiagnosisId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct d.DiagnosisId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblDiagnosis d with(nolock) 						   						  					
						WHERE ' + @WhereQry + ' and IsDiagnosisActive = 1
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, d.DiagnosisId, d.DiagnosisName, 
				
				--d.MedicineIds

				(
					select STRING_AGG( cast(MedicineName as nvarchar(500)), '','') from hospital.tblMedicine where 
						MedicineId in (select cast(value as int) from  string_split(d.MedicineId,'',''))
				) as MedicineIds
				
				, d.Advice, d.IsUterusWeek, d.FollowUpDays
			    , d.IsDiagnosisActive, d.IsEdited, d.EntryDate, d.UpdatedDate, d.CreatedBy, d.UpdatedBy 							  
				  From CTE 
				  INNER JOIN hospital.tblDiagnosis d with(nolock) on CTE.DiagnosisId = d.DiagnosisId
				  						   
					
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
			
		 End

		
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

		

		--DELETE FROM hospital.tblDiagnosis WHERE DiagnosisId=@DiagnosisId 
		
		update hospital.tblDiagnosis set IsDiagnosisActive = 0 where DiagnosisId = @DiagnosisId

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DiagnosisId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Districts]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Districts]  
   @Command varchar(200) 
  , @DistrictId int=NULL 
  , @District nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @StateId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='District'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@StateId and Language=@Language)
		Begin
				  INSERT INTO location.tblDistrict  
				 (District, Language, StateId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@District, @Language, @StateId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. District and State combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@StateId and Language=@Language and DistrictId!=@DistrictId)
			Begin				
				  UPDATE location.tblDistrict 
				  SET District=@District 
				, Language=@Language 
				--, StateId=@StateId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 				
				, UpdatedDate=@UpdatedDate				
				, UpdatedBy=@UpdatedBy 
				 WHERE DistrictId=@DistrictId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @DistrictId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @DistrictId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @DistrictId, @v_Message='error', @v_CustomMessage='Duplication error. District and State combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT d.DistrictId, d.District, d.Language, d.IsActive, d.IsEdited, d.EntryDate, d.UpdatedDate, d.CreatedBy, d.UpdatedBy
			, s.StateId, s.State			 
			FROM location.tblDistrict d with(nolock)
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE DistrictId=@DistrictId 		
		End

			Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And d.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					    When 'District'
							Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
						When 'State'
							Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
						When 'StateId'
							Then 's.StateId = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch'
							Then '(d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or d.Language like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select DistrictId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select d.DistrictId, ' + @SortBy + ' as SortBy
						 FROM location.tblDistrict d with(nolock) 	
						  INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, d.DistrictId, d.District, d.Language
				, s.StateId, s.State  , isnull(City, '''') as City , isnull(CityId , 0) as CityId
				, d.IsActive, d.IsEdited, d.EntryDate, d.UpdatedDate, d.CreatedBy, isnull(d.UpdatedBy,0) as UpdatedBy
				  From CTE
				  INNER JOIN location.tblDistrict d with(nolock) ON CTE.DistrictId=d.DistrictId
				  INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End


    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblDistrict WHERE DistrictId=@DistrictId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DistrictId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_EntityRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_EntityRecords]  
   @Command varchar(200) 
  , @EntityRecordId bigint=NULL 
  , @EntityId int=NULL
  , @Language nvarchar(50)=NULL 
  , @RecordName nvarchar(2000)=NULL 
  , @SequenceNo int=NULL
  , @Remarks nvarchar(4000)=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='RecordName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  , @CurrentUserId bigint=NULL
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

		If Not Exists (select top 1 EntityRecordId from common.tblEntityRecords with (nolock) where EntityId=@EntityId and RecordName=@RecordName and Language=@Language)
		Begin
				INSERT INTO common.tblEntityRecords  
				 (EntityId, Language, RecordName, SequenceNo, Remarks, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@EntityId, @Language, @RecordName, @SequenceNo, @Remarks, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Record with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If Not Exists (select top 1 EntityRecordId from common.tblEntityRecords with (nolock) where EntityId=@EntityId and RecordName=@RecordName and Language=@Language and EntityRecordId!=@EntityRecordId)
		Begin
			  UPDATE common.tblEntityRecords SET EntityId=@EntityId
			    , Language=@Language
				, RecordName=@RecordName
				, SequenceNo=@SequenceNo
				, Remarks=@Remarks 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 
				--, EntryDate=@EntryDate 
				, UpdatedDate=@UpdatedDate 
				--, CreatedBy=@CreatedBy 
				, UpdatedBy=@UpdatedBy 
				 WHERE EntityRecordId=@EntityRecordId  
				 
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = @EntityRecordId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = @EntityRecordId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 

		 End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Record with this name already exists!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand='SelectSingle'
		Begin		

			SELECT er.EntityRecordId, er.Language, er.RecordName, er.SequenceNo, er.Remarks, er.IsActive, er.IsEdited, er.EntryDate, er.UpdatedDate, er.CreatedBy, er.UpdatedBy 
				, em.EntityId, em.EntityName, em.Description
				FROM common.tblEntityRecords er
				INNER JOIN common.tblEntityMaster em on er.EntityId=em.EntityID
				WHERE EntityRecordId=@EntityRecordId 
		End

		-- Jeet Chauhan New Change Auto suggest of Entity Types
		ELSE IF @SubCommand = 'Select EntityRecords'
		BEGIN
			select RecordName from common.tblEntityRecords r
			inner join common.tblEntityMaster m on m.EntityID = r.EntityId
			where m.EntityId = @EntityId
		END
		-- Jeet Chauhan New Change Auto suggest of Entity Types

		Else If @SubCommand='SelectEntityRecords'
		Begin
			if @EntityId=0
			begin
					If Exists (Select HospitalId from hospital.tblHospitalUsers hu where hu.UserId=@CurrentUserId and hu.HospitalId > 1)
					Begin
						 -- -- // // Select Entity Master Values
						SELECT EntityId as EntityRecordId, EntityId, '' as Language, EntityName as RecordName, 0 as SequenceNo, Description as Remarks, IsActive, IsEdited, EntryDate, UpdatedDate, 1 as CreatedBy, 1 as UpdatedBy 
						, EntityId, EntityName, Description
						FROM common.tblEntityMaster with (nolock) 
						WHERE IsActive=1 and IsPublic=1
						--ORDER BY EntityName
						ORDER by SequenceNo asc

					End
					Else
					Begin
						 -- -- // // Select Entity Master Values
						SELECT EntityId as EntityRecordId, EntityId, '' as Language, EntityName as RecordName, 0 as SequenceNo, Description as Remarks, IsActive, IsEdited, EntryDate, UpdatedDate, 1 as CreatedBy, 1 as UpdatedBy 
						, EntityId, EntityName, Description
						FROM common.tblEntityMaster with (nolock) 
						WHERE IsActive=1 
						--ORDER BY EntityName
						ORDER by SequenceNo asc

					End
			end
			else
			begin
				SELECT er.EntityRecordId, er.Language, er.RecordName, er.SequenceNo, er.Remarks, er.IsActive, er.IsEdited, er.EntryDate, er.UpdatedDate, er.CreatedBy, er.UpdatedBy 
				, em.EntityId, em.EntityName, em.Description
				FROM common.tblEntityRecords er with (nolock)
				INNER JOIN common.tblEntityMaster em with (nolock) on er.EntityId=em.EntityID and er.IsActive=1 and em.IsActive=1
				WHERE er.EntityId=@EntityId 
				ORDER BY SequenceNo --RecordName
			end			
		End

		Else If @SubCommand='GetAllList' 
		 Begin
			
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0 and 1=0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end			

			SET @WhereQry = ' er.IsActive in (1,0) '

			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' and er.Language = ''' + @Language + '''';

			If @EntityId > 1
				SET @WhereQry += ' and em.EntityId = ' + Convert(varchar, @EntityId)				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Entity'
						Then 'em.EntityName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(er.RecordName like ''%' + @SearchKey + '%'' 
							Or em.EntityName like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			If Exists (Select HospitalId from hospital.tblHospitalUsers hu where hu.UserId=@CurrentUserId and hu.HospitalId > 1)
			Begin
				SET @WhereQry += ' and em.IsPublic = 1'	
			End
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select EntityRecordId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct er.EntityRecordId, ' + @SortBy + ' as SortBy
						 FROM common.tblEntityRecords er with(nolock) 
						  INNER JOIN common.tblEntityMaster em with(nolock) on em.EntityId = er.EntityId						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, er.EntityRecordId, er.Language, er.RecordName, er.SequenceNo, er.Remarks			
				, er.IsActive, er.IsEdited, er.EntryDate, er.UpdatedDate, er.CreatedBy, er.UpdatedBy
				, em.EntityId, em.EntityName, em.Description				  
				  From CTE 
				  INNER JOIN common.tblEntityRecords er with(nolock) on CTE.EntityRecordId = er.EntityRecordId
				  INNER JOIN common.tblEntityMaster em with(nolock) on em.EntityId = er.EntityId
					
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
			
		 End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM common.tblEntityRecords WHERE EntityRecordId=@EntityRecordId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @EntityRecordId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Groups]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Groups]  
   @Command varchar(200) 
  , @GroupId int=NULL 
  , @GroupTypeId bigint=NULL 
  , @GroupName nvarchar(500)=NULL 
  , @GroupItems nvarchar(4000)=NULL 
  , @IsGroupActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='GroupId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 

  , @SerializeData nvarchar(max) = null
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      
        
		If Not Exists (select top 1 GroupId from common.tblGroups with (nolock) where GroupName=@GroupName and GroupTypeId=@GroupTypeId)
		Begin  
		
			INSERT INTO common.tblGroups  
			(GroupTypeId, GroupName, GroupItems, IsGroupActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , SerializeData) 
			VALUES (@GroupTypeId, @GroupName, @GroupItems, @IsGroupActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @SerializeData ) 
			
			IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Another Group with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN     
		
		If not Exists (select top 1 GroupId from  common.tblGroups with (nolock) where GroupName=@GroupName and GroupTypeId=@GroupTypeId and GroupId!=@GroupId)
			Begin				
				   UPDATE common.tblGroups SET GroupTypeId=@GroupTypeId 
					, GroupName=@GroupName 
					, GroupItems=@GroupItems 
					, IsGroupActive=@IsGroupActive 
					, IsEdited=@IsEdited 
					--, EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
					--, CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					, SerializeData = @SerializeData
					 WHERE GroupId=@GroupId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @GroupId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @GroupId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @GroupId, @v_Message='error', @v_CustomMessage='Duplication error. Another Group with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN       
	  
	  	If @SubCommand = 'SelectSingle'
		Begin
			SELECT GroupId, GroupTypeId, GroupName, GroupItems, IsGroupActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM common.tblGroups with (nolock) WHERE GroupId=@GroupId
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' g.IsGroupActive in (1,0) '				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Name'
						Then 'g.GroupName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(g.GroupName like ''%' + @SearchKey + '%'' 
						Or grouptype.RecordName like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select GroupId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct g.GroupId, ' + @SortBy + ' as SortBy
						 FROM common.tblGroups g with(nolock)
						 INNER JOIN common.tblEntityRecords grouptype with(nolock) on g.GroupTypeId = grouptype.EntityRecordId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, g.GroupId, g.GroupTypeId, grouptype.RecordName as GroupType, g.GroupName, g.GroupItems
				, g.IsGroupActive, g.IsEdited, g.EntryDate, g.UpdatedDate, g.CreatedBy, g.UpdatedBy 							  
				  From CTE 
				  INNER JOIN common.tblGroups g with(nolock) ON CTE.GroupId=g.GroupId
				  INNER JOIN common.tblEntityRecords grouptype with(nolock) on g.GroupTypeId = grouptype.EntityRecordId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
     
		--DELETE FROM common.tblGroups WHERE GroupId=@GroupId 
		
		IF @SubCommand = 'deleteSelectedbyId'
		BEGIN
			update common.tblGroups set IsGroupActive = 0 where GroupId = @GroupId

			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Identity = @GroupId, @v_Message='success'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
			End
             
			SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage

		END

		
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Histolap]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Histolap]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @HistolapId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @AdmissionDate date=NULL 
  --, @AdmissionTime time=NULL 

  , @AdmissionTime nvarchar(50) = NULL 

  , @ProcedureNameRefId nvarchar(200)=NULL 
  , @ProcedureDate date=NULL 
  
  --, @ProcedureTime time=NULL 
  , @ProcedureTime nvarchar(200) = NULL 
  
  , @RightTubeRefId bigint=NULL 
  , @LeftTubeRefId bigint=NULL 
  , @UterusRefId bigint=NULL 
  , @PODRefId bigint=NULL 
  , @EndoCavityRefId bigint=NULL 
  , @CervicalCanalRefId bigint=NULL 
  , @DischargeDate date=NULL 
  
  --, @DischargeTime time=NULL 
  , @DischargeTime nvarchar(50)=NULL 
  
  , @HistolapRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='HistolapId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblHistolap  
         (PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, ProcedureNameRefId, ProcedureDate, ProcedureTime
		 , RightTubeRefId, LeftTubeRefId, UterusRefId, PODRefId, EndoCavityRefId, CervicalCanalRefId, DischargeDate, DischargeTime, HistolapRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @AdmissionDate, cast( @AdmissionTime as time), @ProcedureNameRefId, @ProcedureDate,cast( @ProcedureTime as time)
	   , @RightTubeRefId, @LeftTubeRefId, @UterusRefId, @PODRefId, @EndoCavityRefId, @CervicalCanalRefId, @DischargeDate, cast( @DischargeTime as time), @HistolapRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblHistolap 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , AdmissionDate=@AdmissionDate 
        , AdmissionTime=cast(@AdmissionTime as time)
        , ProcedureNameRefId=@ProcedureNameRefId 
        , ProcedureDate=@ProcedureDate 
        , ProcedureTime=cast(@ProcedureTime as time)
        , RightTubeRefId=@RightTubeRefId 
        , LeftTubeRefId=@LeftTubeRefId 
        , UterusRefId=@UterusRefId 
        , PODRefId=@PODRefId 
        , EndoCavityRefId=@EndoCavityRefId 
        , CervicalCanalRefId=@CervicalCanalRefId 
        , DischargeDate=@DischargeDate 
        , DischargeTime=cast(@DischargeTime as time)
        , HistolapRemark=@HistolapRemark 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        --, CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE HistolapId=@HistolapId 
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HistolapId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @HistolapId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT HistolapId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, ProcedureNameRefId, ProcedureDate, ProcedureTime
		  , RightTubeRefId, LeftTubeRefId, UterusRefId, PODRefId, EndoCavityRefId, CervicalCanalRefId, DischargeDate, DischargeTime, HistolapRemark
		  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
		  FROM  patient.tblHistolap WHERE HistolapId=@HistolapId 
		End

		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 HistolapId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, ProcedureNameRefId, ProcedureDate, ProcedureTime
		  , RightTubeRefId, LeftTubeRefId, UterusRefId, PODRefId, EndoCavityRefId, CervicalCanalRefId, DischargeDate, DischargeTime, HistolapRemark
		  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
		  FROM  patient.tblHistolap 
		  WHERE PatientId = @PatientId
		  order by EntryDate desc
		End

				
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' hl.PatientId = '	+ CONVERT(varchar(20),@PatientId)			
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.HistolapId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct hl.HistolapId, ' + @SortBy + ' as SortBy
						 FROM patient.tblHistolap hl with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, hl.HistolapId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime
				, ProcedureNameRefId, pn.RecordName as ProcedureName
				, ProcedureDate, ProcedureTime
				, RightTubeRefId, rt.RecordName as RightTube
				, LeftTubeRefId, lt.RecordName as LeftTube
				, UterusRefId, ut.RecordName as Uterus
				, PODRefId, pod.RecordName as POD
				, EndoCavityRefId, ec.RecordName as EndoCavity
				, CervicalCanalRefId, cc.RecordName as CervicalCanal
				, DischargeDate, DischargeTime, HistolapRemark
				, hl.IsEdited, hl.EntryDate, hl.UpdatedDate, hl.CreatedBy, hl.UpdatedBy								  
				  From CTE 
				  INNER JOIN patient.tblHistolap hl with(nolock) ON CTE.HistolapId=hl.HistolapId
				  INNER JOIN common.tblEntityRecords pn with(nolock) on hl.ProcedureNameRefId = pn.EntityRecordId
				  INNER JOIN common.tblEntityRecords rt with(nolock) on hl.RightTubeRefId = rt.EntityRecordId
				  INNER JOIN common.tblEntityRecords lt with(nolock) on hl.LeftTubeRefId = lt.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ut with(nolock) on hl.UterusRefId = ut.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pod with(nolock) on hl.PODRefId = pod.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ec with(nolock) on hl.EndoCavityRefId = ec.EntityRecordId
				  LEFT JOIN common.tblEntityRecords cc with(nolock) on hl.CervicalCanalRefId = cc.EntityRecordId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  --DELETE FROM patient.tblHistolap WHERE HistolapId=@HistolapId 
	  --DELETE FROM patient.tblHistolap WHERE VisitId = @VisitId
    
		
	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblHistolap WHERE HistolapId=@HistolapId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblHistolap WHERE VisitId = @VisitId
	  END
		
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HistolapId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

 --select * from patient.tblHistolap
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Hospitals]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Hospitals]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @HospitalName nvarchar(1000)=NULL 
  , @LocationId int=NULL 
  , @Area nvarchar(100)=NULL
  , @Taluka nvarchar(100)=NULL
  , @District nvarchar(100)=NULL
  , @State nvarchar(100)=NULL
  , @Pincode nvarchar(50)=NULL
  , @LocationType nvarchar(50)=NULL
  , @HospitalTypeRefId bigint=NULL
  , @HospitalTiming nvarchar(1000)=NULL
  , @HospitalFooterNote nvarchar(4000)=NULL
  , @HospitalLogo nvarchar(MAX)=NULL
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='HospitalName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Phone nvarchar(100) = NULL
  , @LandLine nvarchar(100) = NULL
  , @FaxNo nvarchar(100) = NULL
  , @EmailAddress nvarchar(100) = NULL
  , @LicenceKey nvarchar(500) = null
  , @Location nvarchar(500) = null
  , @HouseBuilding nvarchar(500) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
		, @v_LocationId int

    IF @Command='INSERT' 
    BEGIN 

				INSERT INTO hospital.tblHospital  
				(HospitalName, LocationId, Area, Taluka, District, State, Pincode, LocationType, HospitalTypeRefId, HospitalTiming, HospitalFooterNote, HospitalLogo
				, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy  , Location , HouseBuilding) 
				VALUES (@HospitalName, @LocationId, @Area, @Taluka, @District, @State, @Pincode, @LocationType, @HospitalTypeRefId, @HospitalTiming, @HospitalFooterNote, @HospitalLogo
				, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy  , @Location , @HouseBuilding) 

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

					If @v_Identity > 0
					Begin
						insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy)
						values (12, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)
					End
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
				             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
			 UPDATE hospital.tblHospital 
			  SET HospitalName=@HospitalName 
				, LocationId=@LocationId 
				, Area=@Area
				, Taluka=@Taluka
				, District=@District
				, State=@State
				, Pincode=@Pincode
				, LocationType=@LocationType
				, HospitalTypeRefId=@HospitalTypeRefId
				, HospitalTiming=@HospitalTiming
				, HospitalFooterNote=@HospitalFooterNote
				, HospitalLogo=@HospitalLogo
				, IsActive=@IsActive 
				, IsEdited=@IsEdited         
				, UpdatedDate=@UpdatedDate         
				, UpdatedBy=@UpdatedBy 
				, Location = @Location
				, HouseBuilding=@HouseBuilding
				 WHERE HospitalId=@HospitalId 


			IF @@ERROR=0
			Begin      
			
				--- Jeet Chauahan New Settings....
				SELECT @v_IsSuccess=1, @v_Identity = @HospitalId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

				if not exists(select top 1 1 from hospital.tblHospitalContacts)
				BEGIN
					
					insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy)
						values (12, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)

				END

				--- Jeet Chauahan New Settings....
				
				ELSE
				BEGIN
					
					

					Update hospital.tblHospitalContacts 
					Set Phone = @Phone
					, LandLine = @LandLine
					, FaxNo = @FaxNo
					, EmailAddress = @EmailAddress
					, UpdatedDate = @UpdatedDate
					, UpdatedBy=@UpdatedBy
					, IsEdited=@IsEdited
					Where ContactEntityRefId=@HospitalId And ContactEntityType=12

				END
				

			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @HospitalId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End 	
		          
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT h.HospitalId, h.HospitalName, h.LocationId, h.Area, h.Taluka, h.District, h.State ,h.Pincode, h.LocationType
			, h.HospitalTypeRefId, ht.RecordName as HospitalType
			, h.HospitalTiming, h.HospitalFooterNote, Location,h.HouseBuilding,
			
			--h.HospitalLogo			
			  CASE 
					WHEN (
						SELECT rh.HospitalLogo 
						FROM hospital.tblReportHeader rh 
						WHERE rh.HospitalId = @HospitalId AND rh.IsTemplateActive = 1
					) is null
					THEN h.HospitalLogo
					ELSE (
						SELECT TOP 1 rh.HospitalLogo 
						FROM hospital.tblReportHeader rh 
						WHERE rh.HospitalId = @HospitalId AND rh.IsTemplateActive = 1
					)
				END AS HospitalLogo
			
			, h.IsActive, h.IsEdited, h.EntryDate, h.UpdatedDate, h.CreatedBy, h.UpdatedBy,
				  hc.Phone, hc.LandLine, hc.FaxNo, hc.EmailAddress, hc.ContactEntityType,	
				  -- isnull((select IsHeaderSelect from hospital.tblReportHeader where HospitalId = @HospitalId and IsTemplateActive = 1),0 )IsHeaderSelect,

				  isnull((select IsTemplateselect from hospital.tbl_UserTemplateSettings where HospitalId = 1 and IsTemplateselect = 1),0 )IsHeaderSelect,

				  --(select headerimage from hospital.tblReportHeader where HospitalId =@HospitalId and IsTemplateActive = 1) HeaderImage	
				  (select headerimage from hospital.tbl_UserTemplateSettings where HospitalId =@HospitalId and IsTemplateselect = 1) HeaderImage	

			FROM hospital.tblHospital h with(nolock)
						LEFT JOIN hospital.tblHospitalContacts hc with(nolock) on h.HospitalId=hc.ContactEntityRefId and hc.ContactEntityType=12
						LEFT JOIN common.tblEntityRecords ht with(nolock) on h.HospitalTypeRefId = ht.EntityRecordId
						 WHERE h.HospitalId=@HospitalId 

		End


		ELSE IF @SubCommand = 'GetKeyFromLicence'
		BEGIN
	
			select top 1  HospitalId from subscription.tblSubscriptions where LicenseKey = @LicenceKey

		END


		ELSE IF @SubCommand='GetAllList' 
		 Begin
			
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				
				declare @totalCount bigint = 10;

				select @totalCount = COUNT(HospitalId) from hospital.tblHospital 
				--set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)

				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@totalCount)

			end

			--SET @WhereQry = ' CO.CompanyId = ' + Convert(varchar, @CompanyId)				
			--SET @WhereQry = ' h.IsActive = ' + Convert(varchar, @IsActive)
			SET @WhereQry = ' h.IsActive in (1,0) '

			If @HospitalId > 0
				SET @WhereQry += ' and h.HospitalId = ' + Convert(varchar, @HospitalId)
			
			--select @OfferStatus = Case When (@OfferStatus is null) Then 1 Else @OfferStatus End
				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'HospitalName'
						Then 'h.HospitalName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(h.HospitalName like ''%' + @SearchKey + '%'' Or h.Area like ''%' + @SearchKey + '%'' Or h.State like ''%' + @SearchKey + '%'' Or h.Pincode like ''%' 
						+ @SearchKey + '%'' Or h.Taluka like ''%' + @SearchKey + '%'' Or h.District like ''%' 
						+ @SearchKey + '%'' Or hc.Phone like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select HospitalId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct h.HospitalId, ' + @SortBy + ' as SortBy
						FROM hospital.tblHospital h with(nolock)
						INNER JOIN hospital.tblHospitalContacts hc with(nolock) on h.HospitalId=hc.ContactEntityRefId and hc.ContactEntityType=12						
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, h.HospitalId, h.HospitalName, h.LocationId, h.Area, h.Taluka, h.District, h.State, h.Pincode, h.LocationType
				, h.HospitalTypeRefId, ht.RecordName as HospitalType
				, h.HospitalTiming, h.HospitalFooterNote, h.HospitalLogo
				, h.IsActive, h.IsEdited, h.EntryDate, h.UpdatedDate, h.CreatedBy, h.UpdatedBy
				, hc.Phone, hc.LandLine, hc.FaxNo, hc.EmailAddress, hc.ContactEntityType, h.Location, h.HouseBuilding			  
				  From CTE 
				  INNER JOIN hospital.tblHospital h with(nolock) ON CTE.HospitalId=h.HospitalId
				  INNER JOIN hospital.tblHospitalContacts hc with(nolock) on h.HospitalId=hc.ContactEntityRefId and hc.ContactEntityType=12
				  LEFT JOIN common.tblEntityRecords ht with(nolock) on h.HospitalTypeRefId = ht.EntityRecordId	
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
			
		 End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tblHospital WHERE HospitalId=@HospitalId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HospitalId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_IndoorRecords]  
    @Command varchar(200) 
  , @HospitalId int=NULL 
  , @IndoorRecordId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @AdmissionDate date=NULL 
  , @AdmissionTime time=NULL 

  --, @AdmissionTime nvarchar(50) = NULL 

  , @IndoorCaseNo nvarchar(50)=NULL 
  , @IndoorDate date=NULL 
  
  , @IndoorTime time=NULL 
  --, @IndoorTime nvarchar(50) = NULL 

  , @TemperatureRefId bigint=NULL 
  , @Pulse int=NULL 
  , @SysBP int=NULL 
  , @DaisBP int=NULL 
  , @SPO2 float=NULL 
  , @PallorRefId bigint=NULL 
  , @IcterusRefId bigint=NULL 
  , @OedemaRefId bigint=NULL 
  , @RS nvarchar(50)=NULL 
  , @CVS nvarchar(50)=NULL 
  , @UTWeeksRefId bigint=NULL 
  , @EBPPRefId bigint=NULL 
  , @FHSRefId bigint=NULL 
  , @UTContRefId nchar(10)=NULL 
  , @PSRefId bigint=NULL 
  , @PVRefId bigint=NULL 
  , @ProvisionalDiagnosisRefId bigint=NULL 

  , @ProvisionalDiagnosis nvarchar(max) = NULL 

  , @OperationNameRefId bigint=NULL 
  , @OTDate date=NULL 
  
  , @OTTime time=NULL 
  --, @OTTime nvarchar(50) = NULL 
  
  , @DiagnosisRefId bigint=NULL 
  , @DischargeDate date=NULL 
 
   , @DischargeTime time=NULL 
   --, @DischargeTime nvarchar(50) = NULL 

 , @AdviceGroup nvarchar(MAX)=NULL 
  , @AdviceDetails nvarchar(MAX)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  , @Surgeon nvarchar(500) = null
  , @Anesthetist nvarchar(500) = null
  , @SrNo bigint = 0

  ,@Diagnosis nvarchar(max) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	declare @InsertSrNo bigint = 0;
	set @InsertSrNo = ( select top 1 isnull(srno,0) from patient.tblIndoorRecords order by srno desc)
	
	If Not Exists (select top 1 isnull(srno,0) from patient.tblIndoorRecords order by srno desc)
	BEGIN
		Set @SrNo =  1
	END
	ELSE
	BEGIN
		Set @SrNo = @InsertSrNo + 1
	END

	

	set @IndoorCaseNo = (select CAST((@SrNo) as nvarchar(500)) + '-' + cast(year(@AdmissionDate)as nvarchar(10)) + '/'  + cast(month(@AdmissionDate)as nvarchar(10)))

      INSERT INTO patient.tblIndoorRecords  
         (PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
		 , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
		 , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId
		 , OperationNameRefId, OTDate, OTTime
		 , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , Surgeon , Anesthetist , SrNo , ProvisionalDiagnosis , Diagnosis) 
       
	   VALUES (@PatientId, @CaseId, @VisitId, @AdmissionDate, cast( @AdmissionTime as time), @IndoorCaseNo, @IndoorDate, @IndoorTime
	   , @TemperatureRefId, @Pulse, @SysBP, @DaisBP, @SPO2, @PallorRefId, @IcterusRefId, @OedemaRefId, @RS, @CVS
	   , @UTWeeksRefId, @EBPPRefId, @FHSRefId, @UTContRefId, @PSRefId, @PVRefId, @ProvisionalDiagnosisRefId
	   , @OperationNameRefId, @OTDate, cast(@OTTime as time)
	   , @DiagnosisRefId, @DischargeDate, cast( @DischargeTime as time), @AdviceGroup, @AdviceDetails
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @Surgeon , @Anesthetist , @SrNo , @ProvisionalDiagnosis, @Diagnosis)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      
	  UPDATE patient.tblIndoorRecords 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , AdmissionDate=@AdmissionDate 
        
		, AdmissionTime= cast( @AdmissionTime as time)
        
		--, IndoorCaseNo=@IndoorCaseNo 
        
		, IndoorDate=@IndoorDate 
        
		--, IndoorTime= cast( @IndoorTime as time)

        , TemperatureRefId=@TemperatureRefId 
        , Pulse=@Pulse 
        , SysBP=@SysBP 
        , DaisBP=@DaisBP 
        , SPO2=@SPO2 
        , PallorRefId=@PallorRefId 
        , IcterusRefId=@IcterusRefId 
        , OedemaRefId=@OedemaRefId 
        , RS=@RS 
        , CVS=@CVS 
        , UTWeeksRefId=@UTWeeksRefId 
        , EBPPRefId=@EBPPRefId 
        , FHSRefId=@FHSRefId 
        , UTContRefId=@UTContRefId 
        , PSRefId=@PSRefId 
        , PVRefId=@PVRefId 
        , ProvisionalDiagnosisRefId=@ProvisionalDiagnosisRefId 
        , OperationNameRefId=@OperationNameRefId 
        , OTDate=@OTDate 
       
	   , OTTime= cast( @OTTime as time)
       
	   , DiagnosisRefId=@DiagnosisRefId 
       
	   , DischargeDate=@DischargeDate 
       
	   , DischargeTime = cast(@DischargeTime as time)
       
	   , AdviceGroup=@AdviceGroup 
        , AdviceDetails=@AdviceDetails 
        , IsEdited=@IsEdited 
      
	  -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, Surgeon = @Surgeon
		, Anesthetist = @Anesthetist

		,ProvisionalDiagnosis = @ProvisionalDiagnosis
		,Diagnosis = @Diagnosis

         WHERE IndoorRecordId=@IndoorRecordId    
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @IndoorRecordId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			
			--select top 1 @VisitId = VisitId, @PatientId = PatientId from patient.tblIndoorRecords where VisitId = @VisitId

			--select PrimaryRelativeNameSuffix from patient.tblPatients where PatientId = @PatientId

		    SELECT IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId, ProvisionalDiagnosis
			  , OperationNameRefId
			  , operationType.RecordName as OperationName
			  , OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , i.IsEdited, i.EntryDate, i.UpdatedDate, i.CreatedBy, i.UpdatedBy , i.Surgeon , i.Anesthetist , i.Diagnosis
			  FROM  patient.tblIndoorRecords i
			  left join common.tblEntityRecords operationType on operationType.EntityRecordId = i.OperationNameRefId
			  WHERE IndoorRecordId=@IndoorRecordId 
		End

		
		ELSE IF @SubCommand  = 'SelectSingleFromVisit'
		BEGIN
			 SELECT top 1 IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId, ProvisionalDiagnosis
			  , OperationNameRefId
			  , operationType.RecordName as OperationName
			  , OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , i.IsEdited, i.EntryDate, i.UpdatedDate, i.CreatedBy, i.UpdatedBy , i.Surgeon , i.Anesthetist , i.Diagnosis
			  FROM  patient.tblIndoorRecords i
			   left join common.tblEntityRecords operationType on operationType.EntityRecordId = i.OperationNameRefId
			  
			  WHERE VisitId=@VisitId 
		END


		If @SubCommand = 'IsIndoorRoundRecordPresent'
		Begin
		    
			
			--IF Exists (SELECT  top 1 IndoorRecordId  from patient.tbl_IndoorRoundRecords where VisitId = @VisitId)
			IF Exists (SELECT  top 1 IndoorRecordId  from patient.tblIndoorRecords where VisitId = @VisitId)
			BEGIN
				select 1 as IsPresent
			END
			ELSE
			BEGIN
				select 0 as IsPresent
			END

		End

		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
		    SELECT top 1 IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId,ProvisionalDiagnosis
			  , OperationNameRefId, OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,Surgeon , Anesthetist , Diagnosis
			  FROM  patient.tblIndoorRecords 
			  WHERE PatientId=@PatientId
			  order by EntryDate desc
		End


		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' ir.PatientId = ' + CONVERT(varchar(20), @PatientId)				
			
			If @CaseId > 0
				SET @WhereQry += ' And ir.CaseId = ' + Convert(varchar(20), @CaseId)		
			If @PatientId > 0
				SET @WhereQry += ' And ir.PatientId = ' + Convert(varchar(20), @PatientId)	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.IndoorRecordId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct ir.IndoorRecordId, ' + @SortBy + ' as SortBy
						 FROM patient.tblIndoorRecords ir with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount			
				, ir.IndoorRecordId, PatientId, CaseId, VisitId
				, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
				, TemperatureRefId, tmp.RecordName as Temperature
				, Pulse, SysBP, DaisBP, SPO2
				, PallorRefId, pal.RecordName as Pallor
				, IcterusRefId, ict.RecordName as Icterus
				, OedemaRefId, oed.RecordName as Oedema
				, RS, CVS
				, UTWeeksRefId, UTWeeksRefId as UTWeeks
				, EBPPRefId, ebpp.RecordName as EBPP
				, FHSRefId, fhs.RecordName as FHS
				, UTContRefId, utc.RecordName as UTCont
				, PSRefId, ps.RecordName as PS
				, PVRefId, pv.RecordName as PV
				, ProvisionalDiagnosisRefId, pd.RecordName as ProvisionalDiagnosis
				, OperationNameRefId, opn.RecordName as OperationName
				, OTDate, OTTime
				, DiagnosisRefId, dia.RecordName as Diagnosis
				, ir.ProvisionalDiagnosis
				, ir.Diagnosis
				, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
				, ir.IsEdited, ir.EntryDate, ir.UpdatedDate, ir.CreatedBy, ir.UpdatedBy		,Surgeon , Anesthetist						  
				  From CTE 
				  INNER JOIN patient.tblIndoorRecords ir with(nolock) ON CTE.IndoorRecordId=ir.IndoorRecordId
				  LEFT JOIN common.tblEntityRecords tmp with(nolock) on ir.TemperatureRefId = tmp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pal with(nolock) on ir.PallorRefId = pal.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ict with(nolock) on ir.IcterusRefId = ict.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oed with(nolock) on ir.OedemaRefId = oed.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on ir.EBPPRefId = ebpp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords fhs with(nolock) on ir.FHSRefId = fhs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords utc with(nolock) on ir.UTContRefId = utc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ps with(nolock) on ir.PSRefId = ps.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pv with(nolock) on ir.PVRefId = pv.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pd with(nolock) on ir.ProvisionalDiagnosisRefId = pd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords opn with(nolock) on ir.OperationNameRefId = opn.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dia with(nolock) on ir.DiagnosisRefId = dia.EntityRecordId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
  
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  --DELETE FROM patient.tblIndoorRecords WHERE IndoorRecordId=@IndoorRecordId 

	  
    
	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblIndoorRecords WHERE IndoorRecordId=@IndoorRecordId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblIndoorRecords WHERE VisitId=@VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRecords_19042025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_IndoorRecords_19042025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @IndoorRecordId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @AdmissionDate date=NULL 
  , @AdmissionTime time=NULL 
  , @IndoorCaseNo nvarchar(50)=NULL 
  , @IndoorDate date=NULL 
  , @IndoorTime time=NULL 
  , @TemperatureRefId bigint=NULL 
  , @Pulse int=NULL 
  , @SysBP int=NULL 
  , @DaisBP int=NULL 
  , @SPO2 float=NULL 
  , @PallorRefId bigint=NULL 
  , @IcterusRefId bigint=NULL 
  , @OedemaRefId bigint=NULL 
  , @RS nvarchar(50)=NULL 
  , @CVS nvarchar(50)=NULL 
  , @UTWeeksRefId bigint=NULL 
  , @EBPPRefId bigint=NULL 
  , @FHSRefId bigint=NULL 
  , @UTContRefId nchar(10)=NULL 
  , @PSRefId bigint=NULL 
  , @PVRefId bigint=NULL 
  , @ProvisionalDiagnosisRefId bigint=NULL 

  , @ProvisionalDiagnosis nvarchar(max) = NULL 

  , @OperationNameRefId bigint=NULL 
  , @OTDate date=NULL 
  , @OTTime time=NULL 
  , @DiagnosisRefId bigint=NULL 
  , @DischargeDate date=NULL 
  , @DischargeTime time=NULL 
  , @AdviceGroup nvarchar(MAX)=NULL 
  , @AdviceDetails nvarchar(MAX)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  , @Surgeon nvarchar(500) = null
  , @Anesthetist nvarchar(500) = null
  , @SrNo bigint = 0

  ,@Diagnosis nvarchar(max) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	declare @InsertSrNo bigint = 0;
	set @InsertSrNo = ( select top 1 isnull(srno,0) from patient.tblIndoorRecords order by srno desc)
	
	If Not Exists (select top 1 isnull(srno,0) from patient.tblIndoorRecords order by srno desc)
	BEGIN
		Set @SrNo =  1
	END
	ELSE
	BEGIN
		Set @SrNo = @InsertSrNo + 1
	END

	

	set @IndoorCaseNo = (select CAST((@SrNo) as nvarchar(500)) + '-' + cast(year(@AdmissionDate)as nvarchar(10)) + '/'  + cast(month(@AdmissionDate)as nvarchar(10)))

      INSERT INTO patient.tblIndoorRecords  
         (PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
		 , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
		 , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId
		 , OperationNameRefId, OTDate, OTTime
		 , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , Surgeon , Anesthetist , SrNo , ProvisionalDiagnosis , Diagnosis) 
       
	   VALUES (@PatientId, @CaseId, @VisitId, @AdmissionDate, @AdmissionTime, @IndoorCaseNo, @IndoorDate, @IndoorTime
	   , @TemperatureRefId, @Pulse, @SysBP, @DaisBP, @SPO2, @PallorRefId, @IcterusRefId, @OedemaRefId, @RS, @CVS
	   , @UTWeeksRefId, @EBPPRefId, @FHSRefId, @UTContRefId, @PSRefId, @PVRefId, @ProvisionalDiagnosisRefId
	   , @OperationNameRefId, @OTDate, @OTTime
	   , @DiagnosisRefId, @DischargeDate, @DischargeTime, @AdviceGroup, @AdviceDetails
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @Surgeon , @Anesthetist , @SrNo , @ProvisionalDiagnosis, @Diagnosis)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblIndoorRecords 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , AdmissionDate=@AdmissionDate 
        , AdmissionTime=@AdmissionTime 
        --, IndoorCaseNo=@IndoorCaseNo 
        , IndoorDate=@IndoorDate 
        , IndoorTime=@IndoorTime 
        , TemperatureRefId=@TemperatureRefId 
        , Pulse=@Pulse 
        , SysBP=@SysBP 
        , DaisBP=@DaisBP 
        , SPO2=@SPO2 
        , PallorRefId=@PallorRefId 
        , IcterusRefId=@IcterusRefId 
        , OedemaRefId=@OedemaRefId 
        , RS=@RS 
        , CVS=@CVS 
        , UTWeeksRefId=@UTWeeksRefId 
        , EBPPRefId=@EBPPRefId 
        , FHSRefId=@FHSRefId 
        , UTContRefId=@UTContRefId 
        , PSRefId=@PSRefId 
        , PVRefId=@PVRefId 
        , ProvisionalDiagnosisRefId=@ProvisionalDiagnosisRefId 
        , OperationNameRefId=@OperationNameRefId 
        , OTDate=@OTDate 
        , OTTime=@OTTime 
        , DiagnosisRefId=@DiagnosisRefId 
        , DischargeDate=@DischargeDate 
        , DischargeTime=@DischargeTime 
        , AdviceGroup=@AdviceGroup 
        , AdviceDetails=@AdviceDetails 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, Surgeon = @Surgeon
		, Anesthetist = @Anesthetist

		,ProvisionalDiagnosis = @ProvisionalDiagnosis
		,Diagnosis = @Diagnosis

         WHERE IndoorRecordId=@IndoorRecordId    
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @IndoorRecordId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			
			--select top 1 @VisitId = VisitId, @PatientId = PatientId from patient.tblIndoorRecords where VisitId = @VisitId

			--select PrimaryRelativeNameSuffix from patient.tblPatients where PatientId = @PatientId

		    SELECT IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId, ProvisionalDiagnosis
			  , OperationNameRefId
			  , operationType.RecordName as OperationName
			  , OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , i.IsEdited, i.EntryDate, i.UpdatedDate, i.CreatedBy, i.UpdatedBy , i.Surgeon , i.Anesthetist , i.Diagnosis
			  FROM  patient.tblIndoorRecords i
			  left join common.tblEntityRecords operationType on operationType.EntityRecordId = i.OperationNameRefId
			  WHERE IndoorRecordId=@IndoorRecordId 
		End

		
		ELSE IF @SubCommand  = 'SelectSingleFromVisit'
		BEGIN
			 SELECT top 1 IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId, ProvisionalDiagnosis
			  , OperationNameRefId
			  , operationType.RecordName as OperationName
			  , OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , i.IsEdited, i.EntryDate, i.UpdatedDate, i.CreatedBy, i.UpdatedBy , i.Surgeon , i.Anesthetist , i.Diagnosis
			  FROM  patient.tblIndoorRecords i
			   left join common.tblEntityRecords operationType on operationType.EntityRecordId = i.OperationNameRefId
			  
			  WHERE VisitId=@VisitId 
		END


		If @SubCommand = 'IsIndoorRoundRecordPresent'
		Begin
		    
			
			--IF Exists (SELECT  top 1 IndoorRecordId  from patient.tbl_IndoorRoundRecords where VisitId = @VisitId)
			IF Exists (SELECT  top 1 IndoorRecordId  from patient.tblIndoorRecords where VisitId = @VisitId)
			BEGIN
				select 1 as IsPresent
			END
			ELSE
			BEGIN
				select 0 as IsPresent
			END

		End

		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
		    SELECT top 1 IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId,ProvisionalDiagnosis
			  , OperationNameRefId, OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,Surgeon , Anesthetist , Diagnosis
			  FROM  patient.tblIndoorRecords 
			  WHERE PatientId=@PatientId
			  order by EntryDate desc
		End


		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' ir.PatientId = ' + CONVERT(varchar(20), @PatientId)				
			
			If @CaseId > 0
				SET @WhereQry += ' And ir.CaseId = ' + Convert(varchar(20), @CaseId)		
			If @PatientId > 0
				SET @WhereQry += ' And ir.PatientId = ' + Convert(varchar(20), @PatientId)	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.IndoorRecordId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct ir.IndoorRecordId, ' + @SortBy + ' as SortBy
						 FROM patient.tblIndoorRecords ir with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount			
				, ir.IndoorRecordId, PatientId, CaseId, VisitId
				, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
				, TemperatureRefId, tmp.RecordName as Temperature
				, Pulse, SysBP, DaisBP, SPO2
				, PallorRefId, pal.RecordName as Pallor
				, IcterusRefId, ict.RecordName as Icterus
				, OedemaRefId, oed.RecordName as Oedema
				, RS, CVS
				, UTWeeksRefId, UTWeeksRefId as UTWeeks
				, EBPPRefId, ebpp.RecordName as EBPP
				, FHSRefId, fhs.RecordName as FHS
				, UTContRefId, utc.RecordName as UTCont
				, PSRefId, ps.RecordName as PS
				, PVRefId, pv.RecordName as PV
				, ProvisionalDiagnosisRefId, pd.RecordName as ProvisionalDiagnosis
				, OperationNameRefId, opn.RecordName as OperationName
				, OTDate, OTTime
				, DiagnosisRefId, dia.RecordName as Diagnosis
				, ir.ProvisionalDiagnosis
				, ir.Diagnosis
				, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
				, ir.IsEdited, ir.EntryDate, ir.UpdatedDate, ir.CreatedBy, ir.UpdatedBy		,Surgeon , Anesthetist						  
				  From CTE 
				  INNER JOIN patient.tblIndoorRecords ir with(nolock) ON CTE.IndoorRecordId=ir.IndoorRecordId
				  LEFT JOIN common.tblEntityRecords tmp with(nolock) on ir.TemperatureRefId = tmp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pal with(nolock) on ir.PallorRefId = pal.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ict with(nolock) on ir.IcterusRefId = ict.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oed with(nolock) on ir.OedemaRefId = oed.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on ir.EBPPRefId = ebpp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords fhs with(nolock) on ir.FHSRefId = fhs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords utc with(nolock) on ir.UTContRefId = utc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ps with(nolock) on ir.PSRefId = ps.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pv with(nolock) on ir.PVRefId = pv.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pd with(nolock) on ir.ProvisionalDiagnosisRefId = pd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords opn with(nolock) on ir.OperationNameRefId = opn.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dia with(nolock) on ir.DiagnosisRefId = dia.EntityRecordId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
  
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  --DELETE FROM patient.tblIndoorRecords WHERE IndoorRecordId=@IndoorRecordId 

	  
    
	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblIndoorRecords WHERE IndoorRecordId=@IndoorRecordId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblIndoorRecords WHERE VisitId=@VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_IndoorRoundRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_IndoorRoundRecords]  
   @Command varchar(200) 
  , @WRoundId bigint=NULL 
  , @IndoorRecordId bigint=NULL 
  , @HospitalId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  --, @IndoorDate date=NULL 

  , @IndoorDate nvarchar(50) = NULL 

  , @IndoorTime time=NULL 
  , @TemperatureRefId int=NULL 
  , @Pulse int=NULL 
  , @SysBP int=NULL 
  , @DaisBP int=NULL 
  , @SPO2 float=NULL 
  , @PallorRefId bigint=NULL 
  , @IcterusRefId bigint=NULL 
  , @OedemaRefId bigint=NULL 
  , @RS nvarchar(255)=NULL 
  , @CVS nvarchar(255)=NULL 
  --, @UTWeeksRefId bigint=NULL 
  --, @EBPPRefId bigint=NULL 

  , @UTWeeksRefId nvarchar(max) = NULL 
  , @EBPPRefId nvarchar(max) = NULL 

  , @FHSRefId bigint=NULL 
  , @UTContRefId nvarchar(MAX)=NULL 
  , @PSRefId bigint=NULL 
  , @PVRefId bigint=NULL 
  , @PatientType int=NULL 
  , @OperativeType nvarchar(138)=NULL 
  , @SrNo bigint=NULL 
  , @EntryDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedDate datetime=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='WRoundId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  , @AdviceDetails nvarchar(max) = null
  , @AdviceGroup nvarchar(max) = null

  , @printIds nvarchar(max) = ''
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0 , @v_PagingQry varchar(2000)='';
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_IndoorRoundRecords  
         (IndoorRecordId, HospitalId, PatientId, CaseId, VisitId, IndoorDate, IndoorTime, TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS, UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, PatientType, OperativeType, SrNo, EntryDate, CreatedBy, UpdatedDate, UpdatedBy , AdviceDetails, AdviceGroup) 
       VALUES (@IndoorRecordId, @HospitalId, @PatientId, @CaseId, @VisitId, @IndoorDate, cast( @IndoorTime as time), @TemperatureRefId, @Pulse, @SysBP, @DaisBP, @SPO2, @PallorRefId, @IcterusRefId, @OedemaRefId, @RS, @CVS, @UTWeeksRefId, @EBPPRefId, @FHSRefId, @UTContRefId, @PSRefId, @PVRefId, @PatientType, @OperativeType, @SrNo, @EntryDate, @CreatedBy, @UpdatedDate, @UpdatedBy , @AdviceDetails , @AdviceGroup)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_IndoorRoundRecords 
	  SET IndoorRecordId=@IndoorRecordId 
        , HospitalId=@HospitalId 
        , PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , IndoorDate=@IndoorDate 
        , IndoorTime = CAST( @IndoorTime as time)
        , TemperatureRefId=@TemperatureRefId 
        , Pulse=@Pulse 
        , SysBP=@SysBP 
        , DaisBP=@DaisBP 
        , SPO2=@SPO2 
        , PallorRefId=@PallorRefId 
        , IcterusRefId=@IcterusRefId 
        , OedemaRefId=@OedemaRefId 
        , RS=@RS 
        , CVS=@CVS 
        , UTWeeksRefId=@UTWeeksRefId 
        , EBPPRefId=@EBPPRefId 
        , FHSRefId=@FHSRefId 
        , UTContRefId=@UTContRefId 
        , PSRefId=@PSRefId 
        , PVRefId=@PVRefId 
        , PatientType=@PatientType 
        , OperativeType=@OperativeType 
        , SrNo=@SrNo 
        --, EntryDate=@EntryDate 
        , CreatedBy=@CreatedBy 
        , UpdatedDate=@UpdatedDate 
        , UpdatedBy=@UpdatedBy 
		,AdviceDetails = @AdviceDetails
		,AdviceGroup = @AdviceGroup
         WHERE WRoundId=@WRoundId     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @WRoundId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @WRoundId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		
		IF @SubCommand = 'SelectSrNo'
		BEGIN
			select (count(SrNo) + 1) as MaxSrNo from patient.tbl_IndoorRoundRecords 
			
			--where  VisitId = @VisitId and PatientId = @PatientId
		END

		Else if @SubCommand='GetAllList' 
		Begin
			--select 1
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			

			SET @WhereQry = ' ir.PatientId = ' + CONVERT(varchar(20), @PatientId)				
			
			If @CaseId > 0
				SET @WhereQry += ' And ir.CaseId = ' + Convert(varchar(20), @CaseId)		
			If @PatientId > 0
				SET @WhereQry += ' And ir.PatientId = ' + Convert(varchar(20), @PatientId)
				
			If @VisitId > 0
				SET @WhereQry += ' And ir.VisitId = ' + Convert(varchar(20), @VisitId)

			--select @WhereQry
			
			--print @WhereQry	
			
			set @BaseQry = '
				;With CTE AS (
					 SELECT 
						a.WRoundId, 
						ROW_NUMBER() OVER (ORDER BY SortBy ' + @SortOrder + ' ) AS RowId 
					FROM (
						SELECT DISTINCT ir.WRoundId, ir.WRoundId AS SortBy
						FROM patient.tbl_IndoorRoundRecords ir WITH (NOLOCK)
						WHERE ' + @WhereQry + '
					) A
				) Select distinct 
				 CTE.RowId
				, ir.IndoorRecordId
				, ir.WRoundId, ir.PatientId, ir.CaseId, ir.VisitId
				, ire.IndoorCaseNo  
				, ir.IndoorDate
				, ir.IndoorTime
				, ir.TemperatureRefId, tmp.RecordName as Temperature
				, ir.Pulse, ir.SysBP, ir.DaisBP, ir.SPO2
				, ir.PallorRefId, pal.RecordName as Pallor
				, ir.IcterusRefId, ict.RecordName as Icterus
				, ir.OedemaRefId, oed.RecordName as Oedema
				, ir.RS, ir.CVS
				
				, ir.UTWeeksRefId, ir.UTWeeksRefId as UTWeeks
				
				, isnull(ir.EBPPRefId,0) as EBPPRefId 

				--,ire.ProvisionalDiagnosis as ProvisionalDiagnosis

				, STUFF((
					
						SELECT '', '' + CONCAT(ROW_NUMBER() OVER (ORDER BY (SELECT NULL)), '') '', LTRIM(RTRIM(value)))
						FROM STRING_SPLIT(ire.ProvisionalDiagnosis, '','')
						WHERE LTRIM(RTRIM(value)) <> ''''
						FOR XML PATH('''')
					), 1, 2, '''') AS ProvisionalDiagnosis

				,case when isnull(ebpp.RecordName,'''') = '''' then ir.EBPPRefId else ebpp.RecordName end as EBPP

				, ir.FHSRefId, fhs.RecordName as FHS
				, ir.UTContRefId, utc.RecordName as UTCont
				, ir.PSRefId, ps.RecordName as PS
				, ir.PVRefId, pv.RecordName as PV
				
			
				, ir.AdviceGroup
				
				--, ir.AdviceDetails
				
				,ir.OperativeType 

				, STUFF((
					SELECT '' # '' + CONCAT(
						ROW_NUMBER() OVER (ORDER BY CAST(JSON_VALUE(item.value, ''$.adviceId'') AS INT)), 
						'') '', 
						JSON_VALUE(item.value, ''$.advice''),
						'' ('',
						JSON_VALUE(item.value, ''$.detail''),
						'')''
					)
					FROM OPENJSON(ir.AdviceDetails) AS item
					FOR XML PATH('''')
				), 1, 2, '''') AS AdviceDetails

				
				, ir.EntryDate, ir.UpdatedDate, ir.CreatedBy, ir.UpdatedBy								  
				  From CTE 
				  
				  INNER JOIN patient.tbl_IndoorRoundRecords ir with(nolock) ON CTE.WRoundId=ir.WRoundId
				 
				 INNER JOIN patient.tblIndoorRecords ire with(nolock) ON ire.IndoorRecordId=ir.IndoorRecordId

				  LEFT JOIN common.tblEntityRecords tmp with(nolock) on ir.TemperatureRefId = tmp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pal with(nolock) on ir.PallorRefId = pal.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ict with(nolock) on ir.IcterusRefId = ict.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oed with(nolock) on ir.OedemaRefId = oed.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords fhs with(nolock) on ir.FHSRefId = fhs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords utc with(nolock) on ir.UTContRefId = utc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ps with(nolock) on ir.PSRefId = ps.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pv with(nolock) on ir.PVRefId = pv.EntityRecordId
				 

				   LEFT JOIN common.tblEntityRecords ebpp with(nolock) on 
						CASE 
							WHEN TRY_CAST(ir.EBPPRefId AS INT) IS NOT NULL 
								THEN TRY_CAST(ir.EBPPRefId AS INT)
							ELSE NULL 
						END = ebpp.EntityRecordId

				

				  ' + @v_PagingQry + ' 
				  Order by ir.IndoorTime asc	'	
				
			--Print (@BaseQry);
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)

		End

		ELSE IF @SubCommand = 'PrintWround'
		BEGIN

			DECLARE @ids nvarchar(max) = @printIds

			DECLARE @WindoorIdsTable TABLE (id bigint)

			INSERT INTO @WindoorIdsTable (id)
			SELECT CAST(value AS bigint)
			FROM STRING_SPLIT(@ids, ',')

				;With CTE AS (
						 SELECT 
							a.WRoundId, 
							ROW_NUMBER() OVER (ORDER BY SortBy asc ) AS RowId 
						FROM (
							SELECT DISTINCT ir.WRoundId, ir.WRoundId AS SortBy
							FROM patient.tbl_IndoorRoundRecords ir WITH (NOLOCK)
							WHERE 1=1
						) A
					) Select distinct 
					 CTE.RowId
					, ir.IndoorRecordId
					, ir.WRoundId, ir.PatientId, ir.CaseId, ir.VisitId
					, ire.IndoorCaseNo  
					, ir.IndoorDate, ir.IndoorTime
					, ir.TemperatureRefId, tmp.RecordName as Temperature
					, ir.Pulse, ir.SysBP, ir.DaisBP, ir.SPO2
					, ir.PallorRefId, pal.RecordName as Pallor
					, ir.IcterusRefId, ict.RecordName as Icterus
					, ir.OedemaRefId, oed.RecordName as Oedema
					, ir.RS, ir.CVS
					,ir.OperativeType 
					,ir. SrNo
					, ir.UTWeeksRefId, ir.UTWeeksRefId as UTWeeks
				
					, isnull(ir.EBPPRefId,0) as EBPPRefId 

					, ire.ProvisionalDiagnosis as ProvisionalDiagnosis

					,case when isnull(ebpp.RecordName,'') = '' then ir.EBPPRefId else ebpp.RecordName end as EBPP

					, ir.FHSRefId, fhs.RecordName as FHS
					, ir.UTContRefId, utc.RecordName as UTCont
					, ir.PSRefId, ps.RecordName as PS
					, ir.PVRefId, pv.RecordName as PV
				
			
					, ir.AdviceGroup
					
					--, ir.AdviceDetails

					, STUFF((
					SELECT ' # ' + CONCAT(
						ROW_NUMBER() OVER (ORDER BY CAST(JSON_VALUE(item.value, '$.adviceId') AS INT)), 
						') ', 
						JSON_VALUE(item.value, '$.advice'),
						' (',
						JSON_VALUE(item.value, '$.detail'),
						')'
					)
					FROM OPENJSON(ir.AdviceDetails) AS item
					FOR XML PATH('')
				), 1, 2, '') AS AdviceDetails

				
					, ir.EntryDate, ir.UpdatedDate, ir.CreatedBy, ir.UpdatedBy								  
					  From CTE 
				  
					  INNER JOIN patient.tbl_IndoorRoundRecords ir with(nolock) ON CTE.WRoundId=ir.WRoundId
				 
					 INNER JOIN patient.tblIndoorRecords ire with(nolock) ON ire.IndoorRecordId=ir.IndoorRecordId

					  LEFT JOIN common.tblEntityRecords tmp with(nolock) on ir.TemperatureRefId = tmp.EntityRecordId
					  LEFT JOIN common.tblEntityRecords pal with(nolock) on ir.PallorRefId = pal.EntityRecordId
					  LEFT JOIN common.tblEntityRecords ict with(nolock) on ir.IcterusRefId = ict.EntityRecordId
					  LEFT JOIN common.tblEntityRecords oed with(nolock) on ir.OedemaRefId = oed.EntityRecordId
				  
					  LEFT JOIN common.tblEntityRecords fhs with(nolock) on ir.FHSRefId = fhs.EntityRecordId
					  LEFT JOIN common.tblEntityRecords utc with(nolock) on ir.UTContRefId = utc.EntityRecordId
					  LEFT JOIN common.tblEntityRecords ps with(nolock) on ir.PSRefId = ps.EntityRecordId
					  LEFT JOIN common.tblEntityRecords pv with(nolock) on ir.PVRefId = pv.EntityRecordId
				 

					   LEFT JOIN common.tblEntityRecords ebpp with(nolock) on 
							CASE 
								WHEN TRY_CAST(ir.EBPPRefId AS INT) IS NOT NULL 
									THEN TRY_CAST(ir.EBPPRefId AS INT)
								ELSE NULL 
							END = ebpp.EntityRecordId

					where ir.WRoundId in (select id from @WindoorIdsTable)

					  Order by WRoundId	
		END

		ELSE IF @SubCommand  = 'SelectSingleFromVisit'
		BEGIN
			SELECT top 1 WRoundId, IndoorRecordId, HospitalId, PatientId, CaseId, VisitId, IndoorDate, IndoorTime, TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS, UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, PatientType, OperativeType, SrNo, EntryDate, CreatedBy, UpdatedDate, UpdatedBy , AdviceDetails, AdviceGroup FROM  patient.tbl_IndoorRoundRecords WHERE VisitId=@VisitId
		END

		ELSE
		BEGIN
			SELECT WRoundId, IndoorRecordId, HospitalId, PatientId, CaseId, VisitId, IndoorDate, IndoorTime, TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS, UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, PatientType, OperativeType, SrNo, EntryDate, CreatedBy, UpdatedDate, UpdatedBy , AdviceDetails, AdviceGroup FROM  patient.tbl_IndoorRoundRecords WHERE WRoundId=@WRoundId 
		END
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

		IF @SubCommand = 'DeleteFromId'
		  BEGIN
			DELETE FROM patient.tbl_IndoorRoundRecords WHERE WRoundId=@WRoundId
		  END
		  ELSE IF (@SubCommand = 'DeleteFromVisits')
		  BEGIN
			DELETE FROM patient.tblIndoorRecords WHERE VisitId=@VisitId
		 END

		
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @WRoundId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Items]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Items]  
   @Command varchar(200) 
  , @ItemId bigint=NULL 
  , @ItemName nvarchar(500)=NULL 
  , @Price money=NULL 
  , @BatchNumber nvarchar(100)=NULL 
  , @ManufacturingDate datetime=NULL
  , @ManufacturingMonth int=NULL
  , @ManufacturingYear int=NULL
  , @ExpiryDate datetime=NULL
  , @ExpiryMonth int=NULL
  , @ExpiryYear int=NULL
  , @IsItemActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='ItemId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  , @ExpMonth nvarchar(50) = null
  , @MfgMonth nvarchar(50) = null
  
  ,@ManufacturingBy nvarchar(max) = null
  ,@Weeks nvarchar(50) = null
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	IF NOT EXISTS (select * from hospital.tblItems where ItemName = @ItemName)
	BEGIN
		 INSERT INTO hospital.tblItems  
         (ItemName, Price, BatchNumber, ManufacturingDate, ManufacturingMonth, ManufacturingYear, ExpiryDate, ExpiryMonth, ExpiryYear,
			IsItemActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , ExpMonth , MfgMonth , ManufacturingBy , Weeks) 

       VALUES (@ItemName, @Price, @BatchNumber, @ManufacturingDate, @ManufacturingMonth, @ManufacturingYear, @ExpiryDate, @ExpiryMonth, @ExpiryYear,
			@IsItemActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @ExpMonth , @MfgMonth , @ManufacturingBy , @Weeks)  
			
			IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End     

	END
	ELSE
	BEGIN
		UPDATE hospital.tblItems 
		SET ItemName=@ItemName 
        , Price=@Price 
        , BatchNumber=@BatchNumber 
        , ManufacturingDate=@ManufacturingDate
		, ManufacturingMonth=@ManufacturingMonth
		, ManufacturingYear=@ManufacturingYear
        , ExpiryDate=@ExpiryDate
		, ExpiryMonth=@ExpiryMonth
		, ExpiryYear=@ExpiryYear
        , IsItemActive=@IsItemActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,ExpMonth = @ExpMonth
		, MfgMonth = @MfgMonth

		,ManufacturingBy = @ManufacturingBy
		, Weeks  = @Weeks

         WHERE ItemName=@ItemName

		 declare @return_identity bigint = 0;
		 select top 1 @return_identity = ItemId from hospital.tblItems where ItemName = trim(@ItemName)

		 IF @@ERROR=0
			Begin               
				SELECT @v_IsSuccess=1, @v_Identity = @return_identity, @v_Message='success',  @v_CustomMessage = 'Updated Successfully!'
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
			End   

	END
        
		        
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE hospital.tblItems SET ItemName=@ItemName 
        , Price=@Price 
        , BatchNumber=@BatchNumber 
        , ManufacturingDate=@ManufacturingDate
		, ManufacturingMonth=@ManufacturingMonth
		, ManufacturingYear=@ManufacturingYear
        , ExpiryDate=@ExpiryDate
		, ExpiryMonth=@ExpiryMonth
		, ExpiryYear=@ExpiryYear
        , IsItemActive=@IsItemActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,ExpMonth = @ExpMonth
		, MfgMonth = @MfgMonth

		,ManufacturingBy = @ManufacturingBy
		, Weeks  = @Weeks
         WHERE ItemId=@ItemId     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ItemId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @ItemId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT ItemId, ItemName, Price, BatchNumber, ManufacturingDate, ManufacturingMonth, ManufacturingYear, ExpiryDate, ExpiryMonth, ExpiryYear
			, IsItemActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , ExpMonth , MfgMonth ,ManufacturingBy
			, ExpMonth , MfgMonth ,Weeks
			FROM  hospital.tblItems WHERE ItemId=@ItemId 
		End
		
		ELSE IF @SubCommand = 'SelectItemByName'
		BEGIN
			SELECT top 1 SerializeData
			FROM  common.tblGroups WHERE GroupId=@ItemName
		END

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1) * @PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			if(@IsItemActive is not null and @IsItemActive=1)
			begin
				SET @WhereQry = ' i.IsItemActive = 1 '
			end
			else
			begin
				SET @WhereQry = ' i.IsItemActive in (1,0) '
			end

							
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				If @SearchType = 'Group'
				Begin
					declare @v_Items varchar(1000) = ''
					
					set @v_Items = (select '''' + Replace(GroupItems,',', ''',''') + '''' from common.tblGroups where GroupId = @SearchKey)

					SET @WhereQry = @WhereQry + ' AND ' 
					+ 'i.ItemName in (' + @v_Items + ')'					

				End
				Else
				Begin
					SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Name'
						Then 'i.ItemName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(i.ItemName like ''%' + @SearchKey + '%'' Or i.BatchNumber like ''%' + @SearchKey + '%'')' 
						
						
					 End
				End

				
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select ItemId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct i.ItemId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblItems i with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, i.ItemId, i.ItemName, i.Price, i.BatchNumber, i.ManufacturingDate, i.ManufacturingMonth, i.ManufacturingYear, i.ExpiryDate, i.ExpiryMonth, i.ExpiryYear,ManufacturingBy, Weeks
				, i.IsItemActive, i.IsEdited, i.EntryDate, i.UpdatedDate, i.CreatedBy, i.UpdatedBy		
				
				, i.ExpMonth , i.MfgMonth
				
				From CTE 
				  INNER JOIN hospital.tblItems i with(nolock) ON CTE.ItemId=i.ItemId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
     
		--DELETE FROM hospital.tblItems WHERE ItemId=@ItemId 
		
		IF @SubCommand = 'deleteSelectedbyId'
		BEGIN
			update hospital.tblItems set IsItemActive = 0 where ItemId = @ItemId
			select 1 as IsSucess
		END

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ItemId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Medicines]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_Medicines]  
   @Command varchar(200) 
  , @MedicineId int=NULL 
  , @MedicineName nvarchar(500)=NULL 
  , @MedicineTypeId bigint=NULL 
  , @MainContent nvarchar(1000)=NULL 
  , @Company nvarchar(500)=NULL 
  , @MorningMedTimeRefId bigint=NULL 
  , @NoonMedTimeRefId bigint=NULL 
  , @EveningMedTimeRefId bigint=NULL 
  , @NightMedTimeRefId bigint=NULL
  , @PrescriptionDays int=NULL 
  , @IsMedicineActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @MorningDose nvarchar(max) = null
  , @NoonDose nvarchar(max) = null
  , @EveningDose nvarchar(max) = null
  , @NightDose nvarchar(max) = null
  , @MedicineType nvarchar(max) = null

  , @Remark nvarchar(max) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)='', @v_meds varchar(100)
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 MedicineId from hospital.tblMedicine with (nolock) where MedicineName=@MedicineName)
		Begin
				INSERT INTO hospital.tblMedicine  
				 (MedicineName, MedicineTypeId, MainContent, Company, MorningMedTimeRefId, NoonMedTimeRefId, EveningMedTimeRefId, NightMedTimeRefId, PrescriptionDays
				 , IsMedicineActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy
				 
				 , MorningMedTimeRef,NoonMedTimeRef,EveningMedTimeRef,NightMedTimeRef , MedicineType
				 , Remark
				 ) 

			   VALUES (@MedicineName, @MedicineTypeId, @MainContent, @Company, @MorningMedTimeRefId, @NoonMedTimeRefId, @EveningMedTimeRefId, @NightMedTimeRefId, @PrescriptionDays
			   , @IsMedicineActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy
			   
			   , @MorningDose , @NoonDose , @EveningDose , @NightDose , @MedicineType
			   , @Remark
			   )    
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End 

				-- -- // Insert into Sync Table =====================================================================
				If Not Exists(Select top 1 MedicineName from sync.tblMedicineNames where LOWER(MedicineName)=LOWER(@MedicineName))
				Begin
					INSERT INTO sync.tblMedicineNames (MedicineName, IsSyncPending, EntryDate)
					VALUES (@MedicineName, 1, GETDATE())
				End
		End
		Else
		Begin

			UPDATE hospital.tblMedicine SET MedicineName=@MedicineName 
					, MedicineTypeId=@MedicineTypeId 
					, MainContent=@MainContent 
					, Company=@Company 
					, MorningMedTimeRefId=@MorningMedTimeRefId 
					, NoonMedTimeRefId=@NoonMedTimeRefId 
					, EveningMedTimeRefId=@EveningMedTimeRefId 
					, NightMedTimeRefId=@NightMedTimeRefId 
					, PrescriptionDays=@PrescriptionDays 
					, IsMedicineActive=@IsMedicineActive 
					, IsEdited=@IsEdited 
					--, EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
					--, CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					, MorningMedTimeRef = @MorningDose
					, NoonMedTimeRef = @NoonDose
					, EveningMedTimeRef = @EveningDose
					, NightMedTimeRef = @NightDose

					,MedicineType = @MedicineType

					,Remark = @Remark

					 WHERE MedicineId=@MedicineId 
			
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Medicine with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If Not Exists (select top 1 MedicineId from hospital.tblMedicine with (nolock) where MedicineName=@MedicineName and MedicineId!=@MedicineId)
		Begin
				  UPDATE hospital.tblMedicine SET MedicineName=@MedicineName 
					, MedicineTypeId=@MedicineTypeId 
					, MainContent=@MainContent 
					, Company=@Company 
					, MorningMedTimeRefId=@MorningMedTimeRefId 
					, NoonMedTimeRefId=@NoonMedTimeRefId 
					, EveningMedTimeRefId=@EveningMedTimeRefId 
					, NightMedTimeRefId=@NightMedTimeRefId 
					, PrescriptionDays=@PrescriptionDays 
					, IsMedicineActive=@IsMedicineActive 
					, IsEdited=@IsEdited 
					--, EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
					--, CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					, MorningMedTimeRef = @MorningDose
					, NoonMedTimeRef = @NoonDose
					, EveningMedTimeRef = @EveningDose
					, NightMedTimeRef = @NightDose

					,MedicineType = @MedicineType

					,Remark = @Remark

					 WHERE MedicineId=@MedicineId 
				 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @MedicineId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @MedicineId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 

					-- -- // Insert into Sync Table =====================================================================
					If Not Exists(Select top 1 MedicineName from sync.tblMedicineNames where LOWER(MedicineName)=LOWER(@MedicineName))
					Begin
						INSERT INTO sync.tblMedicineNames (MedicineName, IsSyncPending, EntryDate)
						VALUES (@MedicineName, 1, GETDATE())
					End

			 End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Another Medicine with this name already exists!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage		
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand='SelectSingle'
		Begin			
			 SELECT top 1  MedicineId, MedicineName, MedicineTypeId, MainContent, 
			  Company, 
			  MorningMedTimeRefId, isnull(morningmedtime.RecordName , isnull(MorningMedTimeRef,'')) as MorningDose,
			  NoonMedTimeRefId, isnull(noonmedtime.RecordName , isnull(NoonMedTimeRef,'')) as NoonDose,
			  EveningMedTimeRefId , isnull(evemedtime.RecordName , isnull(EveningMedTimeRef,'')) as EveningDose, 
			  NightMedTimeRefId, isnull(nightmedtime.RecordName , isnull(NightMedTimeRef,'')) as NightDose,
			  PrescriptionDays
			  , IsMedicineActive, m.IsEdited, m.EntryDate, 
			   isnull(m.UpdatedDate , GETDATE() -1  ) as UpdatedDate , m.CreatedBy, m.UpdatedBy 

			  , MorningMedTimeRef,NoonMedTimeRef,EveningMedTimeRef,NightMedTimeRef 
			  , isnull(medtype.RecordName, isnull(MedicineType,'')) as MedicineType

			  , Remark

			  FROM  hospital.tblMedicine m  with(nolock)
			   LEFT JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
			   LEFT JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
			   LEFT JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
			   LEFT JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
			   LEFT JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId
			  WHERE MedicineId = @MedicineId
		End
		
		Else If @SubCommand='GetAllList' 
		 Begin
			
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0 and 1=0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' m.IsMedicineActive in (1) '
			
			DECLARE @isId BIT = 
						(SELECT CASE 
							WHEN TRY_CAST(@SearchKey AS INT) IS NULL THEN 0 
							ELSE 1 
						END)
			declare @DiagnosisId bigint = 0;

			IF @isId = 0
			BEGIN
				select top 1 @DiagnosisId = DiagnosisId  from hospital.tblDiagnosis where DiagnosisName = @SearchKey
				set @SearchKey = CAST(@DiagnosisId as int)
				set @SearchType = 'DiagnosisWise'
			END


			If ISNULL(@SearchKey,'')!=''
			Begin
				If ISNULL(@SearchType,'')='DiagnosisWise'
				Begin					
					
					SELECT @v_meds =  '''' + Replace(MedicineIds,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisId=@SearchKey and IsUterusWeek=0

					--SELECT @v_meds =  '''' + Replace(MedicineIds,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisName=@SearchKey and IsUterusWeek=0
					
					print @v_meds

					SET @WhereQry = @WhereQry + ' AND m.MedicineName in (' + @v_meds + ') '
					--SET @WhereQry = @WhereQry + ' AND m.MedicineName in (' + @v_meds + ') '
					
					print '@v_meds : ' + @v_meds
					print '@WhereQry : ' + @WhereQry
				End

				-- // ======================================================= by Name ===================
				Else IF (trim(@SearchType) = 'DiagnosisWiseByName')
				BEGIN
					--SELECT @v_meds =  '''' + Replace(MedicineIds,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisId=@SearchKey and IsUterusWeek=0

					SELECT @v_meds =  '''' + Replace(MedicineIds,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisName=@SearchKey and IsUterusWeek=0
					
					--print @v_meds

					--SET @WhereQry = @WhereQry + ' AND m.MedicineName in (' + @v_meds + ') '
					SET @WhereQry = @WhereQry + ' AND m.MedicineName in (' + @v_meds + ') '
					
					--print '@v_meds : ' + @v_meds
					--print '@WhereQry : ' + @WhereQry
				END
				-- // ======================================================= by Name ===================

				Else If ISNULL(@SearchType,'')='UterusWeekWise'
				Begin					
					SELECT @v_meds =  '''' + Replace(MedicineIds,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisName=@SearchKey + ' Weeks' and IsUterusWeek=1
					----print @v_meds

					SET @WhereQry = @WhereQry + ' AND m.MedicineName in (' + @v_meds + ') '


					-- Jeet Chauhan New Changes
					--SELECT @v_meds =  '''' + Replace(MedicineId,',', ''',''') + '''' FROM hospital.tblDiagnosis with(nolock) WHERE DiagnosisName=@SearchKey + ' Weeks' and IsUterusWeek=1
					--print @v_meds

					--SET @WhereQry = @WhereQry + ' AND m.MedicineId in (' + @v_meds + ') '

					print @WhereQry

					-- Jeet Chauhan New Changes

					
					print @SearchKey
					print @v_meds
					--print '@v_meds : ' + @v_meds
					--print '@WhereQry : ' + @WhereQry
				End
				Else If ISNULL(@SearchType ,'')='MedicineWise'
				Begin
					SET @WhereQry = @WhereQry + ' AND m.MedicineId in (' + @SearchKey + ') '
				End
				Else
				Begin
						SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'MedicineName'
						Then 'm.MedicineName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						--Then '(medtype.RecordName like ''%' + @SearchKey + '%'' Or m.MedicineName like ''%' + @SearchKey + '%'')'
						Then '(medtype.RecordName = ''' + @SearchKey + ''' Or m.MedicineName = ''' + @SearchKey + ''')'
						
					 End
				End			
			End			
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select MedicineId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct m.MedicineId, ' + @SortBy + ' as SortBy
			--			 FROM hospital.tblMedicine m with(nolock) 
			--			   INNER JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId						  					
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	--, (select Count(RowId) from CTE) as TotalCount
			--	--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, m.MedicineId, m.MedicineName, m.MedicineTypeId, medtype.RecordName as MedicineType, m.MainContent, m.Company, m.PrescriptionDays
			--	, m.MorningMedTimeRefId, morningmedtime.RecordName as MorningDose
			--	, m.NoonMedTimeRefId, noonmedtime.RecordName as NoonDose
			--	, m.EveningMedTimeRefId, evemedtime.RecordName as EveningDose
			--	, m.NightMedTimeRefId, nightmedtime.RecordName as NightDose
			--	, m.IsMedicineActive, m.IsEdited, m.EntryDate, m.UpdatedDate, m.CreatedBy, m.UpdatedBy
							  
			--	  From CTE 
			--	  INNER JOIN hospital.tblMedicine m with(nolock) on CTE.MedicineId = m.MedicineId
			--	  INNER JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
			--			   LEFT JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId	
					
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'
			


			set @BaseQry = '
				With CTE AS (
					Select MedicineId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct m.MedicineId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblMedicine m with(nolock) 
						   LEFT JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
						   LEFT JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, m.MedicineId, m.MedicineName
				, m.MedicineTypeId
				--, medtype.RecordName as MedicineType
				, isnull(medtype.RecordName, m.MedicineType) as MedicineType
				, m.MainContent
				, m.Company
				, m.PrescriptionDays
				, m.MorningMedTimeRefId, isnull(morningmedtime.RecordName, m.MorningMedTimeRef) as MorningDose
				, m.NoonMedTimeRefId, isnull(noonmedtime.RecordName, m.NoonMedTimeRef) as NoonDose
				, m.EveningMedTimeRefId, isnull( evemedtime.RecordName, m.EveningMedTimeRef) as EveningDose
				, m.NightMedTimeRefId, isnull(nightmedtime.RecordName, m.NightMedTimeRef) as NightDose
				, m.IsMedicineActive, m.IsEdited, m.EntryDate, m.UpdatedDate, m.CreatedBy, m.UpdatedBy
				, m.Remark
				  From CTE 
				  INNER JOIN hospital.tblMedicine m with(nolock) on CTE.MedicineId = m.MedicineId
				  LEFT JOIN common.tblEntityRecords medtype with(nolock) on m.MedicineTypeId = medtype.EntityRecordId
						   LEFT JOIN common.tblEntityRecords morningmedtime with(nolock) on m.MorningMedTimeRefId = morningmedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords noonmedtime with(nolock) on m.NoonMedTimeRefId = noonmedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords evemedtime with(nolock) on m.EveningMedTimeRefId = evemedtime.EntityRecordId
						   LEFT JOIN common.tblEntityRecords nightmedtime with(nolock) on m.NightMedTimeRefId = nightmedtime.EntityRecordId	
					
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	

				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
			
		 End
 
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM hospital.tblMedicine WHERE MedicineId=@MedicineId 

	  update hospital.tblMedicine set IsMedicineActive = 0 where MedicineId = @MedicineId
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MedicineId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ModuleRights]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_ModuleRights]  
   @Command varchar(200) 
  , @UserId bigint=NULL
  , @RightId int=NULL 
  , @ModuleId int=NULL 
  , @RightName nvarchar(100)=NULL 
  , @IsRightActive bit=NULL 
  , @EntryDate date=NULL 
  , @UpdatedDate date=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='RightName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO common.tblAppModuleRights  
         (ModuleId, RightName, IsRightActive, EntryDate, UpdatedDate) 
       VALUES (@ModuleId, @RightName, @IsRightActive, @EntryDate, @UpdatedDate)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE common.tblAppModuleRights SET ModuleId=@ModuleId 
        , RightName=@RightName 
        , IsRightActive=@IsRightActive 
        , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
         WHERE RightId=@RightId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @RightId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @RightId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT RightId, ModuleId, RightName, IsRightActive, IsAdminRight, EntryDate, UpdatedDate FROM common.tblAppModuleRights WHERE RightId=@RightId 
		End
		Else if @SubCommand='GetAllList' 
		Begin
					Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' amr.IsRightActive > 0 '				
			
			If ISNULL(@UserId, 0) > 0
			Begin
				declare @v_Rights varchar(500);
				Select @v_Rights =  UserRights from hospital.tblHospitalUsers with (nolock) where UserId = @UserId;
				Set @v_Rights = ISNULL(@v_Rights, '0');

				SET @WhereQry = @WhereQry + ' AND RightId in (' + @v_Rights + ') '
			End

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
				set @BaseQry = '
					With CTE AS (
						Select a.RightId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
						(
							Select distinct amr.RightId, ' + @SortBy + ' as SortBy
							 FROM common.tblAppModuleRights amr with(nolock) 						  					
							WHERE ' + @WhereQry + ' 
						) A
					) Select distinct 
					CTE.RowId
					--, (select Count(RowId) from CTE) as TotalCount
					--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
					, amr.RightId, am.ModuleId, am.ModuleName, RightName, IsRightActive, IsAdminRight, EntryDate, UpdatedDate 								  
					  From CTE 
					  INNER JOIN common.tblAppModuleRights amr with(nolock) ON CTE.RightId=amr.RightId
					  INNER JOIN common.tblAppModules am with(nolock) on amr.ModuleId = am.ModuleId
					  
					  ' + @v_PagingQry + 
					  ' Order by RowId	'	
				
		
				print '--@WhereQry' + @WhereQry			
				print '--@BaseQry' + @BaseQry			
				Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM common.tblAppModuleRights WHERE RightId=@RightId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @RightId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_MTPs]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @MTPId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @MtpUTWeeks int=NULL 
  , @RMP2 nvarchar(50)=NULL 
  , @LiveMaleFemale nvarchar(50)=NULL 
  , @ReligionRefId bigint=NULL 
  , @MtpReasonRefId bigint=NULL 
  , @Contraception nvarchar(50)=NULL 
  , @MtpComplicationRefId bigint=NULL 
  , @MTPAdmissionDate date=NULL 
  --, @MTPAdmissionTime time=NULL 

  , @MTPAdmissionTime nvarchar(50) = NULL 

  , @MTPProcedureDate date=NULL 
 
 --, @MTPPRocedureTime time=NULL 
 , @MTPPRocedureTime nvarchar(50) = NULL 
 
 , @MTPDischargeDate date=NULL 
 
 --, @MTPDischargeTime time=NULL 
 , @MTPDischargeTime nvarchar(50) = NULL 
 
 , @MTPRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='MTPId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10 
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @isMisMatchSrNos bit = 0
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int

  DECLARE @startdate varchar(20)=@fromdate, @lastdate varchar(20)=@todate, @monthno int=0, @yearno int=0, @fystartdate varchar(20)
  
    IF @Command='INSERT' 
    BEGIN 

		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblMTP where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblMTP where year(entrydate)=year(GETDATE())
				
		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblMTP  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
		 , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  isMisMatchSrNos) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @MtpUTWeeks, @RMP2, @LiveMaleFemale, @ReligionRefId, @MtpReasonRefId, @Contraception, @MtpComplicationRefId
	   , @MTPAdmissionDate,cast( @MTPAdmissionTime as time), @MTPProcedureDate, cast(@MTPPRocedureTime as time), @MTPDischargeDate, cast(@MTPDischargeTime as time), @MTPRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @isMisMatchSrNos)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblMTP SET 
         SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
		, PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , MtpUTWeeks=@MtpUTWeeks 
        , RMP2=@RMP2 
        , LiveMaleFemale=@LiveMaleFemale 
        , ReligionRefId=@ReligionRefId 
        , MtpReasonRefId=@MtpReasonRefId 
        , Contraception=@Contraception 
        , MtpComplicationRefId=@MtpComplicationRefId 
        , MTPAdmissionDate=@MTPAdmissionDate 
        , MTPAdmissionTime= CAST( @MTPAdmissionTime as time)
        , MTPProcedureDate=@MTPProcedureDate 
        , MTPPRocedureTime= CAST(@MTPPRocedureTime as time)
        , MTPDischargeDate=@MTPDischargeDate 
        , MTPDischargeTime=cast(@MTPDischargeTime as time)
        , MTPRemark=@MTPRemark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy
		
		, isMisMatchSrNos = @isMisMatchSrNos

         WHERE MTPId=@MTPId
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @MTPId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT MTPId, PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
			  , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, isMisMatchSrNos as IsMisMatchSrNos FROM  patient.tblMTP WHERE MTPId=@MTPId 
		End


		If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 MTPId, PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
			  , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, isMisMatchSrNos as IsMisMatchSrNos FROM  patient.tblMTP WHERE PatientId=@PatientId
			  order by EntryDate desc
		End



		-- //   // Jeet Chauhan for taking month and year number
		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblMTP where month(MTPProcedureDate ) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblMTP where year(MTPProcedureDate ) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblMTP where  month(MTPProcedureDate ) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblMTP where  year(MTPProcedureDate ) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as srnoAccYear2 

		End
		-- //   // Jeet Chauhan for taking month and year number


		If @SubCommand = 'ValidateYearAndMonth'
		Begin
			declare @srnoAccMonth11 bigint = 0, @srnoAccYear11 bigint = 0
			declare @srnoAccMonth22 bigint = 0, @srnoAccYear22 bigint = 0

			
			select @srnoAccMonth11 = COUNT(SrNoAccMonth) from patient.tblMTP where month(MTPProcedureDate) = month(GETDATE())
			select @srnoAccMonth22 = max(SrNoAccMonth) from patient.tblMTP where  month(MTPProcedureDate) = month(GETDATE())

			select @srnoAccYear11 = COUNT(SrNoAccYear) from patient.tblMTP where year(MTPProcedureDate) = year(GETDATE())
			select @srnoAccYear22 = max(SrNoAccYear) from patient.tblMTP where  year(MTPProcedureDate) = year(GETDATE())

			 

				select case when @srnoAccMonth11 = @srnoAccMonth22 then 'true' else 'false' end as MonthVlidate 
					 , case when @srnoAccYear11 = @srnoAccYear22 then 'true' else 'false' end as YearValidate

		End


		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' p.PatientId > 0'

			If @PatientId > 0
				SET @WhereQry += ' And p.PatientId = '	+ CONVERT(varchar(20),@PatientId)			
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)		
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(mtp.MTPProcedureDate as date) >= ''' + @FromDate + ''' AND cast(mtp.MTPProcedureDate as date) <= ''' + @ToDate + ''')' 

			If ISNULL(@MTPAdmissionDate,'') != ''
				SET @WhereQry += ' And Cast(mtp.MTPAdmissionDate as Date) = Cast(''' +  Convert(varchar(20), @MTPAdmissionDate) + ''' as Date)' 

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(pc.FirstName like ''%' + @SearchKey + '%'' 
						Or pc.LastName like ''%' + @SearchKey + '%'' 						
						Or pc.ContatcNo like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						Or pc.Taluka like ''%' + @SearchKey + '%'' 
						Or pc.District like ''%' + @SearchKey + '%'' 
						Or pc.State like ''%' + @SearchKey + '%'' 
						Or pc.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.MTPId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct mtp.MTPId, ' + @SortBy + ' as SortBy
						 FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, mtp.MTPId, p.PatientId, pc.CaseId, mtp.VisitId
				, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale
				, ReligionRefId, rel.RecordName as Religion
				, MtpReasonRefId, mtpres.RecordName as MTPReason
				, Contraception
				, MtpComplicationRefId, mtpcom.RecordName as MtpComplication
			    , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo			
				, mtp.IsEdited, mtp.EntryDate, mtp.UpdatedDate, mtp.CreatedBy, mtp.UpdatedBy
				, mtp.isMisMatchSrNos
				  From CTE 
				  
				  --INNER JOIN patient.tblMTP mtp with(nolock) ON CTE.MTPId=mtp.MTPId
				  --INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
				  --INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and mtp.CaseId=pc.CaseId
				  --INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
				  --INNER JOIN common.tblEntityRecords rel with(nolock) on mtp.ReligionRefId = rel.EntityRecordId
				  --INNER JOIN common.tblEntityRecords mtpres with(nolock) on mtp.MtpReasonRefId = mtpres.EntityRecordId
				  --INNER JOIN common.tblEntityRecords mtpcom with(nolock) on mtp.MtpComplicationRefId = mtpcom.EntityRecordId


				  LEFT JOIN patient.tblMTP mtp with(nolock) ON CTE.MTPId=mtp.MTPId
				  LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
				  LEFT JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and mtp.CaseId=pc.CaseId
				  LEFT JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
				  LEFT JOIN common.tblEntityRecords rel with(nolock) on mtp.ReligionRefId = rel.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtpres with(nolock) on mtp.MtpReasonRefId = mtpres.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtpcom with(nolock) on mtp.MtpComplicationRefId = mtpcom.EntityRecordId


				  ' + @v_PagingQry + 
				  ' Order by RowId	desc'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      Else if @SubCommand='GetMTPMonthlyReportListByDuration' 
	  Begin

		select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
		select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End
		

		select * from (

		select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
		Select Count(mtp.MTPId) as MTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
						)A
						inner join
		(
		Select Count(mtp.MTPId) as FYTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
					
		)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >=21 AND MtpUTWeeks <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 21 AND MtpUTWeeks <=24)
					
)B on A.Criteria=B.Criteria
) X order by x.Rowid
						

	  End

	   Else if @SubCommand='GetMTPMonthlyReportListByAge' 
	  Begin
	  select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
	  select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age < 15)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age <15)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=20 AND p.Age <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 20 AND p.Age <=24)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=25 AND p.Age <=29)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 25 AND p.Age <=29)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=30 AND p.Age <=34)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 30 AND p.Age <=34)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=35 AND p.Age <=39)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 35 AND p.Age <=39)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=40 AND p.Age <=44)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 40 AND p.Age <=44)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
					
)B on A.Criteria=B.Criteria

) X order by x.Rowid

	  End


	   Else if @SubCommand='GetMTPMonthlyReportListByReligion' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 5 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
					
)B on A.Criteria=B.Criteria



) X order by x.Rowid
						

	  End


	  Else if @SubCommand='GetMTPMonthlyReportListByMTPReason' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


			
Select A1.Criteria, Count(A2.MTPId) as MTDCount , Count(A3.MTPId) as FYTDCount from (
						Select er.EntityRecordId, er.RecordName as Criteria
						FROM common.tblEntityRecords er with(nolock) 
						INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
						) A1

						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A2 ON A1.EntityRecordId=A2.MtpReasonRefId
						
						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A3 ON A1.EntityRecordId=A3.MtpReasonRefId
						
						Group By A1.Criteria

--select * from (

--select A.Criteria, A.MTDCount, B.FYTDCount from (
--Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
--						)A 

--						inner join
--(
--Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId  And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
					
--)B on A.Criteria=B.Criteria

--) X 
						

	  End

	  
	  Else if @SubCommand='GetMTPMonthlyReportListByTerminationType' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

	    Else if @SubCommand='GetMTPMonthlyReportListByDeath' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblMTP WHERE MTPId=@MTPId 
	  
    

	  IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblMTP WHERE MTPId = @MTPId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblMTP WHERE VisitId = @VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs_13022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_MTPs_13022025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @MTPId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @MtpUTWeeks int=NULL 
  , @RMP2 nvarchar(50)=NULL 
  , @LiveMaleFemale nvarchar(50)=NULL 
  , @ReligionRefId bigint=NULL 
  , @MtpReasonRefId bigint=NULL 
  , @Contraception nvarchar(50)=NULL 
  , @MtpComplicationRefId bigint=NULL 
  , @MTPAdmissionDate date=NULL 
  , @MTPAdmissionTime time=NULL 
  , @MTPProcedureDate date=NULL 
  , @MTPPRocedureTime time=NULL 
  , @MTPDischargeDate date=NULL 
  , @MTPDischargeTime time=NULL 
  , @MTPRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='MTPId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10 
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int

  DECLARE @startdate varchar(20)=@fromdate, @lastdate varchar(20)=@todate, @monthno int=0, @yearno int=0, @fystartdate varchar(20)
  
    IF @Command='INSERT' 
    BEGIN 

		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblMTP where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblMTP where year(entrydate)=year(GETDATE())
				
		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblMTP  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
		 , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @MtpUTWeeks, @RMP2, @LiveMaleFemale, @ReligionRefId, @MtpReasonRefId, @Contraception, @MtpComplicationRefId
	   , @MTPAdmissionDate, @MTPAdmissionTime, @MTPProcedureDate, @MTPPRocedureTime, @MTPDischargeDate, @MTPDischargeTime, @MTPRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblMTP SET 
         SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
		, PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , MtpUTWeeks=@MtpUTWeeks 
        , RMP2=@RMP2 
        , LiveMaleFemale=@LiveMaleFemale 
        , ReligionRefId=@ReligionRefId 
        , MtpReasonRefId=@MtpReasonRefId 
        , Contraception=@Contraception 
        , MtpComplicationRefId=@MtpComplicationRefId 
        , MTPAdmissionDate=@MTPAdmissionDate 
        , MTPAdmissionTime=@MTPAdmissionTime 
        , MTPProcedureDate=@MTPProcedureDate 
        , MTPPRocedureTime=@MTPPRocedureTime 
        , MTPDischargeDate=@MTPDischargeDate 
        , MTPDischargeTime=@MTPDischargeTime 
        , MTPRemark=@MTPRemark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE MTPId=@MTPId
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @MTPId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT MTPId, PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
			  , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy FROM  patient.tblMTP WHERE MTPId=@MTPId 
		End



		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' p.PatientId > 0'

			If @PatientId > 0
				SET @WhereQry += ' And p.PatientId = '	+ CONVERT(varchar(20),@PatientId)			
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)		
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(mtp.MTPProcedureDate as date) >= ''' + @FromDate + ''' AND cast(mtp.MTPProcedureDate as date) <= ''' + @ToDate + ''')' 

			If ISNULL(@MTPAdmissionDate,'') != ''
				SET @WhereQry += ' And Cast(mtp.MTPAdmissionDate as Date) = Cast(''' +  Convert(varchar(20), @MTPAdmissionDate) + ''' as Date)' 

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(pc.FirstName like ''%' + @SearchKey + '%'' 
						Or pc.LastName like ''%' + @SearchKey + '%'' 						
						Or pc.ContatcNo like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						Or pc.Taluka like ''%' + @SearchKey + '%'' 
						Or pc.District like ''%' + @SearchKey + '%'' 
						Or pc.State like ''%' + @SearchKey + '%'' 
						Or pc.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.MTPId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct mtp.MTPId, ' + @SortBy + ' as SortBy
						 FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, mtp.MTPId, p.PatientId, pc.CaseId, mtp.VisitId
				, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale
				, ReligionRefId, rel.RecordName as Religion
				, MtpReasonRefId, mtpres.RecordName as MTPReason
				, Contraception
				, MtpComplicationRefId, mtpcom.RecordName as MtpComplication
			    , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo			
				, mtp.IsEdited, mtp.EntryDate, mtp.UpdatedDate, mtp.CreatedBy, mtp.UpdatedBy								  
				  From CTE 
				  INNER JOIN patient.tblMTP mtp with(nolock) ON CTE.MTPId=mtp.MTPId
				  INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and mtp.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on mtp.ReligionRefId = rel.EntityRecordId
				  INNER JOIN common.tblEntityRecords mtpres with(nolock) on mtp.MtpReasonRefId = mtpres.EntityRecordId
				  INNER JOIN common.tblEntityRecords mtpcom with(nolock) on mtp.MtpComplicationRefId = mtpcom.EntityRecordId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      Else if @SubCommand='GetMTPMonthlyReportListByDuration' 
	  Begin

		select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
		select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End
		

		select * from (

		select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
		Select Count(mtp.MTPId) as MTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
						)A
						inner join
		(
		Select Count(mtp.MTPId) as FYTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
					
		)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >=21 AND MtpUTWeeks <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 21 AND MtpUTWeeks <=24)
					
)B on A.Criteria=B.Criteria
) X order by x.Rowid
						

	  End

	   Else if @SubCommand='GetMTPMonthlyReportListByAge' 
	  Begin
	  select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
	  select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age < 15)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age <15)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=20 AND p.Age <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 20 AND p.Age <=24)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=25 AND p.Age <=29)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 25 AND p.Age <=29)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=30 AND p.Age <=34)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 30 AND p.Age <=34)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=35 AND p.Age <=39)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 35 AND p.Age <=39)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=40 AND p.Age <=44)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 40 AND p.Age <=44)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
					
)B on A.Criteria=B.Criteria

) X order by x.Rowid

	  End


	   Else if @SubCommand='GetMTPMonthlyReportListByReligion' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 5 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
					
)B on A.Criteria=B.Criteria



) X order by x.Rowid
						

	  End


	  Else if @SubCommand='GetMTPMonthlyReportListByMTPReason' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


			
Select A1.Criteria, Count(A2.MTPId) as MTDCount , Count(A3.MTPId) as FYTDCount from (
						Select er.EntityRecordId, er.RecordName as Criteria
						FROM common.tblEntityRecords er with(nolock) 
						INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
						) A1

						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A2 ON A1.EntityRecordId=A2.MtpReasonRefId
						
						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A3 ON A1.EntityRecordId=A3.MtpReasonRefId
						
						Group By A1.Criteria

--select * from (

--select A.Criteria, A.MTDCount, B.FYTDCount from (
--Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
--						)A 

--						inner join
--(
--Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId  And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
					
--)B on A.Criteria=B.Criteria

--) X 
						

	  End

	  
	  Else if @SubCommand='GetMTPMonthlyReportListByTerminationType' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

	    Else if @SubCommand='GetMTPMonthlyReportListByDeath' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblMTP WHERE MTPId=@MTPId 
	  DELETE FROM patient.tblMTP WHERE VisitId = @VisitId
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_MTPs_19042025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_MTPs_19042025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @MTPId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @MtpUTWeeks int=NULL 
  , @RMP2 nvarchar(50)=NULL 
  , @LiveMaleFemale nvarchar(50)=NULL 
  , @ReligionRefId bigint=NULL 
  , @MtpReasonRefId bigint=NULL 
  , @Contraception nvarchar(50)=NULL 
  , @MtpComplicationRefId bigint=NULL 
  , @MTPAdmissionDate date=NULL 
  , @MTPAdmissionTime time=NULL 
  , @MTPProcedureDate date=NULL 
  , @MTPPRocedureTime time=NULL 
  , @MTPDischargeDate date=NULL 
  , @MTPDischargeTime time=NULL 
  , @MTPRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='MTPId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10 
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @isMisMatchSrNos bit = 0
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int

  DECLARE @startdate varchar(20)=@fromdate, @lastdate varchar(20)=@todate, @monthno int=0, @yearno int=0, @fystartdate varchar(20)
  
    IF @Command='INSERT' 
    BEGIN 

		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblMTP where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblMTP where year(entrydate)=year(GETDATE())
				
		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblMTP  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
		 , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  isMisMatchSrNos) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @MtpUTWeeks, @RMP2, @LiveMaleFemale, @ReligionRefId, @MtpReasonRefId, @Contraception, @MtpComplicationRefId
	   , @MTPAdmissionDate, @MTPAdmissionTime, @MTPProcedureDate, @MTPPRocedureTime, @MTPDischargeDate, @MTPDischargeTime, @MTPRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @isMisMatchSrNos)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblMTP SET 
         SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
		, PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , MtpUTWeeks=@MtpUTWeeks 
        , RMP2=@RMP2 
        , LiveMaleFemale=@LiveMaleFemale 
        , ReligionRefId=@ReligionRefId 
        , MtpReasonRefId=@MtpReasonRefId 
        , Contraception=@Contraception 
        , MtpComplicationRefId=@MtpComplicationRefId 
        , MTPAdmissionDate=@MTPAdmissionDate 
        , MTPAdmissionTime=@MTPAdmissionTime 
        , MTPProcedureDate=@MTPProcedureDate 
        , MTPPRocedureTime=@MTPPRocedureTime 
        , MTPDischargeDate=@MTPDischargeDate 
        , MTPDischargeTime=@MTPDischargeTime 
        , MTPRemark=@MTPRemark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy
		
		, isMisMatchSrNos = @isMisMatchSrNos

         WHERE MTPId=@MTPId
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @MTPId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT MTPId, PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
			  , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, isMisMatchSrNos as IsMisMatchSrNos FROM  patient.tblMTP WHERE MTPId=@MTPId 
		End


		If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 MTPId, PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale, ReligionRefId, MtpReasonRefId, Contraception, MtpComplicationRefId
			  , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, isMisMatchSrNos as IsMisMatchSrNos FROM  patient.tblMTP WHERE PatientId=@PatientId
			  order by EntryDate desc
		End



		-- //   // Jeet Chauhan for taking month and year number
		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblMTP where month(MTPProcedureDate ) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblMTP where year(MTPProcedureDate ) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblMTP where  month(MTPProcedureDate ) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblMTP where  year(MTPProcedureDate ) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as srnoAccYear2 

		End
		-- //   // Jeet Chauhan for taking month and year number


		If @SubCommand = 'ValidateYearAndMonth'
		Begin
			declare @srnoAccMonth11 bigint = 0, @srnoAccYear11 bigint = 0
			declare @srnoAccMonth22 bigint = 0, @srnoAccYear22 bigint = 0

			
			select @srnoAccMonth11 = COUNT(SrNoAccMonth) from patient.tblMTP where month(MTPProcedureDate) = month(GETDATE())
			select @srnoAccMonth22 = max(SrNoAccMonth) from patient.tblMTP where  month(MTPProcedureDate) = month(GETDATE())

			select @srnoAccYear11 = COUNT(SrNoAccYear) from patient.tblMTP where year(MTPProcedureDate) = year(GETDATE())
			select @srnoAccYear22 = max(SrNoAccYear) from patient.tblMTP where  year(MTPProcedureDate) = year(GETDATE())

			 

				select case when @srnoAccMonth11 = @srnoAccMonth22 then 'true' else 'false' end as MonthVlidate 
					 , case when @srnoAccYear11 = @srnoAccYear22 then 'true' else 'false' end as YearValidate

		End


		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' p.PatientId > 0'

			If @PatientId > 0
				SET @WhereQry += ' And p.PatientId = '	+ CONVERT(varchar(20),@PatientId)			
			
			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)		
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(mtp.MTPProcedureDate as date) >= ''' + @FromDate + ''' AND cast(mtp.MTPProcedureDate as date) <= ''' + @ToDate + ''')' 

			If ISNULL(@MTPAdmissionDate,'') != ''
				SET @WhereQry += ' And Cast(mtp.MTPAdmissionDate as Date) = Cast(''' +  Convert(varchar(20), @MTPAdmissionDate) + ''' as Date)' 

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(pc.FirstName like ''%' + @SearchKey + '%'' 
						Or pc.LastName like ''%' + @SearchKey + '%'' 						
						Or pc.ContatcNo like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						Or pc.Taluka like ''%' + @SearchKey + '%'' 
						Or pc.District like ''%' + @SearchKey + '%'' 
						Or pc.State like ''%' + @SearchKey + '%'' 
						Or pc.PinCode like ''%' + @SearchKey + '%''
						)' 
					
					 End
			End	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.MTPId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct mtp.MTPId, ' + @SortBy + ' as SortBy
						 FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, mtp.MTPId, p.PatientId, pc.CaseId, mtp.VisitId
				, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, RMP2, LiveMaleFemale
				, ReligionRefId, rel.RecordName as Religion
				, MtpReasonRefId, mtpres.RecordName as MTPReason
				, Contraception
				, MtpComplicationRefId, mtpcom.RecordName as MtpComplication
			    , MTPAdmissionDate, MTPAdmissionTime, MTPProcedureDate, MTPPRocedureTime, MTPDischargeDate, MTPDischargeTime, MTPRemark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo			
				, mtp.IsEdited, mtp.EntryDate, mtp.UpdatedDate, mtp.CreatedBy, mtp.UpdatedBy
				, mtp.isMisMatchSrNos
				  From CTE 
				  INNER JOIN patient.tblMTP mtp with(nolock) ON CTE.MTPId=mtp.MTPId
				  INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and mtp.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
				  INNER JOIN common.tblEntityRecords rel with(nolock) on mtp.ReligionRefId = rel.EntityRecordId
				  INNER JOIN common.tblEntityRecords mtpres with(nolock) on mtp.MtpReasonRefId = mtpres.EntityRecordId
				  INNER JOIN common.tblEntityRecords mtpcom with(nolock) on mtp.MtpComplicationRefId = mtpcom.EntityRecordId
				  ' + @v_PagingQry + 
				  ' Order by RowId	desc'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      Else if @SubCommand='GetMTPMonthlyReportListByDuration' 
	  Begin

		select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
		select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End
		

		select * from (

		select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
		Select Count(mtp.MTPId) as MTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
						)A
						inner join
		(
		Select Count(mtp.MTPId) as FYTDCount, 'Upto 12 weeks' as Criteria
		FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks <=12)
					
		)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 13 to 20 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 13 AND MtpUTWeeks <=20)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >=21 AND MtpUTWeeks <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Between 21 to 24 weeks' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (MtpUTWeeks  >= 21 AND MtpUTWeeks <=24)
					
)B on A.Criteria=B.Criteria
) X order by x.Rowid
						

	  End

	   Else if @SubCommand='GetMTPMonthlyReportListByAge' 
	  Begin
	  select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
	  select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age < 15)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Below 15 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age <15)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '15 to 19 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 15 AND p.Age <=19)
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=20 AND p.Age <=24)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '20 to 24 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 20 AND p.Age <=24)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=25 AND p.Age <=29)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '25 to 29 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 25 AND p.Age <=29)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=30 AND p.Age <=34)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '30 to 34 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 30 AND p.Age <=34)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=35 AND p.Age <=39)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '35 to 39 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 35 AND p.Age <=39)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >=40 AND p.Age <=44)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '40 to 44 years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age  >= 40 AND p.Age <=44)
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, '45 and above years' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						and (p.Age >= 45)
					
)B on A.Criteria=B.Criteria

) X order by x.Rowid

	  End


	   Else if @SubCommand='GetMTPMonthlyReportListByReligion' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


select * from (

select A.Criteria, A.MTDCount, B.FYTDCount, 1 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Hindu' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Hindu'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 2 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Muslim' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Muslim'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 3 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Sikh' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Sikh'
					
)B on A.Criteria=B.Criteria


UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 4 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Christian' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Christian'
					
)B on A.Criteria=B.Criteria

UNION

select A.Criteria, A.MTDCount, B.FYTDCount, 5 as Rowid from (
Select Count(mtp.MTPId) as MTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
						)A
						inner join
(
Select Count(mtp.MTPId) as FYTDCount, 'Others' as Criteria
FROM patient.tblMTP mtp with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						 INNER JOIN common.tblEntityRecords er on mtp.ReligionRefId=er.EntityRecordId
						WHERE  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						And er.RecordName='Others'
					
)B on A.Criteria=B.Criteria



) X order by x.Rowid
						

	  End


	  Else if @SubCommand='GetMTPMonthlyReportListByMTPReason' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End


			
Select A1.Criteria, Count(A2.MTPId) as MTDCount , Count(A3.MTPId) as FYTDCount from (
						Select er.EntityRecordId, er.RecordName as Criteria
						FROM common.tblEntityRecords er with(nolock) 
						INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
						) A1

						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A2 ON A1.EntityRecordId=A2.MtpReasonRefId
						
						LEFT JOIN

						(
						select mtp.MTPId, mtp.MtpReasonRefId from patient.tblMTP mtp with(nolock) 
						INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						) A3 ON A1.EntityRecordId=A3.MtpReasonRefId
						
						Group By A1.Criteria

--select * from (

--select A.Criteria, A.MTDCount, B.FYTDCount from (
--Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
--						)A 

--						inner join
--(
--Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
--FROM common.tblEntityRecords er with(nolock) 
--						 INNER JOIN common.tblEntityMaster em with(nolock) on er.EntityId=em.EntityID and em.EntityName='MTP Reason'
--						 LEFT JOIN patient.tblMTP mtp with(nolock) on mtp.MTPReasonRefId=er.EntityRecordId
--						 LEFT JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
--						and  p.HospitalId = @HospitalId  And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
--						--And er.RecordName='Hindu'
--						GROUP BY er.RecordName
					
--)B on A.Criteria=B.Criteria

--) X 
						

	  End

	  
	  Else if @SubCommand='GetMTPMonthlyReportListByTerminationType' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, Contraception as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						WHERE Contraception !='No'
						GROUP BY Contraception
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

	    Else if @SubCommand='GetMTPMonthlyReportListByDeath' 
	  Begin
			select @monthno =  DATEPART(MONTH, @lastdate), @yearno = DATEPART(Year, @lastdate)
			select @fystartdate = Case When (@monthno >=1 and @monthno<=3) Then CONVERT(varchar(20), @yearno-1) + '-04-01' Else CONVERT(varchar(20), @yearno) + '-04-01' End

select * from (

select A.Criteria, A.MTDCount, B.FYTDCount from (
Select Count(mtp.MTPId) as MTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @startdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
						)A 

						inner join
(
Select Count(mtp.MTPId) as FYTDCount, er.RecordName as Criteria
FROM patient.tblMTP mtp with(nolock) 
						 INNER JOIN patient.tblPatients p with(nolock) on mtp.PatientId=p.PatientId
						and  p.HospitalId = @HospitalId And (cast(mtp.MTPProcedureDate as date) >= @fystartdate AND cast(mtp.MTPProcedureDate as date) <= @lastdate) 
						RIGHT JOIN common.tblEntityRecords er on mtp.MtpComplicationRefId=er.EntityRecordId 
						WHERE er.RecordName ='Death'
						GROUP BY er.RecordName
					
)B on A.Criteria=B.Criteria

) X 
						

	  End

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblMTP WHERE MTPId=@MTPId 
	  
    

	  IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblMTP WHERE MTPId = @MTPId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblMTP WHERE VisitId = @VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @MTPId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OpdRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
CREATE PROC [dbo].[Usp_Manage_OpdRecords]  
   @Command varchar(200) 
  , @SubCommand varchar(200) = NULL 
  , @RecordId bigint=NULL 
  , @FirstName varchar(50)=NULL 
  , @MiddleName varchar(50)=NULL 
  , @LastName varchar(50)=NULL 
  , @MobileNo varchar(20)=NULL 
  , @Location varchar(50)=NULL 
  , @OpdDateTime datetime=NULL 
  , @EntryDate datetime=NULL
  -- -- Custom New Additioal Params
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Company'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(15)=NULL
  , @ToDate varchar(15)=NULL  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT 
   
 AS 
  BEGIN 
   SET NOCOUNT ON; 
       DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
  
    IF @Command='INSERT' 
    BEGIN 

		IF @SubCommand='AddRecord' 
		BEGIN
			If Not Exists (select top 1 RecordId from dbo.tblOpdRecord where MobileNo=@MobileNo)
			Begin
						 INSERT INTO tblOpdRecord  
				 (FirstName, MiddleName, LastName, MobileNo, Location, OpdDateTime, EntryDate) 
			   VALUES (@FirstName, @MiddleName, @LastName, @MobileNo, @Location, @OpdDateTime, @EntryDate)   
				
				select @v_Identity = SCOPE_IDENTITY(), @v_CustomMessage = 'Record saved successfully!'
				
			End
			Else
			Begin
				SELECT @v_Identity = 0, @v_CustomMessage='Record already exists!'
			End
		END
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Message='success'
		End

		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Message=ERROR_MESSAGE(),@v_CustomMessage='Record saved failed!'		
		End   

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE tblOpdRecord SET FirstName=@FirstName 
        , MiddleName=@MiddleName 
        , LastName=@LastName 
        , MobileNo=@MobileNo 
        , Location=@Location 
        , OpdDateTime=@OpdDateTime 
        , EntryDate=@EntryDate 
         WHERE RecordId=@RecordId 
    
		IF @@ERROR=0
        Begin               
                SELECT @v_IsSuccess=1, @v_Identity = @RecordId, @v_Message='success'
        End
        Else
        Begin
                SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
        End
             
        --SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @PageSize!= -1
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
		End

		If @SubCommand='GetRecordDetail' 
		Begin
			SELECT RecordId, FirstName, MiddleName, LastName, MobileNo, Location, OpdDateTime, EntryDate FROM tblOpdRecord WHERE RecordId=@RecordId 
		End
		ELSE IF @SubCommand='GetAllRecordDetails' 
		Begin
			SELECT RecordId, FirstName, MiddleName, LastName, MobileNo, Location, OpdDateTime, EntryDate FROM tblOpdRecord 
		End


      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM tblOpdRecord WHERE RecordId=@RecordId 
    
     IF @@ERROR=0
              Begin               
                     SELECT @v_IsSuccess=1, @v_Identity = @RecordId, @v_Message='success'
              End
              Else
              Begin
                     SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
              End
             
              SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 
   SET NOCOUNT OFF; 
  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OTCharges]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_OTCharges]  
   @Command varchar(200) 
  , @OTCId bigint=NULL 
  , @billid bigint=NULL 
  , @hospitalid bigint=NULL 
  , @CaseId bigint=NULL 
  , @visitid bigint=NULL 
  , @patientId bigint=NULL 
  , @OTChargesName nvarchar(500)=NULL 
  , @OTCharge decimal=NULL 
  , @cStatus bit=NULL 
  , @CreatedOn datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedOn datetime=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_OTCharges  
         ( billid, hospitalid, CaseId, visitid, patientId, OTChargesName, OTCharge, CreatedOn, CreatedBy, UpdatedOn, UpdatedBy) 
       VALUES ( @billid, @hospitalid, @CaseId, @visitid, @patientId, @OTChargesName, @OTCharge, getdate(), @CreatedBy, @UpdatedOn, @UpdatedBy)   
        
		declare @AllOTChanrgessum decimal(18,2)= (select SUM(OTCharge) from patient.tbl_OTCharges where billid = @billid)

		update patient.tblBill set OtherCharges = @AllOTChanrgessum where BillId = @billid

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_OTCharges SET 
          billid=@billid 
        , hospitalid=@hospitalid 
        , CaseId=@CaseId 
        , visitid=@visitid 
        , patientId=@patientId 
        , OTChargesName=@OTChargesName 
        , OTCharge=@OTCharge 
        , cStatus=@cStatus 
        , CreatedOn=@CreatedOn 
        , CreatedBy=@CreatedBy 
        , UpdatedOn=GETDATE() 
        , UpdatedBy=@UpdatedBy 
         WHERE OTCId = @OTCId     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @OTCId , @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @OTCId , @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      SELECT OTCId, billid, hospitalid, CaseId, visitid, patientId, OTChargesName, OTCharge, cStatus, CreatedOn, CreatedBy, UpdatedOn, UpdatedBy FROM  patient.tbl_OTCharges WHERE OTCId = @OTCId 
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_OTCharges WHERE OTCId = @OTCId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @OTCId , @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OvulationProfiles]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_OvulationProfiles]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @ProfileId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @OPDay int=NULL 
  , @OPDate date=NULL 
  --, @OPTime time=NULL 

  , @OPTime nvarchar(50) = NULL 

  , @UtBloodFlow nvarchar(2000)=NULL 
  , @OvarianBloodFlow nvarchar(2000)=NULL 
  , @RightOverianFollicle nvarchar(50)=NULL 
  , @LeftOverianFollicle nvarchar(50)=NULL 
  , @Endometrium nvarchar(50)=NULL 
  , @OvulationProfileRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='ProfileId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblOvulationProfile  
         (PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @OPDay, @OPDate, cast( @OPTime as time), @UtBloodFlow, @OvarianBloodFlow, @RightOverianFollicle, @LeftOverianFollicle, @Endometrium, @OvulationProfileRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblOvulationProfile 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , OPDay=@OPDay 
        , OPDate=@OPDate 
        , OPTime=cast( @OPTime as time) 
        , UtBloodFlow=@UtBloodFlow 
        , OvarianBloodFlow=@OvarianBloodFlow 
        , RightOverianFollicle=@RightOverianFollicle 
        , LeftOverianFollicle=@LeftOverianFollicle 
        , Endometrium=@Endometrium 
        , OvulationProfileRemark=@OvulationProfileRemark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE ProfileId=@ProfileId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ProfileId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @ProfileId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
				, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM patient.tblOvulationProfile 
			WHERE ProfileId=@ProfileId 
		End


		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
				, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM patient.tblOvulationProfile 
			WHERE PatientId=@PatientId
			order by EntryDate desc
		End

		Else if @SubCommand='GetAllList' 
		Begin
			
			--Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StartRow = 0	
			--Set @StopRow = (@PageNo*@PageSize)
			Set @StopRow = (select COUNT(ProfileId) from patient.tblOvulationProfile )

			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
				print @v_PagingQry
			end

			SET @WhereQry = ' op.CaseId = '	+ CONVERT(varchar(20),@CaseId)			
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.ProfileId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct op.ProfileId, ' + @SortBy + ' as SortBy
						 FROM patient.tblOvulationProfile op with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, op.ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark							
				, op.IsEdited, op.EntryDate, op.UpdatedDate, op.CreatedBy, op.UpdatedBy								  
				  From CTE 
				  INNER JOIN patient.tblOvulationProfile op with(nolock) ON CTE.ProfileId=op.ProfileId
				  --' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblOvulationProfile WHERE ProfileId=@ProfileId 

	  --DELETE FROM patient.tblOvulationProfile WHERE VisitId = @VisitId
    

	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblOvulationProfile WHERE ProfileId = @ProfileId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblOvulationProfile WHERE VisitId = @VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ProfileId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_OvulationProfiles_19042025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_OvulationProfiles_19042025]  
   @Command varchar(200) 
   , @HospitalId int=NULL 
  , @ProfileId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @OPDay int=NULL 
  , @OPDate date=NULL 
  , @OPTime time=NULL 
  , @UtBloodFlow nvarchar(2000)=NULL 
  , @OvarianBloodFlow nvarchar(2000)=NULL 
  , @RightOverianFollicle nvarchar(50)=NULL 
  , @LeftOverianFollicle nvarchar(50)=NULL 
  , @Endometrium nvarchar(50)=NULL 
  , @OvulationProfileRemark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='ProfileId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblOvulationProfile  
         (PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @OPDay, @OPDate, @OPTime, @UtBloodFlow, @OvarianBloodFlow, @RightOverianFollicle, @LeftOverianFollicle, @Endometrium, @OvulationProfileRemark
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblOvulationProfile 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , OPDay=@OPDay 
        , OPDate=@OPDate 
        , OPTime=@OPTime 
        , UtBloodFlow=@UtBloodFlow 
        , OvarianBloodFlow=@OvarianBloodFlow 
        , RightOverianFollicle=@RightOverianFollicle 
        , LeftOverianFollicle=@LeftOverianFollicle 
        , Endometrium=@Endometrium 
        , OvulationProfileRemark=@OvulationProfileRemark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE ProfileId=@ProfileId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ProfileId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @ProfileId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
				, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM patient.tblOvulationProfile 
			WHERE ProfileId=@ProfileId 
		End


		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark
				, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM patient.tblOvulationProfile 
			WHERE PatientId=@PatientId
			order by EntryDate desc
		End

		Else if @SubCommand='GetAllList' 
		Begin
				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' op.CaseId = '	+ CONVERT(varchar(20),@CaseId)			
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.ProfileId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct op.ProfileId, ' + @SortBy + ' as SortBy
						 FROM patient.tblOvulationProfile op with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, op.ProfileId, PatientId, CaseId, VisitId, OPDay, OPDate, OPTime, UtBloodFlow, OvarianBloodFlow, RightOverianFollicle, LeftOverianFollicle, Endometrium, OvulationProfileRemark							
				, op.IsEdited, op.EntryDate, op.UpdatedDate, op.CreatedBy, op.UpdatedBy								  
				  From CTE 
				  INNER JOIN patient.tblOvulationProfile op with(nolock) ON CTE.ProfileId=op.ProfileId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblOvulationProfile WHERE ProfileId=@ProfileId 

	  --DELETE FROM patient.tblOvulationProfile WHERE VisitId = @VisitId
    

	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblOvulationProfile WHERE ProfileId = @ProfileId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblOvulationProfile WHERE VisitId = @VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ProfileId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientDischarge]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_PatientDischarge]  
   @Command varchar(200) 
  , @HospitalId int=NULL
  , @DischargeId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @AdmissionDate date=NULL 
  --, @AdmissionTime time=NULL 

  , @AdmissionTime nvarchar(50) = NULL 

  , @DeliveryNo int=NULL 
  , @ComplainOfRefId bigint=NULL 
  , @DiagnosisRefId bigint=NULL 
  , @OperationRefId bigint=NULL 
  , @OTDate date=NULL 
  --, @OTTime time=NULL 

  , @OTTime nvarchar(50) = NULL 

  , @TreatmentRefId bigint=NULL 
  , @AdviceRefId bigint=NULL 
  , @HistoryRefId bigint=NULL 
  , @AssistedRefId bigint=NULL 
  , @DischargeDate date=NULL 
  --, @DischargeTime time=NULL 

  , @DischargeTime nvarchar(50) = NULL 

  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='DischargeId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10  
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @Remark nvarchar(max) = null
  , @Diagnosis nvarchar(max) = null
  , @ProvisionalDiagnosis nvarchar(max) = null
  

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblPatientDischarge  
         (PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, DeliveryNo, ComplainOfRefId, DiagnosisRefId, OperationRefId
		 , OTDate, OTTime, TreatmentRefId, AdviceRefId, HistoryRefId, AssistedRefId, DischargeDate, DischargeTime
		 , IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , Remark , Diagnosis , ProvisionalDiagnosis) 
       VALUES (@PatientId, @CaseId, @VisitId, @AdmissionDate, CAST( @AdmissionTime as time), @DeliveryNo, @ComplainOfRefId, @DiagnosisRefId, @OperationRefId
	   , @OTDate, CAST( @OTTime as time) , @TreatmentRefId, @AdviceRefId, @HistoryRefId, @AssistedRefId, @DischargeDate, CAST( @DischargeTime as time)
	   , @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @Remark , @Diagnosis ,@ProvisionalDiagnosis)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatientDischarge SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , AdmissionDate=@AdmissionDate 
        , AdmissionTime= cast(@AdmissionTime as time)
        , DeliveryNo=@DeliveryNo 
        , ComplainOfRefId=@ComplainOfRefId 
        , DiagnosisRefId=@DiagnosisRefId 
        , OperationRefId=@OperationRefId 
        , OTDate=@OTDate 
        , OTTime= cast(@OTTime as time)
        , TreatmentRefId=@TreatmentRefId 
        , AdviceRefId=@AdviceRefId 
        , HistoryRefId=@HistoryRefId 
        , AssistedRefId=@AssistedRefId 
        , DischargeDate=@DischargeDate 
        , DischargeTime=cast(@DischargeTime as time)
        , IsActive=@IsActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,Remark = @Remark
		, Diagnosis = @Diagnosis
		,@ProvisionalDiagnosis = ProvisionalDiagnosis
         WHERE DischargeId=@DischargeId   
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DischargeId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @DischargeId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT DischargeId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, DeliveryNo
			, ComplainOfRefId, comp.RecordName as ComplainOf
			, DiagnosisRefId
			
			--, diag.DiagnosisName as Diagnosis
			
			, OperationRefId, op.RecordName as Operation
			, OTDate, OTTime
			, TreatmentRefId, treat.RecordName as Treatment
			, AdviceRefId, adv.Advice as Advice
			, HistoryRefId, hist.RecordName as History
			, AssistedRefId, DischargeDate, DischargeTime
			, pd.IsActive, pd.IsEdited, pd.EntryDate, pd.UpdatedDate, pd.CreatedBy, pd.UpdatedBy 
			,Remark , Diagnosis , ProvisionalDiagnosis
			FROM patient.tblPatientDischarge pd with(nolock)
				LEFT JOIN common.tblEntityRecords comp with(nolock) on pd.ComplainOfRefId = comp.EntityRecordId
				LEFT JOIN hospital.tblDiagnosis diag with(nolock) on pd.DiagnosisRefId = diag.DiagnosisId
				LEFT JOIN common.tblEntityRecords op with(nolock) on pd.OperationRefId = op.EntityRecordId
				LEFT JOIN common.tblEntityRecords treat with(nolock) on pd.TreatmentRefId = treat.EntityRecordId
				LEFT JOIN hospital.tblAdvice adv with(nolock) on pd.AdviceRefId = adv.AdviceId
				LEFT JOIN common.tblEntityRecords hist with(nolock) on pd.HistoryRefId = hist.EntityRecordId
			WHERE DischargeId=@DischargeId 
		End


		If @SubCommand = 'PrintData'
		Begin
			SELECT DischargeId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, DeliveryNo
			, ComplainOfRefId, comp.RecordName as ComplainOf
			, DiagnosisRefId
			
			--, diag.DiagnosisName as Diagnosis
			
			, OperationRefId, op.RecordName as Operation
			, OTDate, OTTime
			, TreatmentRefId, treat.RecordName as Treatment
			, AdviceRefId, adv.Advice as Advice
			, HistoryRefId, hist.RecordName as History
			, AssistedRefId, DischargeDate, DischargeTime
			, pd.IsActive, pd.IsEdited, pd.EntryDate, pd.UpdatedDate, pd.CreatedBy, pd.UpdatedBy 
			,Remark , Diagnosis , ProvisionalDiagnosis
			FROM patient.tblPatientDischarge pd with(nolock)
				LEFT JOIN common.tblEntityRecords comp with(nolock) on pd.ComplainOfRefId = comp.EntityRecordId
				LEFT JOIN hospital.tblDiagnosis diag with(nolock) on pd.DiagnosisRefId = diag.DiagnosisId
				LEFT JOIN common.tblEntityRecords op with(nolock) on pd.OperationRefId = op.EntityRecordId
				LEFT JOIN common.tblEntityRecords treat with(nolock) on pd.TreatmentRefId = treat.EntityRecordId
				LEFT JOIN hospital.tblAdvice adv with(nolock) on pd.AdviceRefId = adv.AdviceId
				LEFT JOIN common.tblEntityRecords hist with(nolock) on pd.HistoryRefId = hist.EntityRecordId
			WHERE DischargeId=@DischargeId 
		End


		If @SubCommand = 'SelectDeliverySrNo'
		BEGIN
			select top 1 (SrNo + 1) as DeliverySrNo from patient.tblDeliveryRecords order by 1 desc
		END

		ELSE IF @SubCommand  = 'SelectSingleFromVisit'
		BEGIN
			 SELECT top 1 DischargeId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, DeliveryNo
			, ComplainOfRefId, comp.RecordName as ComplainOf
			, DiagnosisRefId
			--, diag.DiagnosisName as Diagnosis
			, OperationRefId, op.RecordName as Operation
			, OTDate, OTTime
			, TreatmentRefId, treat.RecordName as Treatment
			, AdviceRefId, adv.Advice as Advice
			, HistoryRefId, hist.RecordName as History
			, AssistedRefId, DischargeDate, DischargeTime
			, pd.IsActive, pd.IsEdited, pd.EntryDate, pd.UpdatedDate, pd.CreatedBy, pd.UpdatedBy 
			, Remark , Diagnosis , ProvisionalDiagnosis
			FROM patient.tblPatientDischarge pd with(nolock)
				LEFT JOIN common.tblEntityRecords comp with(nolock) on pd.ComplainOfRefId = comp.EntityRecordId
				LEFT JOIN hospital.tblDiagnosis diag with(nolock) on pd.DiagnosisRefId = diag.DiagnosisId
				LEFT JOIN common.tblEntityRecords op with(nolock) on pd.OperationRefId = op.EntityRecordId
				LEFT JOIN common.tblEntityRecords treat with(nolock) on pd.TreatmentRefId = treat.EntityRecordId
				LEFT JOIN hospital.tblAdvice adv with(nolock) on pd.AdviceRefId = adv.AdviceId
				LEFT JOIN common.tblEntityRecords hist with(nolock) on pd.HistoryRefId = hist.EntityRecordId
			WHERE pd.VisitId=@VisitId
			order by 1 desc
		END

		ELSE If @SubCommand = 'SelectPreviousVisitData'
		Begin
			SELECT top 1 DischargeId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, DeliveryNo
			, ComplainOfRefId, comp.RecordName as ComplainOf
			, DiagnosisRefId
			
			--, diag.DiagnosisName as Diagnosis
			
			, OperationRefId, op.RecordName as Operation
			, OTDate, OTTime
			, TreatmentRefId, treat.RecordName as Treatment
			, AdviceRefId, adv.Advice as Advice
			, HistoryRefId, hist.RecordName as History
			, AssistedRefId, DischargeDate, DischargeTime
			, pd.IsActive, pd.IsEdited, pd.EntryDate, pd.UpdatedDate, pd.CreatedBy, pd.UpdatedBy 
			, Remark , Diagnosis , ProvisionalDiagnosis
			FROM patient.tblPatientDischarge pd with(nolock)
				LEFT JOIN common.tblEntityRecords comp with(nolock) on pd.ComplainOfRefId = comp.EntityRecordId
				LEFT JOIN hospital.tblDiagnosis diag with(nolock) on pd.DiagnosisRefId = diag.DiagnosisId
				LEFT JOIN common.tblEntityRecords op with(nolock) on pd.OperationRefId = op.EntityRecordId
				LEFT JOIN common.tblEntityRecords treat with(nolock) on pd.TreatmentRefId = treat.EntityRecordId
				LEFT JOIN hospital.tblAdvice adv with(nolock) on pd.AdviceRefId = adv.AdviceId
				LEFT JOIN common.tblEntityRecords hist with(nolock) on pd.HistoryRefId = hist.EntityRecordId
			WHERE pd.PatientId=@PatientId
			order by EntryDate desc
		End



		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0

			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' pd.CaseId = ' + Convert(varchar(20), @CaseId)					
			
			If @HospitalId > 0
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)		
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (cast(pd.DischargeDate as date) >= ''' + @FromDate + ''' AND cast(pd.DischargeDate as date) <= ''' + @ToDate + ''')' 

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.DischargeId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct pd.DischargeId, ' + @SortBy + ' as SortBy
						 FROM patient.tblPatientDischarge pd with(nolock) 	
						 INNER JOIN patient.tblPatients p with(nolock) on pd.PatientId=p.PatientId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, pd.DischargeId, p.PatientId, pc.CaseId, pd.VisitId
				, AdmissionDate, AdmissionTime
				, DeliveryNo
				, ComplainOfRefId, co.RecordName as ComplainOf
				, DiagnosisRefId
				
				--, dia.DiagnosisName as Diagnosis
				
				, OperationRefId, op.RecordName as Operation
				, OTDate, OTTime
				, TreatmentRefId, treat.RecordName as Treatment
				, AdviceRefId, adv.Advice as Advice
				, HistoryRefId, history.RecordName as History
				, AssistedRefId, assist.RecordName as Assisted
				, DischargeDate, DischargeTime
				
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo			
				, pd.IsActive, pd.IsEdited, pd.EntryDate, pd.UpdatedDate, pd.CreatedBy, pd.UpdatedBy
				, Remark , Diagnosis , ProvisionalDiagnosis
				  From CTE 
				  INNER JOIN patient.tblPatientDischarge pd with(nolock) ON CTE.DischargeId=pd.DischargeId
				  INNER JOIN patient.tblPatients p with(nolock) on pd.PatientId=p.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and pd.CaseId=pc.CaseId
				  INNER JOIN common.tblEntityRecords co with(nolock) on pd.ComplainOfRefId = co.EntityRecordId

				  LEFT JOIN hospital.tblDiagnosis dia with(nolock) on pd.DiagnosisRefId = dia.DiagnosisId

				  INNER JOIN common.tblEntityRecords op with(nolock) on pd.OperationRefId = op.EntityRecordId
				  INNER JOIN common.tblEntityRecords treat with(nolock) on pd.TreatmentRefId = treat.EntityRecordId

				  LEFT JOIN hospital.tblAdvice adv with(nolock) on pd.AdviceRefId = adv.AdviceId

				  INNER JOIN common.tblEntityRecords history with(nolock) on pd.HistoryRefId = history.EntityRecordId
				  INNER JOIN common.tblEntityRecords assist with(nolock) on pd.AssistedRefId = assist.EntityRecordId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      
	  
	  --DELETE FROM patient.tblPatientDischarge WHERE DischargeId=@DischargeId 
	  
    

	IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblPatientDischarge WHERE DischargeId=@DischargeId 
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblPatientDischarge WHERE VisitId=@VisitId
	  END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @DischargeId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============ ––––––––––––––––––––––––––––––––––––––––––––––––

 CREATE PROCEDURE [dbo].[Usp_Manage_Patients]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT

  ,@C_CaseIdReturn bigint = 0 OUTPUT
  ,@V_VisitIdReturn bigint = 0 OUTPUT

  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(100) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added

	, @Remark nvarchar(max) = ''
	, @FUDate nvarchar(100) = ''
	,@City nvarchaR(500) = Null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int = 0 ; --, @V_VisitIdReturn bigint = 0,@C_CaseIdReturn bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight , City) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight , @City)   
        
		IF @@ERROR=0
		Begin              
			set @v_Identity = SCOPE_IDENTITY()
			--SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin

				-- Jeet Chauhan New Taluka add logic

				declare @VV_StateId bigint = 0 , @VV_talukaId bigint = 0 , @VV_DistrictId bigint = 0;

				select top 1 @VV_StateId = StateId from location.tblState where State = @State and Language = @Language and isnull(State , '') <> ''
				select top 1 @VV_DistrictId = StateId from location.tblDistrict where District = @District and Language = @Language  and isnull(District , '') <> ''
				select top 1 @VV_talukaId = TalukaId from location.tblTaluka where Taluka = @Taluka and Language = @Language and isnull(Taluka , '') <> ''

				If Not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language)
				Begin
					INSERT INTO location.tblState  
					 (State, Language, IsActive, IsEdited, EntryDate, CreatedBy) 
						VALUES (@State, @Language, 1, 1, GETDATE(), 1) 

						Set @VV_StateId = SCOPE_IDENTITY()
				END

				If Not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@VV_StateId and Language=@Language)
			    Begin
					 INSERT INTO location.tblDistrict  
					(District, Language, StateId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@District, @Language, @VV_StateId, 1, 1, GETDATE(), 1)

						Set @VV_DistrictId = SCOPE_IDENTITY()
				END



				If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@VV_DistrictId and Language=@Language)
				Begin
					INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@Taluka, @Language, @VV_DistrictId, 1, 1, GETDATE(), 1)  
				END


				-- Jeet Chauhan New Taluka add logic
				

				declare @C_CityId bigint = 0, @C_AreaId bigint = 0 , @C_SocietyId bigint = 0;

				if not Exists (select top 1 CityId from location.TblCity with(nolock) where trim(lower(CityName)) = TRIM(LOWER(@City)))
				begin
					insert into location.TblCity(CityName , Language, IsActive ,IsEdit , StateId , EntryDate)
					values (@City , @Language , 1 , 0 , @VV_StateId , GETDATE())
				
					set @C_CityId = SCOPE_IDENTITY();
				end
				else
				BEGIN
					set @C_CityId = (select top 1 CityId from location.TblCity with(nolock) where trim(lower(CityName)) = TRIM(LOWER(@City)))
				END


				if not Exists (select top 1 Area from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
				begin
					insert into location.tblArea(Area, Language, IsActive ,IsEdited , EntryDate , CityId)
					values (@Area,@Language , 1 , 0 , GETDATE() , @C_CityId)
				
					set @C_AreaId = SCOPE_IDENTITY();

				end
				BEGIN
					set @C_AreaId = (select top 1 AreaId from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
				END


				if not Exists (select top 1 Society from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
				begin
					insert into location.tblSociety(Society, Language , IsActive , IsEdited , EntryDate , AreaId)
					values (@Society,@Language , 1 , 0 , GETDATE() , @C_AreaId)
				
					set @C_SocietyId = SCOPE_IDENTITY();

				end
				BEGIN
					set @C_SocietyId = (select top 1 SocietyId from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
				END


					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					IF @VV_talukaId <> 0 
					BEGIN
						
						INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
							, Area , Society , AreaId , SocietyId , IsVillageCity) 
					   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
								@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , 
								@C_AreaId ,@C_SocietyId , 1)   

					END
					ELSE
					BEGIN
						
						INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District 
						, Area , Society , AreaId , SocietyId , City, IsVillageCity) 
					   VALUES ('', isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
								@Taluka,@State, isnull(@District, '') ,isnull( @Area , '') , ISNULL( @Society , '') , @C_AreaId ,
								@C_SocietyId ,@VillageCity , 0)   

					END
					
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight ,ReferralIndications , City) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight  ,  'xvii. Evaluation of fetal growth parameters, fetal weight and fetal well being.' , @City)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End

			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName, Langauge)
				values (@FirstName , @Language)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName, langauge)
				values (@LastName, @Language)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName , langauge)
				values (@PrimaryRelativeName , @Language)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge )
				values (@Landmark,@Language )
			end

			


			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
							and TRIM(LOWER(Area)) = TRIM(LOWER(@Area))
							and TRIM(LOWER(Society)) = TRIM(LOWER(@Society))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity ,state,taluka,district, langauge,pincode,landmark , Area , Society)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark , @Area , @Society)
			end
			-- -- // ==========================================================================================

			SELECT @v_IsSuccess=1, @v_Identity = @v_Identity, @v_Message='success',  @v_CustomMessage = 'Saved successfully!', @C_CaseIdReturn = @v_CaseId , @V_VisitIdReturn = @v_visitedId;

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
		,City = @City
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka ,City) 
				   VALUES (@VillageCity,isnull( @v_TalukaId , 0 ) , @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka , @City)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, City) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy , @City)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy ,@PatientId)
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, City = @City
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, City = @City
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, trim(p.PrimaryRelativeNameSuffix) as PrimaryRelativeNameSuffix
				  , p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, 
				   trim(p.SecondaryRelativeNameSuffix) as SecondaryRelativeNameSuffix
				   , p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode, p.City
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
				   --p.Height as Height,p.weight as Weight,
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   isnull(MarriedLife,0) as MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   
				   HomeBloodGlucoseMonitoring,BloodGroup,
				   -- isnull(HomeBloodGlucoseMonitoring, '0') as HomeBloodGlucoseMonitoring
				   
				   --,isnull(BloodGroup , '') as BloodGroup


				   UrineSugar, UrineProtein
				   ,p.HouseNo , p.Society

				   --, primarySuffix.RecordName as PrimarySuffix
				   --, secondary.RecordName as SecondarySuffix
				   --, IIF(primarySuffix.RecordName = '-' , '' , primarySuffix.RecordName) as PrimarySuffix
				   --, IIF(secondary.RecordName = '-' , '' ,secondary.RecordName ) as SecondarySuffix
				   ,IIF(case when isnull(primarySuffix.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else primarySuffix.RecordName end = '-' , '' , case when isnull(primarySuffix.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else primarySuffix.RecordName end) as PrimarySuffix

				   --, IIF(primarySuffix.RecordName = '-' , '' , primarySuffix.RecordName) as PrimarySuffix
				   --, IIF(secondary.RecordName = '-' , '' ,secondary.RecordName ) as SecondarySuffix
				   , IIF(case when isnull(secondary.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else secondary.RecordName end = '-' , '' , case when isnull(secondary.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else secondary.RecordName end ) as SecondarySuffix
					-- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added

				  --left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.PrimaryRelativeNameSuffix
				  --left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix

				  LEFT JOIN common.tblEntityRecords primarySuffix with(nolock) on CASE 
							WHEN TRY_CAST(p.PrimaryRelativeNameSuffix AS INT) IS NOT NULL 
								THEN TRY_CAST(p.PrimaryRelativeNameSuffix AS INT)
								ELSE NULL -- Handle invalid data gracefully
							END  = primarySuffix.EntityRecordId

					 LEFT JOIN common.tblEntityRecords secondary with(nolock) on CASE 
							WHEN TRY_CAST(p.SecondaryRelativeNameSuffix AS INT) IS NOT NULL 
								THEN TRY_CAST(p.SecondaryRelativeNameSuffix AS INT)
								ELSE NULL -- Handle invalid data gracefully
							END  = secondary.EntityRecordId

				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, trim(pc.PrimaryRelativeNameSuffix) as PrimaryRelativeNameSuffix
				  , pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, trim(pc.SecondaryRelativeNameSuffix) as SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode , pc.City
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   
				   HomeBloodGlucoseMonitoring,BloodGroup
				   
				   -- isnull(HomeBloodGlucoseMonitoring, '0') as HomeBloodGlucoseMonitoring
				   
				   --,isnull(BloodGroup , '') as BloodGroup

				   , UrineSugar, UrineProtein

				   --, primarySuffix.RecordName as PrimarySuffix
				   --, secondary.RecordName as SecondarySuffix
				   --, IIF(primarySuffix.RecordName = '-' , '' , primarySuffix.RecordName) as PrimarySuffix
				   --, IIF(secondary.RecordName = '-' , '' ,secondary.RecordName ) as SecondarySuffix
				   ,IIF(case when isnull(primarySuffix.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else primarySuffix.RecordName end = '-' , '' , case when isnull(primarySuffix.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else primarySuffix.RecordName end) as PrimarySuffix

				   --, IIF(primarySuffix.RecordName = '-' , '' , primarySuffix.RecordName) as PrimarySuffix
				   --, IIF(secondary.RecordName = '-' , '' ,secondary.RecordName ) as SecondarySuffix
				   , IIF(case when isnull(secondary.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else secondary.RecordName end = '-' , '' , case when isnull(secondary.RecordName,'') = '' then p.PrimaryRelativeNameSuffix else secondary.RecordName end ) as SecondarySuffix
					-- Jeet Chauhan New Changes

				-- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				   -- left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.PrimaryRelativeNameSuffix
				   -- left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix

				   LEFT JOIN common.tblEntityRecords primarySuffix with(nolock) on CASE 
							WHEN TRY_CAST(p.PrimaryRelativeNameSuffix AS INT) IS NOT NULL 
								THEN TRY_CAST(p.PrimaryRelativeNameSuffix AS INT)
								ELSE NULL -- Handle invalid data gracefully
							END  = primarySuffix.EntityRecordId

					 LEFT JOIN common.tblEntityRecords secondary with(nolock) on CASE 
							WHEN TRY_CAST(p.SecondaryRelativeNameSuffix AS INT) IS NOT NULL 
								THEN TRY_CAST(p.SecondaryRelativeNameSuffix AS INT)
								ELSE NULL -- Handle invalid data gracefully
							END  = secondary.EntityRecordId

				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			

			if @PageNo = 1
			begin
				--set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
				set @v_PagingQry = '  1=1 '
			end
			ELSE
			BEGIN
				Set @StartRow = ((@PageNo-2)*@PageSize) + 1		
				Set @StopRow = ((@PageNo - 1)*@PageSize)
				set @v_PagingQry = '  CTE.RowId Between '+CONVERT(varchar(30),@StartRow -1 ) +' And '+ CONVERT(varchar(30),@StopRow  )

			END

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))	
				print @SearchKey
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(@PageNo =0 )
			begin
				set @OPDDateSearchTerm = @SearchKey
			end

			--set @OPDDateSearchTerm = @SearchKey
			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))
				--Set @formattedDate = @OPDDateSearchTerm
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				--set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @OPDDateSearchTerm + ''')'

				set @SearchType = 'FreeSearch'
				print '@datecondition => ' + @datecondition
			end
			--Jeet Chauhan 

			declare @remarkCondition nvarchar(max) = ''
			if(ISNULL(@Remark,'') != '')
			BEGIN
				
				set @remarkCondition = ' and pv.Remark like ''%'+ @Remark +'%'' '
				set @SearchType = 'FreeSearch'
				print @remarkCondition
			END

			declare @FUDateConditions nvarchar(max) = ''
			if(ISNULL(@FUDate,'') != '')
			BEGIN
				
				declare @defaultDateConversion nvarchar(100) = (select LOWER(FORMAT(CONVERT(DATE, @FUDate, 103), 'yyyy-MM-dd')))
				print @defaultDateConversion
				set @FUDateConditions = ' and pv.FollowupDate = ''' + @defaultDateConversion + ''''
				set @SearchType = 'FreeSearch'
				print @FUDateConditions
			END


			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition + @remarkCondition + @FUDateConditions

			print '=============>  start ; '+ @finalQuery + ' ; End'

			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			print 'search key => ' + @SearchKey
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry + 
						CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 

						when 'OpdDate'
						then ' and cast(OpdDate as date) = ' + @SearchKey
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	
			print @v_PagingQry
			set @BaseQry = '				

				;With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE 
						
						

						(
							

							'+ case 
							
							when cast(@PageNo as nvarchar(10)) = 1 and (ISNULL(@finalQuery,'') = '') then + ' cast(OpdDate as date) = CAST(GETDATE() as date)' 
								
						     when cast(@PageNo as nvarchar(10)) = 1 and (ISNULL(@finalQuery,'') <> '') then + '1 = 1 ' + @finalQuery 

							 when cast(@PageNo as nvarchar(10)) > 1 and (ISNULL(@finalQuery,'') <> '') then + ' 1 <> 1'   + @finalQuery 

							   else + @WhereQry + ' and cast(OpdDate as date) < CAST(GETDATE() as date)' 
								
								end 
							+'

						)

					) A
				),
				FirstEDD AS (
					SELECT 
						pc.CaseId,
						MIN(vvc.FirstEDDAccordingUSG) AS FirstEDD
					FROM patient.tblPatientCases pc
					INNER JOIN patient.tblPatientVisits vvc WITH (NOLOCK) ON pc.CaseId = vvc.CaseId
					GROUP BY pc.CaseId
				)
				
				
				Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode , pc.City
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime

				

				,CASE 
					WHEN 
						(DATEDIFF(DAY, fe.FirstEDD, GETDATE()) > 30)
						OR mtp.VisitId IS NOT NULL
						OR del.VisitId IS NOT NULL
					THEN 1 ELSE 0
				END AS ISMoreThenNineMonths,

				CASE WHEN usg.VisitId IS NOT NULL THEN 1 ELSE 0 END AS UsgDone,
				CASE WHEN mtp.VisitId IS NOT NULL THEN 1 ELSE 0 END AS MTPDone,
				CASE WHEN del.VisitId IS NOT NULL THEN 1 ELSE 0 END AS Delivery,
				CASE WHEN bill.VisitId IS NOT NULL THEN 1 ELSE 0 END AS BillPaid,
				1 AS ConsultationDone, 
				CASE WHEN ReferralIndications IS NOT NULL THEN 1 ELSE 0 END AS Reffrel,
				CASE WHEN usgr.VisitId IS NOT NULL THEN 1 ELSE 0 END AS UsgReportDone,
				CASE WHEN ovo.VisitId IS NOT NULL THEN 1 ELSE 0 END AS OvulationDone,
				CASE WHEN histo.VisitId IS NOT NULL THEN 1 ELSE 0 END AS HistolapDone,
				CASE WHEN indoor.VisitId IS NOT NULL THEN 1 ELSE 0 END AS IndoorDone,
				CASE WHEN dis.VisitId IS NOT NULL THEN 1 ELSE 0 END AS DischargeDone

				  From CTE 
				 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId

				  LEFT JOIN FirstEDD fe ON fe.CaseId = pc.CaseId
					LEFT JOIN patient.tblMTP mtp WITH (NOLOCK) ON mtp.VisitId = pv.VisitId
					LEFT JOIN patient.tblDeliveryRecords del WITH (NOLOCK) ON del.VisitId = pv.VisitId
					LEFT JOIN patient.tblUsgDetails usg WITH (NOLOCK) ON usg.VisitId = pv.VisitId
					LEFT JOIN patient.tblBill bill WITH (NOLOCK) ON bill.VisitId = pv.VisitId
					LEFT JOIN patient.tblUsgReports usgr WITH (NOLOCK) ON usgr.VisitId = pv.VisitId
					LEFT JOIN patient.tblOvulationProfile ovo WITH (NOLOCK) ON ovo.VisitId = pv.VisitId
					LEFT JOIN patient.tblHistolap histo WITH (NOLOCK) ON histo.VisitId = pv.VisitId
					LEFT JOIN patient.tblIndoorRecords indoor WITH (NOLOCK) ON indoor.VisitId = pv.VisitId
					LEFT JOIN patient.tblPatientDischarge dis WITH (NOLOCK) ON dis.VisitId = pv.VisitId


				  ' + + 
				  '
				   Where 
				   (
						
						'+ case 
							when cast(@PageNo as nvarchar(10)) = 1 and (ISNULL(@finalQuery,'') = '') then + '1 = 1' 
							-- when cast(@PageNo as nvarchar(10)) > 1 and (ISNULL(@finalQuery,'') <> '') then + '' 
							else + @v_PagingQry  
							end 
						+ '

					)

				  Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		Else if @SubCommand='GetAllDoneList' 
		Begin
			
			
			;With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + ' ' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						 where VisitId = @VisitId --and p.PatientId = @PatientId and pc.CaseId = @CaseId
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity
				,pc.City
				,pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  

		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
			declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds, CaseId
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId,CaseId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
			DECLARE @P_atientId INT, @V_isitId nvarchar(max), @C_CaseId bigint;

			select @P_atientId = PatientId,@V_isitId= VisitIds, @C_CaseId =CaseId  from #TempPatientVisits where RowId = @RowId

			--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
			--select @V_isitId
			--select @P_atientId

			declare @frompatientid bigint = @P_atientId
			declare @fromvisitids nvarchar(max) = @V_isitId
			declare @tblfrom table (ids bigint) 

			insert into @tblfrom(ids)
			select value from string_split(@fromvisitids,',')
		
			--select cast(@RowId as nvarchar(max)) + '_asdfas'
			--select * from @tblfrom


			--declare @t1 table (ids bigint)

			--select VisitId from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) 

			--select VisitId,EntryDate from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

			declare @updatedVisitId bigint = 0;

			;WITH cte AS (
				SELECT 
				VisitId,
					IsLatestVisit,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientVisits
				WHERE PatientId = @frompatientid
				and VisitId in (select VisitId from patient.tblPatientVisits 
				where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
				--and VisitId not in (885)
			)
			SELECT  @updatedVisitId= VisitId
			FROM cte
			WHERE RowNum = 1;


			declare @caseIdToUpdate bigint = 0 ;
			;WITH cte AS (
				SELECT 
				CaseId,
					IsLatest,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientCases
				WHERE PatientId = @frompatientid
				and CaseId in (select CaseId from patient.tblPatientCases 
				where PatientId in (@frompatientid) 
				and CaseId not in (@C_CaseId))
				--and VisitId not in (885)
			)
			SELECT @caseIdToUpdate = CaseId
			FROM cte
			WHERE RowNum = 1;



			--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId4

			if (@updatedVisitId <> 0 )
			BEGIN
				update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

				
			END
		   
		   IF (@caseIdToUpdate <> 0)
			BEGIN
				--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId
				update patient.tblPatientCases set IsLatest = 1 where PatientId = @frompatientid and CaseId in (@caseIdToUpdate)
			END

			

			--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId

			delete from patient.tblPatientVisits 
			where PatientId = @frompatientid and VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end	

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			--------------------------------------
			IF EXISTS ( select PatientId from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			delete from @table

				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_02072025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_02072025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT

  ,@C_CaseIdReturn bigint = 0 OUTPUT
  ,@V_VisitIdReturn bigint = 0 OUTPUT

  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(100) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added

	, @Remark nvarchar(max) = ''
	, @FUDate nvarchar(100) = ''


 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int = 0 ; --, @V_VisitIdReturn bigint = 0,@C_CaseIdReturn bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin              
			set @v_Identity = SCOPE_IDENTITY()
			--SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin

				-- Jeet Chauhan New Taluka add logic

				declare @VV_StateId bigint = 0 , @VV_talukaId bigint = 0 , @VV_DistrictId bigint = 0;

				select top 1 @VV_StateId = StateId from location.tblState where State = @State and Language = @Language 
				select top 1 @VV_DistrictId = StateId from location.tblDistrict where District = @District and Language = @Language 
				select top 1 @VV_talukaId = TalukaId from location.tblTaluka where Taluka = @Taluka and Language = @Language 

				If Not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language)
				Begin
					INSERT INTO location.tblState  
					 (State, Language, IsActive, IsEdited, EntryDate, CreatedBy) 
						VALUES (@State, @Language, 1, 1, GETDATE(), 1) 

						Set @VV_StateId = SCOPE_IDENTITY()
				END

				If Not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@VV_StateId and Language=@Language)
			    Begin
					 INSERT INTO location.tblDistrict  
					(District, Language, StateId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@District, @Language, @VV_StateId, 1, 1, GETDATE(), 1)

						Set @VV_DistrictId = SCOPE_IDENTITY()
				END



				If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@VV_DistrictId and Language=@Language)
				Begin
					INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@Taluka, @Language, @VV_DistrictId, 1, 1, GETDATE(), 1)  
				END


				-- Jeet Chauhan New Taluka add logic
				
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District , Area , Society) 
				   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District , @Area , @Society)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End

			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName)
				values (@FirstName)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName)
				values (@LastName)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName)
				values (@PrimaryRelativeName)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end


			--if not Exists (select top 1 Area from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
			--begin
			--	insert into location.tblArea(Area, Language , IsActive , CreatedBy)
			--	values (@Area,@Language , 1 , 1)
			--end

			--if not Exists (select top 1 Society from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
			--begin
			--	insert into location.tblSociety(Society, Language , IsActive ,IsActive)
			--	values (@Society,@Language)
			--end


			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
							and TRIM(LOWER(Area)) = TRIM(LOWER(@Area))
							and TRIM(LOWER(Society)) = TRIM(LOWER(@Society))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark , Area , Society)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark , @Area , @Society)
			end
			-- -- // ==========================================================================================

			SELECT @v_IsSuccess=1, @v_Identity = @v_Identity, @v_Message='success',  @v_CustomMessage = 'Saved successfully!', @C_CaseIdReturn = @v_CaseId , @V_VisitIdReturn = @v_visitedId;

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity,isnull( @v_TalukaId , 0 ) , @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy ,@PatientId)
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
				   --p.Height as Height,p.weight as Weight,
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   isnull(MarriedLife,0) as MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein
				   ,p.HouseNo , p.Society

				   , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added

				  left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

				     , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				-- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				   left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))	
				print @SearchKey
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(@PageNo =0 )
			begin
				set @OPDDateSearchTerm = @SearchKey
			end

			--set @OPDDateSearchTerm = @SearchKey
			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))
				--Set @formattedDate = @OPDDateSearchTerm
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				--set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @OPDDateSearchTerm + ''')'

				set @SearchType = 'FreeSearch'
				print '@datecondition => ' + @datecondition
			end
			--Jeet Chauhan 

			declare @remarkCondition nvarchar(max) = ''
			if(ISNULL(@Remark,'') != '')
			BEGIN
				
				set @remarkCondition = ' and pv.Remark like ''%'+ @Remark +'%'' '
				set @SearchType = 'FreeSearch'
				print @remarkCondition
			END

			declare @FUDateConditions nvarchar(max) = ''
			if(ISNULL(@FUDate,'') != '')
			BEGIN
				
				declare @defaultDateConversion nvarchar(100) = (select LOWER(FORMAT(CONVERT(DATE, @FUDate, 103), 'yyyy-MM-dd')))
				print @defaultDateConversion
				set @FUDateConditions = ' and pv.FollowupDate = ''' + @defaultDateConversion + ''''
				set @SearchType = 'FreeSearch'
				print @FUDateConditions
			END


			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition + @remarkCondition + @FUDateConditions
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			print 'search key => ' + @SearchKey
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry + 
						CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 

						when 'OpdDate'
						then ' and cast(OpdDate as date) = ' + @SearchKey
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	
			print @v_PagingQry
			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime

				--, (
				--	SELECT TOP 1 
				--		CASE 
				--			--WHEN DATEDIFF(DAY, GETDATE(), vvc.FirstEDDAccordingUSG) > 277 THEN 1 
				--			WHEN DATEDIFF(DAY,  vvc.FirstEDDAccordingUSG ,GETDATE()) > 30 THEN 1 
				--			ELSE 0 
				--		END
				--	FROM patient.tblPatientVisits vvc 
				--	WHERE vvc.CaseId = pc.CaseId 
				--	ORDER BY vvc.FirstEDDAccordingUSG asc
				--) AS ISMoreThenNineMonths


				,(
					CASE 
						WHEN 
							(
								(SELECT TOP 1 
									CASE 
										WHEN DATEDIFF(DAY, vvc.FirstEDDAccordingUSG, GETDATE()) > 30 THEN 1 
										ELSE 0 
									END
								 FROM patient.tblPatientVisits vvc 
								 WHERE vvc.CaseId = pc.CaseId 
								 ORDER BY vvc.FirstEDDAccordingUSG ASC
								) = 1
								OR
								EXISTS (
									SELECT 1 
									FROM patient.tblMTP mmtp
									WHERE mmtp.VisitId = pv.VisitId
								)

								OR

								EXISTS (
									SELECT 1 
									FROM patient.tblDeliveryRecords del 
									WHERE del.VisitId = pv.VisitId
								)
							)
						THEN 1
						ELSE 0
					END
				) AS ISMoreThenNineMonths


				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		Else if @SubCommand='GetAllDoneList' 
		Begin
			
			
			;With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + ' ' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						 where VisitId = @VisitId --and p.PatientId = @PatientId and pc.CaseId = @CaseId
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  

		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
			declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds, CaseId
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId,CaseId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
			DECLARE @P_atientId INT, @V_isitId nvarchar(max), @C_CaseId bigint;

			select @P_atientId = PatientId,@V_isitId= VisitIds, @C_CaseId =CaseId  from #TempPatientVisits where RowId = @RowId

			--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
			--select @V_isitId
			--select @P_atientId

			declare @frompatientid bigint = @P_atientId
			declare @fromvisitids nvarchar(max) = @V_isitId
			declare @tblfrom table (ids bigint) 

			insert into @tblfrom(ids)
			select value from string_split(@fromvisitids,',')
		
			--select cast(@RowId as nvarchar(max)) + '_asdfas'
			--select * from @tblfrom


			--declare @t1 table (ids bigint)

			--select VisitId from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) 

			--select VisitId,EntryDate from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

			declare @updatedVisitId bigint = 0;

			;WITH cte AS (
				SELECT 
				VisitId,
					IsLatestVisit,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientVisits
				WHERE PatientId = @frompatientid
				and VisitId in (select VisitId from patient.tblPatientVisits 
				where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
				--and VisitId not in (885)
			)
			SELECT  @updatedVisitId= VisitId
			FROM cte
			WHERE RowNum = 1;


			declare @caseIdToUpdate bigint = 0 ;
			;WITH cte AS (
				SELECT 
				CaseId,
					IsLatest,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientCases
				WHERE PatientId = @frompatientid
				and CaseId in (select CaseId from patient.tblPatientCases 
				where PatientId in (@frompatientid) 
				and CaseId not in (@C_CaseId))
				--and VisitId not in (885)
			)
			SELECT @caseIdToUpdate = CaseId
			FROM cte
			WHERE RowNum = 1;



			--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId4

			if (@updatedVisitId <> 0 )
			BEGIN
				update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

				
			END
		   
		   IF (@caseIdToUpdate <> 0)
			BEGIN
				--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId
				update patient.tblPatientCases set IsLatest = 1 where PatientId = @frompatientid and CaseId in (@caseIdToUpdate)
			END

			

			--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId

			delete from patient.tblPatientVisits 
			where PatientId = @frompatientid and VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end	

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			--------------------------------------
			IF EXISTS ( select PatientId from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			delete from @table

				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_03052025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_03052025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT

  ,@C_CaseIdReturn bigint = 0 OUTPUT
  ,@V_VisitIdReturn bigint = 0 OUTPUT

  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(10) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int --, @V_VisitIdReturn bigint = 0,@C_CaseIdReturn bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin              
			set @v_Identity = SCOPE_IDENTITY()
			--SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District) 
				   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End

			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName)
				values (@FirstName)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName)
				values (@LastName)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName)
				values (@PrimaryRelativeName)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end

			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark)
			end
			-- -- // ==========================================================================================

			SELECT @v_IsSuccess=1, @v_Identity = @v_Identity, @v_Message='success',  @v_CustomMessage = 'Saved successfully!', @C_CaseIdReturn = @v_CaseId , @V_VisitIdReturn = @v_visitedId;

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy ,@PatientId)
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
				   --p.Height as Height,p.weight as Weight,
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   isnull(MarriedLife,0) as MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein
				   ,p.HouseNo , p.Society

				   , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added

				  left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

				     , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				-- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				   left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))	
				print @SearchKey
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(@PageNo =0 )
			begin
				set @OPDDateSearchTerm = @SearchKey
			end

			--set @OPDDateSearchTerm = @SearchKey
			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))
				--Set @formattedDate = @OPDDateSearchTerm
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @SearchType = 'FreeSearch'
				print '@datecondition => ' + @datecondition
			end
			--Jeet Chauhan 
			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			print 'search key => ' + @SearchKey
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry + 
						CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 

						when 'OpdDate'
						then ' and cast(OpdDate as date) = ' + @SearchKey
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	
			print @v_PagingQry
			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
			declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds, CaseId
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId,CaseId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
			DECLARE @P_atientId INT, @V_isitId nvarchar(max), @C_CaseId bigint;

			select @P_atientId = PatientId,@V_isitId= VisitIds, @C_CaseId =CaseId  from #TempPatientVisits where RowId = @RowId

			--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
			--select @V_isitId
			--select @P_atientId

			declare @frompatientid bigint = @P_atientId
			declare @fromvisitids nvarchar(max) = @V_isitId
			declare @tblfrom table (ids bigint) 

			insert into @tblfrom(ids)
			select value from string_split(@fromvisitids,',')
		
			--select cast(@RowId as nvarchar(max)) + '_asdfas'
			--select * from @tblfrom


			--declare @t1 table (ids bigint)

			--select VisitId from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) 

			--select VisitId,EntryDate from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

			declare @updatedVisitId bigint = 0;

			;WITH cte AS (
				SELECT 
				VisitId,
					IsLatestVisit,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientVisits
				WHERE PatientId = @frompatientid
				and VisitId in (select VisitId from patient.tblPatientVisits 
				where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
				--and VisitId not in (885)
			)
			SELECT  @updatedVisitId= VisitId
			FROM cte
			WHERE RowNum = 1;


			declare @caseIdToUpdate bigint ;
			;WITH cte AS (
				SELECT 
				CaseId,
					IsLatest,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientCases
				WHERE PatientId = @frompatientid
				and CaseId in (select CaseId from patient.tblPatientCases 
				where PatientId in (@frompatientid) 
				and CaseId not in (@C_CaseId))
				--and VisitId not in (885)
			)
			SELECT @caseIdToUpdate = CaseId
			FROM cte
			WHERE RowNum = 1;



			--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId
			update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

			update patient.tblPatientCases set IsLatest = 1 where PatientId = @frompatientid and CaseId in (@caseIdToUpdate)

			delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId

			delete from patient.tblPatientVisits 
			where PatientId = @frompatientid and VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end	

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			--------------------------------------
			IF EXISTS ( select PatientId from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end


				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_15022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 create PROCEDURE [dbo].[Usp_Manage_Patients_15022025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(10) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District) 
				   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName)
				values (@FirstName)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName)
				values (@LastName)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName)
				values (@PrimaryRelativeName)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end

			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark)
			end
			-- -- // ==========================================================================================


		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy )
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
   --p.Height as Height,p.weight as Weight,
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   isnull(MarriedLife,0) as MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))	
				print @SearchKey
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			--if(@PageNo = 1)
			--begin
			--	set @OPDDateSearchTerm = @SearchKey
			--end

			--set @OPDDateSearchTerm = @SearchKey
			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))
				--Set @formattedDate = @OPDDateSearchTerm
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @SearchType = 'FreeSearch'
				print '@datecondition => ' + @datecondition
			end
			--Jeet Chauhan 
			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			print 'search key => ' + @SearchKey
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry + 
						CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 

						when 'OpdDate'
						then ' and cast(OpdDate as date) = ' + @SearchKey
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	
			print @v_PagingQry
			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
			declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
				DECLARE @P_atientId INT, @V_isitId nvarchar(max);

				select @P_atientId = PatientId,@V_isitId= VisitIds  from #TempPatientVisits where RowId = @RowId

					--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
					--select @V_isitId
					--select @P_atientId

					declare @frompatientid bigint = @P_atientId
					declare @fromvisitids nvarchar(max) = @V_isitId
					declare @tblfrom table (ids bigint) 

					insert into @tblfrom(ids)
					select value from string_split(@fromvisitids,',')
		
					--select cast(@RowId as nvarchar(max)) + '_asdfas'
					--select * from @tblfrom


					--declare @t1 table (ids bigint)

					--select VisitId from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) 

					--select VisitId,EntryDate from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

					declare @updatedVisitId bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @frompatientid
						and VisitId in (select VisitId from patient.tblPatientVisits 
						where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
						--and VisitId not in (885)
					)
					SELECT  @updatedVisitId= VisitId
					FROM cte
					WHERE RowNum = 1;

					--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId
					update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

					delete from patient.tblPatientVisits where PatientId = @frompatientid and VisitId in (select ids from @tblfrom)

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom)
			end


				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_21102025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_21102025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT

  ,@C_CaseIdReturn bigint = 0 OUTPUT
  ,@V_VisitIdReturn bigint = 0 OUTPUT

  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(100) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added

	, @Remark nvarchar(max) = ''
	, @FUDate nvarchar(100) = ''


 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int = 0 ; --, @V_VisitIdReturn bigint = 0,@C_CaseIdReturn bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin              
			set @v_Identity = SCOPE_IDENTITY()
			--SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin

				-- Jeet Chauhan New Taluka add logic

				declare @VV_StateId bigint = 0 , @VV_talukaId bigint = 0 , @VV_DistrictId bigint = 0;

				select top 1 @VV_StateId = StateId from location.tblState where State = @State and Language = @Language 
				select top 1 @VV_DistrictId = StateId from location.tblDistrict where District = @District and Language = @Language 
				select top 1 @VV_talukaId = TalukaId from location.tblTaluka where Taluka = @Taluka and Language = @Language 

				If Not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language)
				Begin
					INSERT INTO location.tblState  
					 (State, Language, IsActive, IsEdited, EntryDate, CreatedBy) 
						VALUES (@State, @Language, 1, 1, GETDATE(), 1) 

						Set @VV_StateId = SCOPE_IDENTITY()
				END

				If Not Exists (select top 1 DistrictId from location.tblDistrict with (nolock) where District=@District and StateId=@VV_StateId and Language=@Language)
			    Begin
					 INSERT INTO location.tblDistrict  
					(District, Language, StateId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@District, @Language, @VV_StateId, 1, 1, GETDATE(), 1)

						Set @VV_DistrictId = SCOPE_IDENTITY()
				END



				If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@VV_DistrictId and Language=@Language)
				Begin
					INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, CreatedBy) 
					VALUES (@Taluka, @Language, @VV_DistrictId, 1, 1, GETDATE(), 1)  
				END


				-- Jeet Chauhan New Taluka add logic
				
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District , Area , Society) 
				   VALUES (@VillageCity, isnull(@v_TalukaId,0), @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District , @Area , @Society)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End

			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName, Langauge)
				values (@FirstName , @Language)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName, langauge)
				values (@LastName, @Language)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName , langauge)
				values (@PrimaryRelativeName , @Language)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end


			--if not Exists (select top 1 Area from location.tblArea with(nolock) where trim(lower(Area)) = TRIM(LOWER(@Area)))
			--begin
			--	insert into location.tblArea(Area, Language , IsActive , CreatedBy)
			--	values (@Area,@Language , 1 , 1)
			--end

			--if not Exists (select top 1 Society from location.tblSociety with(nolock) where trim(lower(Society)) = TRIM(LOWER(@Society)))
			--begin
			--	insert into location.tblSociety(Society, Language , IsActive ,IsActive)
			--	values (@Society,@Language)
			--end


			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
							and TRIM(LOWER(Area)) = TRIM(LOWER(@Area))
							and TRIM(LOWER(Society)) = TRIM(LOWER(@Society))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark , Area , Society)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark , @Area , @Society)
			end
			-- -- // ==========================================================================================

			SELECT @v_IsSuccess=1, @v_Identity = @v_Identity, @v_Message='success',  @v_CustomMessage = 'Saved successfully!', @C_CaseIdReturn = @v_CaseId , @V_VisitIdReturn = @v_visitedId;

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity,isnull( @v_TalukaId , 0 ) , @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy ,@PatientId)
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
				   --p.Height as Height,p.weight as Weight,
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   isnull(MarriedLife,0) as MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein
				   ,p.HouseNo , p.Society

				   , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added

				  left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
				   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
				   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
				   MarriedLife,

					Pulse, SystolicBloodPressure,DaistolicBloodPressure,
				   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

				     , primarySuffix.RecordName as PrimarySuffix
				   , secondary.RecordName as SecondarySuffix
					-- Jeet Chauhan New Changes

				-- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				   left join common.tblEntityRecords primarySuffix on primarySuffix.EntityRecordId = p.SecondaryRelativeNameSuffix
				  left join common.tblEntityRecords secondary on secondary.EntityRecordId = p.SecondaryRelativeNameSuffix
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			

			if @PageNo = 1
			begin
				--set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
				set @v_PagingQry = '  1=1 '
			end
			ELSE
			BEGIN
				Set @StartRow = ((@PageNo-2)*@PageSize) + 1		
				Set @StopRow = ((@PageNo - 1)*@PageSize)
				set @v_PagingQry = '  CTE.RowId Between '+CONVERT(varchar(30),@StartRow -1 ) +' And '+ CONVERT(varchar(30),@StopRow  )

			END

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))	
				print @SearchKey
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(@PageNo =0 )
			begin
				set @OPDDateSearchTerm = @SearchKey
			end

			--set @OPDDateSearchTerm = @SearchKey
			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))
				--Set @formattedDate = @OPDDateSearchTerm
				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				--set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @OPDDateSearchTerm + ''')'

				set @SearchType = 'FreeSearch'
				print '@datecondition => ' + @datecondition
			end
			--Jeet Chauhan 

			declare @remarkCondition nvarchar(max) = ''
			if(ISNULL(@Remark,'') != '')
			BEGIN
				
				set @remarkCondition = ' and pv.Remark like ''%'+ @Remark +'%'' '
				set @SearchType = 'FreeSearch'
				print @remarkCondition
			END

			declare @FUDateConditions nvarchar(max) = ''
			if(ISNULL(@FUDate,'') != '')
			BEGIN
				
				declare @defaultDateConversion nvarchar(100) = (select LOWER(FORMAT(CONVERT(DATE, @FUDate, 103), 'yyyy-MM-dd')))
				print @defaultDateConversion
				set @FUDateConditions = ' and pv.FollowupDate = ''' + @defaultDateConversion + ''''
				set @SearchType = 'FreeSearch'
				print @FUDateConditions
			END


			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition + @remarkCondition + @FUDateConditions
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			print 'search key => ' + @SearchKey
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry + 
						CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 

						when 'OpdDate'
						then ' and cast(OpdDate as date) = ' + @SearchKey
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	
			print @v_PagingQry
			set @BaseQry = '				

				;With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE 
						
						

						(
							

							'+ case when cast(@PageNo as nvarchar(10)) = 1 then + 'cast(OpdDate as date) = CAST(GETDATE() as date)' else + @WhereQry end +'

						)

					) A
				),
				FirstEDD AS (
					SELECT 
						pc.CaseId,
						MIN(vvc.FirstEDDAccordingUSG) AS FirstEDD
					FROM patient.tblPatientCases pc
					INNER JOIN patient.tblPatientVisits vvc WITH (NOLOCK) ON pc.CaseId = vvc.CaseId
					GROUP BY pc.CaseId
				)
				
				
				Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime

				

				,CASE 
					WHEN 
						(DATEDIFF(DAY, fe.FirstEDD, GETDATE()) > 30)
						OR mtp.VisitId IS NOT NULL
						OR del.VisitId IS NOT NULL
					THEN 1 ELSE 0
				END AS ISMoreThenNineMonths,

				CASE WHEN usg.VisitId IS NOT NULL THEN 1 ELSE 0 END AS UsgDone,
				CASE WHEN mtp.VisitId IS NOT NULL THEN 1 ELSE 0 END AS MTPDone,
				CASE WHEN del.VisitId IS NOT NULL THEN 1 ELSE 0 END AS Delivery,
				CASE WHEN bill.VisitId IS NOT NULL THEN 1 ELSE 0 END AS BillPaid,
				1 AS ConsultationDone, 
				CASE WHEN ReferralIndications IS NOT NULL THEN 1 ELSE 0 END AS Reffrel,
				CASE WHEN usgr.VisitId IS NOT NULL THEN 1 ELSE 0 END AS UsgReportDone,
				CASE WHEN ovo.VisitId IS NOT NULL THEN 1 ELSE 0 END AS OvulationDone,
				CASE WHEN histo.VisitId IS NOT NULL THEN 1 ELSE 0 END AS HistolapDone,
				CASE WHEN indoor.VisitId IS NOT NULL THEN 1 ELSE 0 END AS IndoorDone,
				CASE WHEN dis.VisitId IS NOT NULL THEN 1 ELSE 0 END AS DischargeDone

				  From CTE 
				 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId

				  LEFT JOIN FirstEDD fe ON fe.CaseId = pc.CaseId
					LEFT JOIN patient.tblMTP mtp WITH (NOLOCK) ON mtp.VisitId = pv.VisitId
					LEFT JOIN patient.tblDeliveryRecords del WITH (NOLOCK) ON del.VisitId = pv.VisitId
					LEFT JOIN patient.tblUsgDetails usg WITH (NOLOCK) ON usg.VisitId = pv.VisitId
					LEFT JOIN patient.tblBill bill WITH (NOLOCK) ON bill.VisitId = pv.VisitId
					LEFT JOIN patient.tblUsgReports usgr WITH (NOLOCK) ON usgr.VisitId = pv.VisitId
					LEFT JOIN patient.tblOvulationProfile ovo WITH (NOLOCK) ON ovo.VisitId = pv.VisitId
					LEFT JOIN patient.tblHistolap histo WITH (NOLOCK) ON histo.VisitId = pv.VisitId
					LEFT JOIN patient.tblIndoorRecords indoor WITH (NOLOCK) ON indoor.VisitId = pv.VisitId
					LEFT JOIN patient.tblPatientDischarge dis WITH (NOLOCK) ON dis.VisitId = pv.VisitId


				  ' + + 
				  '
				   Where 
				   (
						
						'+ case when cast(@PageNo as nvarchar(10)) = 1 then + '1 = 1' else + @v_PagingQry  end + '

					)

				  Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		Else if @SubCommand='GetAllDoneList' 
		Begin
			
			
			;With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + ' ' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						 where VisitId = @VisitId --and p.PatientId = @PatientId and pc.CaseId = @CaseId
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, IsLatest as LatestCase ,p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid

				, Case When Exists (select CaseId from patient.tblPatientVisits where VisitId = pv.VisitId) Then 1 Else 0 End ConsultationDone
				, Case When ReferralIndications is not null Then 1 Else 0 End Reffrel
				, Case When Exists (select CaseId from patient.tblUsgReports where VisitId = pv.VisitId) Then 1 Else 0 End UsgReportDone
				, Case When Exists (select CaseId from patient.tblOvulationProfile where VisitId = pv.VisitId) Then 1 Else 0 End OvulationDone
				, Case When Exists (select CaseId from patient.tblHistolap where VisitId = pv.VisitId) Then 1 Else 0 End HistolapDone
				, Case When Exists (select CaseId from patient.tblIndoorRecords where VisitId = pv.VisitId) Then 1 Else 0 End IndoorDone
				, Case When Exists (select CaseId from patient.tblPatientDischarge where VisitId = pv.VisitId) Then 1 Else 0 End DischargeDone

				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  

		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
			declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds, CaseId
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId,CaseId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
			DECLARE @P_atientId INT, @V_isitId nvarchar(max), @C_CaseId bigint;

			select @P_atientId = PatientId,@V_isitId= VisitIds, @C_CaseId =CaseId  from #TempPatientVisits where RowId = @RowId

			--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
			--select @V_isitId
			--select @P_atientId

			declare @frompatientid bigint = @P_atientId
			declare @fromvisitids nvarchar(max) = @V_isitId
			declare @tblfrom table (ids bigint) 

			insert into @tblfrom(ids)
			select value from string_split(@fromvisitids,',')
		
			--select cast(@RowId as nvarchar(max)) + '_asdfas'
			--select * from @tblfrom


			--declare @t1 table (ids bigint)

			--select VisitId from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) 

			--select VisitId,EntryDate from patient.tblPatientVisits 
			--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

			declare @updatedVisitId bigint = 0;

			;WITH cte AS (
				SELECT 
				VisitId,
					IsLatestVisit,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientVisits
				WHERE PatientId = @frompatientid
				and VisitId in (select VisitId from patient.tblPatientVisits 
				where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
				--and VisitId not in (885)
			)
			SELECT  @updatedVisitId= VisitId
			FROM cte
			WHERE RowNum = 1;


			declare @caseIdToUpdate bigint = 0 ;
			;WITH cte AS (
				SELECT 
				CaseId,
					IsLatest,
					EntryDate,
					ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
				FROM patient.tblPatientCases
				WHERE PatientId = @frompatientid
				and CaseId in (select CaseId from patient.tblPatientCases 
				where PatientId in (@frompatientid) 
				and CaseId not in (@C_CaseId))
				--and VisitId not in (885)
			)
			SELECT @caseIdToUpdate = CaseId
			FROM cte
			WHERE RowNum = 1;



			--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId4

			if (@updatedVisitId <> 0 )
			BEGIN
				update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

				
			END
		   
		   IF (@caseIdToUpdate <> 0)
			BEGIN
				--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId
				update patient.tblPatientCases set IsLatest = 1 where PatientId = @frompatientid and CaseId in (@caseIdToUpdate)
			END

			

			--delete from patient.tblPatientCases where PatientId = @frompatientid and CaseId = @C_CaseId

			delete from patient.tblPatientVisits 
			where PatientId = @frompatientid and VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end	

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			--------------------------------------
			IF EXISTS ( select PatientId from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tbl_IndoorRoundRecords where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId)
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom) and CaseId = @C_CaseId
			end

			delete from @table

				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_23012024]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_23012024]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(10) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, Height, Weight) 

       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName)
				values (@FirstName)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName)
				values (@LastName)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName)
				values (@PrimaryRelativeName)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end

			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark)
			end
			-- -- // ==========================================================================================


		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy )
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
   --p.Height as Height,p.weight as Weight,
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   isnull(MarriedLife,0) as MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))			
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))

				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @SearchType = 'FreeSearch'
			end
			--Jeet Chauhan 
			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry 
					+ CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	

			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where VisitId = pv.VisitId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where VisitId = pv.VisitId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where VisitId = pv.VisitId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where VisitId = pv.VisitId) Then 1 Else 0 End BillPaid
				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
		declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
				DECLARE @P_atientId INT, @V_isitId nvarchar(max);

				select @P_atientId = PatientId,@V_isitId= VisitIds  from #TempPatientVisits where RowId = @RowId

					--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
					--select @V_isitId
					--select @P_atientId

					declare @frompatientid bigint = @P_atientId
					declare @fromvisitids nvarchar(max) = @V_isitId
					declare @tblfrom table (ids bigint) 

					insert into @tblfrom(ids)
					select value from string_split(@fromvisitids,',')
		
					--select cast(@RowId as nvarchar(max)) + '_asdfas'
					--select * from @tblfrom


					--declare @t1 table (ids bigint)

					--select VisitId from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) 

					--select VisitId,EntryDate from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

					declare @updatedVisitId bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @frompatientid
						and VisitId in (select VisitId from patient.tblPatientVisits 
						where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
						--and VisitId not in (885)
					)
					SELECT  @updatedVisitId= VisitId
					FROM cte
					WHERE RowNum = 1;

					--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId
					update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

					delete from patient.tblPatientVisits where PatientId = @frompatientid and VisitId in (select ids from @tblfrom)

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom)
			end


				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_30122024]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_30122024]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL,

  -- new parameters for Patient insert
  @MarriedLife int = null
  ,@FTNDS_LiveM   int = null
  ,@FTNDS_LiveF	 int = null
  ,@FTNDS_DeadM	 int = null
  ,@FTNDS_DeadF	 int = null
  ,@FTLSCS_LiveM int = null
  ,@FTLSCS_LiveF int = null
  ,@FTLSCS_DeadM int = null
  ,@FTLSCS_DeadF int = null

  , @Pulse int = null
  ,@SystolicBloodPressure int= null 
  , @DaistolicBloodPressure int = null

  , @InvestigationId int	=NULL 
  ,@HomeBloodGlucoseMonitoring bigint = null
  ,@BloodGroup     bigint = null
  , @UrineSugar	   bigint = null
  , @UrineProtein  bigint = null

  , @height decimal(18,2) = null
  , @weight decimal (18,2) = null
  -- new parameters for Patient insert


  --new Paramter Added
  --,@HusbandOrFirstName nvarchar(200) = ''
  ,@HusbandName nvarchar(200) = ''
  --,@FirstName nvarchar(200) =''
  ,@VillageOrLastName nvarchar(200) = ''
  ,@OPDDateSearchTerm nvarchar(10) = ''
  --new Paramter Added
  

	-- New parameter Added
	, @isMainDelete int = 0
	, @visitidsDeleteSelected nvarchar(max) = null
	--New Parameter added
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy  , Height, Weight) 
       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,taluka,State,District) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
							@Taluka,@State, @District)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy,  height , weight) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy,  @height, @weight)   
			
			


			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			--INSERT INTO [patient].[tblPatientVisits]
			--	([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			--VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- Jeet Chauhan New added

			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy],
				MarriedLife,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,	Pulse, SystolicBloodPressure,DaistolicBloodPressure,patientid)
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy,
			@MarriedLife
			,@FTNDS_LiveM 
			,@FTNDS_LiveF	
			,@FTNDS_DeadM	
			,@FTNDS_DeadF	
			,@FTLSCS_LiveM
			,@FTLSCS_LiveF
			,@FTLSCS_DeadM
			,@FTLSCS_DeadF
			,@Pulse
			, @SystolicBloodPressure
			, @DaistolicBloodPressure
			, @v_Identity
			)

			declare @v_visitedId bigint = SCOPE_IDENTITY();
			-- Jeet Chauhan New added

			-- Jeet Chauhan Invastigation and sp change of add patient
				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@v_CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein,  CreatedBy)
					Values (@v_Identity, @v_CaseId, @v_visitedId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein,  @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End
				-- Jeet Chauhan Invastigation and sp change of add patient

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			-- -- // Insert into aditional Tables for dropdown like villagecity, firstname, lastname, etc =====
			if not Exists (select top 1 PatientName from patient.tbl_PatientName with(nolock) where trim(lower(PatientName)) = TRIM(LOWER(@FirstName)))
			begin
				insert into patient.tbl_PatientName(PatientName)
				values (@FirstName)
			end

			if not Exists (select top 1 LastName from patient.tbl_LastName with(nolock) where trim(lower(LastName)) = TRIM(LOWER(@LastName)))
			begin
				insert into patient.tbl_LastName(LastName)
				values (@LastName)
			end

			if not Exists (select top 1 HusbandName from patient.tbl_husbandName with(nolock) where trim(lower(HusbandName)) = TRIM(LOWER(@PrimaryRelativeName)))
			begin
				insert into patient.tbl_husbandName(HusbandName)
				values (@PrimaryRelativeName)
			end

			if not Exists (select top 1 landmark from patient.tbl_landmark with(nolock) where trim(lower(landmark)) = TRIM(LOWER(@Landmark)))
			begin
				insert into patient.tbl_landmark(landmark, langauge)
				values (@Landmark,@Language)
			end

			if not Exists (select top 1 id from patient.tbl_regiondetails with(nolock) where 
							trim(lower(villagecity)) = TRIM(LOWER(@VillageCity))
							and trim(lower(state)) = TRIM(LOWER(@State))
							and trim(lower(taluka)) = TRIM(LOWER(@Taluka))
							and trim(lower(district)) = TRIM(LOWER(@District))
							and trim(lower(langauge)) = TRIM(LOWER(@Language))
							and TRIM(LOWER(landmark)) = TRIM(LOWER(@Landmark))
						   )
			begin
				insert into patient.tbl_regiondetails (villagecity,state,taluka,district, langauge,pincode,landmark)
				values (@VillageCity,@State,@Taluka, @District, @Language,@PinCode,@Landmark)
			end
			-- -- // ==========================================================================================


		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	-- Jeet Chauhan For empty reffrel for a patient
	ELSE IF @Command='UpdateToEmpty' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=null      				
				--, IsEdited=@IsEdited 			   
				--, UpdatedDate=@UpdatedDate 			   
				--, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
	-- Jeet Chauhan For empty reffrel for a patient
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy ,

		--new parameters Added
		Weight = @weight,
		Height = @height
		--new parameters Added

         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, State, District, taluka) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy,
					@State, @District, @Taluka)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy )
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					--, PatientId = @PatientId
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy], patientId)
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy, @PatientId )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits 
					SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 

					-- new parameters added
					,MarriedLife = @MarriedLife
					,FTNDS_LiveM = @FTNDS_LiveM
					,FTNDS_LiveF = @FTNDS_LiveF
					,FTNDS_DeadM = @FTNDS_DeadM
					,FTNDS_DeadF = @FTNDS_DeadF
					,FTLSCS_LiveM = @FTLSCS_LiveM 
					,FTLSCS_LiveF = @FTLSCS_LiveF
					,FTLSCS_DeadM = @FTLSCS_DeadM
					,FTLSCS_DeadF = @FTLSCS_DeadF
					-- new parameters added
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications

				  -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF,
   --p.Height as Height,p.weight as Weight,
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   isnull(MarriedLife,0) as MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes

				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				   -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				    -- Jeet Chauhan New Changes
   ,FTNDS_LiveM,FTNDS_LiveF,FTNDS_DeadM,FTNDS_DeadF,FTLSCS_LiveM,FTLSCS_LiveF,FTLSCS_DeadM,FTLSCS_DeadF, 
   isnull(p.Height, 0) as Height,isnull(p.weight, 0) as Weight,
   MarriedLife,

    Pulse, SystolicBloodPressure,DaistolicBloodPressure,
   HomeBloodGlucoseMonitoring,BloodGroup, UrineSugar, UrineProtein

    -- Jeet Chauhan New Changes
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				    -- Jeet Chauhan New Added
				  inner join patient.tblInvestigation pi with(nolock) on pi.PatientId = pc.PatientId
				  -- Jeet Chauhan New Added
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(@HusbandName != '')
			begin
			set @husbandNameQuery = '
						     and
						    (
						        ('''+@HusbandName + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandName + '%'')
								--OR
								--(p.FirstName LIKE ''%' + @HusbandName + '%'')
								
						    )
						'
				print @husbandNameQuery
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			declare @FisrtNameQuery nvarchar(max) =''
			if(@FirstName != '')
			begin
			set @FisrtNameQuery = '
						     and
						    (
						        ('''+@FirstName + ''' = '''' and 1=1)
						        OR
						        (p.FirstName LIKE ''%' + @FirstName + '%'')
								
						    )
						'
				print @FisrtNameQuery
			end
			else
			begin
				set @FisrtNameQuery = ''
			end


			-- for village or lastname
			declare @VillageOrLastNameQuery nvarchar(max) =''
			if(@VillageOrLastName != '')
			begin
			set @VillageOrLastNameQuery = '
						     and
						    (
						        ('''+@VillageOrLastName + ''' = '''' and 1=1)
						        OR
						        (pc.VillageCity LIKE ''%' + @VillageOrLastName + '%'')
								OR
								 (p.LastName LIKE ''%' + @VillageOrLastName + '%'')
						    )
						'
						print @VillageOrLastNameQuery
			end
			else
			begin
				set @VillageOrLastNameQuery = ''
			end

			declare @RegistrationOrContactQuery nvarchar(max) =''
			if(@SearchType = 'FreeSearch')
			begin
				declare @RegistrationOrContact nvarchar(80) = isnull(@SearchKey ,'')
				
				if(@RegistrationOrContact != '')
				begin
				set @RegistrationOrContactQuery =' and
							(
							(pc.ContatcNo like ''%' + @SearchKey + '%'')
							Or 
							(pc.CaseRegNo like ''%' + @SearchKey + '%'')
							)'

							print @RegistrationOrContactQuery
				end
				else
				begin
					set @RegistrationOrContactQuery = ''
				end
			end
			else
			begin
				set @RegistrationOrContactQuery = ''
			end

		


			
			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				--Set @SearchKey = Cast(@SearchKey as Date)				
				Set @SearchKey = LOWER(FORMAT(CONVERT(DATE, @SearchKey, 103), 'yyyy-MM-dd'))			
			End

			--Jeet Chauhan for date condition
			declare @datecondition nvarchar(max) = ''
			--if(@SearchType = 'OpdDate')
			--begin
			--	set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
			--	set @SearchType = 'FreeSearch'
			--end

			if(isnull(@OPDDateSearchTerm,'') != '')
			begin
				declare @formattedDate nvarchar(10)	= ''
				Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @OPDDateSearchTerm, 103), 'yyyy-MM-dd'))

				--Set @formattedDate = LOWER(FORMAT(CONVERT(DATE, @formattedDate, 103), 'yyyy-MM-dd'))

				set @datecondition  = 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @formattedDate + ''')'
				set @SearchType = 'FreeSearch'
			end
			--Jeet Chauhan 
			declare @finalQuery nvarchar(max) = @RegistrationOrContactQuery + @husbandNameQuery + @FisrtNameQuery + @VillageOrLastNameQuery + @datecondition
			--Jeet Chauhan for date condition

			--If ISNULL(@SearchKey,'')!=''
			--If (ISNULL(@SearchKey,'')!='' or ISNULL(@RegistrationOrContactQuery,'')!='' or ISNULL(@VillageOrLastNameQuery,'')!='' or ISNULL(@husbandNameQuery,'')!='')
			if(ISNULL(@finalQuery,'') != '')
			Begin
				--SET @WhereQry = @WhereQry + ' AND ' 
				SET @WhereQry = @WhereQry 
					+ CASE @SearchType
						When 'PatientId'
						Then 'and p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'and p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch'
						
						--Jeet Chauhan New Change
						--Then 
						--'(p.FirstName like ''%' + @SearchKey + '%'' 
						--Or p.LastName like ''%' + @SearchKey + '%'' 
						--Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						--Or pc.ContatcNo like ''%' + @SearchKey + '%''
						--Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						--Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						--Or pc.Taluka like ''%' + @SearchKey + '%'' 
						--Or pc.District like ''%' + @SearchKey + '%'' 
						--Or pc.State like ''%' + @SearchKey + '%'' 
						--Or pc.PinCode like ''%' + @SearchKey + '%''
						--)'
						Then 
						@finalQuery
						--Jeet Chauhan New Change
						
						--When 'OpdDate'
						----Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
						--Then 'and pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	

			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where CaseId = pv.CaseId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where CaseId = pv.CaseId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where CaseId = pv.CaseId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where CaseId = pv.CaseId) Then 1 Else 0 End BillPaid
				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 

	
    
	  
	  -- Jeet Chauhan For Delete Patient
	IF @SubCommand = 'DeleteMultiple'
	BEGIN
		IF EXISTS (select PatientId from patient.tblPatients where PatientId = @patientId)
		BEGIN	
			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--------------------------------------------------------
	
			if exists (select top 1 UsgId from patient.tblUsgDetails where VisitId = @visitId)
			BEGIN
				--select 'tblUsgDetails'
				--select top 1 * from patient.tblUsgDetails where VisitId = @visitId
				delete from patient.tblUsgDetails where VisitId = @visitId
			END

			if exists (select top 1 ReportId from patient.tblUsgReports where VisitId = @visitId)
			BEGIN
				--select top 1 * from patient.tblUsgReports where VisitId = @visitId
				--select 'tblUsgReports'
				delete from patient.tblUsgReports where VisitId = @visitId
			END

			if exists (select top 1 ProfileId from patient.tblOvulationProfile   where VisitId = @visitId)
			BEGIN
				--select 'tblOvulationProfile'
				delete from patient.tblOvulationProfile   where VisitId = @visitId
			END

			if exists (select top 1 MTPId from patient.tblMTP   where VisitId = @visitId)
			BEGIN
				--select 'tblMTP'
				delete from patient.tblMTP   where VisitId = @visitId
			END

			if exists (select top 1 DeliveryId from patient.tblDeliveryRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblDeliveryRecords'
				delete from patient.tblDeliveryRecords   where VisitId = @visitId
			END

			if exists (select top 1 IndoorRecordId from patient.tblIndoorRecords   where VisitId = @visitId)
			BEGIN
				--select 'tblIndoorRecords'
				delete from patient.tblIndoorRecords   where VisitId = @visitId
			END

			if exists (select top 1 BillId from patient.tblBill   where VisitId = @visitId)
			BEGIN
				--select 'tblBill'
				delete from patient.tblBill   where VisitId = @visitId
			END

			if exists (select top 1 VoucherId from patient.tblBillVoucher   where VisitId = @visitId)
			BEGIN
				--select 'tblBillVoucher'
				delete from patient.tblBillVoucher   where VisitId = @visitId
			END

			if exists (select top 1 DischargeId from patient.tblPatientDischarge   where VisitId = @visitId)
			BEGIN
				--select 'tblPatientDischarge'
				delete from patient.tblPatientDischarge   where VisitId = @visitId
			END

			--------------------------------------------------------

		END

		IF @isMainDelete = 1 
		BEGIN

			--IF EXISTS (select * from patient.tblPatientCases where  CaseId = @CaseId)
			--BEGIN
			--	--select 'tblPatientCases'
			--	--select * from patient.tblPatientCases where  CaseId = @CaseId
			--	delete from patient.tblPatientCases where  CaseId = @CaseId
			--END

			--IF EXISTS ( select VisitId from patient.tblPatientVisits where VisitId = @visitId )
			--BEGIN
			--	--select 'tblPatientVisits'
			--	delete from patient.tblPatientVisits where VisitId = @visitId 
			--END

			--IF EXISTS ( select InvestigationId from patient.tblInvestigation where VisitId = @visitId )
			--BEGIN
			--	--select 'tblInvestigation'
			--	delete from patient.tblInvestigation where VisitId = @visitId
			--END

			--	--select 'selected --1'
			--	delete patient.tblPatients where PatientId = @visitId

			---
			--IF EXISTS ( select PatientId from patient.tblPatients where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatients where PatientId = @PatientId
			--end

			----
			--IF EXISTS ( select PatientId from patient.tblPatientCases where PatientId = @PatientId )
			--begin
			--	delete from patient.tblPatientCases where PatientId = @PatientId
			--end

			----
			IF EXISTS ( select PatientId from patient.tblPatientVisits where VisitId = @VisitId)
			begin
			
			declare @PriviousVisitIdToMakeLatest bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @PatientId
					)
					SELECT @PriviousVisitIdToMakeLatest = VisitId
					FROM cte
					where RowNum = 2

				update patient.tblPatientVisits set IsLatestVisit = 1 where VisitId = @PriviousVisitIdToMakeLatest

				delete from patient.tblPatientVisits where VisitId = @VisitId
			end

			----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId = @VisitId )
			begin
				delete from patient.tblInvestigation where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId = @VisitId )
			begin
				delete from patient.tblUsgDetails where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId = @VisitId )
			begin
				delete from patient.tblUsgReports where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId = @VisitId )
			begin
				delete from patient.tblOvulationProfile where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId = @VisitId )
			begin
				delete from patient.tblMTP where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId = @VisitId )
			begin
				delete from patient.tblHistolap where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId = @VisitId )
			begin
				delete from patient.tblDeliveryRecords where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId = @VisitId )
			begin
				delete from patient.tblIndoorRecords where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId = @VisitId )
			begin
				delete from patient.tblBill where VisitId = @VisitId
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId = @VisitId )
			begin
				delete from patient.tblBillVoucher where VisitId = @VisitId
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId = @VisitId )
			begin
				delete from patient.tblPatientDischarge where VisitId = @VisitId
			end
		END
	END
	
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------
	IF @SubCommand = 'DeleteSelected'
	BEGIN
		declare @table  table (visitid bigint)
			insert into @table
			select cast(value as bigint) visitId from string_split(@visitidsDeleteSelected, ',')

			--select * from @table

			--select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId, PatientId, VisitId
			select ROW_NUMBER() OVER (ORDER BY PatientId desc) AS RowId,
			PatientId, STRING_AGG( cast(VisitId as nvarchar(max)),',') as VisitIds
			INTO #TempPatientVisits
			from patient.tblPatientVisits where VisitId in (SELECT VisitId  FROM @table)
			group by PatientId

			--SELECT * FROM #TempPatientVisits;

			DECLARE @TotalRows INT;
			SELECT @TotalRows = COUNT(*) FROM #TempPatientVisits;
			--select @TotalRows

			DECLARE @RowId INT = 1;
			WHILE @RowId <= @TotalRows
			BEGIN
				DECLARE @P_atientId INT, @V_isitId nvarchar(max);

				select @P_atientId = PatientId,@V_isitId= VisitIds  from #TempPatientVisits where RowId = @RowId

					--select cast(@RowId as nvarchar(max)) + '_asdfas111111'
					--select @V_isitId
					--select @P_atientId

					declare @frompatientid bigint = @P_atientId
					declare @fromvisitids nvarchar(max) = @V_isitId
					declare @tblfrom table (ids bigint) 

					insert into @tblfrom(ids)
					select value from string_split(@fromvisitids,',')
		
					--select cast(@RowId as nvarchar(max)) + '_asdfas'
					--select * from @tblfrom


					--declare @t1 table (ids bigint)

					--select VisitId from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) 

					--select VisitId,EntryDate from patient.tblPatientVisits 
					--where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom)

					declare @updatedVisitId bigint = 0;

					;WITH cte AS (
						SELECT 
						VisitId,
							IsLatestVisit,
							EntryDate,
							ROW_NUMBER() OVER (PARTITION BY PatientId ORDER BY EntryDate DESC) AS RowNum
						FROM patient.tblPatientVisits
						WHERE PatientId = @frompatientid
						and VisitId in (select VisitId from patient.tblPatientVisits 
						where PatientId in (@frompatientid) and VisitId not in (select ids from @tblfrom))
						--and VisitId not in (885)
					)
					SELECT  @updatedVisitId= VisitId
					FROM cte
					WHERE RowNum = 1;

					--select * from patient.tblPatientVisits where PatientId = @P_atientId and VisitId = @updatedVisitId
					update patient.tblPatientVisits set IsLatestVisit = 1 where PatientId = @frompatientid and VisitId in (@updatedVisitId)

					delete from patient.tblPatientVisits where PatientId = @frompatientid and VisitId in (select ids from @tblfrom)

					----------------------------------
			IF EXISTS ( select PatientId from patient.tblInvestigation where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblInvestigation where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgDetails where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgDetails where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblUsgReports where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblUsgReports where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom) )
			begin
				delete from patient.tblOvulationProfile where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblMTP where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblMTP where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblHistolap where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblHistolap where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblDeliveryRecords where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblIndoorRecords where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBill where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBill where VisitId in (select ids from @tblfrom)
			end
			
			------------------------------------
			IF EXISTS ( select PatientId from patient.tblBillVoucher where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblBillVoucher where VisitId in (select ids from @tblfrom)
			end

			------------------------------------
			IF EXISTS ( select PatientId from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom))
			begin
				delete from patient.tblPatientDischarge where VisitId in (select ids from @tblfrom)
			end


				SET @RowId = @RowId + 1;
			END;

	END
	----------------------------Jeet Chauhan selected Delete Satrt--------------------------------------------

	 -- Jeet Chauhan For Delete Patient


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Patients_bkp_19_10_2024]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROCEDURE [dbo].[Usp_Manage_Patients_bkp_19_10_2024]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @DateOfBirth date=NULL 
  , @Age int=NULL 
  , @Gender int=NULL 
  , @IsMarried bit=NULL 
  , @ContatcNo nvarchar(50)=NULL 
  , @Email nvarchar(50)=NULL 
  , @PrimaryRelation nvarchar(50)=NULL 
  , @PrimaryRelativeName nvarchar(50)=NULL 
  , @PrimaryRelativeNameSuffix nvarchar(50)=NULL 
  , @PrimaryContactNo nvarchar(50)=NULL 
  , @SecondaryRelation nvarchar(50)=NULL 
  , @SecondaryRelativeName nvarchar(50)=NULL 
  , @SecondaryRelativeNameSuffix nchar(10)=NULL 
  , @SecondaryContactNo nvarchar(50)=NULL 
  , @LocationRefId int=NULL
  , @HouseNo nvarchar(100)=NULL
  , @Society nvarchar(200)=NULL
  , @Area  nvarchar(200)=NULL
  , @Landmark nvarchar(200)=NULL 
  , @VillageCity nvarchar(50)=NULL 
  , @Taluka nvarchar(50)=NULL 
  , @District nvarchar(50)=NULL 
  , @State nvarchar(50)=NULL 
  , @PinCode nvarchar(20)=NULL 
  , @IsPatientActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
 
  , @CaseId bigint = NULL
  , @CaseRegNo nvarchar(100) = NULL
  , @ReferralIndications nvarchar(MAX) = NULL
  , @VisitId bigint = NULL
  , @OpdDate date = NULL
  , @OpdTime time = NULL
  , @Language nvarchar(200) = NULL

  --new Paramter Added
  ,@HusbandOrFirstName nvarchar(200) = null
  --,@VillageOrLastName nvarchar(200) = null
  --new Paramter Added
  
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_CaseId bigint = 0, @v_TalukaId int 
  
    IF @Command='INSERT' 
    BEGIN 
	
      INSERT INTO patient.tblPatients  
         (HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
		 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
		 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
		 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
		 , IsPatientActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
	   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
	   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
	   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
	   , @IsPatientActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End

			-- -- // Add new Patient Case
			INSERT INTO patient.tblPatientCases  
				 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
				 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
				 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
				 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
				 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@CaseRegNo, @v_Identity, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
			   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
			   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
			   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
			   , 1, 1, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
			

			set @v_CaseId = SCOPE_IDENTITY();

			-- -- // Add new Patient Visit 
			INSERT INTO [patient].[tblPatientVisits]
				([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
			VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, @EntryDate, @CreatedBy, @UpdatedBy )

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 

	ELSE IF @Command='UpdateIndications' 
    BEGIN 
			If Exists (select top 1 CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and CaseId=@CaseId)
			Begin				
				 UPDATE patient.tblPatientCases 
				 SET ReferralIndications=@ReferralIndications      				
				, IsEdited=@IsEdited 			   
				, UpdatedDate=@UpdatedDate 			   
				, UpdatedBy=@UpdatedBy 
				 WHERE PatientId=@PatientId and CaseId=@CaseId     
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @CaseId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @CaseId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Record not found!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatients SET FirstName=@FirstName 
        , LastName=@LastName 
        , DateOfBirth=@DateOfBirth 
        , Age=@Age 
        , Gender=@Gender 
        , IsMarried=@IsMarried 
        , ContatcNo=@ContatcNo 
        , Email=@Email 
        , PrimaryRelation=@PrimaryRelation 
        , PrimaryRelativeName=@PrimaryRelativeName 
        , PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
        , PrimaryContactNo=@PrimaryContactNo 
        , SecondaryRelation=@SecondaryRelation 
        , SecondaryRelativeName=@SecondaryRelativeName 
        , SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
        , SecondaryContactNo=@SecondaryContactNo 
        , LocationRefId=@LocationRefId
		, HouseNo=@HouseNo
		, Society=@Society
		, Area=@Area
		, Landmark=@Landmark
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , State=@State 
        , PinCode=@PinCode 
        , IsPatientActive=@IsPatientActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE PatientId=@PatientId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			-- -- // Check to add new location record
			If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@VillageCity and Taluka=@Taluka and District=@District and State=@State)
			Begin
					INSERT INTO location.tblPincodeLocations  
					 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
				   VALUES (@VillageCity, @VillageCity, @Pincode, 'B.O', 'Delivery', @Taluka, @District, @State)   
        
			End

			If Not Exists (select top 1 VillageCityId 
					from location.tblVillageCity vc with (nolock) 
					inner join location.tblTaluka t with (nolock) on vc.TalukaId=t.TalukaId and t.Taluka=@Taluka and t.IsActive=1
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where vc.VillageCity=@VillageCity and vc.Language=@Language and vc.IsActive=1
				)
			Begin
					
					SET @v_TalukaId= (select top 1 TalukaId from  
					location.tblTaluka t with (nolock) 
					inner join location.tblDistrict d with (nolock) on t.DistrictId=d.DistrictId and d.District=@District and d.IsActive=1
					inner join location.tblState s with (nolock) on d.StateId = s.StateId and s.State=@State And s.IsActive=1
					where t.Taluka=@Taluka and t.Language=@Language and t.IsActive=1 
					)

					INSERT INTO location.tblVillageCity  
					 (VillageCity, TalukaId, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@VillageCity, @v_TalukaId, @Language, 1, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)   
        
			End

			-- -- // Insert into Sync Table =====================================================================
			If Not Exists(Select top 1 FirstName from sync.tblFirstNames where LOWER(FirstName)=LOWER(@FirstName))
			Begin
				INSERT INTO sync.tblFirstNames (FirstName, IsSyncPending, EntryDate)
				VALUES (@FirstName, 1, GETDATE())
			End

			If Not Exists(Select top 1 LastName from sync.tblLastNames where LOWER(LastName)=LOWER(@LastName))
			Begin
				INSERT INTO sync.tblLastNames (LastName, IsSyncPending, EntryDate)
				VALUES (@LastName, 1, GETDATE())
			End
			-- -- // =============================================================================================

			If @SubCommand = 'Add New Case'
			Begin
					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where VisitId=@VisitId
					where CaseId=(select CaseId from patient.tblPatientCases pc with (nolock) where pc.PatientId=@PatientId and pc.IsLatest=1) and IsLatestVisit=1
					-- -- // Update latest existing record status of IsLatest to zero(0);
					Update patient.tblPatientCases set IsLatest=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy 
					--where CaseId=@CaseId
					where PatientId=@PatientId and IsLatest=1

					-- -- // Add new Patient Case
					INSERT INTO patient.tblPatientCases  
						 (CaseRegNo, PatientId, HospitalId, FirstName, LastName, DateOfBirth, Age, Gender, IsMarried, ContatcNo, Email
						 , PrimaryRelation, PrimaryRelativeName, PrimaryRelativeNameSuffix, PrimaryContactNo
						 , SecondaryRelation, SecondaryRelativeName, SecondaryRelativeNameSuffix, SecondaryContactNo
						 , LocationRefId, HouseNo, Society, Area, Landmark, VillageCity, Taluka, District, State, PinCode
						 , IsLatest, IsCaseActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
					   VALUES (@CaseRegNo, @PatientId, @HospitalId, @FirstName, @LastName, @DateOfBirth, @Age, @Gender, @IsMarried, @ContatcNo, @Email
					   , @PrimaryRelation, @PrimaryRelativeName, @PrimaryRelativeNameSuffix, @PrimaryContactNo
					   , @SecondaryRelation, @SecondaryRelativeName, @SecondaryRelativeNameSuffix, @SecondaryContactNo
					   , @LocationRefId, @HouseNo, @Society, @Area, @Landmark, @VillageCity, @Taluka, @District, @State, @PinCode
					   , 1, 1, @IsEdited, GETDATE(), NULL, @CreatedBy, @UpdatedBy)   
			

					set @v_CaseId = SCOPE_IDENTITY();					

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy )
			End

			Else If @SubCommand = 'Add New Visit'
			Begin
					-- -- Select latest case record
					select @v_CaseId = CaseId from patient.tblPatientCases with (nolock) where PatientId=@PatientId and IsLatest=1;

						-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@v_CaseId 

					-- -- // Update latest existing record status of last visit to zero(0);				    
				    Update patient.tblPatientVisits set IsLatestVisit=0, @UpdatedDate=GETDATE(), UpdatedBy=@UpdatedBy where CaseId=@v_CaseId and IsLatestVisit=1

					-- -- // Add new Patient Visit			
					INSERT INTO [patient].[tblPatientVisits]
						([CaseId],[OpdDate],[OpdTime],[IsActive],[IsEdited],[EntryDate],[CreatedBy],[UpdatedBy])
					VALUES (@v_CaseId, @OpdDate, @OpdTime, 1, @IsEdited, GETDATE(), @CreatedBy, @UpdatedBy )
			End
			Else
			Begin
					-- -- In Edit Case Update the Case and Visit Records whose CaseId and VisitId are passed

					-- -- // Update Patient Case Profile
					UPDATE patient.tblPatientCases SET FirstName=@FirstName 
					, LastName=@LastName 
					, DateOfBirth=@DateOfBirth 
					, Age=@Age 
					, Gender=@Gender 
					, IsMarried=@IsMarried 
					, ContatcNo=@ContatcNo 
					, Email=@Email 
					, PrimaryRelation=@PrimaryRelation 
					, PrimaryRelativeName=@PrimaryRelativeName 
					, PrimaryRelativeNameSuffix=@PrimaryRelativeNameSuffix 
					, PrimaryContactNo=@PrimaryContactNo 
					, SecondaryRelation=@SecondaryRelation 
					, SecondaryRelativeName=@SecondaryRelativeName 
					, SecondaryRelativeNameSuffix=@SecondaryRelativeNameSuffix 
					, SecondaryContactNo=@SecondaryContactNo 
					, LocationRefId=@LocationRefId
					, HouseNo=@HouseNo
					, Society=@Society
					, Area=@Area
					, Landmark=@Landmark
					, VillageCity=@VillageCity 
					, Taluka=@Taluka 
					, District=@District 
					, State=@State 
					, PinCode=@PinCode 					
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE CaseId=@CaseId     

					 -- -- // Update Patient Visit
					UPDATE patient.tblPatientVisits SET OpdDate=@OpdDate
					, OpdTime=@OpdTime
					, IsEdited=@IsEdited 
				   -- , EntryDate=@EntryDate 
					, UpdatedDate=@UpdatedDate 
				   -- , CreatedBy=@CreatedBy 
					, UpdatedBy=@UpdatedBy 
					 WHERE VisitId=@VisitId     

			End

		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @PatientId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			If ISNULL(@VisitId, 0) > 0
			Begin
					SELECT p.PatientId, p.HospitalId, p.FirstName, p.LastName, p.DateOfBirth, p.Age, p.Gender, p.IsMarried, p.ContatcNo, p.Email
				  , p.PrimaryRelation, p.PrimaryRelativeName, p.PrimaryRelativeNameSuffix, p.PrimaryContactNo
				  , p.SecondaryRelation, p.SecondaryRelativeName, p.SecondaryRelativeNameSuffix, p.SecondaryContactNo
				  , p.LocationRefId, p.HouseNo, p.Society, p.Area, p.Landmark, p.VillageCity, p.Taluka, p.District, p.State, p.PinCode
				  , p.IsPatientActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				  FROM patient.tblPatients p with (nolock) 
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId 
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId 
				  WHERE p.PatientId=@PatientId and pv.VisitId=@VisitId
			End
			Else
			Begin
				-- -- Select Latest Record
				SELECT pc.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				  , pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				  , pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				  , pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				  , p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				  , pc.CaseId, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OPDTime, pc.ReferralIndications
				  FROM patient.tblPatients p with (nolock) 				  
				  INNER JOIN patient.tblPatientCases pc with (nolock)  on p.PatientId=pc.PatientId and pc.IsLatest=1
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId and pv.IsLatestVisit=1
				  WHERE p.PatientId=@PatientId
			End

		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			--SET @WhereQry = ' p.IsPatientActive in (1,0) '				
			SET @WhereQry = ' 1=1 '				
			
			--new Jeet Chauhan
			declare @husbandNameQuery nvarchar(max) =''
			if(isnull(@HusbandOrFirstName,'') != '')
			begin
			set @husbandNameQuery = '
						    AND 
						    (
						        ('''+isnull(@HusbandOrFirstName,'''') + ''' = '''' and 1=1)
						        OR
						        (pc.PrimaryRelativeName LIKE ''%' + @HusbandOrFirstName + '%'')
						    )
						'
			end
			else
			begin
				set @husbandNameQuery = ''
			end

			--new Jeet Chauhan

			If @SearchType = 'OpdDate'
			Begin
				Set @SearchKey = Cast(@SearchKey as Date)				
			End

			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'PatientId'
						Then 'p.PatientId = ' + Convert(varchar, @SearchKey) 
						When 'Name'
						Then 'p.FirstName = ' + Convert(varchar, @SearchKey) 
						When 'FreeSearch' 
						Then '(p.FirstName like ''%' + @SearchKey + '%'' 
						Or p.LastName like ''%' + @SearchKey + '%'' 
						Or (Concat(p.FirstName, '' '', p.LastName) like ''%' + @SearchKey + '%'') 
						Or pc.ContatcNo like ''%' + @SearchKey + '%''
						Or pc.CaseRegNo like ''%' + @SearchKey + '%''
						Or pc.VillageCity like ''%' + @SearchKey + '%'' 
						Or pc.Taluka like ''%' + @SearchKey + '%'' 
						Or pc.District like ''%' + @SearchKey + '%'' 
						Or pc.State like ''%' + @SearchKey + '%'' 
						Or pc.PinCode like ''%' + @SearchKey + '%''
						)'
						+
						@husbandNameQuery
						When 'OpdDate'
						Then ' pv.VisitId in (Select VisitId from patient.tblPatientVisits where OPDDate = ''' + @SearchKey + ''')'
					 End
			End			
			
			
			--print @WhereQry	
			
			
			--set @BaseQry = '
			--	With CTE AS (
			--		Select PatientId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
			--		(
			--			Select distinct p.PatientId, ' + @SortBy + ' as SortBy
			--			 FROM patient.tblPatients p with(nolock) 		
			--			 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--			 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--			WHERE ' + @WhereQry + ' 
			--		) A
			--	) Select distinct 
			--	CTE.RowId
			--	, (select Count(RowId) from CTE) as TotalCount
			--	, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
			--	, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
			--	, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
			--	, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
			--	, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
			--	, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
			--	, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
			--	  From CTE 
			--	  INNER JOIN patient.tblPatients p with(nolock) ON CTE.PatientId=p.PatientId
			--	  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
			--	  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
			--	  ' + @v_PagingQry + 
			--	  ' Order by RowId	'	

			set @BaseQry = '				

					With CTE AS (
					Select VisitId, CaseId, Row_Number() Over (Order by OpdDateTime Desc) as RowId From
					(
						Select Distinct pv.VisitId, pv.CaseId, OpdDate, OPDTime, (Convert(varchar(20), OpdDate) + '' '' + Convert(varchar(20), OpdTime)) as OpdDateTime
						 FROM patient.tblPatients p with(nolock) 		
						 INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PatientId, p.HospitalId, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive, pc.IsEdited, pc.EntryDate, pc.UpdatedDate, pc.CreatedBy, pc.UpdatedBy
				, pc.CaseID, pc.CaseRegNo, pv.VisitId, pv.OpdDate, pv.OpdTime
				, Case When Exists (select CaseId from patient.tblUsgDetails where CaseId = pv.CaseId) Then 1 Else 0 End UsgDone
				, Case When Exists (select CaseId from patient.tblMTP where CaseId = pv.CaseId) Then 1 Else 0 End MTPDone
				, Case When Exists (select CaseId from patient.tblDeliveryRecords where CaseId = pv.CaseId) Then 1 Else 0 End Delivery
				, Case When Exists (select CaseId from patient.tblBill where CaseId = pv.CaseId) Then 1 Else 0 End BillPaid
				  From CTE 
				 INNER JOIN patient.tblPatientVisits pv with (nolock) on pv.VisitId=CTE.VisitId And pv.CaseId=CTE.CaseId
					INNER JOIN patient.tblPatientCases pc with (nolock) on pv.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatients p with(nolock) ON pc.PatientId=p.PatientId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

       
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tblPatients WHERE PatientId=@PatientId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PatientId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- ============
 CREATE PROC [dbo].[Usp_Manage_PatientVisits]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @VisitId bigint=NULL 
  , @CaseId bigint=NULL 
  , @OpdDate varchar(50)=NULL 
  , @OpdTime time=NULL 
  , @PatientType nvarchar(50)=NULL 
  , @PresentHistory nvarchar(2000)=NULL 
  , @FamilyHistory nvarchar(2000)=NULL 
  , @PastHistory nvarchar(2000)=NULL 
  , @MarriedLife int=NULL 
  , @FTNDS_LiveM int=NULL 
  , @FTNDS_LiveF int=NULL 
  , @FTNDS_DeadM int=NULL 
  , @FTNDS_DeadF int=NULL 
  , @FTLSCS_LiveM int=NULL 
  , @FTLSCS_LiveF int=NULL 
  , @FTLSCS_DeadM int=NULL 
  , @FTLSCS_DeadF int=NULL 
  , @Temperature nvarchar(50)=NULL 
  , @RespiratoryRate int=NULL 
  , @SPO2 int=NULL 
  , @Pallor nvarchar(50)=NULL 
  , @Icterus nvarchar(50)=NULL 
  , @Oedema nvarchar(50)=NULL 
  , @RespiratorySystem nvarchar(500)=NULL 
  , @CardiovascularSystem nvarchar(500)=NULL 
  , @Breast nchar(10)=NULL 
  , @LMPDate varchar(50)=NULL 
  , @EDD varchar(50)=NULL 
  , @MensturalHistoryDays nvarchar(100)=NULL 
  , @MensturalDays int=NULL 
  , @MensturalSeverity nvarchar(100)=NULL 
  , @HistoryOf nvarchar(1000)=NULL 
  , @ComplainOf nvarchar(1000)=NULL 
  , @Pulse int=NULL 
  , @SystolicBloodPressure int=NULL 
  , @DaistolicBloodPressure int=NULL 
  , @PerAbdomen nvarchar(500)=NULL 
  , @PerSpeculum nvarchar(500)=NULL 
  , @PerVaginum nvarchar(500)=NULL 
  , @Diagnosis nvarchar(500)=NULL 
  , @Advice nvarchar(500)=NULL 
  , @Remark nvarchar(500)=NULL 
  , @FollowupDays int=NULL 
  , @FollowupDate datetime=NULL 
  , @Parity nvarchar(100)=NULL 
  , @PreviousDeliveryType nvarchar(100)=NULL 
  , @PossibleLMP varchar(50)=NULL 
  , @WeeksAccordingLMP decimal=NULL 
  , @PossibleEDD varchar(50)=NULL 
  , @WeeksAccordingFirstEDD decimal=NULL 
  , @FirstEDDAccordingUSG varchar(50)=NULL
  , @PreviousMH int=NULL
  , @IsPAUtSelected bit=NULL 
  , @PAUtValue nvarchar(50)=NULL 
  , @UterusDays int=NULL 
  , @UterusWeeks int=NULL 
  , @ExternalBallottementPresentingPart nvarchar(50)=NULL 
  , @FetalHeartSound nvarchar(50)=NULL 
  , @UterusCondition nvarchar(50)=NULL
  , @PrescribedMedicines varchar(MAX)=NULL
  , @IsLatestVisit bit=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate varchar(50)=NULL 
  , @UpdatedDate varchar(50)=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  
, @InvestigationId int=NULL 
, @HomeBloodGlucoseMonitoring  varchar(200) = NULL  
, @BloodGroup  varchar(200) = NULL  
, @UrineSugar  varchar(200) = NULL  
, @UrineProtein  varchar(200) = NULL  
, @HIV  varchar(200) = NULL  
, @HepatitisBsurfaceAntigen  varchar(200) = NULL  
, @ThyroidStimuatingHormone  varchar(200) = NULL  
, @VenerealDiseaseResearchLaboratory  varchar(200) = NULL  
, @Other  varchar(200) = NULL  
  
, @PerSpeculumId int = null

,@UterusWeeksPA int = null

, @Gync_LiveM int=NULL 
, @Gync_LiveF int=NULL 

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
   IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatientVisits 
	  -- CaseId=@CaseId 
       -- OpdDate=@OpdDate 
        --OpdTime=@OpdTime 
       SET PatientType=@PatientType 
        , PresentHistory=@PresentHistory 
        , FamilyHistory=@FamilyHistory 
        , PastHistory=@PastHistory 
        , MarriedLife=@MarriedLife 
        , FTNDS_LiveM=@FTNDS_LiveM 
        , FTNDS_LiveF=@FTNDS_LiveF 
        , FTNDS_DeadM=@FTNDS_DeadM 
        , FTNDS_DeadF=@FTNDS_DeadF 
        , FTLSCS_LiveM=@FTLSCS_LiveM 
        , FTLSCS_LiveF=@FTLSCS_LiveF 
        , FTLSCS_DeadM=@FTLSCS_DeadM 
        , FTLSCS_DeadF=@FTLSCS_DeadF 
        , Temperature=@Temperature 
        , RespiratoryRate=@RespiratoryRate 
        , SPO2=@SPO2 
        , Pallor=@Pallor 
        , Icterus=@Icterus 
        , Oedema=@Oedema 
        , RespiratorySystem=@RespiratorySystem 
        , CardiovascularSystem=@CardiovascularSystem 
        , Breast=@Breast 
        , LMPDate=@LMPDate 
        , EDD=@EDD 
        , MensturalHistoryDays=@MensturalHistoryDays 
        , MensturalDays=@MensturalDays 
        , MensturalSeverity=@MensturalSeverity 
        , HistoryOf=@HistoryOf 
        , ComplainOf=@ComplainOf 
        , Pulse=@Pulse 
        , SystolicBloodPressure=@SystolicBloodPressure 
        , DaistolicBloodPressure=@DaistolicBloodPressure 
        , PerAbdomen=@PerAbdomen 
        , PerSpeculum=@PerSpeculum 
        , PerVaginum=@PerVaginum 
        , Diagnosis=@Diagnosis 
        , Advice=@Advice 
        , Remark=@Remark 
        , FollowupDays=@FollowupDays 
        , FollowupDate=@FollowupDate 
        , Parity=@Parity 
        , PreviousDeliveryType=@PreviousDeliveryType 
        , PossibleLMP=@PossibleLMP 
        , WeeksAccordingLMP=@WeeksAccordingLMP 
        , PossibleEDD=@PossibleEDD 
        , WeeksAccordingFirstEDD=@WeeksAccordingFirstEDD 
        , FirstEDDAccordingUSG=@FirstEDDAccordingUSG
		, PreviousMH=@PreviousMH
        , IsPAUtSelected=@IsPAUtSelected 
        , PAUtValue=@PAUtValue 
        , UterusDays=@UterusDays 
        , UterusWeeks=@UterusWeeks 
        , ExternalBallottementPresentingPart=@ExternalBallottementPresentingPart 
        , FetalHeartSound=@FetalHeartSound 
        , UterusCondition=@UterusCondition
		, PrescribedMedicines=@PrescribedMedicines
       -- , IsLatestVisit=@IsLatestVisit 
        , IsActive=@IsActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, UterusWeeksPA = @UterusWeeksPA
		, Gync_LiveM = @Gync_LiveM
		, Gync_LiveF = @Gync_LiveF
         WHERE VisitId=@VisitId     

		
		IF @@ERROR=0
		Begin               

				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein, HIV, HepatitisBsurfaceAntigen, ThyroidStimuatingHormone, VenerealDiseaseResearchLaboratory, Other, CreatedBy)
					Values (@PatientId, @CaseId, @VisitId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein, @HIV, @HepatitisBsurfaceAntigen, @ThyroidStimuatingHormone, @VenerealDiseaseResearchLaboratory, @Other, @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, HIV=@HIV
							, HepatitisBsurfaceAntigen=@HepatitisBsurfaceAntigen
							, ThyroidStimuatingHormone=@ThyroidStimuatingHormone
							, VenerealDiseaseResearchLaboratory=@VenerealDiseaseResearchLaboratory
							, Other=@Other
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End

			

			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @VisitId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'PreviousVisit'
		Begin

		
		select top 1 @CaseId =  CaseId from patient.tblPatientVisits where VisitId = @VisitId

		 declare @IsFirstVisit int = 0

				declare @P_patientId bigint = 0, @C_caseId bigint = 0, @C_OpdDate datetime = getdate();

				select @P_patientId = PatientId, @C_caseId = CaseId, @C_OpdDate = OpdDate from patient.tblPatientVisits where VisitId = @VisitId

				select @IsFirstVisit = (case when COUNT(VisitId) > 1 then 1 else 0 end) from patient.tblPatientVisits where PatientId = @P_patientId
										and CaseId = @C_caseId


				declare @CountOfVisits bigint = 0;

				select @CountOfVisits =  COUNT( VisitId) from patient.tblPatientVisits where CaseId = @C_caseId and PatientId = @P_patientId and cast(OpdDate as date) <= CAST(isnull(@C_OpdDate, GETDATE()) as date)



			SELECT top 1 pv.VisitId, pv.CaseId, OpdDate, OpdTime , @CountOfVisits as VisitNo
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays
			  
			  , MensturalSeverity
			  
			  --, MensturalSeverity.RecordName as MensturalSeverityText
			  
			  ,case 
					when isnull(MensturalSeverity.RecordName,'') = '' and isnull(MensturalSeverity.RecordName,'') = '' 
					then MensturalSeverity 
					else MensturalSeverity.RecordName
					end 
			    as MensturalSeverityText

			  , HistoryOf
			  ,Gync_LiveM
			  ,Gync_LiveF
			  --, his.RecordName as HistoryOfText

			   ,case when isnull(his.RecordName,'') = '' and isnull(his.RecordName,'') = '' then HistoryOf end as HistoryOfText

			  , ComplainOf
			  --, comp.RecordName as ComplainOfText

			   ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then ComplainOf end as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen
			  
			  --, prab.RecordName as PerAbdomenText
			  ,case when isnull(prsp.RecordName,'') = '' and isnull(prsp.RecordName,'') = '' then PerSpeculum end as PerSpeculumText
			  
			  , PerSpeculum
			  
			  --, prsp.RecordName as PerSpeculumText
			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then PerAbdomen end as PerAbdomenText

			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart
			  
			  --, ebpp.RecordName as ExternalBallottementPresentingPartText
			  ,case when isnull(ebpp.RecordName,'') = '' and isnull(ebpp.RecordName,'') = '' then ExternalBallottementPresentingPart end as ExternalBallottementPresentingPartText
			  
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  ,@IsFirstVisit as IsFirstVisit
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			    --LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId

			--LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on pv.MensturalSeverity = MensturalSeverity.EntityRecordId

			 LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on CASE 
							WHEN TRY_CAST(pv.MensturalSeverity AS INT) IS NOT NULL THEN TRY_CAST(pv.MensturalSeverity AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = MensturalSeverity.EntityRecordId


			    LEFT JOIN common.tblEntityRecords his with(nolock) on CASE 
							WHEN TRY_CAST(pv.HistoryOf AS INT) IS NOT NULL THEN TRY_CAST(pv.HistoryOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = his.EntityRecordId


			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on CASE 
							WHEN TRY_CAST(pv.ComplainOf AS INT) IS NOT NULL THEN TRY_CAST(pv.ComplainOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = comp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerAbdomen AS INT) IS NOT NULL THEN TRY_CAST(pv.PerAbdomen AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = prab.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId

			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerSpeculum AS INT) IS NOT NULL THEN TRY_CAST(pv.PerSpeculum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prsp.EntityRecordId
			  
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			 -- LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 
			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on CASE 
							WHEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT) IS NOT NULL THEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = ebpp.EntityRecordId

			 LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId



			  WHERE pv.CaseId= @CaseId And pv.IsActive=1 And IsLatestVisit=0
			  --Order By pv.VisitId desc
			   Order By pv.EntryDate asc
			

			 --SELECT top 1 pv.VisitId, pv.CaseId, OpdDate, OpdTime
			 -- , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			 -- , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			 -- , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			 -- , Temperature, temp.RecordName as TemperatureText
			 -- , RespiratoryRate, SPO2
			 -- , Pallor, pal.RecordName as PallorText
			 -- , Icterus, ict.RecordName as IcterusText
			 -- , Oedema, oed.RecordName as OedemaText
			 -- , RespiratorySystem, CardiovascularSystem
			 -- , Breast, brst.RecordName as BreastText
			 -- , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			 -- , HistoryOf, his.RecordName as HistoryOfText
			 -- , ComplainOf, comp.RecordName as ComplainOfText
			 -- , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			 -- , PerAbdomen, prab.RecordName as PerAbdomenText
			 -- , PerSpeculum, prsp.RecordName as PerSpeculumText
			 -- , PerVaginum, prvg.RecordName as PerVaginumText
			 -- , Diagnosis, Advice, Remark
			 -- , FollowupDays, FollowupDate
			 -- , Parity, PreviousDeliveryType
			 -- , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			 -- , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			 -- , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			 -- , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			 -- , UterusCondition, utrs.RecordName as UterusConditionText

			 -- , PrescribedMedicines
			 -- , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			 -- , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			 -- , inv.HomeBloodGlucoseMonitoring
			 -- , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			 -- , inv.UrineSugar, inv.UrineProtein, inv.HIV
			 -- , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			 -- , UterusWeeksPA
			 -- FROM  patient.tblPatientVisits pv with(nolock)
			 -- LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			 --  LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			 --  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			 -- LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			 -- LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId



			 -- WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=0
			 -- Order By pv.VisitId desc
		End

		Else If @VisitId > 0
		Begin
				

			   declare @IsFirstVisit1 int = 0

				declare @P_patientId1 bigint = 0, @C_caseId1 bigint = 0, @C_OpdDate1 datetime = getdate();

				select @P_patientId1 = PatientId, @C_caseId1 = CaseId, @C_OpdDate1 = OpdDate from patient.tblPatientVisits where VisitId = @VisitId

				select @IsFirstVisit1 = (case when COUNT(VisitId) > 1 then 1 else 0 end) from patient.tblPatientVisits where PatientId = @P_patientId1
										and CaseId = @C_caseId1


				declare @CountOfVisits1 bigint = 0;

				select @CountOfVisits1 =  COUNT( VisitId) from patient.tblPatientVisits where CaseId = @C_caseId1 and PatientId = @P_patientId1 and cast(OpdDate as date) <= CAST(isnull(@C_OpdDate1, GETDATE()) as date)

			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime , @CountOfVisits1 as VisitNo
			  , PatientType,
			 
			  replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  replace(PastHistory,'Not Significant','') as PastHistory, 

			  MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays
			  
			  , MensturalSeverity
			  
			  -- , MensturalSeverity.RecordName as MensturalSeverityText
			  
			   ,case 
					when isnull(MensturalSeverity.RecordName,'') = '' and isnull(MensturalSeverity.RecordName,'') = '' 
					then MensturalSeverity 
					else MensturalSeverity.RecordName
					end 
			    as MensturalSeverityText

			  --, HistoryOf, his.RecordName as HistoryOfText
			  
			  , HistoryOf 
			  ,Gync_LiveM
			  ,Gync_LiveF
			  ,case when isnull(his.RecordName,'') = ''  then HistoryOf else his.RecordName end as HistoryOfText
			  
			  , ComplainOf 
			  
			  --,comp.RecordName as ComplainOfText
			  --,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then ComplainOf end as ComplainOfText

			  ,case when isnull(comp.RecordName,'') = ''  then ComplainOf else  comp.RecordName end as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen
			  
			  --, prab.RecordName as PerAbdomenText

			  ,case when isnull(prab.RecordName,'') = '' then PerAbdomen else prab.RecordName end as PerAbdomenText

			  , PerSpeculum
			  
			  --, prsp.RecordName as PerSpeculumText

			  ,case when isnull(prsp.RecordName,'') = '' then PerSpeculum else prsp.RecordName end as PerSpeculumText

			  , PerVaginum
			  
			  --, prvg.RecordName as PerVaginumText
			   ,case when isnull(prvg.RecordName,'') = '' then PerVaginum else prvg.RecordName end as PerVaginumText

			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart
			  --, ebpp.RecordName as ExternalBallottementPresentingPartText
			   ,case when isnull(ebpp.RecordName,'') = '' then ExternalBallottementPresentingPart else ebpp.RecordName end as ExternalBallottementPresentingPartText
			  
			  , FetalHeartSound
			  --, fhs.RecordName as FetalHeartSoundText
			  ,case when isnull(FHS.RecordName,'') = '' then FetalHeartSound else FHS.RecordName end 
					as FetalHeartSoundText

			  , UterusCondition
			  --, utrs.RecordName as UterusConditionText
			  ,case when isnull(utrs.RecordName,'') = '' then UterusCondition else utrs.RecordName end 
					as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit
			  
			  ,@IsFirstVisit1 as IsFirstVisit

			  , pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , isnull(inv.HomeBloodGlucoseMonitoring , '0') as HomeBloodGlucoseMonitoring
			  , isnull(inv.BloodGroup , '') as BloodGroup
			  , bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  pv.CaseId = inv.CaseId
			  --pv.VisitId=inv.VisitId	
			  
			  LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on pv.MensturalSeverity = MensturalSeverity.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId

			  LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on CASE 
							WHEN TRY_CAST(pv.MensturalSeverity AS INT) IS NOT NULL THEN TRY_CAST(pv.MensturalSeverity AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = MensturalSeverity.EntityRecordId

			  LEFT JOIN common.tblEntityRecords his with(nolock) on CASE 
							WHEN TRY_CAST(pv.HistoryOf AS INT) IS NOT NULL THEN TRY_CAST(pv.HistoryOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = his.EntityRecordId


			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on CASE 
							WHEN TRY_CAST(pv.ComplainOf AS INT) IS NOT NULL THEN TRY_CAST(pv.ComplainOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = comp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerAbdomen AS INT) IS NOT NULL THEN TRY_CAST(pv.PerAbdomen AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = prab.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId

			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerSpeculum AS INT) IS NOT NULL THEN TRY_CAST(pv.PerSpeculum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prsp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on CASE 
							WHEN TRY_CAST( pv.PerVaginum AS INT) IS NOT NULL THEN TRY_CAST( pv.PerVaginum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prvg.EntityRecordId


			 -- LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 
			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on CASE 
							WHEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT) IS NOT NULL THEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = ebpp.EntityRecordId


			LEFT JOIN common.tblEntityRecords FHS with(nolock) on CASE 
							WHEN TRY_CAST( pv.FetalHeartSound AS INT) IS NOT NULL THEN TRY_CAST( pv.FetalHeartSound AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = FHS.EntityRecordId


			-- LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId


			LEFT JOIN common.tblEntityRecords utrs with(nolock) on CASE 
							WHEN TRY_CAST( pv.UterusCondition AS INT) IS NOT NULL THEN TRY_CAST( pv.UterusCondition AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = utrs.EntityRecordId

			 --LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.VisitId=@VisitId 


		End

		ELSE IF @SubCommand = 'PreviousDataLoad'
		BEGIN
			
			--select @PatientId
			--///  Previous visit data on load
			declare @IsFirstVisit_Prev int = 0

				declare @P_patientId_Prev bigint = 0, @C_caseId_Prev bigint = 0
				select top 1  @C_caseId_Prev = CaseId from patient.tblPatientVisits where PatientId = @PatientId

				select @IsFirstVisit = (case when COUNT(VisitId) > 1 then 1 else 0 end) from patient.tblPatientVisits where PatientId = @PatientId
				and CaseId = @C_caseId_Prev

		    declare @PreviousData_visitid bigint = 0
			select top 1 @PreviousData_visitid = VisitId from patient.tblPatientVisits 
			where CaseId = @C_caseId_Prev order by EntryDate asc

			--declare  @IsFirstVisit bigint	= 0
			  SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType,
			  --PresentHistory, 
			  --FamilyHistory, 
			  --PastHistory,

			   replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  replace(PastHistory,'Not Significant','') as PastHistory, 

			  MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays
			  
			  , MensturalSeverity
			  --, MensturalSeverity.RecordName as MensturalSeverityText
			  ,case 
					when isnull(MensturalSeverity.RecordName,'') = '' and isnull(MensturalSeverity.RecordName,'') = '' 
					then MensturalSeverity 
					else MensturalSeverity.RecordName
					end 
			    as MensturalSeverityText

			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf 
			  
			  --,comp.RecordName as ComplainOfText
			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then ComplainOf end as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen
			  
			  --, prab.RecordName as PerAbdomenText

			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then PerAbdomen end as PerAbdomenText

			  , PerSpeculum
			  
			  --, prsp.RecordName as PerSpeculumText

			  ,case when isnull(prsp.RecordName,'') = '' and isnull(prsp.RecordName,'') = '' then PerSpeculum end as PerSpeculumText

			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart
			  --, ebpp.RecordName as ExternalBallottementPresentingPartText
			   ,case when isnull(ebpp.RecordName,'') = '' and isnull(ebpp.RecordName,'') = '' then ExternalBallottementPresentingPart end as ExternalBallottementPresentingPartText
			  
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit
			  ,Gync_LiveM
			  ,Gync_LiveF

			  ,@IsFirstVisit as IsFirstVisit

			  , pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  pv.CaseId = inv.CaseId
			  --pv.VisitId=inv.VisitId	
			  
			  LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId

			   --LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on pv.MensturalSeverity = MensturalSeverity.EntityRecordId

			    LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on CASE 
							WHEN TRY_CAST(pv.MensturalSeverity AS INT) IS NOT NULL THEN TRY_CAST(pv.MensturalSeverity AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = MensturalSeverity.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on CASE 
							WHEN TRY_CAST(pv.ComplainOf AS INT) IS NOT NULL THEN TRY_CAST(pv.ComplainOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = comp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerAbdomen AS INT) IS NOT NULL THEN TRY_CAST(pv.PerAbdomen AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = prab.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId

			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerSpeculum AS INT) IS NOT NULL THEN TRY_CAST(pv.PerSpeculum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prsp.EntityRecordId
			  
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			 -- LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 
			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on CASE 
							WHEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT) IS NOT NULL THEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = ebpp.EntityRecordId

			 LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.VisitId=@PreviousData_visitid
				--///  Previous visit data on load
		END

		Else
		Begin
				
			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity

			  , MensturalSeverity.RecordName as MensturalSeverityText

			  , HistoryOf, his.RecordName as HistoryOfText
			  
			  , ComplainOf
			  , comp.RecordName as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen, prab.RecordName as PerAbdomenText
			  , PerSpeculum, prsp.RecordName as PerSpeculumText
			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  ,Gync_LiveM
			  ,Gync_LiveF
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId

			    LEFT JOIN common.tblEntityRecords MensturalSeverity with(nolock) on pv.MensturalSeverity = MensturalSeverity.EntityRecordId

			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=1
		End


     
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tblPatientVisits WHERE VisitId=@VisitId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END;  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits_07032025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_PatientVisits_07032025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @VisitId bigint=NULL 
  , @CaseId bigint=NULL 
  , @OpdDate varchar(50)=NULL 
  , @OpdTime time=NULL 
  , @PatientType nvarchar(50)=NULL 
  , @PresentHistory nvarchar(2000)=NULL 
  , @FamilyHistory nvarchar(2000)=NULL 
  , @PastHistory nvarchar(2000)=NULL 
  , @MarriedLife int=NULL 
  , @FTNDS_LiveM int=NULL 
  , @FTNDS_LiveF int=NULL 
  , @FTNDS_DeadM int=NULL 
  , @FTNDS_DeadF int=NULL 
  , @FTLSCS_LiveM int=NULL 
  , @FTLSCS_LiveF int=NULL 
  , @FTLSCS_DeadM int=NULL 
  , @FTLSCS_DeadF int=NULL 
  , @Temperature nvarchar(50)=NULL 
  , @RespiratoryRate int=NULL 
  , @SPO2 int=NULL 
  , @Pallor nvarchar(50)=NULL 
  , @Icterus nvarchar(50)=NULL 
  , @Oedema nvarchar(50)=NULL 
  , @RespiratorySystem nvarchar(500)=NULL 
  , @CardiovascularSystem nvarchar(500)=NULL 
  , @Breast nchar(10)=NULL 
  , @LMPDate varchar(50)=NULL 
  , @EDD varchar(50)=NULL 
  , @MensturalHistoryDays nvarchar(100)=NULL 
  , @MensturalDays int=NULL 
  , @MensturalSeverity nvarchar(100)=NULL 
  , @HistoryOf nvarchar(1000)=NULL 
  , @ComplainOf nvarchar(1000)=NULL 
  , @Pulse int=NULL 
  , @SystolicBloodPressure int=NULL 
  , @DaistolicBloodPressure int=NULL 
  , @PerAbdomen nvarchar(500)=NULL 
  , @PerSpeculum nvarchar(500)=NULL 
  , @PerVaginum nvarchar(500)=NULL 
  , @Diagnosis nvarchar(500)=NULL 
  , @Advice nvarchar(500)=NULL 
  , @Remark nvarchar(500)=NULL 
  , @FollowupDays int=NULL 
  , @FollowupDate datetime=NULL 
  , @Parity nvarchar(100)=NULL 
  , @PreviousDeliveryType nvarchar(100)=NULL 
  , @PossibleLMP varchar(50)=NULL 
  , @WeeksAccordingLMP decimal=NULL 
  , @PossibleEDD varchar(50)=NULL 
  , @WeeksAccordingFirstEDD decimal=NULL 
  , @FirstEDDAccordingUSG varchar(50)=NULL
  , @PreviousMH int=NULL
  , @IsPAUtSelected bit=NULL 
  , @PAUtValue nvarchar(50)=NULL 
  , @UterusDays int=NULL 
  , @UterusWeeks int=NULL 
  , @ExternalBallottementPresentingPart nvarchar(50)=NULL 
  , @FetalHeartSound nvarchar(50)=NULL 
  , @UterusCondition nvarchar(50)=NULL
  , @PrescribedMedicines varchar(MAX)=NULL
  , @IsLatestVisit bit=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate varchar(50)=NULL 
  , @UpdatedDate varchar(50)=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  
, @InvestigationId int=NULL 
, @HomeBloodGlucoseMonitoring  varchar(200) = NULL  
, @BloodGroup  varchar(200) = NULL  
, @UrineSugar  varchar(200) = NULL  
, @UrineProtein  varchar(200) = NULL  
, @HIV  varchar(200) = NULL  
, @HepatitisBsurfaceAntigen  varchar(200) = NULL  
, @ThyroidStimuatingHormone  varchar(200) = NULL  
, @VenerealDiseaseResearchLaboratory  varchar(200) = NULL  
, @Other  varchar(200) = NULL  
  
, @PerSpeculumId int = null

,@UterusWeeksPA int = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
   IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatientVisits 
	  -- CaseId=@CaseId 
       -- OpdDate=@OpdDate 
        --OpdTime=@OpdTime 
       SET PatientType=@PatientType 
        , PresentHistory=@PresentHistory 
        , FamilyHistory=@FamilyHistory 
        , PastHistory=@PastHistory 
        , MarriedLife=@MarriedLife 
        , FTNDS_LiveM=@FTNDS_LiveM 
        , FTNDS_LiveF=@FTNDS_LiveF 
        , FTNDS_DeadM=@FTNDS_DeadM 
        , FTNDS_DeadF=@FTNDS_DeadF 
        , FTLSCS_LiveM=@FTLSCS_LiveM 
        , FTLSCS_LiveF=@FTLSCS_LiveF 
        , FTLSCS_DeadM=@FTLSCS_DeadM 
        , FTLSCS_DeadF=@FTLSCS_DeadF 
        , Temperature=@Temperature 
        , RespiratoryRate=@RespiratoryRate 
        , SPO2=@SPO2 
        , Pallor=@Pallor 
        , Icterus=@Icterus 
        , Oedema=@Oedema 
        , RespiratorySystem=@RespiratorySystem 
        , CardiovascularSystem=@CardiovascularSystem 
        , Breast=@Breast 
        , LMPDate=@LMPDate 
        , EDD=@EDD 
        , MensturalHistoryDays=@MensturalHistoryDays 
        , MensturalDays=@MensturalDays 
        , MensturalSeverity=@MensturalSeverity 
        , HistoryOf=@HistoryOf 
        , ComplainOf=@ComplainOf 
        , Pulse=@Pulse 
        , SystolicBloodPressure=@SystolicBloodPressure 
        , DaistolicBloodPressure=@DaistolicBloodPressure 
        , PerAbdomen=@PerAbdomen 
        , PerSpeculum=@PerSpeculum 
        , PerVaginum=@PerVaginum 
        , Diagnosis=@Diagnosis 
        , Advice=@Advice 
        , Remark=@Remark 
        , FollowupDays=@FollowupDays 
        , FollowupDate=@FollowupDate 
        , Parity=@Parity 
        , PreviousDeliveryType=@PreviousDeliveryType 
        , PossibleLMP=@PossibleLMP 
        , WeeksAccordingLMP=@WeeksAccordingLMP 
        , PossibleEDD=@PossibleEDD 
        , WeeksAccordingFirstEDD=@WeeksAccordingFirstEDD 
        , FirstEDDAccordingUSG=@FirstEDDAccordingUSG
		, PreviousMH=@PreviousMH
        , IsPAUtSelected=@IsPAUtSelected 
        , PAUtValue=@PAUtValue 
        , UterusDays=@UterusDays 
        , UterusWeeks=@UterusWeeks 
        , ExternalBallottementPresentingPart=@ExternalBallottementPresentingPart 
        , FetalHeartSound=@FetalHeartSound 
        , UterusCondition=@UterusCondition
		, PrescribedMedicines=@PrescribedMedicines
       -- , IsLatestVisit=@IsLatestVisit 
        , IsActive=@IsActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, UterusWeeksPA = @UterusWeeksPA

         WHERE VisitId=@VisitId     

		
		IF @@ERROR=0
		Begin               

				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein, HIV, HepatitisBsurfaceAntigen, ThyroidStimuatingHormone, VenerealDiseaseResearchLaboratory, Other, CreatedBy)
					Values (@PatientId, @CaseId, @VisitId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein, @HIV, @HepatitisBsurfaceAntigen, @ThyroidStimuatingHormone, @VenerealDiseaseResearchLaboratory, @Other, @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, HIV=@HIV
							, HepatitisBsurfaceAntigen=@HepatitisBsurfaceAntigen
							, ThyroidStimuatingHormone=@ThyroidStimuatingHormone
							, VenerealDiseaseResearchLaboratory=@VenerealDiseaseResearchLaboratory
							, Other=@Other
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End

			

			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @VisitId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'PreviousVisit'
		Begin
			 SELECT top 1 pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf, comp.RecordName as ComplainOfText
			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen, prab.RecordName as PerAbdomenText
			  , PerSpeculum, prsp.RecordName as PerSpeculumText
			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText

			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			   LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId



			  WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=0
			  Order By pv.VisitId desc
		End

		Else If @VisitId > 0
		Begin
				 --SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  --, PatientType,
			  ----PresentHistory, 
			  ----FamilyHistory, 
			  ----PastHistory,

			  -- replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  --replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  --replace(PastHistory,'Not Significant','') as PastHistory, 

			  --MarriedLife
			  --, FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  --, FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  --, Temperature, temp.RecordName as TemperatureText
			  --, RespiratoryRate, SPO2
			  --, Pallor, pal.RecordName as PallorText
			  --, Icterus, ict.RecordName as IcterusText
			  --, Oedema, oed.RecordName as OedemaText
			  --, RespiratorySystem, CardiovascularSystem
			  --, Breast, brst.RecordName as BreastText
			  --, LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  --, HistoryOf, his.RecordName as HistoryOfText
			  --, ComplainOf, comp.RecordName as ComplainOfText
			  --, Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  --, PerAbdomen, prab.RecordName as PerAbdomenText

			  --, PerSpeculum, prsp.RecordName as PerSpeculumText
			  --, PerVaginum, prvg.RecordName as PerVaginumText
			  --, Diagnosis, Advice, Remark
			  --, FollowupDays, FollowupDate
			  --, Parity, PreviousDeliveryType
			  --, PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  --, IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  --, ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  --, FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  --, UterusCondition, utrs.RecordName as UterusConditionText
			  
			  --, PrescribedMedicines
			  --, pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  --, inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  --, inv.HomeBloodGlucoseMonitoring
			  --, inv.BloodGroup, bg.RecordName as BloodGroupText
			  --, inv.UrineSugar, inv.UrineProtein, inv.HIV
			  --, inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  --FROM  patient.tblPatientVisits pv with(nolock)
			  --LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  --pv.CaseId = inv.CaseId
			  ----pv.VisitId=inv.VisitId	
			  
			  --LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  --WHERE pv.VisitId=@VisitId 

			   declare @IsFirstVisit int = 0

				declare @P_patientId bigint = 0, @C_caseId bigint = 0
				select @P_patientId = PatientId, @C_caseId = CaseId from patient.tblPatientVisits where VisitId = @VisitId

				select @IsFirstVisit = (case when COUNT(VisitId) > 1 then 1 else 0 end) from patient.tblPatientVisits where PatientId = @P_patientId
				and CaseId = @C_caseId


			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType,
			  --PresentHistory, 
			  --FamilyHistory, 
			  --PastHistory,

			   replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  replace(PastHistory,'Not Significant','') as PastHistory, 

			  MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf 
			  
			  --,comp.RecordName as ComplainOfText
			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then ComplainOf end as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen
			  
			  --, prab.RecordName as PerAbdomenText

			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then PerAbdomen end as PerAbdomenText

			  , PerSpeculum
			  
			  --, prsp.RecordName as PerSpeculumText

			  ,case when isnull(prsp.RecordName,'') = '' and isnull(prsp.RecordName,'') = '' then PerSpeculum end as PerSpeculumText

			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart
			  --, ebpp.RecordName as ExternalBallottementPresentingPartText
			   ,case when isnull(ebpp.RecordName,'') = '' and isnull(ebpp.RecordName,'') = '' then ExternalBallottementPresentingPart end as ExternalBallottementPresentingPartText
			  
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit
			  
			  ,@IsFirstVisit as IsFirstVisit

			  , pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  pv.CaseId = inv.CaseId
			  --pv.VisitId=inv.VisitId	
			  
			  LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on CASE 
							WHEN TRY_CAST(pv.ComplainOf AS INT) IS NOT NULL THEN TRY_CAST(pv.ComplainOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = comp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerAbdomen AS INT) IS NOT NULL THEN TRY_CAST(pv.PerAbdomen AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = prab.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId

			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerSpeculum AS INT) IS NOT NULL THEN TRY_CAST(pv.PerSpeculum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prsp.EntityRecordId
			  
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			 -- LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 
			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on CASE 
							WHEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT) IS NOT NULL THEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = ebpp.EntityRecordId

			 LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.VisitId=@VisitId 


		End
		Else
		Begin
				 --SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime, PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  --, FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF, FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  --, Temperature, RespiratoryRate, SPO2, Pallor, Icterus, Oedema, RespiratorySystem, CardiovascularSystem, Breast
			  --, LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity, HistoryOf, ComplainOf, Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  --, PerAbdomen, PerSpeculum, PerVaginum, Diagnosis, Advice, Remark, FollowupDays, FollowupDate, Parity, PreviousDeliveryType
			  --, PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks
			  --, ExternalBallottementPresentingPart, FetalHeartSound, UterusCondition, PrescribedMedicines
			  --, pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  --, inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  --, inv.HomeBloodGlucoseMonitoring, inv.BloodGroup, inv.UrineSugar, inv.UrineProtein, inv.HIV, inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  --FROM  patient.tblPatientVisits pv with(nolock)
			  --LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  
			  --WHERE pv.CaseId=@CaseId And IsActive=1 And IsLatestVisit=1

			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf, comp.RecordName as ComplainOfText
			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen, prab.RecordName as PerAbdomenText
			  , PerSpeculum, prsp.RecordName as PerSpeculumText
			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=1
		End


     
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tblPatientVisits WHERE VisitId=@VisitId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PatientVisits_24022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_PatientVisits_24022025]  
   @Command varchar(200) 
  , @PatientId bigint=NULL 
  , @VisitId bigint=NULL 
  , @CaseId bigint=NULL 
  , @OpdDate varchar(50)=NULL 
  , @OpdTime time=NULL 
  , @PatientType nvarchar(50)=NULL 
  , @PresentHistory nvarchar(2000)=NULL 
  , @FamilyHistory nvarchar(2000)=NULL 
  , @PastHistory nvarchar(2000)=NULL 
  , @MarriedLife int=NULL 
  , @FTNDS_LiveM int=NULL 
  , @FTNDS_LiveF int=NULL 
  , @FTNDS_DeadM int=NULL 
  , @FTNDS_DeadF int=NULL 
  , @FTLSCS_LiveM int=NULL 
  , @FTLSCS_LiveF int=NULL 
  , @FTLSCS_DeadM int=NULL 
  , @FTLSCS_DeadF int=NULL 
  , @Temperature nvarchar(50)=NULL 
  , @RespiratoryRate int=NULL 
  , @SPO2 int=NULL 
  , @Pallor nvarchar(50)=NULL 
  , @Icterus nvarchar(50)=NULL 
  , @Oedema nvarchar(50)=NULL 
  , @RespiratorySystem nvarchar(500)=NULL 
  , @CardiovascularSystem nvarchar(500)=NULL 
  , @Breast nchar(10)=NULL 
  , @LMPDate varchar(50)=NULL 
  , @EDD varchar(50)=NULL 
  , @MensturalHistoryDays nvarchar(100)=NULL 
  , @MensturalDays int=NULL 
  , @MensturalSeverity nvarchar(100)=NULL 
  , @HistoryOf nvarchar(1000)=NULL 
  , @ComplainOf nvarchar(1000)=NULL 
  , @Pulse int=NULL 
  , @SystolicBloodPressure int=NULL 
  , @DaistolicBloodPressure int=NULL 
  , @PerAbdomen nvarchar(500)=NULL 
  , @PerSpeculum nvarchar(500)=NULL 
  , @PerVaginum nvarchar(500)=NULL 
  , @Diagnosis nvarchar(500)=NULL 
  , @Advice nvarchar(500)=NULL 
  , @Remark nvarchar(500)=NULL 
  , @FollowupDays int=NULL 
  , @FollowupDate datetime=NULL 
  , @Parity nvarchar(100)=NULL 
  , @PreviousDeliveryType nvarchar(100)=NULL 
  , @PossibleLMP varchar(50)=NULL 
  , @WeeksAccordingLMP decimal=NULL 
  , @PossibleEDD varchar(50)=NULL 
  , @WeeksAccordingFirstEDD decimal=NULL 
  , @FirstEDDAccordingUSG varchar(50)=NULL
  , @PreviousMH int=NULL
  , @IsPAUtSelected bit=NULL 
  , @PAUtValue nvarchar(50)=NULL 
  , @UterusDays int=NULL 
  , @UterusWeeks int=NULL 
  , @ExternalBallottementPresentingPart nvarchar(50)=NULL 
  , @FetalHeartSound nvarchar(50)=NULL 
  , @UterusCondition nvarchar(50)=NULL
  , @PrescribedMedicines varchar(MAX)=NULL
  , @IsLatestVisit bit=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate varchar(50)=NULL 
  , @UpdatedDate varchar(50)=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  
, @InvestigationId int=NULL 
, @HomeBloodGlucoseMonitoring  varchar(200) = NULL  
, @BloodGroup  varchar(200) = NULL  
, @UrineSugar  varchar(200) = NULL  
, @UrineProtein  varchar(200) = NULL  
, @HIV  varchar(200) = NULL  
, @HepatitisBsurfaceAntigen  varchar(200) = NULL  
, @ThyroidStimuatingHormone  varchar(200) = NULL  
, @VenerealDiseaseResearchLaboratory  varchar(200) = NULL  
, @Other  varchar(200) = NULL  
  
, @PerSpeculumId int = null

,@UterusWeeksPA int = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
   IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblPatientVisits 
	  -- CaseId=@CaseId 
       -- OpdDate=@OpdDate 
        --OpdTime=@OpdTime 
       SET PatientType=@PatientType 
        , PresentHistory=@PresentHistory 
        , FamilyHistory=@FamilyHistory 
        , PastHistory=@PastHistory 
        , MarriedLife=@MarriedLife 
        , FTNDS_LiveM=@FTNDS_LiveM 
        , FTNDS_LiveF=@FTNDS_LiveF 
        , FTNDS_DeadM=@FTNDS_DeadM 
        , FTNDS_DeadF=@FTNDS_DeadF 
        , FTLSCS_LiveM=@FTLSCS_LiveM 
        , FTLSCS_LiveF=@FTLSCS_LiveF 
        , FTLSCS_DeadM=@FTLSCS_DeadM 
        , FTLSCS_DeadF=@FTLSCS_DeadF 
        , Temperature=@Temperature 
        , RespiratoryRate=@RespiratoryRate 
        , SPO2=@SPO2 
        , Pallor=@Pallor 
        , Icterus=@Icterus 
        , Oedema=@Oedema 
        , RespiratorySystem=@RespiratorySystem 
        , CardiovascularSystem=@CardiovascularSystem 
        , Breast=@Breast 
        , LMPDate=@LMPDate 
        , EDD=@EDD 
        , MensturalHistoryDays=@MensturalHistoryDays 
        , MensturalDays=@MensturalDays 
        , MensturalSeverity=@MensturalSeverity 
        , HistoryOf=@HistoryOf 
        , ComplainOf=@ComplainOf 
        , Pulse=@Pulse 
        , SystolicBloodPressure=@SystolicBloodPressure 
        , DaistolicBloodPressure=@DaistolicBloodPressure 
        , PerAbdomen=@PerAbdomen 
        , PerSpeculum=@PerSpeculum 
        , PerVaginum=@PerVaginum 
        , Diagnosis=@Diagnosis 
        , Advice=@Advice 
        , Remark=@Remark 
        , FollowupDays=@FollowupDays 
        , FollowupDate=@FollowupDate 
        , Parity=@Parity 
        , PreviousDeliveryType=@PreviousDeliveryType 
        , PossibleLMP=@PossibleLMP 
        , WeeksAccordingLMP=@WeeksAccordingLMP 
        , PossibleEDD=@PossibleEDD 
        , WeeksAccordingFirstEDD=@WeeksAccordingFirstEDD 
        , FirstEDDAccordingUSG=@FirstEDDAccordingUSG
		, PreviousMH=@PreviousMH
        , IsPAUtSelected=@IsPAUtSelected 
        , PAUtValue=@PAUtValue 
        , UterusDays=@UterusDays 
        , UterusWeeks=@UterusWeeks 
        , ExternalBallottementPresentingPart=@ExternalBallottementPresentingPart 
        , FetalHeartSound=@FetalHeartSound 
        , UterusCondition=@UterusCondition
		, PrescribedMedicines=@PrescribedMedicines
       -- , IsLatestVisit=@IsLatestVisit 
        , IsActive=@IsActive 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, UterusWeeksPA = @UterusWeeksPA

         WHERE VisitId=@VisitId     

		
		IF @@ERROR=0
		Begin               

				If Not Exists (select top 1 InvestigationId from patient.tblInvestigation with (nolock) where CaseId=@CaseId)
				Begin
					Insert into patient.tblInvestigation (PatientId, CaseId, VisitId, HomeBloodGlucoseMonitoring, BloodGroup, 
					UrineSugar, UrineProtein, HIV, HepatitisBsurfaceAntigen, ThyroidStimuatingHormone, VenerealDiseaseResearchLaboratory, Other, CreatedBy)
					Values (@PatientId, @CaseId, @VisitId, @HomeBloodGlucoseMonitoring, @BloodGroup
					, @UrineSugar, @UrineProtein, @HIV, @HepatitisBsurfaceAntigen, @ThyroidStimuatingHormone, @VenerealDiseaseResearchLaboratory, @Other, @CreatedBy)

				End
				Else
				Begin
						Update patient.tblInvestigation
						SET HomeBloodGlucoseMonitoring=@HomeBloodGlucoseMonitoring
							, BloodGroup=@BloodGroup
							, UrineSugar=@UrineSugar
							, UrineProtein=@UrineProtein
							, HIV=@HIV
							, HepatitisBsurfaceAntigen=@HepatitisBsurfaceAntigen
							, ThyroidStimuatingHormone=@ThyroidStimuatingHormone
							, VenerealDiseaseResearchLaboratory=@VenerealDiseaseResearchLaboratory
							, Other=@Other
							, IsEdited=1
							, UpdatedDate=@UpdatedDate
							, UpdatedBy = @UpdatedBy
							WHERE CaseId=@CaseId
				End

			

			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @VisitId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'PreviousVisit'
		Begin
			 SELECT top 1 pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf, comp.RecordName as ComplainOfText
			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen, prab.RecordName as PerAbdomenText
			  , PerSpeculum, prsp.RecordName as PerSpeculumText
			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText

			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			   LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId



			  WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=0
			  Order By pv.VisitId desc
		End

		Else If @VisitId > 0
		Begin
				 --SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  --, PatientType,
			  ----PresentHistory, 
			  ----FamilyHistory, 
			  ----PastHistory,

			  -- replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  --replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  --replace(PastHistory,'Not Significant','') as PastHistory, 

			  --MarriedLife
			  --, FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  --, FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  --, Temperature, temp.RecordName as TemperatureText
			  --, RespiratoryRate, SPO2
			  --, Pallor, pal.RecordName as PallorText
			  --, Icterus, ict.RecordName as IcterusText
			  --, Oedema, oed.RecordName as OedemaText
			  --, RespiratorySystem, CardiovascularSystem
			  --, Breast, brst.RecordName as BreastText
			  --, LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  --, HistoryOf, his.RecordName as HistoryOfText
			  --, ComplainOf, comp.RecordName as ComplainOfText
			  --, Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  --, PerAbdomen, prab.RecordName as PerAbdomenText

			  --, PerSpeculum, prsp.RecordName as PerSpeculumText
			  --, PerVaginum, prvg.RecordName as PerVaginumText
			  --, Diagnosis, Advice, Remark
			  --, FollowupDays, FollowupDate
			  --, Parity, PreviousDeliveryType
			  --, PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  --, IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  --, ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  --, FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  --, UterusCondition, utrs.RecordName as UterusConditionText
			  
			  --, PrescribedMedicines
			  --, pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  --, inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  --, inv.HomeBloodGlucoseMonitoring
			  --, inv.BloodGroup, bg.RecordName as BloodGroupText
			  --, inv.UrineSugar, inv.UrineProtein, inv.HIV
			  --, inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  --FROM  patient.tblPatientVisits pv with(nolock)
			  --LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  --pv.CaseId = inv.CaseId
			  ----pv.VisitId=inv.VisitId	
			  
			  --LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  --LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  --WHERE pv.VisitId=@VisitId 


			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType,
			  --PresentHistory, 
			  --FamilyHistory, 
			  --PastHistory,

			   replace(PresentHistory,'Not Significant','') as PresentHistory, 
			  replace(FamilyHistory,'Not Significant','') as FamilyHistory, 
			  replace(PastHistory,'Not Significant','') as PastHistory, 

			  MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf 
			  
			  --,comp.RecordName as ComplainOfText
			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then ComplainOf end as ComplainOfText

			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen
			  
			  --, prab.RecordName as PerAbdomenText

			  ,case when isnull(comp.RecordName,'') = '' and isnull(comp.RecordName,'') = '' then PerAbdomen end as PerAbdomenText

			  , PerSpeculum
			  
			  --, prsp.RecordName as PerSpeculumText

			  ,case when isnull(prsp.RecordName,'') = '' and isnull(prsp.RecordName,'') = '' then PerSpeculum end as PerSpeculumText

			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart
			  --, ebpp.RecordName as ExternalBallottementPresentingPartText
			   ,case when isnull(ebpp.RecordName,'') = '' and isnull(ebpp.RecordName,'') = '' then ExternalBallottementPresentingPart end as ExternalBallottementPresentingPartText
			  
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON 
			  pv.CaseId = inv.CaseId
			  --pv.VisitId=inv.VisitId	
			  
			  LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId

			  --LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on CASE 
							WHEN TRY_CAST(pv.ComplainOf AS INT) IS NOT NULL THEN TRY_CAST(pv.ComplainOf AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = comp.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerAbdomen AS INT) IS NOT NULL THEN TRY_CAST(pv.PerAbdomen AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END  = prab.EntityRecordId
			  
			  --LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId

			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on CASE 
							WHEN TRY_CAST(pv.PerSpeculum AS INT) IS NOT NULL THEN TRY_CAST(pv.PerSpeculum AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = prsp.EntityRecordId
			  
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			 -- LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			 
			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on CASE 
							WHEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT) IS NOT NULL THEN TRY_CAST( pv.ExternalBallottementPresentingPart AS INT)
							ELSE NULL -- Handle invalid data gracefully
						END = ebpp.EntityRecordId

			 LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.VisitId=@VisitId 


		End
		Else
		Begin
				 --SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime, PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  --, FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF, FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  --, Temperature, RespiratoryRate, SPO2, Pallor, Icterus, Oedema, RespiratorySystem, CardiovascularSystem, Breast
			  --, LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity, HistoryOf, ComplainOf, Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  --, PerAbdomen, PerSpeculum, PerVaginum, Diagnosis, Advice, Remark, FollowupDays, FollowupDate, Parity, PreviousDeliveryType
			  --, PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks
			  --, ExternalBallottementPresentingPart, FetalHeartSound, UterusCondition, PrescribedMedicines
			  --, pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  --, inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  --, inv.HomeBloodGlucoseMonitoring, inv.BloodGroup, inv.UrineSugar, inv.UrineProtein, inv.HIV, inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  --FROM  patient.tblPatientVisits pv with(nolock)
			  --LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  
			  --WHERE pv.CaseId=@CaseId And IsActive=1 And IsLatestVisit=1

			   SELECT pv.VisitId, pv.CaseId, OpdDate, OpdTime
			  , PatientType, PresentHistory, FamilyHistory, PastHistory, MarriedLife
			  , FTNDS_LiveM, FTNDS_LiveF, FTNDS_DeadM, FTNDS_DeadF
			  , FTLSCS_LiveM, FTLSCS_LiveF, FTLSCS_DeadM, FTLSCS_DeadF
			  , Temperature, temp.RecordName as TemperatureText
			  , RespiratoryRate, SPO2
			  , Pallor, pal.RecordName as PallorText
			  , Icterus, ict.RecordName as IcterusText
			  , Oedema, oed.RecordName as OedemaText
			  , RespiratorySystem, CardiovascularSystem
			  , Breast, brst.RecordName as BreastText
			  , LMPDate, EDD, MensturalHistoryDays, MensturalDays, MensturalSeverity
			  , HistoryOf, his.RecordName as HistoryOfText
			  , ComplainOf, comp.RecordName as ComplainOfText
			  , Pulse, SystolicBloodPressure, DaistolicBloodPressure
			  , PerAbdomen, prab.RecordName as PerAbdomenText
			  , PerSpeculum, prsp.RecordName as PerSpeculumText
			  , PerVaginum, prvg.RecordName as PerVaginumText
			  , Diagnosis, Advice, Remark
			  , FollowupDays, FollowupDate
			  , Parity, PreviousDeliveryType
			  , PossibleLMP, WeeksAccordingLMP, PossibleEDD, WeeksAccordingFirstEDD, FirstEDDAccordingUSG, PreviousMH
			  , IsPAUtSelected, PAUtValue, UterusDays, UterusWeeks

			  , ExternalBallottementPresentingPart, ebpp.RecordName as ExternalBallottementPresentingPartText
			  , FetalHeartSound, fhs.RecordName as FetalHeartSoundText
			  , UterusCondition, utrs.RecordName as UterusConditionText
			  
			  , PrescribedMedicines
			  , pv.IsLatestVisit, pv.IsActive, pv.IsEdited, pv.EntryDate, pv.UpdatedDate, pv.CreatedBy, pv.UpdatedBy 	  
			  , inv.InvestigationId, inv.PatientId, inv.CaseId, inv.VisitId
			  , inv.HomeBloodGlucoseMonitoring
			  , inv.BloodGroup, inv.BloodGroup, bg.RecordName as BloodGroupText
			  , inv.UrineSugar, inv.UrineProtein, inv.HIV
			  , inv.HepatitisBsurfaceAntigen, inv.ThyroidStimuatingHormone, inv.VenerealDiseaseResearchLaboratory, inv.Other
			  , UterusWeeksPA
			  FROM  patient.tblPatientVisits pv with(nolock)
			  LEFT JOIN patient.tblInvestigation inv with(nolock) ON pv.VisitId=inv.VisitId	  

			   LEFT JOIN common.tblEntityRecords temp with(nolock) on pv.Temperature = temp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords pal with(nolock) on pv.Pallor = pal.EntityRecordId
			  LEFT JOIN common.tblEntityRecords ict with(nolock) on pv.Icterus = ict.EntityRecordId
			  LEFT JOIN common.tblEntityRecords oed with(nolock) on pv.Oedema = oed.EntityRecordId
			  LEFT JOIN common.tblEntityRecords brst with(nolock) on pv.Breast = brst.EntityRecordId
			  LEFT JOIN common.tblEntityRecords his with(nolock) on pv.HistoryOf = his.EntityRecordId
			  LEFT JOIN common.tblEntityRecords comp with(nolock) on pv.ComplainOf = comp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prab with(nolock) on pv.PerAbdomen = prab.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prsp with(nolock) on pv.PerSpeculum = prsp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords prvg with(nolock) on pv.PerVaginum = prvg.EntityRecordId

			  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on pv.ExternalBallottementPresentingPart = ebpp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords fhs with(nolock) on pv.FetalHeartSound = fhs.EntityRecordId
			  LEFT JOIN common.tblEntityRecords utrs with(nolock) on pv.UterusCondition = utrs.EntityRecordId

			  LEFT JOIN common.tblEntityRecords bg with(nolock) on inv.BloodGroup = bg.EntityRecordId

			  WHERE pv.CaseId=@CaseId And pv.IsActive=1 And IsLatestVisit=1
		End


     
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tblPatientVisits WHERE VisitId=@VisitId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VisitId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_PincodeLocations]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_PincodeLocations]  
   @Command varchar(200) 
  , @LocationId int=NULL 
  , @Location varchar(50)=NULL 
  , @OfficeName varchar(50)=NULL 
  , @Pincode varchar(50)=NULL 
  , @OfficeType varchar(50)=NULL 
  , @Deliverystatus varchar(50)=NULL 
  , @Taluka varchar(50)=NULL 
  , @District varchar(50)=NULL 
  , @State varchar(50)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Location'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN       
        
		If Not Exists (select top 1 LocationId from location.tblPincodeLocations with (nolock) where OfficeName=@Location and Taluka=@Taluka and District=@District and State=@State)
		Begin
				INSERT INTO location.tblPincodeLocations  
				 (Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State) 
			   VALUES (@Location, @OfficeName, @Pincode, @OfficeType, @Deliverystatus, @Taluka, @District, @State)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Location with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      

		 If not Exists (select top 1 LocationId from location.tblPincodeLocations  with (nolock) where OfficeName=@Location and Taluka=@Taluka and District=@District and State=@State and LocationId!=@LocationId)
			Begin				
				 UPDATE location.tblPincodeLocations SET Location=@Location 
				, OfficeName=@OfficeName 
				, Pincode=@Pincode 
				, OfficeType=@OfficeType 
				, Deliverystatus=@Deliverystatus 
				, Taluka=@Taluka 
				, District=@District 
				, State=@State 
				 WHERE LocationId=@LocationId    
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @LocationId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @LocationId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @LocationId, @v_Message='error', @v_CustomMessage='Duplication error. Another Location with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage


    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT LocationId, Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State 
			FROM location.tblPincodeLocations with (nolock) WHERE LocationId=@LocationId 
		End

		Else If @SubCommand = 'GetAll'
		Begin
			SELECT LocationId, Location, OfficeName, Pincode, OfficeType, Deliverystatus, Taluka, District, State 
			FROM location.tblPincodeLocations with (nolock) 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' pl.LocationId!=0 '				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Name'
						Then 'pl.Location = ''' + @SearchKey + ''''
						When 'State'
						Then 'pl.State = ''' + @SearchKey + ''''
						When 'Taluka'
						Then 'pl.Taluka = ''' + @SearchKey + ''''
						When 'District'
						Then 'pl.District = ''' + @SearchKey + ''''
						When 'FreeSearch'
						Then '(pl.Location like ''%' + @SearchKey + '%'' 
						Or pl.Taluka like ''%' + @SearchKey + '%'' Or pl.District like ''%' + @SearchKey + '%'' Or pl.State like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select LocationId, Row_Number() Over (Order by Sortby ' + @SortOrder + ') as RowId From
					(
						Select pl.LocationId, ' + @SortBy + ' as SortBy
						 FROM location.tblPincodeLocations pl with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select  
				CTE.RowId
				, case CTE.RowId when 1 then (select Count(RowId) from CTE) else 0 end as TotalCount 
				, case CTE.RowId when 1 then (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) else 0 end as PageCount				
				, pl.LocationId, pl.Location, pl.OfficeName, pl.Pincode, pl.OfficeType, pl.Deliverystatus, pl.Taluka, pl.District, pl.State   
				  From CTE 
				  INNER JOIN location.tblPincodeLocations pl with(nolock) ON CTE.LocationId=pl.LocationId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblPincodeLocations WHERE LocationId=@LocationId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @LocationId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Plans]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Plans]  
   @Command varchar(200) 
  , @PlanId int=NULL 
  , @PlanName nvarchar(100)=NULL 
  , @Description nvarchar(2000)=NULL 
  , @Price money=NULL 
  , @DiscountPercent float=NULL 
  , @Validity int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='PlanName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

		If Not Exists (select top 1 PlanId from subscription.tblPlans with (nolock) where PlanName=@PlanName)
		Begin
				 INSERT INTO subscription.tblPlans  
				 (PlanName, Description, Price, DiscountPercent, Validity, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@PlanName, @Description, @Price, @DiscountPercent, @Validity, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Plan with this name already exists!'
		End                  
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
			If not Exists (select top 1 PlanId from subscription.tblPlans with (nolock) where PlanName=@PlanName and PlanId!=@PlanId)
			Begin				
				 UPDATE subscription.tblPlans 
				  SET PlanName=@PlanName 
					, Description=@Description 
					, Price=@Price 
					, DiscountPercent=@DiscountPercent 
					, Validity=@Validity 
					, IsActive=@IsActive 
					, IsEdited=@IsEdited         
					, UpdatedDate=@UpdatedDate         
					, UpdatedBy=@UpdatedBy 
					 WHERE PlanId=@PlanId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @PlanId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @PlanId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @PlanId, @v_Message='error', @v_CustomMessage='Duplication error. Another Plan with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT PlanId, PlanName, Description, Price, DiscountPercent, Validity, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM subscription.tblPlans with (nolock) WHERE PlanId=@PlanId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' p.IsActive in (1,0) '				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'Name'
						Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(p.PlanName like ''%' + @SearchKey + '%'' 
						Or p.Description like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select PlanId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct p.PlanId, ' + @SortBy + ' as SortBy
						 FROM subscription.tblPlans p with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, p.PlanId, p.PlanName, p.Description, p.Price, p.DiscountPercent, p.Validity								
				, p.IsActive, p.IsEdited, p.EntryDate, p.UpdatedDate, p.CreatedBy, p.UpdatedBy								  
				  From CTE 
				  INNER JOIN subscription.tblPlans p with(nolock) ON CTE.PlanId=p.PlanId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM subscription.tblPlans WHERE PlanId=@PlanId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @PlanId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ReportHeader]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_ReportHeader]  
   @Command varchar(200) 
  , @HeaderId int=NULL 
  , @HospitalId int=NULL
  , @TemplateTypeId bigint=NULL
  , @TemplateHeader nvarchar(200)=NULL 
  , @HeaderText nvarchar(MAX)=NULL
  , @LanguageCode nvarchar(50)=NULL
  , @IsTemplateActive bit=NULL
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  
  ,@HeaderImage nvarchar(max) = null
  , @IsHeaderSelect bit = 0
  , @FontFamily nvarchar(50) = null
  , @BGColour nvarchar(50) = null
  , @HeaderType nvarchar(50) = null
  , @LogoImage text = null
   
    , @BGColourFullTemplate int = 0
  , @FontFamilyFullTemplate int = 0

  ,@FontColour nvarchar(50) = null
  , @FontColourFullTemplate int = null

  ,@HospitalLogo text=null

  ,@LogoId bigint = null
  ,@DoctorImageId bigint = null
  ,@ObgyImageId bigint = null
  ,@PlusImageId bigint = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	If @IsTemplateActive=1
	Begin
	    -- -- // At a time only a single entry will be active for a particular Template Type for a Hospital
		Update hospital.tblReportHeader  Set IsTemplateActive=0 Where HospitalId=@HospitalId And TemplateTypeId=@TemplateTypeId
	End

      INSERT INTO hospital.tblReportHeader  
         (HospitalId, TemplateTypeId, TemplateHeader, HeaderText, LanguageCode, IsTemplateActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, HeaderImage, IsHeaderSelect, FontFamily, BGColour, HeaderType, LogoImage,BGColourFullTemplate, FontFamilyFullTemplate, FontColour, FontColourFullTemplate
		 ,HospitalLogo
		 
		 ,LogoId,DoctorImageId,ObgyImageId,PlusImageId)
		 
       VALUES (@HospitalId, @TemplateTypeId, @TemplateHeader, @HeaderText, @LanguageCode, @IsTemplateActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @HeaderImage, @IsHeaderSelect, @FontFamily, @BGColour, @HeaderType, @LogoImage,@BGColourFullTemplate, @FontFamilyFullTemplate, @FontColour, @FontColourFullTemplate
	   ,@HospitalLogo
	   
	   ,@LogoId,@DoctorImageId, @ObgyImageId, @PlusImageId)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	If @IsTemplateActive=1
	Begin
	    -- -- // At a time only a single entry will be active for a particular Template Type for a Hospital
		Update hospital.tblReportHeader  Set IsTemplateActive=0 Where HospitalId=@HospitalId And TemplateTypeId=@TemplateTypeId And HeaderId!=@HeaderId
	End

	declare @reportHeaderImage nvarchar(max) = (select HeaderImage from hospital.tblReportHeader where HeaderId = @HeaderId)

      UPDATE hospital.tblReportHeader 
	  SET HospitalId=@HospitalId
	  , TemplateTypeId=@TemplateTypeId
        , TemplateHeader=@TemplateHeader 
        , HeaderText=@HeaderText
		, LanguageCode=@LanguageCode
		, IsTemplateActive=@IsTemplateActive
        , IsEdited=@IsEdited 
      --  , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		--, HeaderImage = @HeaderImage
		, HeaderImage = @reportHeaderImage
		, IsHeaderSelect = @IsHeaderSelect

		,FontFamily = @FontFamily 
		, BGColour = @BGColour
		, HeaderType = @HeaderType
		, LogoImage = @LogoImage

		,BGColourFullTemplate = @BGColourFullTemplate
		, FontFamilyFullTemplate = @FontFamilyFullTemplate

		,FontColour = @FontColour
		,FontColourFullTemplate = @FontColourFullTemplate

		,HospitalLogo = @HospitalLogo

		,LogoId = @LogoId
		,DoctorImageId = @DoctorImageId
		,ObgyImageId = @ObgyImageId
		,PlusImageId = @PlusImageId

         WHERE HeaderId=@HeaderId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HeaderId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @HeaderId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			--SELECT HeaderId, HospitalId, TemplateTypeId, TemplateHeader, HeaderText, LanguageCode, IsTemplateActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , HeaderImage, IsHeaderSelect as IsHeaderImageOrHtml, FontFamily, BGColour, HeaderType, LogoImage, BGColourFullTemplate, FontFamilyFullTemplate
			--,FontColour,FontColourFullTemplate, HospitalLogo
			--,DoctorImageId,ObgyImageId,PlusImageId  
			--FROM  hospital.tblReportHeader 
			--WHERE HeaderId=@HeaderId
			

			SELECT HeaderId, HospitalId, TemplateTypeId, TemplateHeader, HeaderText, LanguageCode, IsTemplateActive, IsEdited, EntryDate, UpdatedDate, r.CreatedBy, r.UpdatedBy , HeaderImage, IsHeaderSelect as IsHeaderImageOrHtml, FontFamily, BGColour, HeaderType, LogoImage, BGColourFullTemplate, FontFamilyFullTemplate
			,FontColour,FontColourFullTemplate, HospitalLogo
			,DoctorImageId,ObgyImageId,PlusImageId  
			, img1.DoctorImage, img2.ObgyImage, img3.PlusImage
			FROM  hospital.tblReportHeader r
			LEFT JOIN hospital.tbl_reportheaderImages img1 WITH (NOLOCK) 
			ON img1.headerimageid = r.DoctorImageId

			 LEFT JOIN hospital.tbl_reportheaderImages img2 WITH (NOLOCK) 
			ON img2.headerimageid = r.obgyimageid

			LEFT JOIN hospital.tbl_reportheaderImages img3 WITH (NOLOCK) 
			ON img3.headerimageid = r.plusimageId

			WHERE HeaderId=@HeaderId

		End

		---// -------------------------
		ELSE If @SubCommand = 'SelectImages'
		Begin
			select headerImageId,TypeImage,DoctorImage,ObgyImage,Logo ,PlusImage
			from hospital.tbl_reportHeaderImages with(nolock)
		End
		---// -------------------------

		---// -------------------------
		ELSE If @SubCommand = 'SelectSelectedImages'
		Begin
		;with cte as(
			SELECT 

			   img.headerimageid,img.typeimage ,img.Doctorimage

			   from 
				   hospital.tblReportHeader r
			LEFT JOIN hospital.tbl_reportheaderImages img WITH (NOLOCK) 
			ON img.headerimageid = r.DoctorImageId

			where HospitalId = @HospitalId

			union all

			SELECT 
			   img.headerimageid,img.typeimage ,img.Obgyimage

			   from 
				   hospital.tblReportHeader r
				 LEFT JOIN hospital.tbl_reportheaderImages img WITH (NOLOCK) 
			ON img.headerimageid = r.obgyimageid
			where HospitalId = @HospitalId

			union all

			SELECT 
			   img.headerimageid,img.typeimage ,img.Plusimage

			   from 
				   hospital.tblReportHeader r
			LEFT JOIN hospital.tbl_reportheaderImages img WITH (NOLOCK) 
			ON img.headerimageid = r.plusimageId
			where HospitalId = @HospitalId

		) select * from cte 

		End
		---// -------------------------



		Else if @SubCommand='GetAllList' 
		Begin
				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' rh.HeaderId > 0 '	
			
			If @HospitalId > 0
				SET @WhereQry += ' And rh.HospitalId = ' + Convert(varchar(20), @HospitalId)


				--	set @BaseQry = '
				--With CTE AS (
				--	Select a.HeaderId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
				--	(
				--		Select distinct rh.HeaderId, ' + @SortBy + ' as SortBy
				--		 FROM hospital.tblReportHeader rh with(nolock) 						  					
				--		WHERE ' + @WhereQry + ' 
				--	) A
				--) Select distinct 
				--CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				--, rh.HeaderId, HospitalId
				--, rh.TemplateTypeId, tt.RecordName as TemplateType
				--, TemplateHeader, HeaderText, LanguageCode
				--, rh.IsTemplateActive, rh.IsEdited, rh.EntryDate, rh.UpdatedDate, rh.CreatedBy, rh.UpdatedBy,rh.HeaderImage					
				--, rh.IsHeaderSelect as IsHeaderImageOrHtml

				--  From CTE 
				--  INNER JOIN hospital.tblReportHeader rh with(nolock) ON CTE.HeaderId=rh.HeaderId
				--  INNER JOIN common.tblEntityRecords tt with(nolock) ON rh.TemplateTypeId=tt.EntityRecordId
				  
				--  ' + @v_PagingQry + 
				--  ' Order by RowId	'	
				



			set @BaseQry = '
				With CTE AS (
					Select a.HeaderId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct rh.HeaderId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblReportHeader rh with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) 
				--Select distinct 
				Select 
				CTE.RowId
				, (select Count(RowId) from CTE) as TotalCount
				, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, rh.HeaderId, HospitalId
				, rh.TemplateTypeId, tt.RecordName as TemplateType
				, TemplateHeader, HeaderText, LanguageCode
				, rh.IsTemplateActive, rh.IsEdited, rh.EntryDate, rh.UpdatedDate, rh.CreatedBy, rh.UpdatedBy
				--,rh.HeaderImage					
				,rh.IsHeaderSelect as IsHeaderImageOrHtml
				, HeaderImage, BGColour,FontFamily,HeaderType,LogoImage
				,isnull(BGColourFullTemplate,0) as BGColourFullTemplate 
				, isnull( FontFamilyFullTemplate, 0) as FontFamilyFullTemplate
				, FontColour ,FontColourFullTemplate,HospitalLogo

				,img.DoctorImage,img2.ObgyImage,img3.PlusImage

				  From CTE 
				  INNER JOIN hospital.tblReportHeader rh with(nolock) ON CTE.HeaderId=rh.HeaderId
				  INNER JOIN common.tblEntityRecords tt with(nolock) ON rh.TemplateTypeId=tt.EntityRecordId

				  LEFT JOIN hospital.tbl_reportheaderImages img WITH (NOLOCK) ON img.headerimageid = rh.DoctorImageId
				  LEFT JOIN hospital.tbl_reportheaderImages img2 WITH (NOLOCK) ON img2.headerimageid = rh.obgyimageid
				  LEFT JOIN hospital.tbl_reportheaderImages img3 WITH (NOLOCK) ON img3.headerimageid = rh.plusimageId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tblReportHeader WHERE HeaderId=@HeaderId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HeaderId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_ReportHeader_BKP]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_ReportHeader_BKP]  
   @Command varchar(200) 
  , @HeaderId int=NULL 
  , @HospitalId int=NULL
  , @TemplateTypeId bigint=NULL
  , @TemplateHeader nvarchar(200)=NULL 
  , @HeaderText nvarchar(MAX)=NULL
  , @LanguageCode nvarchar(50)=NULL
  , @IsTemplateActive bit=NULL
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  
  ,@HeaderImage nvarchar(max) = null
  , @IsHeaderSelect bit = 0
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	If @IsTemplateActive=1
	Begin
	    -- -- // At a time only a single entry will be active for a particular Template Type for a Hospital
		Update hospital.tblReportHeader  Set IsTemplateActive=0 Where HospitalId=@HospitalId And TemplateTypeId=@TemplateTypeId
	End

      INSERT INTO hospital.tblReportHeader  
         (HospitalId, TemplateTypeId, TemplateHeader, HeaderText, LanguageCode, IsTemplateActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, HeaderImage, IsHeaderSelect) 
       VALUES (@HospitalId, @TemplateTypeId, @TemplateHeader, @HeaderText, @LanguageCode, @IsTemplateActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @HeaderImage, @IsHeaderSelect)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	If @IsTemplateActive=1
	Begin
	    -- -- // At a time only a single entry will be active for a particular Template Type for a Hospital
		Update hospital.tblReportHeader  Set IsTemplateActive=0 Where HospitalId=@HospitalId And TemplateTypeId=@TemplateTypeId And HeaderId!=@HeaderId
	End

      UPDATE hospital.tblReportHeader 
	  SET HospitalId=@HospitalId
	  , TemplateTypeId=@TemplateTypeId
        , TemplateHeader=@TemplateHeader 
        , HeaderText=@HeaderText
		, LanguageCode=@LanguageCode
		, IsTemplateActive=@IsTemplateActive
        , IsEdited=@IsEdited 
      --  , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		, HeaderImage = @HeaderImage
		, IsHeaderSelect = @IsHeaderSelect

         WHERE HeaderId=@HeaderId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HeaderId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @HeaderId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT HeaderId, HospitalId, TemplateTypeId, TemplateHeader, HeaderText, LanguageCode, IsTemplateActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , HeaderImage, IsHeaderSelect
			FROM  hospital.tblReportHeader 
			WHERE HeaderId=@HeaderId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' rh.HeaderId > 0 '	
			
			If @HospitalId > 0
				SET @WhereQry += ' And rh.HospitalId = ' + Convert(varchar(20), @HospitalId)


				--	set @BaseQry = '
				--With CTE AS (
				--	Select a.HeaderId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
				--	(
				--		Select distinct rh.HeaderId, ' + @SortBy + ' as SortBy
				--		 FROM hospital.tblReportHeader rh with(nolock) 						  					
				--		WHERE ' + @WhereQry + ' 
				--	) A
				--) Select distinct 
				--CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				--, rh.HeaderId, HospitalId
				--, rh.TemplateTypeId, tt.RecordName as TemplateType
				--, TemplateHeader, HeaderText, LanguageCode
				--, rh.IsTemplateActive, rh.IsEdited, rh.EntryDate, rh.UpdatedDate, rh.CreatedBy, rh.UpdatedBy,rh.HeaderImage					
				--, rh.IsHeaderSelect as IsHeaderImageOrHtml

				--  From CTE 
				--  INNER JOIN hospital.tblReportHeader rh with(nolock) ON CTE.HeaderId=rh.HeaderId
				--  INNER JOIN common.tblEntityRecords tt with(nolock) ON rh.TemplateTypeId=tt.EntityRecordId
				  
				--  ' + @v_PagingQry + 
				--  ' Order by RowId	'	
				



			set @BaseQry = '
				With CTE AS (
					Select a.HeaderId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct rh.HeaderId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblReportHeader rh with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) 
				--Select distinct 
				Select 
				CTE.RowId
				, (select Count(RowId) from CTE) as TotalCount
				, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, rh.HeaderId, HospitalId
				, rh.TemplateTypeId, tt.RecordName as TemplateType
				, TemplateHeader, HeaderText, LanguageCode
				, rh.IsTemplateActive, rh.IsEdited, rh.EntryDate, rh.UpdatedDate, rh.CreatedBy, rh.UpdatedBy
				--,rh.HeaderImage					
				,rh.IsHeaderSelect as IsHeaderImageOrHtml
				,  (
						SELECT HeaderImage 
						FROM hospital.tbl_UserTemplateSettings 
						WHERE HospitalId = '+cast(@HospitalId as nvarchar(10))+'
						  AND IsTemplateSelect = 1
					) AS HeaderImage

				  From CTE 
				  INNER JOIN hospital.tblReportHeader rh with(nolock) ON CTE.HeaderId=rh.HeaderId
				  INNER JOIN common.tblEntityRecords tt with(nolock) ON rh.TemplateTypeId=tt.EntityRecordId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tblReportHeader WHERE HeaderId=@HeaderId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @HeaderId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Society]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Society]  
   @Command varchar(200) 
  , @SocietyId bigint=NULL 
  , @Society nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @AreaId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  , @Area nvarchar(200) = null
  , @City nvarchar(200) = null
  , @State nvarchar(200) = null
  , @StateId bigint = 0
  , @CityId bigint = 0


   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 

	IF Not Exists (select top 1 1 from location.tblSociety where Society = @Society and Language = @Language)
	BEGIN
		INSERT INTO location.tblSociety  
         (Society, Language, AreaId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@Society, @Language, @AreaId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)  
	   
	   declare @V_SocietyId bigint = SCOPE_IDENTITY()

	   IF Not Exists (select top 1 1 from location.tblVillageCity where Area = @Area and City = @City and Society = @Society )
	   BEGIN
			
			
		insert into location.tblVillageCity (VillageCity,Language,TalukaId,IsActive,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy,taluka,District,State,Area,Society,City,SocietyId,AreaId,IsVillageCity)
		values
			('',@Language , 0,1,0,GETDATE() , null, @CreatedBy , @UpdatedBy , '' ,''  , @State, @Area , @Society , @City , @V_SocietyId , @AreaId , 0 )

	   END

	END
	
      
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE location.tblSociety SET Society=@Society 
        , Language=@Language 
        , AreaId=@AreaId 
        , IsActive=@IsActive 
        , IsEdited=@IsEdited 
        , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE SocietyId=@SocietyId     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @SocietyId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @SocietyId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		
		IF @SubCommand = 'GetAllList'
		BEGIN
			SELECT SocietyId, Society, s.Language, s.AreaId, Area ,s.IsActive, s.IsEdited, s.EntryDate, s.UpdatedDate, s.CreatedBy, s.UpdatedBy FROM  
				location.tblSociety s
				inner join location.tblArea a on a.AreaId = s.AreaId
		END
		ELSE
		BEGIN
			SELECT SocietyId, Society, so.Language, a.AreaId, so.IsActive, so.IsEdited, so.EntryDate, so.UpdatedDate, so.CreatedBy
			, a.Area , c.CityName as City, c.CityId , s.State , s.StateId
			, so.UpdatedBy FROM  
			location.tblSociety so
			inner join location.tblArea a on a.AreaId = so.AreaId
			inner join location.TblCity c on c.CityId = a.CityId
			inner join location.tblState s on s.StateId = c.StateId
			WHERE SocietyId=@SocietyId 

		END

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblSociety WHERE SocietyId=@SocietyId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @SocietyId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_States]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_States]  
   @Command varchar(200) 
  , @StateId int=NULL 
  , @State nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='State'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language)
		Begin
				  INSERT INTO location.tblState  
					 (State, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
				   VALUES (@State, @Language, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)  
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. State with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

		If not Exists (select top 1 StateId from location.tblState with (nolock) where State=@State and Language=@Language and StateId!=@StateId)
			Begin				
				UPDATE location.tblState SET State=@State 
			, Language=@Language 
			, IsActive=@IsActive 
			, IsEdited=@IsEdited      
			, UpdatedDate=@UpdatedDate        
			, UpdatedBy=@UpdatedBy 
			 WHERE StateId=@StateId 
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @StateId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @StateId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @StateId, @v_Message='error', @v_CustomMessage='Duplication error. Another State with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT StateId, State, Language, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			FROM location.tblState with (nolock) WHERE StateId=@StateId 			
		End
		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And s.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''							 						
						When 'FreeSearch'
						Then '(s.State like ''%' + @SearchKey + '%'' 
						Or s.Language like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select StateId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select s.StateId, ' + @SortBy + ' as SortBy
						 FROM location.tblState s with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, s.StateId, State, Language								
				, s.IsActive, s.IsEdited, s.EntryDate, s.UpdatedDate, s.CreatedBy, isnull(s.UpdatedBy,0) as UpdatedBy
				  From CTE 
				  INNER JOIN location.tblState s with(nolock) ON CTE.StateId=s.StateId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblState WHERE StateId=@StateId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @StateId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Subscriptions]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Subscriptions]  
   @Command varchar(200) 
  , @SubscriptionId int=NULL 
  , @HospitalId int=NULL 
  , @PlanId int=NULL 
  , @StartDate date=NULL 
  , @EndDate date=NULL 
  , @BasePrice money=NULL 
  , @TaxPercentage float=NULL 
  , @TaxAmount float=NULL 
  , @DiscountPercentage float=NULL 
  , @DiscountAmount float=NULL 
  , @TotalAmount money=NULL 
  , @SubscriptionTypeId tinyint=NULL
  , @LicenseKey nvarchar(100)=NULL
  , @LicenseCount int=NULL
  , @Remarks nvarchar(2000)=NULL 
  , @IsSubscriptionActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='SubscriptionId'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  , @AttendanceAccess bit = 0
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	IF not exists (select top 1 1 from subscription.tblSubscriptions)
	BEGIN
		 INSERT INTO subscription.tblSubscriptions  
         (HospitalId, PlanId, StartDate, EndDate, BasePrice, TaxPercentage, TaxAmount, DiscountPercentage, DiscountAmount, TotalAmount, SubscriptionTypeId, LicenseKey, LicenseCount,
		 Remarks, IsSubscriptionActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , AttendanceAccess) 
       VALUES (@HospitalId, @PlanId, @StartDate, @EndDate, @BasePrice, @TaxPercentage, @TaxAmount, @DiscountPercentage, @DiscountAmount, @TotalAmount, @SubscriptionTypeId, @LicenseKey, @LicenseCount,
	   @Remarks, @IsSubscriptionActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @AttendanceAccess)   
        
	END
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE subscription.tblSubscriptions 
	  SET HospitalId=@HospitalId 
        , PlanId=@PlanId 
        , StartDate=@StartDate 
        , EndDate=@EndDate 
        , BasePrice=@BasePrice 
        , TaxPercentage=@TaxPercentage 
        , TaxAmount=@TaxAmount 
        , DiscountPercentage=@DiscountPercentage 
        , DiscountAmount=@DiscountAmount 
        , TotalAmount=@TotalAmount 
        , SubscriptionTypeId=@SubscriptionTypeId
		, LicenseCount=@LicenseCount
        , Remarks=@Remarks 
        , IsSubscriptionActive=@IsSubscriptionActive 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        --, CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
		, AttendanceAccess = @AttendanceAccess
         WHERE SubscriptionId=@SubscriptionId   
		 

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @SubscriptionId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @SubscriptionId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT SubscriptionId, HospitalId, PlanId, StartDate, EndDate, BasePrice, TaxPercentage, TaxAmount, DiscountPercentage, DiscountAmount, TotalAmount, SubscriptionTypeId, 
			LicenseKey, LicenseCount, InstalledCount,
			Remarks, IsSubscriptionActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,AttendanceAccess
			  FROM subscription.tblSubscriptions WHERE SubscriptionId=@SubscriptionId 
		End

		Else If @SubCommand = 'ValidateLicenseKey'
		Begin
			SELECT SubscriptionId, HospitalId, PlanId, StartDate, EndDate, BasePrice, TaxPercentage, TaxAmount, DiscountPercentage, DiscountAmount, TotalAmount, SubscriptionTypeId, 
			LicenseKey, LicenseCount, InstalledCount,
			Remarks, IsSubscriptionActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,AttendanceAccess
			  FROM subscription.tblSubscriptions WHERE LicenseKey=@LicenseKey 

			 Update subscription.tblSubscriptions 
			 SET InstalledCount = InstalledCount + 1
			 , IsEdited=1
			 , UpdatedDate=Getdate() 
			 WHERE LicenseKey=@LicenseKey
			 AND IsSubscriptionActive = 1
			 AND Cast(EndDate as Date) >= Cast(GETDATE() as Date)
			 AND InstalledCount + 1 <= LicenseCount

		End

		Else if @SubCommand='GetAllList' 
		Begin
				Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' s.IsSubscriptionActive in (1,0) '				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'HospitalName'
						Then 'h.PlanName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(p.PlanName like ''%' + @SearchKey + '%'' 
						Or p.Description like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select SubscriptionId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct s.SubscriptionId, ' + @SortBy + ' as SortBy
						 FROM subscription.tblSubscriptions s						 
						 INNER JOIN subscription.tblPlans p with(nolock) ON s.PlanId=p.PlanId 
						 INNER JOIN hospital.tblHospital h with(nolock) ON s.HospitalId=h.HospitalId
						 INNER JOIN common.tblEntityRecords substype with(nolock) on s.SubscriptionTypeId = substype.EntityRecordId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, s.SubscriptionId, s.StartDate, s.EndDate, s.BasePrice, s.TaxPercentage, s.TaxAmount, s.DiscountPercentage, s.DiscountAmount, s.TotalAmount
				, s.LicenseKey, s.LicenseCount, s.InstalledCount
				, s.Remarks
				, s.SubscriptionTypeId, substype.RecordName as SubscriptionType
				, s.IsSubscriptionActive, s.IsEdited, s.EntryDate, s.UpdatedDate, s.CreatedBy, s.UpdatedBy
				, p.PlanId, p.PlanName, p.Description, p.Validity
				, h.HospitalId, h.HospitalName, h.LocationId, h.Area, h.Taluka, h.District, h.State, h.Pincode
				, s.AttendanceAccess

				  From CTE 
				  INNER JOIN subscription.tblSubscriptions s with(nolock) ON CTE.SubscriptionId=s.SubscriptionId				  
				  INNER JOIN subscription.tblPlans p with(nolock) ON s.PlanId=p.PlanId 
				  INNER JOIN hospital.tblHospital h with(nolock) ON s.HospitalId=h.HospitalId
				  INNER JOIN common.tblEntityRecords substype with(nolock) on s.SubscriptionTypeId = substype.EntityRecordId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM subscription.tblSubscriptions WHERE SubscriptionId=@SubscriptionId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @SubscriptionId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Talukas]  
   @Command varchar(200) 
  , @TalukaId int=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @DistrictId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Taluka'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language)
		Begin
				INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@Taluka, @Language, @DistrictId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language and TalukaId!=@TalukaId)
			Begin				
				  UPDATE location.tblTaluka SET Taluka=@Taluka 
				, Language=@Language 
				, DistrictId=@DistrictId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 				
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				 WHERE TalukaId=@TalukaId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN     

	  	If @SubCommand = 'SelectSingle'
		Begin
			SELECT TalukaId, Taluka, t.Language, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, t.UpdatedBy
			, d.DistrictId, d.District
			, s.StateId, s.State			 
			FROM location.tblTaluka t with(nolock) 
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE TalukaId=@TalukaId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And t.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					 When 'Taluka'
						Then 't.Taluka = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'District'
						Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'DistrictId'
						Then 'd.DistrictId = ' + Convert(varchar, @SearchKey) 
					 When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
					 When 'StateId'
						Then 's.StateId = ' + Convert(varchar, @SearchKey) 
					 When 'FreeSearch'
						Then '(t.Taluka like ''%' + @SearchKey + '%'' Or d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or t.Language like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select TalukaId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select t.TalukaId, ' + @SortBy + ' as SortBy
						 FROM 
						 location.tblTaluka t with (nolock)
						  LEFT JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
						  LEFT JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, t.TalukaId, t.Taluka, t.Language
				, isnull(d.DistrictId, 0) as DistrictId , isnull(d.District , '''') as District
				--, isnull(s.StateId , '''') as StateId, isnull(s.State,'''') as State , isnull(t.Area,'''')as Area , isnull(d2.City, '''') as City
				, isnull(s.StateId , isnull( s2.StateId,0)) as StateId, isnull(s.State,s2.State) as State , isnull(t.Area,'''')as Area , isnull(d2.City, '''') as City
				,t.AreaId
				, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, isnull(t.UpdatedBy,0) as UpdatedBy
				  From CTE
				  LEFT JOIN location.tblTaluka t with(nolock) ON CTE.TalukaId=t.TalukaId
				  LEFT JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
				  LEFT JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
				  LEFT JOIN location.tblDistrict d2 with(nolock) on d2.CityId = t.CityId
				  LEFT JOIN location.TblCity c with(nolock) on c.CityId = d2.CityId
				  LEFT JOIN location.tblState s2 with(nolock) on s2.StateId = c.StateId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblTaluka WHERE TalukaId=@TalukaId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas_15_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Talukas_15_06_2025]  
   @Command varchar(200) 
  , @TalukaId int=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @DistrictId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Taluka'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language)
		Begin
				INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@Taluka, @Language, @DistrictId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language and TalukaId!=@TalukaId)
			Begin				
				  UPDATE location.tblTaluka SET Taluka=@Taluka 
				, Language=@Language 
				, DistrictId=@DistrictId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 				
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				 WHERE TalukaId=@TalukaId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN     

	  	If @SubCommand = 'SelectSingle'
		Begin
			SELECT TalukaId, Taluka, t.Language, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, t.UpdatedBy
			, d.DistrictId, d.District
			, s.StateId, s.State			 
			FROM location.tblTaluka t with(nolock) 
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE TalukaId=@TalukaId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And t.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					 When 'Taluka'
						Then 't.Taluka = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'District'
						Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'DistrictId'
						Then 'd.DistrictId = ' + Convert(varchar, @SearchKey) 
					 When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
					 When 'StateId'
						Then 's.StateId = ' + Convert(varchar, @SearchKey) 
					 When 'FreeSearch'
						Then '(t.Taluka like ''%' + @SearchKey + '%'' Or d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or t.Language like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select TalukaId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select t.TalukaId, ' + @SortBy + ' as SortBy
						 FROM 
						 location.tblTaluka t with (nolock)
						  INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
						  INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, t.TalukaId, t.Taluka, t.Language
				, d.DistrictId, d.District
				, s.StateId, s.State , City ,Area 
				, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, t.UpdatedBy								  
				  From CTE
				  INNER JOIN location.tblTaluka t with(nolock) ON CTE.TalukaId=t.TalukaId
				  INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
				  INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblTaluka WHERE TalukaId=@TalukaId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Talukas_16_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Talukas_16_06_2025]  
   @Command varchar(200) 
  , @TalukaId int=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @DistrictId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='Taluka'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
		If Not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language)
		Begin
				INSERT INTO location.tblTaluka  
				 (Taluka, Language, DistrictId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
			   VALUES (@Taluka, @Language, @DistrictId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		If not Exists (select top 1 TalukaId from location.tblTaluka with (nolock) where Taluka=@Taluka and DistrictId=@DistrictId and Language=@Language and TalukaId!=@TalukaId)
			Begin				
				  UPDATE location.tblTaluka SET Taluka=@Taluka 
				, Language=@Language 
				, DistrictId=@DistrictId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 				
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				 WHERE TalukaId=@TalukaId  
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @TalukaId, @v_Message='error', @v_CustomMessage='Duplication error. Taluka and District combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN     

	  	If @SubCommand = 'SelectSingle'
		Begin
			SELECT TalukaId, Taluka, t.Language, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, t.UpdatedBy
			, d.DistrictId, d.District
			, s.StateId, s.State			 
			FROM location.tblTaluka t with(nolock) 
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE TalukaId=@TalukaId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And t.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					 When 'Taluka'
						Then 't.Taluka = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'District'
						Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'DistrictId'
						Then 'd.DistrictId = ' + Convert(varchar, @SearchKey) 
					 When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
					 When 'StateId'
						Then 's.StateId = ' + Convert(varchar, @SearchKey) 
					 When 'FreeSearch'
						Then '(t.Taluka like ''%' + @SearchKey + '%'' Or d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or t.Language like ''%' + @SearchKey + '%'')' 
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select TalukaId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select t.TalukaId, ' + @SortBy + ' as SortBy
						 FROM 
						 location.tblTaluka t with (nolock)
						  LEFT JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
						  LEFT JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, t.TalukaId, t.Taluka, t.Language
				, isnull(d.DistrictId, 0) as DistrictId , isnull(d.District , '''') as District
				, isnull(s.StateId , '''') as StateId, isnull(s.State,'''') as State , isnull(t.Area,'''')as Area , isnull(d2.City, '''') as City
				, t.IsActive, t.IsEdited, t.EntryDate, t.UpdatedDate, t.CreatedBy, t.UpdatedBy								  
				  From CTE
				  LEFT JOIN location.tblTaluka t with(nolock) ON CTE.TalukaId=t.TalukaId
				  LEFT JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
				  LEFT JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
				  LEFT JOIN location.tblDistrict d2 with(nolock) on d2.CityId = t.CityId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM location.tblTaluka WHERE TalukaId=@TalukaId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @TalukaId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_tblIndoorRecords]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_tblIndoorRecords]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @IndoorRecordId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @AdmissionDate date=NULL 
  , @AdmissionTime time=NULL 
  , @IndoorCaseNo nvarchar(50)=NULL 
  , @IndoorDate date=NULL 
  , @IndoorTime time=NULL 
  , @TemperatureRefId bigint=NULL 
  , @Pulse int=NULL 
  , @SysBP int=NULL 
  , @DaisBP int=NULL 
  , @SPO2 float=NULL 
  , @PallorRefId bigint=NULL 
  , @IcterusRefId bigint=NULL 
  , @OedemaRefId bigint=NULL 
  , @RS nvarchar(50)=NULL 
  , @CVS nvarchar(50)=NULL 
  , @UTWeeksRefId bigint=NULL 
  , @EBPPRefId bigint=NULL 
  , @FHSRefId bigint=NULL 
  , @UTContRefId nchar(10)=NULL 
  , @PSRefId bigint=NULL 
  , @PVRefId bigint=NULL 
  , @ProvisionalDiagnosisRefId bigint=NULL 
  , @OperationNameRefId bigint=NULL 
  , @OTDate date=NULL 
  , @OTTime time=NULL 
  , @DiagnosisRefId bigint=NULL 
  , @DischargeDate date=NULL 
  , @DischargeTime time=NULL 
  , @AdviceGroup nvarchar(MAX)=NULL 
  , @AdviceDetails nvarchar(MAX)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblIndoorRecords  
         (PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
		 , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
		 , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId
		 , OperationNameRefId, OTDate, OTTime
		 , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy) 
       VALUES (@PatientId, @CaseId, @VisitId, @AdmissionDate, @AdmissionTime, @IndoorCaseNo, @IndoorDate, @IndoorTime
	   , @TemperatureRefId, @Pulse, @SysBP, @DaisBP, @SPO2, @PallorRefId, @IcterusRefId, @OedemaRefId, @RS, @CVS
	   , @UTWeeksRefId, @EBPPRefId, @FHSRefId, @UTContRefId, @PSRefId, @PVRefId, @ProvisionalDiagnosisRefId
	   , @OperationNameRefId, @OTDate, @OTTime
	   , @DiagnosisRefId, @DischargeDate, @DischargeTime, @AdviceGroup, @AdviceDetails
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblIndoorRecords 
	  SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , AdmissionDate=@AdmissionDate 
        , AdmissionTime=@AdmissionTime 
        --, IndoorCaseNo=@IndoorCaseNo 
        , IndoorDate=@IndoorDate 
        , IndoorTime=@IndoorTime 
        , TemperatureRefId=@TemperatureRefId 
        , Pulse=@Pulse 
        , SysBP=@SysBP 
        , DaisBP=@DaisBP 
        , SPO2=@SPO2 
        , PallorRefId=@PallorRefId 
        , IcterusRefId=@IcterusRefId 
        , OedemaRefId=@OedemaRefId 
        , RS=@RS 
        , CVS=@CVS 
        , UTWeeksRefId=@UTWeeksRefId 
        , EBPPRefId=@EBPPRefId 
        , FHSRefId=@FHSRefId 
        , UTContRefId=@UTContRefId 
        , PSRefId=@PSRefId 
        , PVRefId=@PVRefId 
        , ProvisionalDiagnosisRefId=@ProvisionalDiagnosisRefId 
        , OperationNameRefId=@OperationNameRefId 
        , OTDate=@OTDate 
        , OTTime=@OTTime 
        , DiagnosisRefId=@DiagnosisRefId 
        , DischargeDate=@DischargeDate 
        , DischargeTime=@DischargeTime 
        , AdviceGroup=@AdviceGroup 
        , AdviceDetails=@AdviceDetails 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
      --  , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 
         WHERE IndoorRecordId=@IndoorRecordId    
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @IndoorRecordId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
		    SELECT IndoorRecordId, PatientId, CaseId, VisitId, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
			  , TemperatureRefId, Pulse, SysBP, DaisBP, SPO2, PallorRefId, IcterusRefId, OedemaRefId, RS, CVS
			  , UTWeeksRefId, EBPPRefId, FHSRefId, UTContRefId, PSRefId, PVRefId, ProvisionalDiagnosisRefId
			  , OperationNameRefId, OTDate, OTTime
			  , DiagnosisRefId, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy 
			  FROM  patient.tblIndoorRecords 
			  WHERE IndoorRecordId=@IndoorRecordId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' ir.IndoorRecordId > 0 '				
			
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select a.IndoorRecordId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct ir.IndoorRecordId, ' + @SortBy + ' as SortBy
						 FROM patient.tblIndoorRecords ir with(nolock) 						  					
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount			
				, ir.IndoorRecordId, PatientId, CaseId, VisitId
				, AdmissionDate, AdmissionTime, IndoorCaseNo, IndoorDate, IndoorTime
				, TemperatureRefId, tmp.RecordName as Temperature
				, Pulse, SysBP, DaisBP, SPO2
				, PallorRefId, pal.RecordName as Pallor
				, IcterusRefId, ict.RecordName as Icterus
				, OedemaRefId, oed.RecordName as Oedema
				, RS, CVS
				, UTWeeksRefId, UTWeeksRefId as UTWeeks
				, EBPPRefId, ebpp.RecordName as EBPP
				, FHSRefId, fhs.RecordName as FHS
				, UTContRefId, utc.RecordName as UTCont
				, PSRefId, ps.RecordName as PS
				, PVRefId, pv.RecordName as PV
				, ProvisionalDiagnosisRefId, pd.RecordName as ProvisionalDiagnosis
				, OperationNameRefId, opn.RecordName as OperationName
				, OTDate, OTTime
				, DiagnosisRefId, dia.RecordName as Diagnosis
				, DischargeDate, DischargeTime, AdviceGroup, AdviceDetails
				, ir.IsEdited, ir.EntryDate, ir.UpdatedDate, ir.CreatedBy, ir.UpdatedBy								  
				  From CTE 
				  INNER JOIN patient.tblIndoorRecords ir with(nolock) ON CTE.IndoorRecordId=ir.IndoorRecordId
				  LEFT JOIN common.tblEntityRecords tmp with(nolock) on ir.TemperatureRefId = tmp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pal with(nolock) on ir.PallorRefId = pal.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ict with(nolock) on ir.IcterusRefId = ict.EntityRecordId
				  LEFT JOIN common.tblEntityRecords oed with(nolock) on ir.OedemaRefId = oed.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords ebpp with(nolock) on ir.EBPPRefId = ebpp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords fhs with(nolock) on ir.FHSRefId = fhs.EntityRecordId
				  LEFT JOIN common.tblEntityRecords utc with(nolock) on ir.UTContRefId = utc.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ps with(nolock) on ir.PSRefId = ps.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pv with(nolock) on ir.PVRefId = pv.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pd with(nolock) on ir.ProvisionalDiagnosisRefId = pd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords opn with(nolock) on ir.OperationNameRefId = opn.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dia with(nolock) on ir.DiagnosisRefId = dia.EntityRecordId

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
  
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tblIndoorRecords WHERE IndoorRecordId=@IndoorRecordId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @IndoorRecordId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_Users]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_Users]  
   @Command varchar(200) 
  , @UserId bigint=NULL 
  , @HospitalId int=NULL 
  , @FirstName nvarchar(100)=NULL 
  , @MiddleName nvarchar(100)=NULL 
  , @LastName nvarchar(100)=NULL 
  , @UserTypeId bigint=NULL 
  , @DepartmentId bigint=NULL 
  , @DesignationId bigint=NULL 
  , @UserCode nvarchar(100)=NULL 
  , @LocationId int=NULL 
  , @Area nvarchar(100)=NULL 
  , @Taluka nvarchar(100)=NULL 
  , @District nvarchar(100)=NULL 
  , @State nvarchar(100)=NULL 
  , @Pincode nvarchar(50)=NULL
  , @AadhaarNo nvarchar(50)=NULL 
  , @RegistrationNo nvarchar(100)=NULL
  , @UsgRegNo nvarchar(100)=NULL
  , @DocSequenceNo int=NULL
  , @EduDegree nvarchar(100)=NULL 
  , @EduSpeciality nvarchar(100)=NULL 
  
  , @EmployeeTypeId bigint=NULL
  , @Password nvarchar(50)=NULL
  , @LoginAccessTypeId bigint=NULL
  , @UserRights varchar(500)=NULL

  , @IsUserActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='FirstName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Phone nvarchar(100) = NULL
  , @LandLine nvarchar(100) = NULL
  , @FaxNo nvarchar(100) = NULL
  , @EmailAddress nvarchar(100) = NULL

  --Jeet Chauhan NEw parameter
  , @FontFamilyId bigint = null
  --Jeet Chauhan NEw parameter
  ,@AditionRegistrationNo nvarchar(100) = null

  ,@EmailId nvarchar(200) = null
  ,@EmpId nvarchar(200) = null
   ,@Location nvarchar(500) = null
  ,@HouseBuilding nvarchar(500) = null

   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      
	  declare @TotalCountOfUsers bigint =0;

	  select @TotalCountOfUsers=COUNT(UserId) from hospital.tblHospitalUsers where UserTypeId = 4 and HospitalId = @HospitalId

	 IF @TotalCountOfUsers >= 3
	 BEGIN
		SELECT @v_IsSuccess=1, @v_Identity = 0, @v_Message='success',  @v_CustomMessage = 'You have Already 3 entries of doctors.'
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage 
		RETURN;
	 END
	  
	  INSERT INTO hospital.tblHospitalUsers  
         (HospitalId, FirstName, MiddleName, LastName, UserTypeId, DepartmentId, DesignationId, UserCode
		 , LocationId, Area, Taluka, District, State, Pincode, AadhaarNo, RegistrationNo, UsgRegNo, DocSequenceNo, EduDegree, EduSpeciality, EmployeeTypeId, Password, LoginAccessTypeId
		 , IsUserActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, FontFamilyId , AditionalRegistrationNo,UserRights,Location, HouseBuilding)
		 
       VALUES (@HospitalId, @FirstName, @MiddleName, @LastName, @UserTypeId, @DepartmentId, @DesignationId, @UserCode
	   , @LocationId, @Area, @Taluka, @District, @State, @Pincode, @AadhaarNo, @RegistrationNo, @UsgRegNo, @DocSequenceNo, @EduDegree, @EduSpeciality, @EmployeeTypeId, @Password, @LoginAccessTypeId
	   , @IsUserActive, @IsEdited, GETDATE(), @UpdatedDate, @CreatedBy, @UpdatedBy, @FontFamilyId , @AditionRegistrationNo , @UserRights ,@Location , @HouseBuilding)  
      
	  
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			If @v_Identity > 0
			Begin
				-- -- // Auto Generate UserCode for the New Employee
				Update hospital.tblHospitalUsers Set UserCode = 'EMP' + CONVERT(varchar(50),@v_Identity) Where UserId = @v_Identity

				-- -- // Insert User Contact Information
				insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy)
				values (13, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)
			End
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 



	IF @Command='InsertUserFromAPI' 
    BEGIN 
	  --set @UserRights = '1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72';

	  INSERT INTO hospital.tblHospitalUsers  
         (HospitalId, FirstName, MiddleName, LastName, UserTypeId, DepartmentId, DesignationId, UserCode
		 , LocationId, Area, Taluka, District, State, Pincode, AadhaarNo, RegistrationNo, UsgRegNo, DocSequenceNo, EduDegree, EduSpeciality, EmployeeTypeId, Password, LoginAccessTypeId
		 , IsUserActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, FontFamilyId , AditionalRegistrationNo,UserRights,Location, HouseBuilding)
		 
       VALUES (@HospitalId, @FirstName, @MiddleName, @LastName, @UserTypeId, @DepartmentId, @DesignationId, @UserCode
	   , @LocationId, @Area, @Taluka, @District, @State, @Pincode, @AadhaarNo, @RegistrationNo, @UsgRegNo, @DocSequenceNo, @EduDegree, @EduSpeciality, @EmployeeTypeId, @Password, @LoginAccessTypeId
	   , @IsUserActive, @IsEdited, GETDATE(), @UpdatedDate, @CreatedBy, @UpdatedBy, @FontFamilyId , @AditionRegistrationNo , @UserRights ,@Location , @HouseBuilding)  
      
	  
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

			If @v_Identity > 0
			Begin
				-- -- // Auto Generate UserCode for the New Employee
				-- Update hospital.tblHospitalUsers Set UserCode = 'EMP' + CONVERT(varchar(50),@v_Identity) Where UserId = @v_Identity

				insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy)
				values (13, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)

			End
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 


     
    ELSE IF @Command='UPDATE' 
    BEGIN 
		-- -- // Do not update the HospitalId, UserCode; It is onetime set only during adding new user (insert) process

		If @SubCommand='UpdatePassword'
		Begin
				If Exists (Select UserId from hospital.tblHospitalUsers with (nolock) where UserId=@UserId and Password=@Password)
				Begin
					UPDATE hospital.tblHospitalUsers 
					SET 
					Password=@EmailAddress				
					, IsEdited=@IsEdited         
					, UpdatedDate=GETDATE()        
					 Where UserId=@UserId and Password=@Password

					 IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @UserId, @v_Message='success',  @v_CustomMessage = 'Password updated successfully!'					
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Password update failed!'
					End 

				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message='Error',  @v_CustomMessage = 'Password update failed. Current Password was invalid. Please enter correct password!'
				End
		End

		Else If @SubCommand='UpdateUserPassword'
		Begin
				--If Exists (Select UserId from hospital.tblHospitalUsers with (nolock) where UserId=@UserId and Password=@Password)
				--Begin
					UPDATE hospital.tblHospitalUsers 
					SET 
					Password=@Password				
					, IsEdited=@IsEdited         
					, UpdatedDate=@UpdatedDate        
					 Where UserId=@UserId
					 --and Password=@Password

					 IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @UserId, @v_Message='success',  @v_CustomMessage = 'Password updated successfully!'					
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Password update failed!'
					End 

				--End
				--Else
				--Begin
				--	SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message='Error',  @v_CustomMessage = 'Password update failed. Current Password was invalid. Please enter correct password!'
				--End
		End

		Else If @SubCommand='UpdateUserRights'
		Begin
				If Exists (Select UserId from hospital.tblHospitalUsers with (nolock) where UserId=@UserId )
				Begin
					UPDATE hospital.tblHospitalUsers 
					SET 
					UserRights=@UserRights				
					, IsEdited=@IsEdited         
					, UpdatedDate=@UpdatedDate        
					 Where UserId=@UserId

					 IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @UserId, @v_Message='success',  @v_CustomMessage = 'Rights updated successfully!'					
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Rights update failed!'
					End 

				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message='Error',  @v_CustomMessage = 'Rights update failed. User not found!'
				End
		End
		Else
		Begin
			
			  UPDATE hospital.tblHospitalUsers 
			  SET 
				FirstName=@FirstName 
				, MiddleName=@MiddleName 
				, LastName=@LastName 
				--, HospitalId=@HospitalId 
				, UserTypeId=@UserTypeId 
				, DepartmentId=@DepartmentId 
				, DesignationId=@DesignationId 
			   -- , UserCode=@UserCode 
				, LocationId=@LocationId 
				, Area=@Area 
				, Taluka=@Taluka 
				, District=@District 
				, State=@State
				, Pincode=@Pincode
				, AadhaarNo=@AadhaarNo 
				, RegistrationNo=@RegistrationNo
				, UsgRegNo=@UsgRegNo
				, DocSequenceNo=@DocSequenceNo
				, EduDegree=@EduDegree 
				, EduSpeciality=@EduSpeciality 
				, EmployeeTypeId=@EmployeeTypeId
				, Password=@Password
				, LoginAccessTypeId=@LoginAccessTypeId
				, IsUserActive=@IsUserActive 
				, IsEdited=@IsEdited         
				, UpdatedDate=@UpdatedDate        
				, UpdatedBy=@UpdatedBy   
				--Jeet Chauhan New parameter
				, FontFamilyId = @FontFamilyId
				--Jeet Chauhan New parameter
				, AditionalRegistrationNo = @AditionRegistrationNo
				,Location = @Location
				,HouseBuilding = @HouseBuilding
				 WHERE UserId=@UserId     

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = @UserId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

					If Exists (Select ContactId from hospital.tblHospitalContacts with(nolock) Where ContactEntityRefId=@UserId And ContactEntityType=13)
					Begin
							-- -- // Update User Contact Information
							Update hospital.tblHospitalContacts 
							Set Phone = @Phone
							, LandLine = @LandLine
							, FaxNo = @FaxNo
							, EmailAddress = @EmailAddress
							, UpdatedDate = @UpdatedDate
							, UpdatedBy=@UpdatedBy
							, IsEdited=@IsEdited
							Where ContactEntityRefId=@UserId And ContactEntityType=13
					End
					Else
					Begin
							-- -- // Insert User Contact Information
							insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy)
							values (13, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy)
					End			
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = @UserId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End   
		End

                
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		
		If @SubCommand = 'SelectSingle'
		Begin
			SELECT hu.UserId, h.HospitalId, h.HospitalName, hu.FirstName, hu.MiddleName, hu.LastName
			, hu.UserTypeId, usertype.RecordName as UserType, hu.DepartmentId, dept.RecordName as Department, hu.DesignationId, desig.RecordName as Designation, hu.UserCode
			  , hu.LocationId, hu.Area, hu.Taluka, hu.District, hu.State, hu.Pincode
			  , hu.AadhaarNo, hu.RegistrationNo, hu.UsgRegNo, hu.DocSequenceNo
			  , hu.EduDegree, hu.EduSpeciality, hu.EmployeeTypeId, emptyp.RecordName as EmployeeType, Password, LoginAccessTypeId, accesstyp.RecordName as LoginAccessType, UserRights  
			  , hu.IsUserActive, hu.IsEdited, hu.EntryDate, hu.UpdatedDate, hu.CreatedBy, hu.UpdatedBy
			  , hc.Phone, hc.LandLine, hc.FaxNo, hc.EmailAddress, hc.ContactEntityType , FontFamilyId
			  , hu.Location , hu.HouseBuilding
			  ,AditionalRegistrationNo

			  FROM hospital.tblHospitalUsers hu with(nolock) 
			  --INNER JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
			  --INNER JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
			  --INNER JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
			  --INNER JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
			  --INNER JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
			  --INNER JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
			  --INNER JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13


			  LEFT JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
			  LEFT JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
			  LEFT JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
			  LEFT JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
			  LEFT JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
			  LEFT JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
			  LEFT JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13


			  WHERE UserId=@UserId
		End


		

		
		ELSE IF @SubCommand='GetAllList' 
		Begin
			
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' hu.IsUserActive in (1,0) '

			If @HospitalId > 1
				SET @WhereQry += ' and hu.HospitalId = ' + Convert(varchar, @HospitalId)

			--If @UserId > 0
			--	SET @WhereQry += ' and hu.UserId = ' + Convert(varchar, @UserId)
			
			--select @OfferStatus = Case When (@OfferStatus is null) Then 1 Else @OfferStatus End
				
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
						When 'FirstName'
						Then 'h.FirstName = ' + Convert(varchar, @SearchKey)							 						
						When 'FreeSearch'
						Then '(hu.FirstName like ''%' + @SearchKey + '%'' 
						Or hu.LastName like ''%' + @SearchKey + '%'' 
						Or hu.MiddleName like ''%' + @SearchKey + '%'' 
						Or hu.UserCode like ''%' + @SearchKey + '%'' 
						Or hu.Area like ''%' + @SearchKey + '%'' 						
						Or hu.Pincode like ''%'	+ @SearchKey + '%'' 
						Or hu.Taluka like ''%' + @SearchKey + '%'' 
						Or hu.District like ''%' + @SearchKey + '%'' 
						Or hu.State like ''%' + @SearchKey + '%'' 
						Or hc.Email like ''%' + @SearchKey + '%'' 
						Or hc.Phone like ''%' + @SearchKey + '%'')' 
						When 'UserType'
						Then 'usertype.RecordName=''' + @SearchKey + ''' AND hu.IsUserActive=1'
					 End
			End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UserId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct hu.UserId, ' + @SortBy + ' as SortBy
						 FROM hospital.tblHospitalUsers hu with(nolock) 
						  --INNER JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
						  --INNER JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
						  --INNER JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
						  --INNER JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
						  --INNER JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
						  --INNER JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
						  --INNER JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13
						  
						  LEFT JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
						  LEFT JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
						  LEFT JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
						  LEFT JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
						  LEFT JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
						  LEFT JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
						  LEFT JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13	

						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, hu.UserId, h.HospitalId, h.HospitalName, hu.FirstName, hu.MiddleName, hu.LastName
				, hu.UserTypeId, usertype.RecordName as UserType, hu.DepartmentId, dept.RecordName as Department, hu.DesignationId, desig.RecordName as Designation, hu.UserCode
				, hu.LocationId, hu.Area, hu.Taluka, hu.District, hu.State, hu.Pincode
				, hu.AadhaarNo, hu.RegistrationNo, hu.UsgRegNo, hu.DocSequenceNo
				, hu.EduDegree, hu.EduSpeciality, hu.EmployeeTypeId, emptyp.RecordName as EmployeeType, Password, LoginAccessTypeId, accesstyp.RecordName as LoginAccessType, UserRights   
				, hu.IsUserActive, hu.IsEdited, hu.EntryDate, hu.UpdatedDate, hu.CreatedBy, hu.UpdatedBy
				, hc.Phone, hc.LandLine, hc.FaxNo, hc.EmailAddress, hc.ContactEntityType
				, hu.Location , hu.HouseBuilding
				, hu.AditionalRegistrationNo ,
				--isnull(fontf.RecordName,''none'') as FontFamily				  
					isnull(temp2.RecordName,''auto'') as FontFamily,
					isnull(temp1.RecordName,''white'') as BGColour

				  From CTE 
				  --INNER JOIN hospital.tblHospitalUsers hu with(nolock) ON CTE.UserId=hu.UserId					 
				  --INNER JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
				  --INNER JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
				  --INNER JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
				  --INNER JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
				  --INNER JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
				  --INNER JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId


				  LEFT JOIN hospital.tblHospitalUsers hu with(nolock) ON CTE.UserId=hu.UserId					 
				  LEFT JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
				  LEFT JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
				  LEFT JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
				  LEFT JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
				  LEFT JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
				  LEFT JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId


				    --left JOIN common.tblEntityRecords fontf with(nolock) on hu.fontfamilyid = fontf.EntityRecordId

					  LEFT join hospital.tbl_UserTemplateSettings ut on ut.HospitalId = h.HospitalId
				LEFT join common.tblEntityRecords temp1 on ut.BGColour = temp1.EntityRecordId
				LEFT join common.tblEntityRecords temp2 on ut.FontFamily = temp2.EntityRecordId

				  INNER JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13
					
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
			
		 End
       
		ELSE If @SubCommand = 'SelectDoctorsList'
		Begin
			SELECT hu.UserId, h.HospitalId, h.HospitalName, hu.FirstName, hu.MiddleName, hu.LastName
			, hu.UserTypeId, usertype.RecordName as UserType, hu.DepartmentId, dept.RecordName as Department, hu.DesignationId, desig.RecordName as Designation, hu.UserCode,hu.Location
				, hu.LocationId, hu.Area, hu.Taluka, hu.District, hu.State, hu.Pincode
				, hu.AadhaarNo, hu.RegistrationNo, hu.UsgRegNo, hu.DocSequenceNo
				, hu.EduDegree, hu.EduSpeciality, hu.EmployeeTypeId, emptyp.RecordName as EmployeeType, Password, LoginAccessTypeId, accesstyp.RecordName as LoginAccessType, UserRights  
				, hu.IsUserActive, hu.IsEdited, hu.EntryDate, hu.UpdatedDate, hu.CreatedBy, hu.UpdatedBy
				, hc.Phone, hc.LandLine, hc.FaxNo, hc.EmailAddress, hc.ContactEntityType

				,'auto' as FontFamily, 'white' BGColour
				, hu.Location , hu.HouseBuilding
				, AditionalRegistrationNo
				FROM hospital.tblHospitalUsers hu with(nolock) 
				--INNER JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
				--INNER JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
				--INNER JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
				--INNER JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
				--INNER JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
				--INNER JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
				--INNER JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13

				LEFT JOIN hospital.tblHospital h with(nolock)  on hu.HospitalId = h.HospitalId
				LEFT JOIN common.tblEntityRecords usertype with(nolock) on hu.UserTypeId = usertype.EntityRecordId
				LEFT JOIN common.tblEntityRecords dept with(nolock) on hu.DepartmentId = dept.EntityRecordId
				LEFT JOIN common.tblEntityRecords desig with(nolock) on hu.DesignationId = desig.EntityRecordId
				LEFT JOIN common.tblEntityRecords emptyp with(nolock) on hu.EmployeeTypeId = emptyp.EntityRecordId
				LEFT JOIN common.tblEntityRecords accesstyp with(nolock) on hu.LoginAccessTypeId = accesstyp.EntityRecordId
				LEFT JOIN hospital.tblHospitalContacts hc with(nolock) on hu.UserId = hc.ContactEntityRefId and hc.ContactEntityType=13

				WHERE hu.HospitalId=@HospitalId and usertype.RecordName in ('Hospital Doctor' , 'Hospital Admin') ORDER BY hu.DocSequenceNo asc
		End	   

		ELSE IF @SubCommand = 'GetLatestCount'
		BEGIN
			DECLARE @CountHospital bigint = 0;
			SELECT @CountHospital = COUNT(HospitalId) from hospital.tblHospitalUsers where HospitalId = @HospitalId and UserTypeId = 4

			SELECT @CountHospital as TotalCount
		END


		ELSE IF @SubCommand = 'GetOTP'
		BEGIN
			Declare @OTP nvarchar(10) = 0;
			SELECT @OTP= (FLOOR(RAND() * (999999 - 100000 + 1)) + 100000 );

			IF isnull(@EmpId,'') <> ''
			BEGIN

				Declare @V_UserId bigint , @V_HospitalId bigint ;
				select top 1 @V_UserId = UserId from hospital.tblHospitalUsers where UserCode = @EmpId
				
				insert into hospital.tbl_UserVerification(EMPId , EmailId , OTP , userid , usercode)
				values (@EmpId , @EmailId , @OTP , @V_UserId , @EmpId)
			END

			select @OTP as OTP

		END


		ELSE IF @SubCommand = 'UpdatePassWord'
		BEGIN

			IF isnull(@EmpId,'') <> ''
			BEGIN

				Update hospital.tblHospitalUsers set Password = @Password where  UserCode = @EmpId
				
				select 'Password update successfully.' as UpdateMesage
				RETURN;
			END

			select 'No UserFound!' as UpdateMesage
			RETURN;

		END


    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tblHospitalUsers WHERE UserId=@UserId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UserId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UserSettings]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_UserSettings]  
   @Command varchar(200) 
  , @userSettingId bigint=NULL 
  , @UserCode nvarchar(200)=NULL 
  , @Setting nvarchar(200)=NULL 
  , @description nvarchar(MAX)=NULL 
  , @TabConfigFields nvarchar(MAX)=NULL 
  , @isActive bit=NULL 
  , @createdOn datetime=NULL 
  , @updatedOn datetime=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL,
  
  @UserId bigint = null,
  @Module nvarchar(200) = null,
  @FieldName nvarchar(200) = null,
  @DefaultValue nvarchar(500) = null,
  @Tabindex int = 0,
  @EmptyText nvarchar(500) = null,
  @inputType nvarchar(200) = null,
  @Validate BIT = 0,
  @HospitalId bigint = 0,
  @ModuleFormId nvarchar(200) = '',
  @Visited BIT = 0,
  @VisitedTabIndex int = 0,

  @CaseId bigint = 0,
  @VisitedId bigint = 0
  , @CStatus bit = 0
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 

		set @Setting = 'tab'

		declare @updateId bigint;

		IF @inputType like '%table%'
		BEGIN
			
			

			IF @FieldName like '%content%'
			BEGIN
				
				update common.tbl_UserSettingConfiguration set cstatus = 0  where  userId = @UserId and userCode = @UserCode and module = @Module and fieldName = '.content-onload'  
				   and Visited = @Visited

				update common.tbl_UserSettingConfiguration set cstatus = 1  where  userId = @UserId and userCode = @UserCode and module = @Module and fieldName = '.brand-onload' 
				   and Visited = @Visited

				   RETURN;
			END
			ELSE
			BEGIN
				update common.tbl_UserSettingConfiguration set cstatus = 1  where  userId = @UserId and userCode = @UserCode and module = @Module and fieldName = '.content-onload' 
				   and Visited = @Visited

				update common.tbl_UserSettingConfiguration set cstatus = 0  where  userId = @UserId and userCode = @UserCode and module = @Module and fieldName = '.brand-onload' 
				   and Visited = @Visited

				   RETURN;
			END

			

		END


		if exists (select top 1 id from common.tbl_UserSettingConfiguration with(nolock)
		           where userId = @UserId and userCode = @UserCode and module = @Module and fieldName = @FieldName 
				   and Visited = @Visited)
		BEGIN
				   set @updateId = (select top 1 id from common.tbl_UserSettingConfiguration with(nolock)
		           where userId = @UserId and userCode = @UserCode and module = @Module and fieldName = @FieldName
				   and Visited = @Visited) 
				
					IF (@Visited = 1)
					BEGIN
						set @VisitedTabIndex = @Tabindex
						set @Tabindex = 0
					END

				UPDATE common.tbl_UserSettingConfiguration
				SET 
					--userCode = @UserCode,
					module = @Module,
					fieldName = @FieldName,
					defaultValue = @DefaultValue,
					tabIndex = @TabIndex,
					emptyText = @EmptyText,
					setting = @Setting,
					inputType = @InputType,
					IsValid =  case when @inputType in ('button','checkbox','combo select','select','table') then 0 else  @Validate end ,
					hospitalId= @HospitalId,
					ModuleFormId = @ModuleFormId,
					Visited = @Visited,
					VisitedTabIndex = @VisitedTabIndex
					--fieldName = @FieldName
				WHERE 
					id = @updateId and HospitalId = @HospitalId
					
					--AND fieldName = @FieldName;


					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @updateId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @updateId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End             
		
					SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage



		END
		ELSE
		BEGIN

			IF (@Visited = 1)
			BEGIN
				set @VisitedTabIndex = @Tabindex
				set @Tabindex = 0
			END

			insert into common.tbl_UserSettingConfiguration
			(userId,userCode, module,fieldName,defaultValue,tabIndex,emptyText,setting,inputType,IsValid,hospitalId,ModuleFormId, Visited, VisitedTabIndex)
			values
			(@UserId,@UserCode,@Module,@FieldName,@DefaultValue, isnull(@Tabindex,0), @EmptyText, @Setting, @inputType,
			
			case when @inputType in ('button','checkbox','combo select','select','table') then 0 else  @Validate end
			
			,@HospitalId,@ModuleFormId,@Visited,ISNULL( @VisitedTabIndex,0))

					IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage


		END
        

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE hospital.tbl_UserSettings SET 
         UserCode=@UserCode 
        , Setting=@Setting 
        , description=@description 
        , TabConfigFields=@TabConfigFields 
        , isActive=@isActive 
        , createdOn=@createdOn 
        , updatedOn=@updatedOn 
		
         WHERE settingId = @userSettingId  
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @userSettingId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @userSettingId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
     IF @SubCommand = 'ALL'
	 begin
		
		declare @NumberOfVisits bigint = 0;
		
		select @CaseId = CaseId from patient.tblPatientVisits where VisitId= @VisitedId 
		select @NumberOfVisits = COUNT(VisitId) from patient.tblPatientVisits where CaseId = @CaseId
		print @VisitedId
		print @NumberOfVisits
		IF(@NumberOfVisits > 1 and @CaseId <> 0)
		BEGIN
			IF EXISTS(select id from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and module = @Module and cstatus = 1)
			BEGIN
				;with cte as (
		
					select * from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and  cstatus = 1
				) select 
				@UserId as UserId,
				@UserCode as UserCode,
				module as Module ,
				setting as Setting,
				inputType as InputType,
				isnull(defaultValue,'-') as DefaultValue,
				isnull(emptytext,'-') as placeHolder, 
				c.fieldName as Fields,
				f.FieldLabelName as Label,
				case when inputType in ('button','checkbox','combo select','select','table') then 0 else  isValid end as Validate,
				--IsValid as Validate,
				VisitedTabIndex as TabIndexes,
				c.ModuleFormId,
				HospitalId,
				Visited,
				CStatus,

				selectVal.RecordName as SelectName

				from cte c
				inner join common.tbl_ModuleFields f 
				on f.FieldName = c.fieldName 
				and f.ModuleFormId = c.ModuleFormId
				left join common.tblEntityRecords selectVal on selectVal.EntityRecordId = TRY_CAST(c.defaultValue as bigint)
				where userCode = @UserCode and HospitalId = @HospitalId
				and Visited = 1
				order by VisitedTabIndex asc
			END
			ELSE
			BEGIN
				set @UserCode = 'SA1'
				Set @UserId = 1
				set @UserCode = (select top 1 UserCode from hospital.tblHospitalUsers where UserId = 1)

				;with cte as (
		
					select * from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and  cstatus = 1
				) select 
				@UserId as UserId,
				@UserCode as UserCode,
				module as Module ,
				setting as Setting,
				inputType as InputType,
				isnull(defaultValue,'-') as DefaultValue,
				isnull(emptytext,'-') as placeHolder, 
				c.fieldName as Fields,
				f.FieldLabelName as Label,
				--IsValid as Validate,
				case when inputType in ('button','checkbox','combo select','select','table') then 0 else  isValid end as Validate,
				VisitedTabIndex as TabIndexes,
				c.ModuleFormId,
				HospitalId,
				Visited,
				CStatus,
				selectVal.RecordName as SelectName
				from cte c
				inner join common.tbl_ModuleFields f 
				on f.FieldName = c.fieldName 
				and f.ModuleFormId = c.ModuleFormId
				left join common.tblEntityRecords selectVal on selectVal.EntityRecordId = TRY_CAST(c.defaultValue as bigint)
				where userCode = @UserCode and HospitalId = @HospitalId
				and Visited = 1
				--and tabIndex != 0
				order by VisitedTabIndex asc
			END
		END
		ELSE -- IF This is the first Visit of a Patient
		BEGIN
			IF EXISTS(select id from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and module = @Module and  cstatus = 1)
			BEGIN
				;with cte as (
		
					select * from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and  cstatus = 1
				) select 
				@UserId as UserId,
				@UserCode as UserCode,
				module as Module ,
				setting as Setting,
				inputType as InputType,
				isnull(defaultValue,'-') as DefaultValue,
				isnull(emptytext,'-') as placeHolder, 
				c.fieldName as Fields,
				f.FieldLabelName as Label,
				--IsValid as Validate,
				case when inputType in ('button','checkbox','combo select','select','table') then 0 else  isValid end as Validate,
				tabIndex as TabIndexes,
				c.ModuleFormId,
				HospitalId,
				Visited,
				CStatus,
				selectVal.RecordName as SelectName
				from cte c
				inner join common.tbl_ModuleFields f 
				on f.FieldName = c.fieldName 
				and f.ModuleFormId = c.ModuleFormId
				left join common.tblEntityRecords selectVal on selectVal.EntityRecordId = TRY_CAST(c.defaultValue as bigint)
				where userCode = @UserCode and HospitalId = @HospitalId
				and Visited = 0
				order by tabindex asc
			END
			ELSE
			BEGIN
				set @UserCode = 'SA1'
				Set @UserId = 1
				set @UserCode = (select top 1 UserCode from hospital.tblHospitalUsers where UserId = 1)

				;with cte as (
		
					select * from common.tbl_UserSettingConfiguration where userCode = @UserCode and UserId =@UserId and  cstatus = 1
				) select 
				@UserId as UserId,
				@UserCode as UserCode,
				module as Module ,
				setting as Setting,
				inputType as InputType,
				isnull(defaultValue,'-') as DefaultValue,
				isnull(emptytext,'-') as placeHolder, 
				c.fieldName as Fields,
				f.FieldLabelName as Label,
				--IsValid as Validate,
				case when inputType in ('button','checkbox','combo select','select','table') then 0 else  isValid end as Validate,
				tabIndex as TabIndexes,
				c.ModuleFormId,
				HospitalId,
				Visited,
				CStatus,
				selectVal.RecordName as SelectName
				from cte c
				inner join common.tbl_ModuleFields f 
				on f.FieldName = c.fieldName 
				and f.ModuleFormId = c.ModuleFormId
				left join common.tblEntityRecords selectVal on selectVal.EntityRecordId = TRY_CAST(c.defaultValue as bigint)
				where userCode = @UserCode and HospitalId = @HospitalId
				and Visited = 0
				order by tabindex asc
			END
		END
		


		END
		ELSE  IF @SubCommand = 'Select Module'
		BEGIN
			--select distinct module from common.tbl_UserSettingConfiguration with(nolock)
			select distinct settingModules as module, moduleFormId as ModuleFormId from  common.tbl_SettingModules

		END

		ELSE  IF @SubCommand = 'Select Fields'
		BEGIN
			--select distinct module from common.tbl_UserSettingConfiguration with(nolock)
		
			--select ModuleName as Module, FieldName as Fields, FieldLabelName as FieldLabel,Type as InputType from common.tbl_ModuleFields where ModuleName = @Module
			set @Visited = 1;

			select 
				ModuleName as Module, 
				c.FieldName   as Fields, 
				--FieldLabelName + ' > ' + cast(tabIndex as nvarchar(max))  as FieldLabel,
				(
				 -- case 
					--when VisitedTabIndex = 0  then FieldLabelName + ' > ' + cast(tabIndex as nvarchar(max)) + ' First Visit'  
					--when tabIndex = 0  then FieldLabelName + ' > ' + cast(VisitedTabIndex as nvarchar(max)) + ' After First Visit'
					--ELSE FieldLabelName
				 -- end

				 CASE 
					WHEN VisitedTabIndex = 0 THEN 
						CASE 
							WHEN inputType LIKE 'table' THEN FieldLabelName  
							ELSE FieldLabelName + ' > ' + CAST(tabIndex AS NVARCHAR(MAX)) + ' First Visit'  
						END
					WHEN tabIndex = 0 THEN 
						FieldLabelName + ' > ' + CAST(VisitedTabIndex AS NVARCHAR(MAX)) + ' After First Visit'
					ELSE 
						FieldLabelName
				END

				)as FieldLAbel, 
				Type as InputType 
				from common.tbl_ModuleFields f
				inner join common.tbl_UserSettingConfiguration c on c.fieldName = f.FieldName and c.module = f.ModuleName
				where module = @Module and Visited = @Visited and f.isActive= 1 

				

				union 

				select 
				ModuleName as Module, 
				FieldName as Fields, 
				FieldLabelName as FieldLabel,
				Type as InputType 
				from common.tbl_ModuleFields f where ModuleName = @Module
				and FieldName not in (
				select 
				c.FieldName  
				from common.tbl_UserSettingConfiguration c 
				where module = @Module and Visited = @Visited 
				) and f.isActive = 1 
			


		END

		ELSE  IF @SubCommand = 'Select TabIndexes'
		BEGIN
			
			--select cast(tabIndex as nvarchar(max)) + ' > ' +  module + ' > ' + fieldName  as TabIndexes 
			--select cast(tabIndex as nvarchar(max)) + ' > ' + fieldName  as TabIndexes ,tabIndex as TabIndexId
			--from common.tbl_UserSettingConfiguration with(nolock) where userCode	= @UserCode
			--and 
			--(
			--	(isnull(@Module,'') = '' and 1 = 1)
			--	or
			--	(module = @Module)
			--)
			--order by tabIndex asc

		if(@Visited = 1)
		BEGIN
			select VisitedTabIndex as TabIndexId,
			isnull(defaultValue,'') DefaultValue, isnull(emptyText ,'')as EmptyText,
			cStatus
			,
			(
				select cStatus from common.tbl_UserSettingConfiguration where userCode = @UserCode and inputType = 'table' and fieldName like '%brand%'
			) as IsBrandNameSelected
			from common.tbl_UserSettingConfiguration with(nolock) where userCode = @UserCode 
			and 
			(
				(isnull(@Module,'') = '' and 1 = 1)
				or
				(module = @Module)
			)
			and fieldName = @FieldName
			order by VisitedTabIndex asc
		END
		ELSE 
		BEGIN
			select tabIndex as TabIndexId,
			isnull(defaultValue,'') DefaultValue, isnull(emptyText ,'')as EmptyText,
			cStatus,
			--,case when fieldName like '%content%' then 0 else 1 end as IsBrandNameSelected

			(
				select cStatus from common.tbl_UserSettingConfiguration where userCode = @UserCode and inputType = 'table' and fieldName like '%brand%'
			) as IsBrandNameSelected

			from common.tbl_UserSettingConfiguration with(nolock) where userCode = @UserCode 
			and 
			(
				(isnull(@Module,'') = '' and 1 = 1)
				or
				(module = @Module)
			)
			and fieldName = @FieldName
			order by tabIndex asc
		END

		END

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tbl_UserSettings WHERE settingId=@userSettingId
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @userSettingId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_UsgDetails]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @UsgId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @RefByDoc nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @PerformingDocName nvarchar(200)=NULL 
  , @ConsentDate date=NULL 
  , @ProcedureDate date=NULL 
  , @PDPResultConveyedTo nvarchar(200)=NULL 
  , @SonographyDate date=NULL 
  , @MTPIndication nvarchar(2000)=NULL 
  , @MTPDone nvarchar(20)=NULL 
  , @UsgImageNo int=NULL 
  , @SonographyResult nvarchar(2000)=NULL 
  , @OtherSpecify nvarchar(2000)=NULL
  , @ChildrenCount int=NULL
  , @ChildrenDetails nvarchar(MAX)=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='UsgId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @USGUterusWeeks int=NULL 
  , @USGLMPDate date=NULL
  , @USGDiagnosis nvarchar(2000)=NULL
  , @IndicationsForDiagnostic nvarchar(2000)=NULL

  ,@SonographyResult2 nvarchar(500) = null

  , @isMisMatchSrNos bit = 0

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int
	   , @V_IdentityNew bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblUsgDetails where year(entrydate)=year(GETDATE())

		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblUsgDetails  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic, RefByDoc, VillageCity, Taluka, District, PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo, SonographyDate
		 , MTPIndication, MTPDone, UsgImageNo, SonographyResult, OtherSpecify, ChildrenCount, ChildrenDetails, Remark, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, SonographyResult2 ,  isMisMatchSrNos) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @USGUterusWeeks, @USGLMPDate, @USGDiagnosis, @IndicationsForDiagnostic, @RefByDoc, @VillageCity, @Taluka, @District, @PerformingDocName, @ConsentDate, @ProcedureDate, @PDPResultConveyedTo, @SonographyDate
	   , @MTPIndication, @MTPDone, @UsgImageNo, @SonographyResult, @OtherSpecify, @ChildrenCount, @ChildrenDetails, @Remark, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @SonographyResult2 , @isMisMatchSrNos)   
        
		set  @V_IdentityNew = SCOPE_IDENTITY();

		--// // ===================== new change of auto insert mtp

		IF (@MTPDone = 'yes' )
		BEGIN
		 IF not exists ( select top 1 MTPId from  patient.tblMTP where PatientId = @PatientId and VisitId = @VisitId and CaseId = @CaseId)
		 BEGIN

			declare @v_SrNoAccMonth_MTP int, @v_SrNoAccYear_MTP int , @SrNoAccMonth_MTP int , @SrNoAccYear_MTP int;

			select @v_SrNoAccMonth_MTP = max(SrNoAccMonth) from patient.tblMTP where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
			select @v_SrNoAccYear_MTP = max(SrNoAccYear) from patient.tblMTP where year(entrydate)=year(GETDATE())
				
			Select @SrNoAccMonth_MTP = ISNULL(@v_SrNoAccMonth_MTP,0)+1, @SrNoAccYear_MTP=ISNULL(@v_SrNoAccYear_MTP,0)+1

			declare @MtpUTWeeks bigint , @LiveMaleFemale nvarchar(100);

			set @MtpUTWeeks = (select top 1 UterusWeeks from patient.tblPatientVisits where VisitId = @VisitId and CaseId = @CaseId and PatientId = @PatientId)

			declare @livemales int, @liveFemales int;

			select 
				@livemales = sum(FTLSCS_LiveM + FTNDS_LiveM),
				@liveFemales = sum(FTLSCS_LiveF + FTNDS_LiveF)
			from 
				patient.tblPatientVisits
			where 
				VisitId = @VisitId and 
				CaseId = @CaseId and 
				PatientId = @PatientId;

			set @LiveMaleFemale = CAST(@livemales as nvarchar(10)) + '/' + CAST(@liveFemales as nvarchar(10));

		  INSERT INTO patient.tblMTP  
			 (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, LiveMaleFemale, ReligionRefId,MtpReasonRefId,Contraception,MtpComplicationRefId,
			  IsEdited, EntryDate, CreatedBy, UpdatedBy) 
		   VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth_MTP, @SrNoAccYear_MTP, @MtpUTWeeks, @LiveMaleFemale,136,139,'No',142,
			 1, GETDATE(), @CreatedBy, @UpdatedBy)   

		 END

			

		END

		
		 
		 --// // ===================== new change of auto insert mtp

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @V_IdentityNew, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgDetails 
	  SET  SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
	  , RefByDoc=@RefByDoc 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , PerformingDocName=@PerformingDocName 
        , ConsentDate=@ConsentDate 
        , ProcedureDate=@ProcedureDate 
        , PDPResultConveyedTo=@PDPResultConveyedTo 
        , SonographyDate=@SonographyDate 
        , MTPIndication=@MTPIndication 
        , MTPDone=@MTPDone 
        , UsgImageNo=@UsgImageNo 
        , SonographyResult=@SonographyResult
		, OtherSpecify = @OtherSpecify
		, ChildrenCount= @ChildrenCount
        , ChildrenDetails=@ChildrenDetails 
        , Remark=@Remark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,SonographyResult2 = @SonographyResult2

		,isMisMatchSrNos = @isMisMatchSrNos
         WHERE UsgId=@UsgId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @UsgId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

	
		--declare @Strusglmpdate nvarchar(max) = '', @Stropddate nvarchar(max) = ''

		--select @CaseId = CaseId, @PatientId= PatientId, @VisitId = VisitId from patient.tblUsgDetails where UsgId  = 74

		--select @Strusglmpdate=USGLMPDate from patient.tblUsgDetails where PatientId = @PatientId and CaseId= @CaseId and VisitId = @VisitId
		--select @Stropddate=OpdDate from patient.tblPatientVisits  where PatientId = @PatientId and CaseId= @CaseId and VisitId = @VisitId

		--select @Stropddate

		--select @Strusglmpdate

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount,
			  
			  --ChildrenDetails, 
			
			(SELECT 
							childrenNo,
							genderType,
							-- Calculate the birth date by subtracting the years and months from today's date
  --  DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())) AS BirthDate,
    
    -- Calculate the age dynamically as of today
      CASE 
        WHEN DATEADD(YEAR, DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()),
                     DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))) > GETDATE()
        THEN DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()) - 1
        ELSE DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE())
    END AS year,
    
    -- Calculate the remaining months
    (DATEDIFF(MONTH, DATEADD(YEAR, -DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()), 
                    DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))), GETDATE())) % 12 AS month
							FROM OPENJSON(ChildrenDetails)
							WITH (
								childrenNo NVARCHAR(50) '$.childrenNo',
								genderType NVARCHAR(50) '$.genderType',
								year NVARCHAR(10) '$.year',
								month NVARCHAR(10) '$.month'
								)
								FOR JSON PATH
							) 
						
						AS ChildrenDetails,
			
					
				
						--(
						--	SELECT 
						--	childrenNo,
						--	genderType,
						--	CAST(((CAST(year AS INT) * 12 + CAST(month AS INT)) + 6) / 12 AS NVARCHAR) AS year,
						--	CAST(((CAST(year AS INT) * 12 + CAST(month AS INT)) + 6) % 12 AS NVARCHAR) AS month
						--	FROM OPENJSON(ChildrenDetails)
						--	WITH (
						--		childrenNo NVARCHAR(50) '$.childrenNo',
						--		genderType NVARCHAR(50) '$.genderType',
						--		year NVARCHAR(10) '$.year',
						--		month NVARCHAR(10) '$.month'
						--		)
						--		FOR JSON PATH
						--	) 
						
						--AS ChildrenDetails, 


			  
			  Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2 , isMisMatchSrNos as IsMisMatchSrNos
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@UsgId 
		End

		ELSE IF @SubCommand = 'SelectPreviousVisitData'
		BEGIN

		declare @selectedusgId bigint = (select top 1 UsgId from patient.tblUsgDetails where PatientId = @PatientId order by EntryDate desc)

			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount,
						(SELECT 
							childrenNo,
							genderType,
							-- Calculate the birth date by subtracting the years and months from today's date
  --  DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())) AS BirthDate,
    
    -- Calculate the age dynamically as of today
      CASE 
        WHEN DATEADD(YEAR, DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()),
                     DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))) > GETDATE()
        THEN DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()) - 1
        ELSE DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE())
    END AS year,
    
    -- Calculate the remaining months
    (DATEDIFF(MONTH, DATEADD(YEAR, -DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()), 
                    DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))), GETDATE())) % 12 AS month
							FROM OPENJSON(ChildrenDetails)
							WITH (
								childrenNo NVARCHAR(50) '$.childrenNo',
								genderType NVARCHAR(50) '$.genderType',
								year NVARCHAR(10) '$.year',
								month NVARCHAR(10) '$.month'
								)
								FOR JSON PATH
							) 
						
						AS ChildrenDetails,
			  Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2 , isMisMatchSrNos as IsMisMatchSrNos
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@selectedusgId 
		END
		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usg.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usg.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			SET @WhereQry = '1=1'

			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usg.SonographyDate >= ''' + @FromDate + ''' AND usg.SonographyDate <= ''' + @ToDate + ''')' 	
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UsgId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usg.UsgId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgDetails usg with(nolock) 
						  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry 
						
						+ ' -- And pc.caseId = '+ cast(@CaseId as nvarchar(70)) +'
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usg.UsgId, usg.PatientId, usg.CaseId, usg.VisitId
				, SrNoAccMonth, SrNoAccYear
				, usg.USGUterusWeeks, usg.USGLMPDate, usg.USGDiagnosis, usg.IndicationsForDiagnostic
				, usg.RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName
				, usg.ConsentDate, usg.ProcedureDate
				, usg.PDPResultConveyedTo
			    , usg.SonographyDate
				, usg.MTPIndication
				
				--, mtd.RecordName as MTPIndicationText
				
				,case when isnull(mtd.RecordName,'''') = '''' and isnull(mtd.RecordName,'''') = '''' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText

				, usg.MTPDone
				, usg.UsgImageNo
				--, usg.SonographyResult, result.RecordName as SonographyResultText
				, usg.SonographyResult, SonographyResult as SonographyResultText
				, usg.OtherSpecify, other.RecordName as OtherSpecifyText
				, usg.ChildrenCount
				, usg.ChildrenDetails
				, usg.Remark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo as PatientHouseNo, pc.Society as PatientSociety, pc.Area as PatientArea, pc.Landmark as PatientLandmark, pc.VillageCity as PatientVillageCity
				, pc.Taluka as PatientTaluka, pc.District as PatientDistrict, pc.State as PatientState, pc.PinCode as PatientPinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy
				, SonographyResult2
				, isMisMatchSrNos as IsMisMatchSrNos
				  From CTE 
				  INNER JOIN patient.tblUsgDetails usg with(nolock) ON CTE.UsgId=usg.UsgId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId 
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId and usg.CaseId=pc.CaseId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId

				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
				 -- where pc.CaseId = '+ CAST(@CaseId as nvarchar(70)) +'

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 

		End

		ELSE If @SubCommand = 'ValidateYearAndMonth'
		Begin

			declare @srnoAccMonth11 bigint = 0, @srnoAccYear11 bigint = 0
			declare @srnoAccMonth22 bigint = 0, @srnoAccYear22 bigint = 0

			--select @srnoAccMonth11 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			--select @srnoAccYear11 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())

			
			--select @srnoAccMonth22 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())
			--select @srnoAccYear22 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			--select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
			--		(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 


			
			select @srnoAccMonth11 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			select @srnoAccMonth22 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())

			select @srnoAccYear11 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())
			select @srnoAccYear22 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			 

				select case when @srnoAccMonth11 = @srnoAccMonth22 then 'true' else 'false' end as MonthVlidate 
					 , case when @srnoAccYear11 = @srnoAccYear22 then 'true' else 'false' end as YearValidate

       END
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgDetails WHERE UsgId=@UsgId 

	  IF @SubCommand = 'DeleteFromUsgId'
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE UsgId = @UsgId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE VisitId = @VisitId
	  END


	
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_04032025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_UsgDetails_04032025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @UsgId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @RefByDoc nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @PerformingDocName nvarchar(200)=NULL 
  , @ConsentDate date=NULL 
  , @ProcedureDate date=NULL 
  , @PDPResultConveyedTo nvarchar(200)=NULL 
  , @SonographyDate date=NULL 
  , @MTPIndication nvarchar(2000)=NULL 
  , @MTPDone nvarchar(20)=NULL 
  , @UsgImageNo int=NULL 
  , @SonographyResult nvarchar(2000)=NULL 
  , @OtherSpecify nvarchar(2000)=NULL
  , @ChildrenCount int=NULL
  , @ChildrenDetails nvarchar(MAX)=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='UsgId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @USGUterusWeeks int=NULL 
  , @USGLMPDate date=NULL
  , @USGDiagnosis nvarchar(2000)=NULL
  , @IndicationsForDiagnostic nvarchar(2000)=NULL

  ,@SonographyResult2 nvarchar(500) = null

  , @isMisMatchSrNos bit = 0

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int
  
    IF @Command='INSERT' 
    BEGIN 
		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblUsgDetails where year(entrydate)=year(GETDATE())

		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblUsgDetails  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic, RefByDoc, VillageCity, Taluka, District, PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo, SonographyDate
		 , MTPIndication, MTPDone, UsgImageNo, SonographyResult, OtherSpecify, ChildrenCount, ChildrenDetails, Remark, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, SonographyResult2 ,  isMisMatchSrNos) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @USGUterusWeeks, @USGLMPDate, @USGDiagnosis, @IndicationsForDiagnostic, @RefByDoc, @VillageCity, @Taluka, @District, @PerformingDocName, @ConsentDate, @ProcedureDate, @PDPResultConveyedTo, @SonographyDate
	   , @MTPIndication, @MTPDone, @UsgImageNo, @SonographyResult, @OtherSpecify, @ChildrenCount, @ChildrenDetails, @Remark, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @SonographyResult2 , @isMisMatchSrNos)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgDetails 
	  SET  SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
	  , RefByDoc=@RefByDoc 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , PerformingDocName=@PerformingDocName 
        , ConsentDate=@ConsentDate 
        , ProcedureDate=@ProcedureDate 
        , PDPResultConveyedTo=@PDPResultConveyedTo 
        , SonographyDate=@SonographyDate 
        , MTPIndication=@MTPIndication 
        , MTPDone=@MTPDone 
        , UsgImageNo=@UsgImageNo 
        , SonographyResult=@SonographyResult
		, OtherSpecify = @OtherSpecify
		, ChildrenCount= @ChildrenCount
        , ChildrenDetails=@ChildrenDetails 
        , Remark=@Remark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,SonographyResult2 = @SonographyResult2

		,isMisMatchSrNos = @isMisMatchSrNos
         WHERE UsgId=@UsgId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @UsgId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount, ChildrenDetails, Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2 , isMisMatchSrNos as IsMisMatchSrNos
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@UsgId 
		End

		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usg.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usg.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usg.SonographyDate >= ''' + @FromDate + ''' AND usg.SonographyDate <= ''' + @ToDate + ''')' 	
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UsgId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usg.UsgId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgDetails usg with(nolock) 
						  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' And pc.caseId = '+ cast(@CaseId as nvarchar(70)) +'
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usg.UsgId, usg.PatientId, usg.CaseId, usg.VisitId
				, SrNoAccMonth, SrNoAccYear
				, usg.USGUterusWeeks, usg.USGLMPDate, usg.USGDiagnosis, usg.IndicationsForDiagnostic
				, usg.RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName
				, usg.ConsentDate, usg.ProcedureDate
				, usg.PDPResultConveyedTo
			    , usg.SonographyDate
				, usg.MTPIndication
				
				--, mtd.RecordName as MTPIndicationText
				
				,case when isnull(mtd.RecordName,'''') = '''' and isnull(mtd.RecordName,'''') = '''' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText

				, usg.MTPDone
				, usg.UsgImageNo
				--, usg.SonographyResult, result.RecordName as SonographyResultText
				, usg.SonographyResult, SonographyResult as SonographyResultText
				, usg.OtherSpecify, other.RecordName as OtherSpecifyText
				, usg.ChildrenCount
				, usg.ChildrenDetails
				, usg.Remark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo as PatientHouseNo, pc.Society as PatientSociety, pc.Area as PatientArea, pc.Landmark as PatientLandmark, pc.VillageCity as PatientVillageCity
				, pc.Taluka as PatientTaluka, pc.District as PatientDistrict, pc.State as PatientState, pc.PinCode as PatientPinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy
				, SonographyResult2
				, isMisMatchSrNos as IsMisMatchSrNos
				  From CTE 
				  INNER JOIN patient.tblUsgDetails usg with(nolock) ON CTE.UsgId=usg.UsgId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId

				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
				  where pc.CaseId = '+ CAST(@CaseId as nvarchar(70)) +'

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 

		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgDetails WHERE UsgId=@UsgId 

	  IF @SubCommand = 'DeleteFromUsgId'
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE UsgId = @UsgId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE VisitId = @VisitId
	  END


	
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_14032025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_UsgDetails_14032025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @UsgId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @RefByDoc nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @PerformingDocName nvarchar(200)=NULL 
  , @ConsentDate date=NULL 
  , @ProcedureDate date=NULL 
  , @PDPResultConveyedTo nvarchar(200)=NULL 
  , @SonographyDate date=NULL 
  , @MTPIndication nvarchar(2000)=NULL 
  , @MTPDone nvarchar(20)=NULL 
  , @UsgImageNo int=NULL 
  , @SonographyResult nvarchar(2000)=NULL 
  , @OtherSpecify nvarchar(2000)=NULL
  , @ChildrenCount int=NULL
  , @ChildrenDetails nvarchar(MAX)=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='UsgId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @USGUterusWeeks int=NULL 
  , @USGLMPDate date=NULL
  , @USGDiagnosis nvarchar(2000)=NULL
  , @IndicationsForDiagnostic nvarchar(2000)=NULL

  ,@SonographyResult2 nvarchar(500) = null

  , @isMisMatchSrNos bit = 0

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int
	   , @V_IdentityNew bigint = 0;
  
    IF @Command='INSERT' 
    BEGIN 
		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblUsgDetails where year(entrydate)=year(GETDATE())

		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblUsgDetails  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic, RefByDoc, VillageCity, Taluka, District, PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo, SonographyDate
		 , MTPIndication, MTPDone, UsgImageNo, SonographyResult, OtherSpecify, ChildrenCount, ChildrenDetails, Remark, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, SonographyResult2 ,  isMisMatchSrNos) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @USGUterusWeeks, @USGLMPDate, @USGDiagnosis, @IndicationsForDiagnostic, @RefByDoc, @VillageCity, @Taluka, @District, @PerformingDocName, @ConsentDate, @ProcedureDate, @PDPResultConveyedTo, @SonographyDate
	   , @MTPIndication, @MTPDone, @UsgImageNo, @SonographyResult, @OtherSpecify, @ChildrenCount, @ChildrenDetails, @Remark, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @SonographyResult2 , @isMisMatchSrNos)   
        
		set  @V_IdentityNew = SCOPE_IDENTITY();

		--// // ===================== new change of auto insert mtp

		IF (@MTPDone = 'yes' )
		BEGIN
		 IF not exists ( select top 1 MTPId from  patient.tblMTP where PatientId = @PatientId and VisitId = @VisitId and CaseId = @CaseId)
		 BEGIN

			declare @v_SrNoAccMonth_MTP int, @v_SrNoAccYear_MTP int , @SrNoAccMonth_MTP int , @SrNoAccYear_MTP int;

			select @v_SrNoAccMonth_MTP = max(SrNoAccMonth) from patient.tblMTP where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
			select @v_SrNoAccYear_MTP = max(SrNoAccYear) from patient.tblMTP where year(entrydate)=year(GETDATE())
				
			Select @SrNoAccMonth_MTP = ISNULL(@v_SrNoAccMonth_MTP,0)+1, @SrNoAccYear_MTP=ISNULL(@v_SrNoAccYear_MTP,0)+1

			declare @MtpUTWeeks bigint , @LiveMaleFemale nvarchar(100);

			set @MtpUTWeeks = (select top 1 UterusWeeks from patient.tblPatientVisits where VisitId = @VisitId and CaseId = @CaseId and PatientId = @PatientId)

			declare @livemales int, @liveFemales int;

			select 
				@livemales = sum(FTLSCS_LiveM + FTNDS_LiveM),
				@liveFemales = sum(FTLSCS_LiveF + FTNDS_LiveF)
			from 
				patient.tblPatientVisits
			where 
				VisitId = @VisitId and 
				CaseId = @CaseId and 
				PatientId = @PatientId;

			set @LiveMaleFemale = CAST(@livemales as nvarchar(10)) + '/' + CAST(@liveFemales as nvarchar(10));

		  INSERT INTO patient.tblMTP  
			 (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, MtpUTWeeks, LiveMaleFemale, ReligionRefId,MtpReasonRefId,Contraception,MtpComplicationRefId,
			  IsEdited, EntryDate, CreatedBy, UpdatedBy) 
		   VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth_MTP, @SrNoAccYear_MTP, @MtpUTWeeks, @LiveMaleFemale,136,139,'No',142,
			 1, GETDATE(), @CreatedBy, @UpdatedBy)   

		 END

			

		END

		
		 
		 --// // ===================== new change of auto insert mtp

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @V_IdentityNew, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgDetails 
	  SET  SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
	  , RefByDoc=@RefByDoc 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , PerformingDocName=@PerformingDocName 
        , ConsentDate=@ConsentDate 
        , ProcedureDate=@ProcedureDate 
        , PDPResultConveyedTo=@PDPResultConveyedTo 
        , SonographyDate=@SonographyDate 
        , MTPIndication=@MTPIndication 
        , MTPDone=@MTPDone 
        , UsgImageNo=@UsgImageNo 
        , SonographyResult=@SonographyResult
		, OtherSpecify = @OtherSpecify
		, ChildrenCount= @ChildrenCount
        , ChildrenDetails=@ChildrenDetails 
        , Remark=@Remark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,SonographyResult2 = @SonographyResult2

		,isMisMatchSrNos = @isMisMatchSrNos
         WHERE UsgId=@UsgId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @UsgId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

	
		--declare @Strusglmpdate nvarchar(max) = '', @Stropddate nvarchar(max) = ''

		--select @CaseId = CaseId, @PatientId= PatientId, @VisitId = VisitId from patient.tblUsgDetails where UsgId  = 74

		--select @Strusglmpdate=USGLMPDate from patient.tblUsgDetails where PatientId = @PatientId and CaseId= @CaseId and VisitId = @VisitId
		--select @Stropddate=OpdDate from patient.tblPatientVisits  where PatientId = @PatientId and CaseId= @CaseId and VisitId = @VisitId

		--select @Stropddate

		--select @Strusglmpdate

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount,
			  
			  --ChildrenDetails, 
			
			(SELECT 
							childrenNo,
							genderType,
							-- Calculate the birth date by subtracting the years and months from today's date
  --  DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())) AS BirthDate,
    
    -- Calculate the age dynamically as of today
      CASE 
        WHEN DATEADD(YEAR, DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()),
                     DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))) > GETDATE()
        THEN DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()) - 1
        ELSE DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE())
    END AS year,
    
    -- Calculate the remaining months
    (DATEDIFF(MONTH, DATEADD(YEAR, -DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()), 
                    DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))), GETDATE())) % 12 AS month
							FROM OPENJSON(ChildrenDetails)
							WITH (
								childrenNo NVARCHAR(50) '$.childrenNo',
								genderType NVARCHAR(50) '$.genderType',
								year NVARCHAR(10) '$.year',
								month NVARCHAR(10) '$.month'
								)
								FOR JSON PATH
							) 
						
						AS ChildrenDetails,
			
					
				
						--(
						--	SELECT 
						--	childrenNo,
						--	genderType,
						--	CAST(((CAST(year AS INT) * 12 + CAST(month AS INT)) + 6) / 12 AS NVARCHAR) AS year,
						--	CAST(((CAST(year AS INT) * 12 + CAST(month AS INT)) + 6) % 12 AS NVARCHAR) AS month
						--	FROM OPENJSON(ChildrenDetails)
						--	WITH (
						--		childrenNo NVARCHAR(50) '$.childrenNo',
						--		genderType NVARCHAR(50) '$.genderType',
						--		year NVARCHAR(10) '$.year',
						--		month NVARCHAR(10) '$.month'
						--		)
						--		FOR JSON PATH
						--	) 
						
						--AS ChildrenDetails, 


			  
			  Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2 , isMisMatchSrNos as IsMisMatchSrNos
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@UsgId 
		End

		ELSE IF @SubCommand = 'SelectPreviousVisitData'
		BEGIN

		declare @selectedusgId bigint = (select top 1 UsgId from patient.tblUsgDetails where PatientId = @PatientId order by EntryDate desc)

			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount,
						(SELECT 
							childrenNo,
							genderType,
							-- Calculate the birth date by subtracting the years and months from today's date
  --  DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())) AS BirthDate,
    
    -- Calculate the age dynamically as of today
      CASE 
        WHEN DATEADD(YEAR, DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()),
                     DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))) > GETDATE()
        THEN DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()) - 1
        ELSE DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE())
    END AS year,
    
    -- Calculate the remaining months
    (DATEDIFF(MONTH, DATEADD(YEAR, -DATEDIFF(YEAR, DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE())), GETDATE()), 
                    DATEADD(MONTH, -CAST(month AS INT), DATEADD(YEAR, -CAST(year AS INT), GETDATE()))), GETDATE())) % 12 AS month
							FROM OPENJSON(ChildrenDetails)
							WITH (
								childrenNo NVARCHAR(50) '$.childrenNo',
								genderType NVARCHAR(50) '$.genderType',
								year NVARCHAR(10) '$.year',
								month NVARCHAR(10) '$.month'
								)
								FOR JSON PATH
							) 
						
						AS ChildrenDetails,
			  Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2 , isMisMatchSrNos as IsMisMatchSrNos
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@selectedusgId 
		END
		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usg.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usg.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usg.SonographyDate >= ''' + @FromDate + ''' AND usg.SonographyDate <= ''' + @ToDate + ''')' 	
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UsgId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usg.UsgId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgDetails usg with(nolock) 
						  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' And pc.caseId = '+ cast(@CaseId as nvarchar(70)) +'
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usg.UsgId, usg.PatientId, usg.CaseId, usg.VisitId
				, SrNoAccMonth, SrNoAccYear
				, usg.USGUterusWeeks, usg.USGLMPDate, usg.USGDiagnosis, usg.IndicationsForDiagnostic
				, usg.RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName
				, usg.ConsentDate, usg.ProcedureDate
				, usg.PDPResultConveyedTo
			    , usg.SonographyDate
				, usg.MTPIndication
				
				--, mtd.RecordName as MTPIndicationText
				
				,case when isnull(mtd.RecordName,'''') = '''' and isnull(mtd.RecordName,'''') = '''' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText

				, usg.MTPDone
				, usg.UsgImageNo
				--, usg.SonographyResult, result.RecordName as SonographyResultText
				, usg.SonographyResult, SonographyResult as SonographyResultText
				, usg.OtherSpecify, other.RecordName as OtherSpecifyText
				, usg.ChildrenCount
				, usg.ChildrenDetails
				, usg.Remark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo as PatientHouseNo, pc.Society as PatientSociety, pc.Area as PatientArea, pc.Landmark as PatientLandmark, pc.VillageCity as PatientVillageCity
				, pc.Taluka as PatientTaluka, pc.District as PatientDistrict, pc.State as PatientState, pc.PinCode as PatientPinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy
				, SonographyResult2
				, isMisMatchSrNos as IsMisMatchSrNos
				  From CTE 
				  INNER JOIN patient.tblUsgDetails usg with(nolock) ON CTE.UsgId=usg.UsgId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId

				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
				  where pc.CaseId = '+ CAST(@CaseId as nvarchar(70)) +'

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 

		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgDetails WHERE UsgId=@UsgId 

	  IF @SubCommand = 'DeleteFromUsgId'
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE UsgId = @UsgId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE VisitId = @VisitId
	  END


	
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_19022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_UsgDetails_19022025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @UsgId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @RefByDoc nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @PerformingDocName nvarchar(200)=NULL 
  , @ConsentDate date=NULL 
  , @ProcedureDate date=NULL 
  , @PDPResultConveyedTo nvarchar(200)=NULL 
  , @SonographyDate date=NULL 
  , @MTPIndication nvarchar(2000)=NULL 
  , @MTPDone nvarchar(20)=NULL 
  , @UsgImageNo int=NULL 
  , @SonographyResult nvarchar(2000)=NULL 
  , @OtherSpecify nvarchar(2000)=NULL
  , @ChildrenCount int=NULL
  , @ChildrenDetails nvarchar(MAX)=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='UsgId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @USGUterusWeeks int=NULL 
  , @USGLMPDate date=NULL
  , @USGDiagnosis nvarchar(2000)=NULL
  , @IndicationsForDiagnostic nvarchar(2000)=NULL

  ,@SonographyResult2 nvarchar(500) = null

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int
  
    IF @Command='INSERT' 
    BEGIN 
		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblUsgDetails where year(entrydate)=year(GETDATE())

		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblUsgDetails  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic, RefByDoc, VillageCity, Taluka, District, PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo, SonographyDate
		 , MTPIndication, MTPDone, UsgImageNo, SonographyResult, OtherSpecify, ChildrenCount, ChildrenDetails, Remark, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, SonographyResult2) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @USGUterusWeeks, @USGLMPDate, @USGDiagnosis, @IndicationsForDiagnostic, @RefByDoc, @VillageCity, @Taluka, @District, @PerformingDocName, @ConsentDate, @ProcedureDate, @PDPResultConveyedTo, @SonographyDate
	   , @MTPIndication, @MTPDone, @UsgImageNo, @SonographyResult, @OtherSpecify, @ChildrenCount, @ChildrenDetails, @Remark, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @SonographyResult2)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgDetails 
	  SET  SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
	  , RefByDoc=@RefByDoc 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , PerformingDocName=@PerformingDocName 
        , ConsentDate=@ConsentDate 
        , ProcedureDate=@ProcedureDate 
        , PDPResultConveyedTo=@PDPResultConveyedTo 
        , SonographyDate=@SonographyDate 
        , MTPIndication=@MTPIndication 
        , MTPDone=@MTPDone 
        , UsgImageNo=@UsgImageNo 
        , SonographyResult=@SonographyResult
		, OtherSpecify = @OtherSpecify
		, ChildrenCount= @ChildrenCount
        , ChildrenDetails=@ChildrenDetails 
        , Remark=@Remark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,SonographyResult2 = @SonographyResult2

         WHERE UsgId=@UsgId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @UsgId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount, ChildrenDetails, Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@UsgId 
		End

		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usg.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usg.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usg.SonographyDate >= ''' + @FromDate + ''' AND usg.SonographyDate <= ''' + @ToDate + ''')' 	
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UsgId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usg.UsgId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgDetails usg with(nolock) 
						  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usg.UsgId, usg.PatientId, usg.CaseId, usg.VisitId
				, SrNoAccMonth, SrNoAccYear
				, usg.USGUterusWeeks, usg.USGLMPDate, usg.USGDiagnosis, usg.IndicationsForDiagnostic
				, usg.RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName
				, usg.ConsentDate, usg.ProcedureDate
				, usg.PDPResultConveyedTo
			    , usg.SonographyDate
				, usg.MTPIndication
				
				--, mtd.RecordName as MTPIndicationText
				
				,case when isnull(mtd.RecordName,'''') = '''' and isnull(mtd.RecordName,'''') = '''' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText

				, usg.MTPDone
				, usg.UsgImageNo
				--, usg.SonographyResult, result.RecordName as SonographyResultText
				, usg.SonographyResult, SonographyResult as SonographyResultText
				, usg.OtherSpecify, other.RecordName as OtherSpecifyText
				, usg.ChildrenCount
				, usg.ChildrenDetails
				, usg.Remark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo as PatientHouseNo, pc.Society as PatientSociety, pc.Area as PatientArea, pc.Landmark as PatientLandmark, pc.VillageCity as PatientVillageCity
				, pc.Taluka as PatientTaluka, pc.District as PatientDistrict, pc.State as PatientState, pc.PinCode as PatientPinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy
				, SonographyResult2
				  From CTE 
				  INNER JOIN patient.tblUsgDetails usg with(nolock) ON CTE.UsgId=usg.UsgId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId

				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(EntryDate) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(EntryDate) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblUsgDetails where  year(EntryDate) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 

		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgDetails WHERE UsgId=@UsgId 
	  DELETE FROM patient.tblUsgDetails WHERE VisitId = @VisitId
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgDetails_23022025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_UsgDetails_23022025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @UsgId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @SrNoAccMonth int=NULL 
  , @SrNoAccYear int=NULL 
  , @RefByDoc nvarchar(200)=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Taluka nvarchar(200)=NULL 
  , @District nvarchar(200)=NULL 
  , @PerformingDocName nvarchar(200)=NULL 
  , @ConsentDate date=NULL 
  , @ProcedureDate date=NULL 
  , @PDPResultConveyedTo nvarchar(200)=NULL 
  , @SonographyDate date=NULL 
  , @MTPIndication nvarchar(2000)=NULL 
  , @MTPDone nvarchar(20)=NULL 
  , @UsgImageNo int=NULL 
  , @SonographyResult nvarchar(2000)=NULL 
  , @OtherSpecify nvarchar(2000)=NULL
  , @ChildrenCount int=NULL
  , @ChildrenDetails nvarchar(MAX)=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='UsgId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
  , @USGUterusWeeks int=NULL 
  , @USGLMPDate date=NULL
  , @USGDiagnosis nvarchar(2000)=NULL
  , @IndicationsForDiagnostic nvarchar(2000)=NULL

  ,@SonographyResult2 nvarchar(500) = null



 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
	   , @v_SrNoAccMonth int, @v_SrNoAccYear int
  
    IF @Command='INSERT' 
    BEGIN 
		select @v_SrNoAccMonth = max(SrNoAccMonth) from patient.tblUsgDetails where month(EntryDate)=month(GETDATE()) and year(entrydate)=year(GETDATE())
		select @v_SrNoAccYear = max(SrNoAccYear) from patient.tblUsgDetails where year(entrydate)=year(GETDATE())

		Select @SrNoAccMonth = ISNULL(@v_SrNoAccMonth,0)+1, @SrNoAccYear=ISNULL(@v_SrNoAccYear,0)+1

      INSERT INTO patient.tblUsgDetails  
         (PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic, RefByDoc, VillageCity, Taluka, District, PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo, SonographyDate
		 , MTPIndication, MTPDone, UsgImageNo, SonographyResult, OtherSpecify, ChildrenCount, ChildrenDetails, Remark, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, SonographyResult2) 
       VALUES (@PatientId, @CaseId, @VisitId, @SrNoAccMonth, @SrNoAccYear, @USGUterusWeeks, @USGLMPDate, @USGDiagnosis, @IndicationsForDiagnostic, @RefByDoc, @VillageCity, @Taluka, @District, @PerformingDocName, @ConsentDate, @ProcedureDate, @PDPResultConveyedTo, @SonographyDate
	   , @MTPIndication, @MTPDone, @UsgImageNo, @SonographyResult, @OtherSpecify, @ChildrenCount, @ChildrenDetails, @Remark, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @SonographyResult2)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgDetails 
	  SET  SrNoAccMonth=@SrNoAccMonth 
        , SrNoAccYear=@SrNoAccYear 
	  , RefByDoc=@RefByDoc 
        , VillageCity=@VillageCity 
        , Taluka=@Taluka 
        , District=@District 
        , PerformingDocName=@PerformingDocName 
        , ConsentDate=@ConsentDate 
        , ProcedureDate=@ProcedureDate 
        , PDPResultConveyedTo=@PDPResultConveyedTo 
        , SonographyDate=@SonographyDate 
        , MTPIndication=@MTPIndication 
        , MTPDone=@MTPDone 
        , UsgImageNo=@UsgImageNo 
        , SonographyResult=@SonographyResult
		, OtherSpecify = @OtherSpecify
		, ChildrenCount= @ChildrenCount
        , ChildrenDetails=@ChildrenDetails 
        , Remark=@Remark 
        , IsEdited=@IsEdited 
       -- , EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
       -- , CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy 

		,SonographyResult2 = @SonographyResult2

         WHERE UsgId=@UsgId     

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @UsgId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 

		If @SubCommand = 'SelectSingle'
		Begin
			SELECT UsgId, p.PatientId, CaseId, VisitId, SrNoAccMonth, SrNoAccYear
			, USGUterusWeeks, USGLMPDate, USGDiagnosis, IndicationsForDiagnostic
			, RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName, ConsentDate, ProcedureDate, PDPResultConveyedTo
			  , SonographyDate
			  , usg.MTPIndication, 
			  
			  --mtd.RecordName as MTPIndicationText

			   case when isnull(mtd.RecordName,'') = '' and isnull(mtd.RecordName,'') = '' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText
			  
			  , MTPDone, UsgImageNo
			, usg.SonographyResult, SonographyResult as SonographyResultText
			--, result.RecordName as SonographyResultText
			, usg.OtherSpecify, other.RecordName as OtherSpecifyText
			  , ChildrenCount, ChildrenDetails, Remark
			  , usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy , SonographyResult2
			  FROM  patient.tblUsgDetails usg with(nolock)
			   INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId

				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
			  WHERE UsgId=@UsgId 
		End

		
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usg.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usg.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usg.SonographyDate >= ''' + @FromDate + ''' AND usg.SonographyDate <= ''' + @ToDate + ''')' 	
			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select UsgId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usg.UsgId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgDetails usg with(nolock) 
						  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
						  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
						 INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId
						WHERE ' + @WhereQry + ' And pc.caseId = '+ cast(@CaseId as nvarchar(70)) +'
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usg.UsgId, usg.PatientId, usg.CaseId, usg.VisitId
				, SrNoAccMonth, SrNoAccYear
				, usg.USGUterusWeeks, usg.USGLMPDate, usg.USGDiagnosis, usg.IndicationsForDiagnostic
				, usg.RefByDoc, usg.VillageCity, usg.Taluka, usg.District, usg.PerformingDocName
				, usg.ConsentDate, usg.ProcedureDate
				, usg.PDPResultConveyedTo
			    , usg.SonographyDate
				, usg.MTPIndication
				
				--, mtd.RecordName as MTPIndicationText
				
				,case when isnull(mtd.RecordName,'''') = '''' and isnull(mtd.RecordName,'''') = '''' then usg.MTPIndication else  mtd.RecordName  end as MTPIndicationText

				, usg.MTPDone
				, usg.UsgImageNo
				--, usg.SonographyResult, result.RecordName as SonographyResultText
				, usg.SonographyResult, SonographyResult as SonographyResultText
				, usg.OtherSpecify, other.RecordName as OtherSpecifyText
				, usg.ChildrenCount
				, usg.ChildrenDetails
				, usg.Remark
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo as PatientHouseNo, pc.Society as PatientSociety, pc.Area as PatientArea, pc.Landmark as PatientLandmark, pc.VillageCity as PatientVillageCity
				, pc.Taluka as PatientTaluka, pc.District as PatientDistrict, pc.State as PatientState, pc.PinCode as PatientPinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usg.IsEdited, usg.EntryDate, usg.UpdatedDate, usg.CreatedBy, usg.UpdatedBy
				, SonographyResult2
				  From CTE 
				  INNER JOIN patient.tblUsgDetails usg with(nolock) ON CTE.UsgId=usg.UsgId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usg.PatientId
				  INNER JOIN patient.tblPatientCases pc with (nolock) on p.PatientId=pc.PatientId
				  INNER JOIN patient.tblPatientVisits pv with (nolock) on pc.CaseId=pv.CaseId

				  --LEFT JOIN common.tblEntityRecords result with(nolock) on usg.SonographyResult = result.EntityRecordId
				  
				  --LEFT JOIN common.tblEntityRecords mtd with(nolock) on usg.MTPIndication = mtd.EntityRecordId

				  LEFT JOIN common.tblEntityRecords mtd with(nolock) on CASE 
							
							WHEN TRY_CAST(usg.MTPIndication AS INT) IS NOT NULL 
							THEN cast(usg.MTPIndication AS INT)
							ELSE NULL -- Handle invalid data gracefully

						END= mtd.EntityRecordId
				  
				  LEFT JOIN common.tblEntityRecords other with(nolock) on usg.OtherSpecify = other.EntityRecordId
				  
				  where pc.CaseId = '+ CAST(@CaseId as nvarchar(70)) +'

				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		If @SubCommand = 'selectYearAndMonth'
		Begin
			declare @srnoAccMonth1 bigint = 0, @srnoAccYear1 bigint = 0
			declare @srnoAccMonth2 bigint = 0, @srnoAccYear2 bigint = 0

			select @srnoAccMonth1 = COUNT(SrNoAccMonth) from patient.tblUsgDetails where month(SonographyDate) = month(GETDATE())
			select @srnoAccYear1 = COUNT(SrNoAccYear) from patient.tblUsgDetails where year(SonographyDate) = year(GETDATE())

			
			select @srnoAccMonth2 = max(SrNoAccMonth) from patient.tblUsgDetails where  month(SonographyDate) = month(GETDATE())
			select @srnoAccYear2 = max(SrNoAccYear) from patient.tblUsgDetails where  year(SonographyDate) = year(GETDATE())

			select (isnull(@srnoAccMonth1,0) + 1) as SrNoAccMonth, (isnull(@srnoAccYear1,0) + 1) as SrNoAccYear,
					(isnull(@srnoAccMonth2, 0) + 1) as SrNoAccMonth2 , (isnull(@srnoAccYear2,0) + 1) as SrNoAccYear2 

		End
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgDetails WHERE UsgId=@UsgId 

	  IF @SubCommand = 'DeleteFromUsgId'
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE UsgId = @UsgId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgDetails WHERE VisitId = @VisitId
	  END


	
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @UsgId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgReports]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_UsgReports]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @ReportId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @ReportDate date=NULL 
  --, @ReportTime time=NULL 
  , @ReportTime nvarchar(50) = NULL 
  , @Remark nvarchar(2000)=NULL 
  , @NoOfFoetusRefId bigint=NULL 
  , @CardiacActivityRefId bigint=NULL 
  , @PresentationRefId bigint=NULL 
  , @GSPregWeek int=NULL 
  , @GSPregDay int=NULL 
  , @GSEDD date=NULL 
  , @CRLPregWeek int=NULL 
  , @CRLPregDay int=NULL 
  , @CRLEDD date=NULL 
  , @FLPregWeek int=NULL 
  , @FLPregDay int=NULL 
  , @FLEDD date=NULL 
  , @BPDPregWeek int=NULL 
  , @BPDPregDay int=NULL 
  , @BPDEDD date=NULL 
  , @HCPregWeek int=NULL 
  , @HCPregDay int=NULL 
  , @HCEDD date=NULL 
  , @ACPregWeek int=NULL 
  , @ACPregDay int=NULL 
  , @ACEDD date=NULL 
  , @AvgPregWeek int=NULL 
  , @AvgPregDay int=NULL 
  , @AvgEDD date=NULL 
  , @PossibleLMP date=NULL 
  , @PlacentalLocationRefId bigint=NULL 
  , @LiquarAmountRefId bigint=NULL 
  , @AnomaliesRefId bigint=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='ReportId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
   -- Jeet Chauhan new parameter
  , @USGDetail varchar(500) = null
  , @USGDetailId bigint = null
   -- Jeet Chauhan new parameter

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblUsgReports  
         (PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
		 , NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
		 , GSPregWeek, GSPregDay, GSEDD
		 , CRLPregWeek, CRLPregDay, CRLEDD
		 , FLPregWeek, FLPregDay, FLEDD
		 , BPDPregWeek, BPDPregDay, BPDEDD
		 , HCPregWeek, HCPregDay, HCEDD
		 , ACPregWeek, ACPregDay, ACEDD
		 , AvgPregWeek, AvgPregDay, AvgEDD
		 , PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, USGDetailId)
		 
       VALUES (@PatientId, @CaseId, @VisitId, @ReportDate, cast( @ReportTime as time), @Remark
	   , @NoOfFoetusRefId, @CardiacActivityRefId, @PresentationRefId
	   , @GSPregWeek, @GSPregDay, @GSEDD
	   , @CRLPregWeek, @CRLPregDay, @CRLEDD
	   , @FLPregWeek, @FLPregDay, @FLEDD
	   , @BPDPregWeek, @BPDPregDay, @BPDEDD
	   , @HCPregWeek, @HCPregDay, @HCEDD
	   , @ACPregWeek, @ACPregDay, @ACEDD
	   , @AvgPregWeek, @AvgPregDay, @AvgEDD
	   , @PossibleLMP, @PlacentalLocationRefId, @LiquarAmountRefId, @AnomaliesRefId
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @USGDetailId)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgReports SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , ReportDate=@ReportDate 
        --, ReportTime=@ReportTime 

		, ReportTime = CAST( @ReportTime as time)

        , Remark=@Remark 
        , NoOfFoetusRefId=@NoOfFoetusRefId 
        , CardiacActivityRefId=@CardiacActivityRefId 
        , PresentationRefId=@PresentationRefId 
        , GSPregWeek=@GSPregWeek 
        , GSPregDay=@GSPregDay 
        , GSEDD=@GSEDD 
        , CRLPregWeek=@CRLPregWeek 
        , CRLPregDay=@CRLPregDay 
        , CRLEDD=@CRLEDD 
        , FLPregWeek=@FLPregWeek 
        , FLPregDay=@FLPregDay 
        , FLEDD=@FLEDD 
        , BPDPregWeek=@BPDPregWeek 
        , BPDPregDay=@BPDPregDay 
        , BPDEDD=@BPDEDD 
        , HCPregWeek=@HCPregWeek 
        , HCPregDay=@HCPregDay 
        , HCEDD=@HCEDD 
        , ACPregWeek=@ACPregWeek 
        , ACPregDay=@ACPregDay 
        , ACEDD=@ACEDD 
        , AvgPregWeek=@AvgPregWeek 
        , AvgPregDay=@AvgPregDay 
        , AvgEDD=@AvgEDD 
        , PossibleLMP=@PossibleLMP 
        , PlacentalLocationRefId=@PlacentalLocationRefId 
        , LiquarAmountRefId=@LiquarAmountRefId 
        , AnomaliesRefId=@AnomaliesRefId 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        --, CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy,
		
		USGDetailId = @USGDetailId
         WHERE ReportId=@ReportId  
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ReportId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @ReportId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			    SELECT ReportId, PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
				, NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
			  , GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
			  , AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,USGDetailId
			  FROM  patient.tblUsgReports 
			  WHERE ReportId=@ReportId 
		End


		If @SubCommand = 'SelectPreviousVisitData'
		Begin
			    SELECT top 1 ReportId, PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
				, NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
			  , GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
			  , AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,USGDetailId
			  FROM  patient.tblUsgReports 
			  WHERE PatientId = @PatientId 
			  ORDER BY EntryDate desc
		End

			
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND  @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usgrpt.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usgrpt.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usgrpt.ReportDate >= ''' + @FromDate + ''' AND usgrpt.ReportDate <= ''' + @ToDate + ''')' 	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select ReportId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usgrpt.ReportId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgReports usgrpt with(nolock) 
						 inner join patient.tblPatients p with(nolock) on p.PatientId=usgrpt.PatientId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usgrpt.ReportId, p.PatientId, usgrpt.CaseId, usgrpt.VisitId, usgrpt.ReportDate, usgrpt.ReportTime, usgrpt.Remark
				, NoOfFoetusRefId, nof.RecordName as NoOfFoetusText
				, CardiacActivityRefId, ca.RecordName as CardiacActivityText
				, PresentationRefId, pre.RecordName as PresentationText
				, GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
				, AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP
				, PlacentalLocationRefId, pl.RecordName as PlacentalLocationText
				, LiquarAmountRefId, la.RecordName as LiquarAmountText
				, AnomaliesRefId, ano.RecordName as AnomaliesText				
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usgrpt.IsEdited, usgrpt.EntryDate, usgrpt.UpdatedDate, usgrpt.CreatedBy, usgrpt.UpdatedBy
				
				  From CTE 
				  INNER JOIN patient.tblUsgReports usgrpt with(nolock) ON CTE.ReportId=usgrpt.ReportId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usgrpt.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and usgrpt.CaseId=pc.CaseId
				  LEFT JOIN common.tblEntityRecords nof with(nolock) on usgrpt.NoOfFoetusRefId = nof.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ca with(nolock) on usgrpt.CardiacActivityRefId = ca.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pre with(nolock) on usgrpt.PresentationRefId = pre.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pl with(nolock) on usgrpt.PlacentalLocationRefId = pl.EntityRecordId
				  LEFT JOIN common.tblEntityRecords la with(nolock) on usgrpt.LiquarAmountRefId = la.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ano with(nolock) on usgrpt.AnomaliesRefId = ano.EntityRecordId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
  

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgReports WHERE ReportId=@ReportId 


	    IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblUsgReports WHERE ReportId=@ReportId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgReports WHERE VisitId=@VisitId
	  END


	  
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ReportId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_UsgReports_19042025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_Manage_UsgReports_19042025]  
   @Command varchar(200) 
  , @HospitalId int=NULL 
  , @ReportId bigint=NULL 
  , @PatientId bigint=NULL 
  , @CaseId bigint=NULL 
  , @VisitId bigint=NULL 
  , @ReportDate date=NULL 
  , @ReportTime time=NULL 
  , @Remark nvarchar(2000)=NULL 
  , @NoOfFoetusRefId bigint=NULL 
  , @CardiacActivityRefId bigint=NULL 
  , @PresentationRefId bigint=NULL 
  , @GSPregWeek int=NULL 
  , @GSPregDay int=NULL 
  , @GSEDD date=NULL 
  , @CRLPregWeek int=NULL 
  , @CRLPregDay int=NULL 
  , @CRLEDD date=NULL 
  , @FLPregWeek int=NULL 
  , @FLPregDay int=NULL 
  , @FLEDD date=NULL 
  , @BPDPregWeek int=NULL 
  , @BPDPregDay int=NULL 
  , @BPDEDD date=NULL 
  , @HCPregWeek int=NULL 
  , @HCPregDay int=NULL 
  , @HCEDD date=NULL 
  , @ACPregWeek int=NULL 
  , @ACPregDay int=NULL 
  , @ACEDD date=NULL 
  , @AvgPregWeek int=NULL 
  , @AvgPregDay int=NULL 
  , @AvgEDD date=NULL 
  , @PossibleLMP date=NULL 
  , @PlacentalLocationRefId bigint=NULL 
  , @LiquarAmountRefId bigint=NULL 
  , @AnomaliesRefId bigint=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='ReportId'
  , @SortOrder varchar(5)='Desc'
  , @PageNo int=1
  , @PageSize int=10
  , @FromDate varchar(50) = NULL
  , @ToDate varchar(50) = NULL
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
   -- Jeet Chauhan new parameter
  , @USGDetail varchar(500) = null
  , @USGDetailId bigint = null
   -- Jeet Chauhan new parameter

 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tblUsgReports  
         (PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
		 , NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
		 , GSPregWeek, GSPregDay, GSEDD
		 , CRLPregWeek, CRLPregDay, CRLEDD
		 , FLPregWeek, FLPregDay, FLEDD
		 , BPDPregWeek, BPDPregDay, BPDEDD
		 , HCPregWeek, HCPregDay, HCEDD
		 , ACPregWeek, ACPregDay, ACEDD
		 , AvgPregWeek, AvgPregDay, AvgEDD
		 , PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
		 , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy, USGDetailId)
		 
       VALUES (@PatientId, @CaseId, @VisitId, @ReportDate, @ReportTime, @Remark
	   , @NoOfFoetusRefId, @CardiacActivityRefId, @PresentationRefId
	   , @GSPregWeek, @GSPregDay, @GSEDD
	   , @CRLPregWeek, @CRLPregDay, @CRLEDD
	   , @FLPregWeek, @FLPregDay, @FLEDD
	   , @BPDPregWeek, @BPDPregDay, @BPDEDD
	   , @HCPregWeek, @HCPregDay, @HCEDD
	   , @ACPregWeek, @ACPregDay, @ACEDD
	   , @AvgPregWeek, @AvgPregDay, @AvgEDD
	   , @PossibleLMP, @PlacentalLocationRefId, @LiquarAmountRefId, @AnomaliesRefId
	   , @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy, @USGDetailId)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tblUsgReports SET PatientId=@PatientId 
        , CaseId=@CaseId 
        , VisitId=@VisitId 
        , ReportDate=@ReportDate 
        , ReportTime=@ReportTime 
        , Remark=@Remark 
        , NoOfFoetusRefId=@NoOfFoetusRefId 
        , CardiacActivityRefId=@CardiacActivityRefId 
        , PresentationRefId=@PresentationRefId 
        , GSPregWeek=@GSPregWeek 
        , GSPregDay=@GSPregDay 
        , GSEDD=@GSEDD 
        , CRLPregWeek=@CRLPregWeek 
        , CRLPregDay=@CRLPregDay 
        , CRLEDD=@CRLEDD 
        , FLPregWeek=@FLPregWeek 
        , FLPregDay=@FLPregDay 
        , FLEDD=@FLEDD 
        , BPDPregWeek=@BPDPregWeek 
        , BPDPregDay=@BPDPregDay 
        , BPDEDD=@BPDEDD 
        , HCPregWeek=@HCPregWeek 
        , HCPregDay=@HCPregDay 
        , HCEDD=@HCEDD 
        , ACPregWeek=@ACPregWeek 
        , ACPregDay=@ACPregDay 
        , ACEDD=@ACEDD 
        , AvgPregWeek=@AvgPregWeek 
        , AvgPregDay=@AvgPregDay 
        , AvgEDD=@AvgEDD 
        , PossibleLMP=@PossibleLMP 
        , PlacentalLocationRefId=@PlacentalLocationRefId 
        , LiquarAmountRefId=@LiquarAmountRefId 
        , AnomaliesRefId=@AnomaliesRefId 
        , IsEdited=@IsEdited 
        --, EntryDate=@EntryDate 
        , UpdatedDate=@UpdatedDate 
        --, CreatedBy=@CreatedBy 
        , UpdatedBy=@UpdatedBy,
		
		USGDetailId = @USGDetailId
         WHERE ReportId=@ReportId  
		 
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ReportId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @ReportId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		If @SubCommand = 'SelectSingle'
		Begin
			    SELECT ReportId, PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
				, NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
			  , GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
			  , AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,USGDetailId
			  FROM  patient.tblUsgReports 
			  WHERE ReportId=@ReportId 
		End


		If @SubCommand = 'SelectPreviousVisitData'
		Begin
			    SELECT top 1 ReportId, PatientId, CaseId, VisitId, ReportDate, ReportTime, Remark
				, NoOfFoetusRefId, CardiacActivityRefId, PresentationRefId
			  , GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
			  , AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP, PlacentalLocationRefId, LiquarAmountRefId, AnomaliesRefId
			  , IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy ,USGDetailId
			  FROM  patient.tblUsgReports 
			  WHERE PatientId = @PatientId 
			  ORDER BY EntryDate desc
		End

			
		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize>0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '	

			If @HospitalId > 0 AND  @HospitalId > 1
				SET @WhereQry += ' And p.HospitalId = ' + Convert(varchar(20), @HospitalId)				
			If @PatientId > 0
				SET @WhereQry += ' And usgrpt.PatientId = ' + Convert(varchar(20), @PatientId)	
			If @CaseId > 0
				SET @WhereQry += ' And usgrpt.CaseId = ' + Convert(varchar(20), @CaseId)	
			
			If ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') != ''
				SET @WhereQry += ' And (usgrpt.ReportDate >= ''' + @FromDate + ''' AND usgrpt.ReportDate <= ''' + @ToDate + ''')' 	

			--If ISNULL(@SearchKey,'')!=''
			--Begin
			--	SET @WhereQry = @WhereQry + ' AND ' 
			--		+ CASE @SearchType
			--			When 'Name'
			--			Then 'p.PlanName = ' + Convert(varchar, @SearchKey)							 						
			--			When 'FreeSearch'
			--			Then '(p.PlanName like ''%' + @SearchKey + '%'' 
			--			Or p.Description like ''%' + @SearchKey + '%'')' 
			--		 End
			--End			
			
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select ReportId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select distinct usgrpt.ReportId, ' + @SortBy + ' as SortBy
						 FROM patient.tblUsgReports usgrpt with(nolock) 
						 inner join patient.tblPatients p with(nolock) on p.PatientId=usgrpt.PatientId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, usgrpt.ReportId, p.PatientId, usgrpt.CaseId, usgrpt.VisitId, usgrpt.ReportDate, usgrpt.ReportTime, usgrpt.Remark
				, NoOfFoetusRefId, nof.RecordName as NoOfFoetusText
				, CardiacActivityRefId, ca.RecordName as CardiacActivityText
				, PresentationRefId, pre.RecordName as PresentationText
				, GSPregWeek, GSPregDay, GSEDD, CRLPregWeek, CRLPregDay, CRLEDD, FLPregWeek, FLPregDay, FLEDD, BPDPregWeek, BPDPregDay, BPDEDD, HCPregWeek, HCPregDay, HCEDD, ACPregWeek, ACPregDay, ACEDD
				, AvgPregWeek, AvgPregDay, AvgEDD, PossibleLMP
				, PlacentalLocationRefId, pl.RecordName as PlacentalLocationText
				, LiquarAmountRefId, la.RecordName as LiquarAmountText
				, AnomaliesRefId, ano.RecordName as AnomaliesText				
				, pc.FirstName, pc.LastName, pc.DateOfBirth, pc.Age, pc.Gender, pc.IsMarried, pc.ContatcNo, pc.Email
				, pc.PrimaryRelation, pc.PrimaryRelativeName, pc.PrimaryRelativeNameSuffix, pc.PrimaryContactNo
				, pc.SecondaryRelation, pc.SecondaryRelativeName, pc.SecondaryRelativeNameSuffix, pc.SecondaryContactNo
				, pc.LocationRefId, pc.HouseNo, pc.Society, pc.Area, pc.Landmark, pc.VillageCity, pc.Taluka, pc.District, pc.State, pc.PinCode
				, p.IsPatientActive
				, pc.CaseRegNo
				, usgrpt.IsEdited, usgrpt.EntryDate, usgrpt.UpdatedDate, usgrpt.CreatedBy, usgrpt.UpdatedBy
				
				  From CTE 
				  INNER JOIN patient.tblUsgReports usgrpt with(nolock) ON CTE.ReportId=usgrpt.ReportId
				  INNER JOIN patient.tblPatients p with(nolock) on p.PatientId=usgrpt.PatientId
				  INNER JOIN patient.tblPatientCases pc with(nolock) on p.PatientId=pc.PatientId and usgrpt.CaseId=pc.CaseId
				  LEFT JOIN common.tblEntityRecords nof with(nolock) on usgrpt.NoOfFoetusRefId = nof.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ca with(nolock) on usgrpt.CardiacActivityRefId = ca.EntityRecordId
				  LEFT JOIN common.tblEntityRecords pre with(nolock) on usgrpt.PresentationRefId = pre.EntityRecordId

				  LEFT JOIN common.tblEntityRecords pl with(nolock) on usgrpt.PlacentalLocationRefId = pl.EntityRecordId
				  LEFT JOIN common.tblEntityRecords la with(nolock) on usgrpt.LiquarAmountRefId = la.EntityRecordId
				  LEFT JOIN common.tblEntityRecords ano with(nolock) on usgrpt.AnomaliesRefId = ano.EntityRecordId
				  
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End
  

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      --DELETE FROM patient.tblUsgReports WHERE ReportId=@ReportId 


	    IF @SubCommand = 'DeleteFromId'
	  BEGIN
		DELETE FROM patient.tblUsgReports WHERE ReportId=@ReportId
	  END
	  ELSE IF (@SubCommand = 'DeleteFromVisits')
	  BEGIN
		DELETE FROM patient.tblUsgReports WHERE VisitId=@VisitId
	  END


	  
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @ReportId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_VillageCity]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_VillageCity]  
   @Command varchar(200) 
  , @VillageCityId int=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @TalukaId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='VillageCity'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL,

  --New Added
  @MultipleDeleteIds nvarchar(max) = null
  --New Added

  , @Taluka nvarchar(200) = ''
  , @State nvarchar(200) = ''
  , @District nvarchar(200) = ''

  , @Society nvarchar(200) = ''
  , @SocietyId bigint = 0
  , @Area nvarchar(200) = null
  , @AreaId bigint = 0
  , @City nvarchar(200) = null

   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	If Not Exists (select top 1 VillageCityId from location.tblVillageCity with (nolock) where VillageCity=@VillageCity and TalukaId=@TalukaId and Language=@Language)
		Begin
				INSERT INTO location.tblVillageCity  
				 (VillageCity, Language, TalukaId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , taluka , State , District
				 , Society , Area , City , AreaId , SocietyId , isvillageCity ) 
			   VALUES (@VillageCity, @Language, @TalukaId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @Taluka , @State , @District , @Society , @Area , @City , @AreaId , @SocietyId , 1)  
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Village/City and Taluka combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	If not Exists (select top 1 VillageCityId from location.tblVillageCity with (nolock) where VillageCity=@VillageCity and TalukaId=@TalukaId and Language=@Language and VillageCityId!=@VillageCityId)
			Begin				
				 UPDATE location.tblVillageCity SET 
				  VillageCity=@VillageCity 
				, Language=@Language 
				--, TalukaId=@TalukaId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 			
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				,State = @State
				,District = @District
				,taluka = @taluka
				,City = @City
				,AreaId = @AreaId
				, Society = @Society
				,Area = @Area
				, SocietyId = @SocietyId
				 WHERE VillageCityId=@VillageCityId   
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @VillageCityId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @VillageCityId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @VillageCityId, @v_Message='error', @v_CustomMessage='Duplication error. Village/City and Taluka combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN      

	  If @SubCommand = 'SelectSingle'
		Begin
			 SELECT VillageCityId, VillageCity, vc.Language, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy
			, t.TalukaId, t.Taluka
			, d.DistrictId, d.District
			, s.StateId, s.State			
			FROM location.tblVillageCity vc with(nolock)
			INNER JOIN location.tblTaluka t with(nolock) on vc.TalukaId=t.TalukaId
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE VillageCityId=@VillageCityId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And t.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					 When 'VillageCity'
						Then 'vc.VillageCity = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'Taluka'
						Then 't.Taluka = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'TalukaId'
						Then 't.TalukaId = ' + Convert(varchar, @SearchKey) 
					 When 'District'
						Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'DistrictId'
						Then 'd.DistrictId = ' + Convert(varchar, @SearchKey) 
					 When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
					 When 'StateId'
						Then 's.StateId = ' + Convert(varchar, @SearchKey) 
					 When 'FreeSearch'
						Then '(vc.VillageCity like ''%' + @SearchKey + '%'' Or t.Taluka like ''%' + @SearchKey + '%'' Or d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or vc.Language like ''%' + @SearchKey + '%'')' 
					 End
			End		
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select VillageCityId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select vc.VillageCityId, ' + @SortBy + ' as SortBy
						 FROM 
						 location.tblVillageCity vc with (nolock)
						 left JOIN location.tblTaluka t with (nolock) ON vc.TalukaId=t.TalukaId
						 left JOIN location.tblDistrict d with(nolock) ON t.DistrictId=d.DistrictId
						 left JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/' + CONVERT(varchar(30),@PageSize) + ') from CTE) as PageCount
				, vc.VillageCityId, vc.VillageCity, vc.Language
				, ISNULL(t.TalukaId , 0) as TalukaId, ISNULL(t.Taluka,'''') as Taluka
				, ISNULL(d.DistrictId, 0) as DistrictId, ISNULL(d.District,'''') as District
				, ISNULL(s.StateId,0) as StateId ,ISNULL( vc.State , '''') as State

				, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy ,
				  ISNULL(vc.Area,'''') as Area, ISNULL(vc.City , '''') as City  , ISNULL(vc.Society,'''') as Society , SocietyId								  
				  From CTE
				  left JOIN location.tblVillageCity vc with (nolock) ON CTE.VillageCityId=vc.VillageCityId
				  left JOIN location.tblTaluka t with(nolock) ON vc.TalukaId=t.TalukaId
				  left JOIN location.tblDistrict d with(nolock) ON t.DistrictId=d.DistrictId
				  left JOIN location.tblState s with(nolock) ON d.StateId=s.StateId 

		
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		-- New Logic of Get tokenized autosuggest
		ELSE IF @SubCommand = 'GetTokenize'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				;With CTE AS (
					Select * From
					(
						Select * 
						 FROM 
						 location.tblVillageCity vc with (nolock)
						WHERE  1=1   and Language = @Language  and IsVillageCity = 1
					) A
				) Select distinct 
				
				 --vc.VillageCityId,
				 vc.VillageCity, vc.Language
				 ,vc.Taluka
				, vc.District
				, vc.State
				, vc.IsActive
				, vc.IsEdited
				--, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy									  
				From CTE vc 
				where isnull(VillageCity,'') <> ''
				and isnull(District,'') <> ''
				and isnull(taluka,'') <> ''
		END
		-- New Logic of Get tokenized autosuggest
		ELSE IF @SubCommand = 'GetTokenizeArea'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

					;With CTE AS (
					Select * From
					(
						Select * 
						 FROM 
						 location.tblVillageCity vc with (nolock)
						WHERE  1=1   and Language = @Language and IsActive = 1
					) A
				) Select distinct 
				
				 vc.VillageCityId
				 , vc.VillageCity
				 , vc.Language
				 ,vc.Taluka
				, vc.District
				, vc.State
				,vc.Area
				,vc.Society
				, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy									  
				From CTE vc 
		END
		-- New Logic of Get tokenized autosuggest


		IF @SubCommand = 'GetTokenizeSocietyFullList'
		BEGIN
			set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				;With CTE AS (
					Select * From
					(
						Select * 
						 FROM 
						 location.tblVillageCity vc with (nolock)
						WHERE  1=1   and Language = @Language and IsActive = 1 and IsVillageCity = 0
					) A
				) Select distinct 
				
				--vc.VillageCityId,
				vc.VillageCity,
				vc.Language,
				vc.SocietyId,
				 vc.Society,

				 ss.StateId,
				 vc.State,

				 vc.AreaId,
				 vc.Area,

				 vc.City,
				 c.cityid,
				 
				 vc.IsActive 
				 --vc.IsEdited,
				 --vc.EntryDate, 
				 --vc.UpdatedDate, 
				 --vc.CreatedBy, 
				 --vc.UpdatedBy
				 
				From CTE vc 
				inner join location.tblArea a on a.AreaId = vc.AreaId
				inner join location.TblCity c on c.CityId = a.CityId
				inner join location.tblState ss on ss.StateId = c.StateId
		END


		ELSE IF @SubCommand = 'GetTokenizeAreaList'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				--	;With CTE AS (
				--	Select * From
				--	(
				--		select area , societyid , society , s.isActive from location.tblarea a
				--		inner join location.tblsociety s on s.areaid = a.areaid
				--		where 1 = 1 and s.language = @Language and 
				--		(
				--			(isnull(@Society, '') = ''  and 1 = 1 )
				--			or
				--			(s.society = @Society)
						
				--		)
				--	) A
				--) Select distinct 
				
				--vc.area
				--,vc.SocietyId
				--, vc.society
				--,vc.isActive
				--From CTE vc
				
				;With CTE AS (
					Select * From
					(
						select distinct Area ,IsActive from location.tblVillageCity 
						where 1 = 1 and language = @Language and 
						--where 1 = 1 and language = 'English' and 
						(
							(isnull(@VillageCity, '') = ''  and 1 = 1 )
							or
							(VillageCity = @VillageCity)
						
						)
					) A
				) Select distinct 
				
				vc.Area as Area,
				IsActive as IsActive
				From CTE vc


		END
		-- New Logic of Get tokenized autosuggest
		ELSE IF @SubCommand = 'GetTokenizeCityList'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				
				
				;With CTE AS (
					Select * From
					(
						--select distinct CityName as City ,IsActive from location.TblCity 
						--where 1 = 1 and language = @Language and 
						select s.StateId, State , CityId , CityName as City , c.IsActive , c.language from location.TblCity c
						inner join location.tblState s on s.StateId = c.StateId
						where 1 = 1 and c.language = @Language and 
						(
							(isnull(@State, '') = ''  and 1 = 1 )
							or
							(State = @State)
						
						)
					) A
				) Select distinct 
				vc.State ,
				vc.StateId ,
				vc.Language ,
				vc.City as City,
				IsActive as IsActive
				From CTE vc


		END



    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		IF @SubCommand = 'Multiple'
		BEGIN
			
			DELETE FROM location.tblVillageCity WHERE VillageCityId in (select value from string_split(@MultipleDeleteIds,','))
		END
		ELSE
		BEGIN
			DELETE FROM location.tblVillageCity WHERE VillageCityId=@VillageCityId 
		END
			
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VillageCityId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_Manage_VillageCity_16_06_2025]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [dbo].[Usp_Manage_VillageCity_16_06_2025]  
   @Command varchar(200) 
  , @VillageCityId int=NULL 
  , @VillageCity nvarchar(200)=NULL 
  , @Language nvarchar(50)=NULL 
  , @TalukaId int=NULL 
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='VillageCity'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL,

  --New Added
  @MultipleDeleteIds nvarchar(max) = null
  --New Added

  , @Taluka nvarchar(200) = ''
  , @State nvarchar(200) = ''
  , @District nvarchar(200) = ''

  , @Society nvarchar(200) = ''
  , @SocietyId bigint = 0
  , @Area nvarchar(200) = null
  , @AreaId bigint = 0
  , @City nvarchar(200) = null

   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
  
    IF @Command='INSERT' 
    BEGIN 

	If Not Exists (select top 1 VillageCityId from location.tblVillageCity with (nolock) where VillageCity=@VillageCity and TalukaId=@TalukaId and Language=@Language)
		Begin
				INSERT INTO location.tblVillageCity  
				 (VillageCity, Language, TalukaId, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , taluka , State , District
				 , Society , Area , City , AreaId , SocietyId , isvillageCity ) 
			   VALUES (@VillageCity, @Language, @TalukaId, @IsActive, @IsEdited, @EntryDate, @UpdatedDate, @CreatedBy, @UpdatedBy , @Taluka , @State , @District , @Society , @Area , @City , @AreaId , @SocietyId , 1)  
        
				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End
		End
		Else
		Begin
			SELECT  @v_IsSuccess=0, @v_Identity = 0, @v_Message='error', @v_CustomMessage='Duplication error. Village/City and Taluka combination with this name already exists!'
		End                  

		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage

    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	If not Exists (select top 1 VillageCityId from location.tblVillageCity with (nolock) where VillageCity=@VillageCity and TalukaId=@TalukaId and Language=@Language and VillageCityId!=@VillageCityId)
			Begin				
				 UPDATE location.tblVillageCity SET 
				  VillageCity=@VillageCity 
				, Language=@Language 
				--, TalukaId=@TalukaId 
				, IsActive=@IsActive 
				, IsEdited=@IsEdited 			
				, UpdatedDate=@UpdatedDate
				, UpdatedBy=@UpdatedBy 
				,State = @State
				,District = @District
				,taluka = @taluka
				,City = @City
				,AreaId = @AreaId
				, Society = @Society
				,Area = @Area
				, SocietyId = @SocietyId
				 WHERE VillageCityId=@VillageCityId   
		 
					IF @@ERROR=0
					Begin               
						SELECT @v_IsSuccess=1, @v_Identity = @VillageCityId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
					End
					Else
					Begin
						SELECT @v_IsSuccess=0, @v_Identity = @VillageCityId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
					End 
			End
			Else
			Begin
				SELECT @v_IsSuccess=0, @v_Identity = @VillageCityId, @v_Message='error', @v_CustomMessage='Duplication error. Village/City and Taluka combination with this name already exists!'
			End                 
		
			SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN      

	  If @SubCommand = 'SelectSingle'
		Begin
			 SELECT VillageCityId, VillageCity, vc.Language, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy
			, t.TalukaId, t.Taluka
			, d.DistrictId, d.District
			, s.StateId, s.State			
			FROM location.tblVillageCity vc with(nolock)
			INNER JOIN location.tblTaluka t with(nolock) on vc.TalukaId=t.TalukaId
			INNER JOIN location.tblDistrict d with(nolock) on t.DistrictId=d.DistrictId
			INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
			WHERE VillageCityId=@VillageCityId 
		End

		Else if @SubCommand='GetAllList' 
		Begin
			Set @StartRow = ((@PageNo-1)*@PageSize) + 1		
			Set @StopRow = (@PageNo*@PageSize)
    
			if @PageSize > 0
			begin
				set @v_PagingQry = ' Where CTE.RowId Between '+CONVERT(varchar(30),@StartRow) +' And '+ CONVERT(varchar(30),@StopRow)
			end

			SET @WhereQry = ' 1=1 '		
			
			If ISNULL(@Language,'')!=''
				SET @WhereQry += ' And t.Language = ''' + @Language + ''''		
			
			If ISNULL(@SearchKey,'')!=''
			Begin
				SET @WhereQry = @WhereQry + ' AND ' 
					+ CASE @SearchType
					 When 'VillageCity'
						Then 'vc.VillageCity = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'Taluka'
						Then 't.Taluka = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'TalukaId'
						Then 't.TalukaId = ' + Convert(varchar, @SearchKey) 
					 When 'District'
						Then 'd.District = ''' + Convert(varchar, @SearchKey) + ''''
					 When 'DistrictId'
						Then 'd.DistrictId = ' + Convert(varchar, @SearchKey) 
					 When 'State'
						Then 's.State = ''' + Convert(varchar, @SearchKey) + ''''	
					 When 'StateId'
						Then 's.StateId = ' + Convert(varchar, @SearchKey) 
					 When 'FreeSearch'
						Then '(vc.VillageCity like ''%' + @SearchKey + '%'' Or t.Taluka like ''%' + @SearchKey + '%'' Or d.District like ''%' + @SearchKey + '%'' Or s.State like ''%' + @SearchKey + '%'' Or vc.Language like ''%' + @SearchKey + '%'')' 
					 End
			End		
			
			--print @WhereQry	
			
			set @BaseQry = '
				With CTE AS (
					Select VillageCityId, Row_Number() Over (Order by SortBy ' + @SortOrder + ') as RowId From
					(
						Select vc.VillageCityId, ' + @SortBy + ' as SortBy
						 FROM 
						 location.tblVillageCity vc with (nolock)
						 INNER JOIN location.tblTaluka t with (nolock) ON vc.TalukaId=t.TalukaId
						 INNER JOIN location.tblDistrict d with(nolock) ON t.DistrictId=d.DistrictId
						 INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId
						WHERE ' + @WhereQry + ' 
					) A
				) Select distinct 
				CTE.RowId
				--, (select Count(RowId) from CTE) as TotalCount
				--, (select Ceiling(Cast(Count(RowId) as Float)/'+CONVERT(varchar(30),@PageSize)+') from CTE) as PageCount
				, vc.VillageCityId, vc.VillageCity, vc.Language
				, t.TalukaId, t.Taluka
				, d.DistrictId, d.District
				, s.StateId, s.State
				, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy								  
				  From CTE
				  INNER JOIN location.tblVillageCity vc with (nolock) ON CTE.VillageCityId=vc.VillageCityId
				  INNER JOIN location.tblTaluka t with(nolock) ON vc.TalukaId=t.TalukaId
				  INNER JOIN location.tblDistrict d with(nolock) ON t.DistrictId=d.DistrictId
				  INNER JOIN location.tblState s with(nolock) ON d.StateId=s.StateId 

		
				  ' + @v_PagingQry + 
				  ' Order by RowId	'	
				
		
			print '--@WhereQry' + @WhereQry			
			print '--@BaseQry' + @BaseQry			
			Exec (@BaseQry)
		End

		-- New Logic of Get tokenized autosuggest
		ELSE IF @SubCommand = 'GetTokenize'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				;With CTE AS (
					Select * From
					(
						Select * 
						 FROM 
						 location.tblVillageCity vc with (nolock)
						WHERE  1=1   and Language = @Language
					) A
				) Select distinct 
				
				 vc.VillageCityId, vc.VillageCity, vc.Language
				 ,vc.Taluka
				, vc.District
				, vc.State
				, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy									  
				From CTE vc 
		END
		-- New Logic of Get tokenized autosuggest
		ELSE IF @SubCommand = 'GetTokenizeArea'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

					;With CTE AS (
					Select * From
					(
						Select * 
						 FROM 
						 location.tblVillageCity vc with (nolock)
						WHERE  1=1   and Language = @Language and IsActive = 1
					) A
				) Select distinct 
				
				 vc.VillageCityId
				 , vc.VillageCity
				 , vc.Language
				 ,vc.Taluka
				, vc.District
				, vc.State
				,vc.Area
				,vc.Society
				, vc.IsActive, vc.IsEdited, vc.EntryDate, vc.UpdatedDate, vc.CreatedBy, vc.UpdatedBy									  
				From CTE vc 
		END
		-- New Logic of Get tokenized autosuggest

		ELSE IF @SubCommand = 'GetTokenizeAreaList'
		BEGIN
				set @Language  = case when isnull(@Language,'') = '' then 'english' else @Language end

				--	;With CTE AS (
				--	Select * From
				--	(
				--		select area , societyid , society , s.isActive from location.tblarea a
				--		inner join location.tblsociety s on s.areaid = a.areaid
				--		where 1 = 1 and s.language = @Language and 
				--		(
				--			(isnull(@Society, '') = ''  and 1 = 1 )
				--			or
				--			(s.society = @Society)
						
				--		)
				--	) A
				--) Select distinct 
				
				--vc.area
				--,vc.SocietyId
				--, vc.society
				--,vc.isActive
				--From CTE vc
				
				--declare @VillageCity nvarchar(200) = ''
				;With CTE AS (
					Select * From
					(
						select * from location.tblVillageCity 
						where 1 = 1 and language = @Language and 
						--where 1 = 1 and language = 'English' and 
						(
							(isnull(@VillageCity, '') = ''  and 1 = 1 )
							or
							(VillageCity = @VillageCity)
						
						)
					) A
				) Select distinct 
				
				vc.area
				,0 as SocietyId
				, vc.society
				,vc.isActive
				From CTE vc


		END
		-- New Logic of Get tokenized autosuggest

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		IF @SubCommand = 'Multiple'
		BEGIN
			
			DELETE FROM location.tblVillageCity WHERE VillageCityId in (select value from string_split(@MultipleDeleteIds,','))
		END
		ELSE
		BEGIN
			DELETE FROM location.tblVillageCity WHERE VillageCityId=@VillageCityId 
		END
			
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @VillageCityId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 
GO
/****** Object:  StoredProcedure [dbo].[Usp_SubscriptionExecution]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Usp_SubscriptionExecution]
@Command varchar(200) 
  , @HospitalId int=NULL 
  , @HospitalName nvarchar(1000)=NULL 
  , @LocationId int=NULL 
  , @Area nvarchar(100)=NULL
  , @Taluka nvarchar(100)=NULL
  , @District nvarchar(100)=NULL
  , @State nvarchar(100)=NULL
  , @Pincode nvarchar(50)=NULL
  , @LocationType nvarchar(50)=NULL
  , @HospitalTypeRefId bigint=NULL
  , @HospitalTiming nvarchar(1000)=NULL
  , @HospitalFooterNote nvarchar(4000)=NULL
  , @HospitalLogo nvarchar(MAX)=NULL
  , @IsActive bit=NULL 
  , @IsEdited bit=NULL 
  , @EntryDate datetime=NULL 
  , @UpdatedDate datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='HospitalName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  , @Phone nvarchar(100) = NULL
  , @LandLine nvarchar(100) = NULL
  , @FaxNo nvarchar(100) = NULL
  , @EmailAddress nvarchar(100) = NULL
  
  , @LicenceKey nvarchar(500) = null
  , @Location nvarchar(500) = null
  , @HouseBuilding nvarchar(500) = null


  as

  BEGIN

    DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0, @v_PagingQry varchar(2000)=''
		, @v_LocationId int

	IF @Command = 'INSERT'
	BEGIN
		
		INSERT INTO hospital.tblHospital  
				(HospitalName, LocationId, Area, Taluka, District, State, Pincode, LocationType, HospitalTypeRefId, HospitalTiming, HospitalFooterNote, HospitalLogo
				, IsActive, IsEdited, EntryDate, UpdatedDate, CreatedBy, UpdatedBy , HospitalMasterId,Location , HouseBuilding) 
				VALUES (@HospitalName, @LocationId, @Area, @Taluka, @District, @State, @Pincode, @LocationType, @HospitalTypeRefId, @HospitalTiming, @HospitalFooterNote, @HospitalLogo
				, @IsActive, @IsEdited, GETDATE(), @UpdatedDate, @CreatedBy, @UpdatedBy , @HospitalId,@Location , @HouseBuilding) 

				IF @@ERROR=0
				Begin               
					SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'

					If @v_Identity > 0
					Begin
						insert into hospital.tblHospitalContacts (ContactEntityType,ContactEntityRefId,Phone,LandLine,FaxNo,EmailAddress,IsEdited,EntryDate,UpdatedDate,CreatedBy,UpdatedBy , hospitalId , HospitalMasterId)
						values (12, @v_Identity, @Phone, @LandLine, @FaxNo, @EmailAddress, 1, GETDATE(), null, @CreatedBy, @UpdatedBy , @v_Identity , @HospitalId)
					End
				End
				Else
				Begin
					SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
				End

				SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
	END



  END
GO
/****** Object:  StoredProcedure [dbo].[Usp_UserTemplateSettings]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [dbo].[Usp_UserTemplateSettings]  
   @Command varchar(200) 
  , @TempSettingId bigint=NULL 
  , @UserId bigint=NULL 
  , @UserCode nvarchar(MAX)=NULL 
  , @FontFamily nvarchar(MAX)=NULL 
  , @BGColour nvarchar(MAX)=NULL 
  , @CreatedOn datetime=NULL 
  , @UpdateOn datetime=NULL 
  , @CreatedBy bigint=NULL 
  , @UpdatedBy bigint=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  ,

  @HospitalId bigint = null,
  @headerImages text = null
  , @IsTemplateSelect int = 0
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 

	  update hospital.tbl_UserTemplateSettings set IsTemplateSelect = 0 where HospitalId = @HospitalId
	
      INSERT INTO hospital.tbl_UserTemplateSettings  
         ( UserId, UserCode, FontFamily, HospitalId,BGColour, CreatedOn,UpdateOn, CreatedBy, UpdatedBy, HeaderImage, IsTemplateSelect) 
       VALUES (@UserId, @UserCode, @FontFamily, @HospitalId,@BGColour, @CreatedOn, @UpdateOn, @CreatedBy, @UpdatedBy, @headerImages, 1)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE hospital.tbl_UserTemplateSettings SET UserId = @UserId
         , UserCode=@UserCode 
        , FontFamily=@FontFamily 
        , BGColour=@BGColour 
        , CreatedOn=@CreatedOn 
        , UpdateOn=@UpdateOn 
        , CreatedBy=@CreatedBy 
		, HospitalId = @HospitalId
        , UpdatedBy=@UpdatedBy 

		, HeaderImage = @headerImages

         WHERE  TempSettingId=@TempSettingId

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @TempSettingId, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @TempSettingId, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		
		IF @SubCommand = 'SelectSingle Users'
		BEGIN	
			select UserId, UserCode from hospital.tblHospitalUsers where HospitalId = @HospitalId
		END
		ELSE IF @SubCommand ='ALL Images'
		BEGIN
			--SELECT 
			----TempSettingId, 
			----UserId, 
			----UserCode, 
			----FontFamily, 
			----BGColour, 
			----CreatedOn, 
			----UpdateOn, 
			----CreatedBy, 
			----UpdatedBy,
			-- IsTemplateSelect
			--,HeaderImage 
			--FROM  hospital.tbl_UserTemplateSettings 
			--WHERE 
			----UserId=@UserId 
			--HospitalId = @HospitalId
			----order by IsTemplateSelect desc

			select 
			IsTemplateActive as IsTemplateSelect,
			HeaderImage
			from hospital.tblReportHeader 
			where 
			HospitalId = @HospitalId and
			--HeaderImage is not null
			isnull(HeaderImage,'') <> ''


		END
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM hospital.tbl_UserTemplateSettings WHERE  UserId=@UserId 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @TempSettingId, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_District]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_District]  
   @Command varchar(200) 
  , @id bigint=NULL 
  , @DistrictName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='DistrictName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_district  
         (DistrictName) 
       VALUES ( @DistrictName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_district  set
         DistrictName=@DistrictName 
         WHERE id =@id     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @id, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      SELECT id, DistrictName FROM  patient.tbl_district WHERE id =@id 
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_district WHERE id =@id
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_HusbandNames]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_HusbandNames]
   @Command varchar(200) 
  , @hid bigint=NULL 
  , @HusbandName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='HusbandName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  
  -- new parameter for multiple delete
  , @ids nvarchar(max) = ''
  , @TrueValue nvarchar(200) = ''
  -- new parameter for multiple delete
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_husbandName  
         ( HusbandName) 
       VALUES ( @HusbandName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	UPDATE patient.tblPatients set PrimaryRelativeName = @HusbandName where FirstName = trim(@TrueValue)

      UPDATE patient.tbl_husbandName SET 
         HusbandName=@HusbandName 
         WHERE hid =@hid     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @hid, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @hid, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF (@SubCommand = 'Single')
		begin
			SELECT hid, HusbandName FROM  patient.tbl_husbandName WHERE hid =@hid
		end
		IF(@SubCommand = 'ALL')
		begin
			SELECT hid, HusbandName FROM  patient.tbl_husbandName with(nolock) order by 1 desc
		end

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
	IF @SubCommand = 'Single'
	BEGIN
      DELETE FROM patient.tbl_husbandName WHERE hid =@hid
	  END
    ELSE IF @SubCommand = 'Multiple'
		BEGIN
			DELETE FROM patient.tbl_husbandName where hid in (select value from string_split(@ids,','))
		END
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @hid, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_Landmarks]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [patient].[Usp_Manage_Landmarks]  
   @Command varchar(200) 
  , @lid bigint=NULL 
  , @Landmark nvarchar(200)=NULL 
  , @langauge nvarchar(100)=NULL 
  , @createdOn datetime=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL
  
  -- new parameter for multiple delete
  , @ids nvarchar(max) = ''
   , @TrueValue nvarchar(200) = ''
  -- new parameter for multiple delete
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_landmark  
         ( Landmark, langauge, createdOn) 
       VALUES ( @Landmark, @langauge, @createdOn)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

	UPDATE patient.tblPatients set Landmark = @Landmark where FirstName = trim(@TrueValue)


      UPDATE patient.tbl_landmark SET
         Landmark=@Landmark 
        , langauge=@langauge 
        , createdOn=@createdOn 
         WHERE lid= @lid     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @lid, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @lid, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF @SubCommand = 'ALL'
		BEGIN
			select lid,Landmark,langauge from patient.tbl_Landmark with(nolock) order by 1 desc
		END
		ELSE IF @SubCommand = 'Single'
		BEGIN
			SELECT lid, Landmark, langauge, createdOn FROM  patient.tbl_landmark WHERE lid =@lid 
		END
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		IF @SubCommand = 'Single'
		BEGIN
			DELETE FROM patient.tbl_landmark WHERE lid=@lid 
		END
		ELSE IF @SubCommand = 'Multiple'
		BEGIN
			DELETE FROM patient.tbl_landmark where lid in (select value from string_split(@ids,','))
		END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @lid, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 


GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_LastNames]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_LastNames]  
   @Command varchar(200) 
  , @id bigint=NULL 
  , @LastName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL 
  
  -- new parameter for multiple delete
  , @ids nvarchar(max) = ''
  , @TrueValue nvarchar(200) = ''
  -- new parameter for multiple delete
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_LastName  
         ( LastName) 
       VALUES (@LastName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

		UPDATE patient.tblPatients set LastName = @LastName where FirstName = trim(@TrueValue)

      UPDATE patient.tbl_LastName SET 
         LastName=@LastName 
         WHERE id= @id     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @id, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF @SubCommand = 'ALL'
		begin
			SELECT id, LastName FROM  patient.tbl_LastName with(nolock) order by 1 desc
		end
		ELSE IF @SubCommand = 'Single'
		begin
			SELECT id, LastName FROM  patient.tbl_LastName WHERE id= @id
		end
      
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		IF @SubCommand = 'Single'
		BEGIN
			DELETE FROM patient.tbl_LastName WHERE id= @id 
		END
		ELSE IF @SubCommand = 'Multiple'
		BEGIN
			DELETE FROM patient.tbl_LastName where id in (select value from string_split(@ids,','))
		END


		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_patientNames]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 CREATE PROC [patient].[Usp_Manage_patientNames]  
   @Command varchar(200) 
  , @pid bigint=NULL 
  , @PatientName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='PatientName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  

  -- new parameter for multiple delete
  , @ids nvarchar(max) = ''
  , @TrueValue nvarchar(200) = ''
  -- new parameter for multiple delete
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_PatientName  
         ( PatientName) 
       VALUES (@PatientName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 

		
	 UPDATE patient.tblPatients set FirstName = @PatientName where FirstName = trim(@TrueValue)
		
      UPDATE patient.tbl_PatientName SET 
         PatientName=@PatientName 
         WHERE pid =@pid     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @pid, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @pid, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF @SubCommand = 'Single'
		begin
			SELECT pid, PatientName FROM  patient.tbl_PatientName WHERE pid= @pid 
		end
		ELSE IF @SubCommand = 'ALL'
		BEGIN
			SELECT pid, PatientName FROM  patient.tbl_PatientName order by 1 desc
		END

    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
		IF @SubCommand = 'Single'
		begin
			DELETE FROM patient.tbl_PatientName WHERE pid =@pid 
		end
		ELSE IF @SubCommand = 'Multiple'
		begin
			DELETE FROM patient.tbl_PatientName where pid in (select value from string_split(@ids,','))
		end

		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @pid, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_PinCodes]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_PinCodes] 
   @Command varchar(200) 
  , @pinid bigint=NULL 
  , @PinCode nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='PinCode'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_PinCode  
         ( PinCode) 
       VALUES (@PinCode)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_PinCode SET 
         PinCode=@PinCode 
         WHERE pinid =@pinid    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @pinid, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @pinid, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF @SubCommand = 'Single'
		begin
			SELECT pinid, PinCode FROM  patient.tbl_PinCode WHERE pinid = @pinid
		end
		ELSE IF @SubCommand = 'ALL'
		begin
			SELECT pinid, PinCode FROM  patient.tbl_PinCode with(nolock)
		end
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_PinCode WHERE pinid = @pinid 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @pinid, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_regiondetails]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_regiondetails]  
   @Command varchar(200) 
  , @id bigint=NULL 
  , @villagecity nvarchar(400)=NULL 
  , @taluka nvarchar(400)=NULL 
  , @district nvarchar(400)=NULL 
  , @state nvarchar(400)=NULL 
  , @pincode nvarchar(200)=NULL 
  , @createdOn datetime=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='villagecity'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_regiondetails  
         ( villagecity, taluka, district, state, pincode, createdOn) 
       VALUES ( @villagecity, @taluka, @district, @state, @pincode, @createdOn)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_regiondetails SET  
         villagecity=@villagecity 
        , taluka=@taluka 
        , district=@district 
        , state=@state 
        , pincode=@pincode 
        , createdOn=@createdOn 
         WHERE id=@id     
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @id, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
		IF @SubCommand = 'Single'
		begin
			SELECT id, villagecity, taluka, district, state, pincode, createdOn FROM  patient.tbl_regiondetails WHERE id=@id
		end
		ELSE IF @SubCommand = 'ALL'
		begin
			SELECT id, villagecity, taluka, district, state, pincode, createdOn FROM  patient.tbl_regiondetails with(nolock)
		end
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_regiondetails WHERE id=@id
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_states]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_states]  
   @Command varchar(200) 
  , @id bigint=NULL 
  , @StateName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='StateName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_state  
         ( StateName) 
       VALUES ( @StateName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_state SET 
         StateName=@StateName 
         WHERE id=@id      
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @id, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      SELECT id, StateName FROM  patient.tbl_state WHERE id=@id 
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_state WHERE id=@id 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
/****** Object:  StoredProcedure [patient].[Usp_Manage_taluka]    Script Date: 13-02-2026 09:34:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ============
 CREATE PROC [patient].[Usp_Manage_taluka]  
   @Command varchar(200) 
  , @id bigint=NULL 
  , @TalukaName nvarchar(400)=NULL 
  , @Edit bit=NULL 
  , @SearchType varchar(200)=NULL
  , @SearchKey varchar(1000)=NULL
  , @SortBy varchar(200)='CategoryName'
  , @SortOrder varchar(5)='Asc'
  , @PageNo int=1
  , @PageSize int=10  
  , @outIsSuccess bit = NULL OUTPUT
  , @outIdentity bigint = NULL OUTPUT
  , @outMessage VARCHAR(MAX) = NULL OUTPUT
  , @outCustomMessage VARCHAR(MAX) = NULL OUTPUT
  , @SubCommand varchar(200) = NULL  
   
 AS 
  BEGIN 
   SET NOCOUNT ON;        
	   
  DECLARE @v_IsSuccess bit=0, @v_Identity as bigint=0, @v_Message varchar(MAX)='', @v_CustomMessage varchar(MAX)=''
	   , @BaseQry varchar(MAX), @WhereQry varchar(MAX), @Qry varchar(8000), @StartRow int=0, @StopRow int=0
  
    IF @Command='INSERT' 
    BEGIN 
      INSERT INTO patient.tbl_taluka  
         ( TalukaName) 
       VALUES ( @TalukaName)   
        
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = SCOPE_IDENTITY(), @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='UPDATE' 
    BEGIN 
      UPDATE patient.tbl_taluka SET 
        TalukaName=@TalukaName 
         WHERE id=@id      
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success',  @v_CustomMessage = 'Saved successfully!'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = @id, @v_Message=ERROR_MESSAGE(),  @v_CustomMessage = 'Save failed!'
		End             
		
		SELECT @outIsSuccess=@v_IsSuccess , @outIdentity=@v_Identity, @outMessage=@v_Message, @outCustomMessage = @v_CustomMessage
    END 
     
    ELSE IF @Command='SELECT' 
    BEGIN 
      SELECT id, TalukaName FROM  patient.tbl_taluka WHERE id=@id  
    END 
     
    ELSE IF @Command='DELETE' 
    BEGIN 
      DELETE FROM patient.tbl_taluka WHERE id=@id 
    
		IF @@ERROR=0
		Begin               
			SELECT @v_IsSuccess=1, @v_Identity = @id, @v_Message='success'
		End
		Else
		Begin
			SELECT @v_IsSuccess=0, @v_Identity = 0, @v_Message=ERROR_MESSAGE()
		End
             
		SELECT @v_IsSuccess AS IsSuccess, @v_IsSuccess as IdentityValue, @v_Message as ProcessMessage
    
    END 

   SET NOCOUNT OFF; 

  END  
 

GO
